(self.webpackChunkdigitalisation_emargement_frontend=self.webpackChunkdigitalisation_emargement_frontend||[]).push([[374],{745:()=>{},6374:(Y0,os,vt)=>{"use strict";vt.r(os),vt.d(os,{ScanQrComponent:()=>j0});var or=vt(467),Vo=vt(1626),ar=vt(177),ee=vt(8457),as=function(r,t){return(as=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var o in n)n.hasOwnProperty(o)&&(e[o]=n[o])})(r,t)};function mt(r,t){function e(){this.constructor=r}as(r,t),r.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}function Y(r,t,e,n){return new(e||(e=Promise))(function(o,a){function i(c){try{u(n.next(c))}catch(l){a(l)}}function s(c){try{u(n.throw(c))}catch(l){a(l)}}function u(c){c.done?o(c.value):new e(function(l){l(c.value)}).then(i,s)}u((n=n.apply(r,t||[])).next())})}function $(r,t){var e,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(u){return function(c){return function(l){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,n&&(o=2&l[0]?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(6===l[0]&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(r,i)}catch(h){l=[6,h],n=0}finally{e=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([u,c])}}}var yh=function(){function r(t){this.global=t,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return r.prototype.setPlatform=function(t,e){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+e+"."),this.platformName=t,this.platform=e},r.prototype.registerFlag=function(t,e,n){if(this.flagRegistry[t]={evaluationFn:e,setHook:n},null!=this.urlFlags[t]){var o=this.urlFlags[t];console.warn("Setting feature override from URL "+t+": "+o+"."),this.set(t,o)}},r.prototype.get=function(t){return t in this.flags||(this.flags[t]=this.evaluateFlag(t)),this.flags[t]},r.prototype.getNumber=function(t){return this.get(t)},r.prototype.getBool=function(t){return this.get(t)},r.prototype.getFlags=function(){return this.flags},Object.defineProperty(r.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),r.prototype.set=function(t,e){if(null==this.flagRegistry[t])throw new Error("Cannot set flag "+t+" as it has not been registered.");this.flags[t]=e,null!=this.flagRegistry[t].setHook&&this.flagRegistry[t].setHook(e)},r.prototype.evaluateFlag=function(t){if(null==this.flagRegistry[t])throw new Error("Cannot evaluate flag '"+t+"': no evaluation function found.");return this.flagRegistry[t].evaluationFn()},r.prototype.setFlags=function(t){this.flags=Object.assign({},t)},r.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},r.prototype.populateURLFlags=function(){var t=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var n,o=(n={},this.global.location.search.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(a){for(var i=[],s=1;s<arguments.length;s++)i[s-1]=arguments[s];return function xh(r,t,e){r[decodeURIComponent(t)]=decodeURIComponent(e||"")}(n,i[0],i[1]),i.join("=")}),n);"tfjsflags"in o&&o.tfjsflags.split(",").forEach(function(a){var i=a.split(":"),s=i[0];t.urlFlags[s]=function(c,l){if("true"===(l=l.toLowerCase())||"false"===l)return"true"===l;if(""+ +l===l)return+l;throw new Error("Could not parse value flag value "+l+" for flag "+c+".")}(s,i[1])})}},r}();function M(){return is}var is=null,Nn=new Map,ir=new Map;function ss(r,t){var e=Uo(r,t);return Nn.get(e)}function us(r){for(var t=Nn.entries(),e=[];;){var n=t.next(),a=n.value;if(n.done)break;var s=a[1];a[0].split("_")[0]===r&&e.push(s)}return e}function cs(r){var t=r.kernelName,e=r.backendName,n=Uo(t,e);if(Nn.has(n))throw new Error("The kernel '"+t+"' for backend '"+e+"' is already registered");Nn.set(n,r)}function wh(r){var t=r.kernelName;ir.has(t)&&console.warn("Overriding the gradient for '"+t+"'"),ir.set(t,r)}function Uo(r,t){return t+"_"+r}function ls(r){for(var t=r.length,e=0,n=0;t>0;)n=Math.random()*t|0,e=r[--t],r[t]=r[n],r[n]=e}function zr(r,t,e){return Math.max(r,Math.min(t,e))}function Go(r){return r%2==0?r:r+1}function hs(r){for(var t=0,e=0;e<r.length;e++)t+=r[e];return t}function E(r,t){if(!r)throw new Error("string"==typeof t?t:t())}function pe(r,t,e){void 0===e&&(e=""),E(Ne(r,t),function(){return e+" Shapes "+r+" and "+t+" must match"})}function mn(r){E(null!=r,function(){return"The input to the tensor constructor must be a non-null value."})}function Wt(r,t,e){if(void 0===t&&(t=[]),void 0===e&&(e=!1),null==t&&(t=[]),Array.isArray(r)||He(r)&&!e)for(var n=0;n<r.length;++n)Wt(r[n],t,e);else t.push(r);return t}function Q(r){if(0===r.length)return 1;for(var t=r[0],e=1;e<r.length;e++)t*=r[e];return t}function Ne(r,t){if(r===t)return!0;if(null==r||null==t||r.length!==t.length)return!1;for(var e=0;e<r.length;e++)if(r[e]!==t[e])return!1;return!0}function Re(r){return r%1==0}function fs(r){if(null!=Math.tanh)return Math.tanh(r);if(r===1/0)return 1;if(r===-1/0)return-1;var t=Math.exp(2*r);return(t-1)/(t+1)}function Vr(r){var t=Math.ceil(Math.sqrt(r));return[t,Math.ceil(r/t)]}function gn(r,t){return t<=r.length?r:r+" ".repeat(t-r.length)}function Ho(r,t,e){return void 0===t&&(t=function(n){return 0}),new Promise(function(n,o){var a=0,i=function(){if(r())n();else{a++;var s=t(a);null!=e&&a>=e?o():setTimeout(i,s)}};i()})}function ds(r,t){for(var e=1,n=-1,o=0;o<r.length;++o)if(r[o]>=0)e*=r[o];else if(-1===r[o]){if(-1!==n)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+n+" and dim "+o);n=o}else if(r[o]<0)throw Error("Shapes can not be < 0. Found "+r[o]+" at dim "+o);if(-1===n){if(t>0&&t!==e)throw Error("Size("+t+") must match the product of shape "+r);return r}if(0===e)throw Error("Cannot infer the missing size in ["+r+"] when there are 0 elements");if(t%e!=0)throw Error("The implicit shape can't be a fractional number. Got "+t+" / "+e);var a=r.slice();return a[n]=t/e,a}function Pe(r,t){var e=t.length;return E((r=null==r?t.map(function(n,o){return o}):[].concat(r)).every(function(n){return n>=-e&&n<e}),function(){return"All values in axis param must be in range [-"+e+", "+e+") but got axis "+r}),E(r.every(function(n){return Re(n)}),function(){return"All values in axis param must be integers but got axis "+r}),r.map(function(n){return n<0?e+n:n})}function en(r,t){for(var e=[],n=[],o=null!=t&&Array.isArray(t)&&0===t.length,a=null==t||o?null:Pe(t,r).sort(),i=0,s=0;s<r.length;++s){if(null!=a){if(a[i]===s&&1!==r[s])throw new Error("Can't squeeze axis "+s+" since its dim '"+r[s]+"' is not 1");(null==a[i]||a[i]>s)&&1===r[s]&&(e.push(r[s]),n.push(s)),a[i]<=s&&i++}1!==r[s]&&(e.push(r[s]),n.push(s))}return{newShape:e,keptDims:n}}function Pn(r,t){var e=null;if(null==r||"float32"===r)e=new Float32Array(t);else if("int32"===r)e=new Int32Array(t);else{if("bool"!==r)throw new Error("Unknown data type "+r);e=new Uint8Array(t)}return e}function sr(r,t){var e=null;if(null==r||"float32"===r)e=new Float32Array(t);else if("int32"===r)e=new Int32Array(t);else if("bool"===r)e=new Uint8Array(t);else{if("string"!==r)throw new Error("Unknown data type "+r);e=new Array(t)}return e}function ps(r,t){for(var e=0;e<r.length;e++){var n=r[e];if(isNaN(n)||!isFinite(n))throw Error("A tensor of type "+t+" being uploaded contains "+n+".")}}function vs(r){return"bool"===r||"complex64"===r||"float32"===r||"int32"===r||"string"===r}function ms(r,t){return!("complex64"===t||"float32"===t&&"complex64"!==r||"int32"===t&&"float32"!==r&&"complex64"!==r||"bool"===t&&"bool"===r)}function He(r){return r instanceof Float32Array||r instanceof Int32Array||r instanceof Uint8Array}function jo(r){if("float32"===r||"int32"===r)return 4;if("complex64"===r)return 8;if("bool"===r)return 1;throw new Error("Unknown dtype "+r)}function gs(r){if(null==r)return 0;var t=0;return r.forEach(function(e){return t+=e.length}),t}function tn(r){return"string"==typeof r||r instanceof String}function ys(r){return"boolean"==typeof r}function xs(r){return"number"==typeof r}function Mn(r){return Array.isArray(r)?Mn(r[0]):r instanceof Float32Array?"float32":r instanceof Int32Array||r instanceof Uint8Array?"int32":xs(r)?"float32":tn(r)?"string":ys(r)?"bool":"float32"}function nn(r){return!!(r&&r.constructor&&r.call&&r.apply)}function Ur(r,t){for(var e=t;e<r;++e)if(r%e==0)return e;return r}function gt(r){var t=r.length;if(t<2)return[];var e=new Array(t-1);e[t-2]=r[t-1];for(var n=t-3;n>=0;--n)e[n]=e[n+1]*r[n+1];return e}function qo(r,t,e){if("string"===t)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(r)&&(r=Wt(r)),e&&ps(r,t),i=t,(a=r)instanceof Float32Array&&"float32"===i||a instanceof Int32Array&&"int32"===i||a instanceof Uint8Array&&"bool"===i)return r;var a,i;if(null==t||"float32"===t||"complex64"===t)return new Float32Array(r);if("int32"===t)return new Int32Array(r);if("bool"===t){for(var n=new Uint8Array(r.length),o=0;o<n.length;++o)0!==Math.round(r[o])&&(n[o]=1);return n}throw new Error("Unknown data type "+t)}function Ko(r,t){if(0===r.length)return t[0];var e=r.reduce(function(n,o){return n*o});if(0===e)return[];if(e!==t.length)throw new Error("["+r+"] does not match the input size.");return function n(o,a,i){var s=new Array;if(1===a.length)for(var u=a[0],c=0;c<u;c++)s[c]=i[o+c];else{u=a[0];var l=a.slice(1),h=l.reduce(function(f,d){return f*d});for(c=0;c<u;c++)s[c]=n(o+c*h,l,i)}return s}(0,r,t)}function Xo(r,t){for(var e=On(r,t),n=0;n<e.length;n++)e[n]=1;return e}function On(r,t){if(null==t||"float32"===t||"complex64"===t)return new Float32Array(r);if("int32"===t)return new Int32Array(r);if("bool"===t)return new Uint8Array(r);throw new Error("Unknown data type "+t)}function yt(){return M().platform.now()}function Yo(r){r.forEach(function(t){E(Number.isInteger(t)&&t>=0,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+r+"]."})})}function bs(r,t){return void 0===t&&(t="utf-8"),t=t||"utf-8",M().platform.encode(r,t)}function ur(r,t){return void 0===t&&(t="utf-8"),t=t||"utf-8",M().platform.decode(r,t)}function $o(r,t,e){if(0===t)return 0;if(1===t)return r[0];for(var n=r[r.length-1],o=0;o<r.length-1;++o)n+=e[o]*r[o];return n}function ws(r,t,e){if(0===t)return[];if(1===t)return[r];for(var n=new Array(t),o=0;o<n.length-1;++o)n[o]=Math.floor(r/e[o]),r-=n[o]*e[o];return n[n.length-1]=r,n}Object.freeze({shuffle:ls,clamp:zr,nearestLargerEven:Go,sum:hs,randUniform:function(r,t){var e=Math.random();return t*e+(1-e)*r},distSquared:function(r,t){for(var e=0,n=0;n<r.length;n++){var o=Number(r[n])-Number(t[n]);e+=o*o}return e},assert:E,assertShapesMatch:pe,assertNonNull:mn,flatten:Wt,sizeFromShape:Q,isScalarShape:function(r){return 0===r.length},arraysEqual:Ne,isInt:Re,tanh:fs,sizeToSquarishShape:Vr,createShuffledIndices:function(r){for(var t=new Uint32Array(r),e=0;e<r;++e)t[e]=e;return ls(t),t},rightPad:gn,repeatedTry:Ho,inferFromImplicitShape:ds,parseAxisParam:Pe,squeezeShape:en,getTypedArrayFromDType:Pn,getArrayFromDType:sr,checkConversionForErrors:ps,isValidDtype:vs,hasEncodingLoss:ms,isTypedArray:He,bytesPerElement:jo,bytesFromStringArray:gs,isString:tn,isBoolean:ys,isNumber:xs,inferDtype:Mn,isFunction:nn,nearestDivisor:Ur,computeStrides:gt,toTypedArray:qo,toNestedArray:Ko,makeOnesTypedArray:Xo,makeZerosTypedArray:On,now:yt,assertNonNegativeIntegerDimensions:Yo,fetch:function(r,t){return M().platform.fetch(r,t)},encodeString:bs,decodeString:ur,locToIndex:$o,indexToLoc:ws});var _h=function(){function r(t,e){this.backendTimer=t,this.logger=e,null==e&&(this.logger=new Ch)}return r.prototype.profileKernel=function(t,e,n){var o,a=this,i=this.backendTimer.time(function(){o=n()});return o.forEach(function(s){s.data().then(function(u){(function(c,l,h){if("float32"!==l)return!1;for(var f=0;f<c.length;f++){var d=c[f];if(isNaN(d)||!isFinite(d))return console.warn("Found "+d+" in the result of '"+h+"'"),!0}})(u,s.dtype,t),i.then(function(c){var l="";null!=c.getExtraProfileInfo&&(l=c.getExtraProfileInfo()),a.logger.logKernelProfile(t,s,u,c.kernelMs,e,l)})})}),o},r}(),Ch=function(){function r(){}return r.prototype.logKernelProfile=function(t,e,n,o,a,i){var s="number"==typeof o?gn(o+"ms",9):o.error,u=gn(t,25),c=e.rank,l=e.size,h=gn(e.shape.toString(),14),f="";for(var d in a){var p=a[d].shape||e.shape,m=p.length;f+=d+": "+m+"D "+(m>0?p:"")+" "}console.log("%c"+u+"\t%c"+s+"\t%c"+c+"D "+h+"\t%c"+l+"\t%c"+f+"\t%c"+i,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},r}();function lr(r,t,e){return gn(Array.isArray(r)?parseFloat(r[0].toFixed(7))+" + "+parseFloat(r[1].toFixed(7))+"j":tn(r)?"'"+r+"'":"bool"===e?Cs(r):parseFloat(r.toFixed(7)).toString(),t)}function Cs(r){return 0===r?"false":"true"}function hr(r){for(var t=[],e=0;e<r.length;e+=2)t.push([r[e],r[e+1]]);return t}var fr=function(){function r(t,e,n){var o=this;if(this.dtype=e,this.shape=t.slice(),this.size=Q(t),null!=n){var a=n.length;E(a===this.size,function(){return"Length of values '"+a+"' does not match the size inferred by the shape '"+o.size+"'."})}if("complex64"===e)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=n||sr(e,this.size),this.strides=gt(t)}return r.prototype.set=function(t){for(var e=this,n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];0===n.length&&(n=[0]),E(n.length===this.rank,function(){return"The number of provided coordinates ("+n.length+") must match the rank ("+e.rank+")"});var a=this.locToIndex(n);this.values[a]=t},r.prototype.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];0===t.length&&(t=[0]);for(var n=0,o=0,a=t;o<a.length;o++){var i=a[o];if(i<0||i>=this.shape[n])throw new Error("Requested out of range element at "+t+".   Buffer shape="+this.shape);n++}for(var u=t[t.length-1],c=0;c<t.length-1;++c)u+=this.strides[c]*t[c];return this.values[u]},r.prototype.locToIndex=function(t){if(0===this.rank)return 0;if(1===this.rank)return t[0];for(var e=t[t.length-1],n=0;n<t.length-1;++n)e+=this.strides[n]*t[n];return e},r.prototype.indexToLoc=function(t){if(0===this.rank)return[];if(1===this.rank)return[t];for(var e=new Array(this.shape.length),n=0;n<e.length-1;++n)e[n]=Math.floor(t/this.strides[n]),t-=e[n]*this.strides[n];return e[e.length-1]=t,e},Object.defineProperty(r.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),r.prototype.toTensor=function(){return It().makeTensor(this.values,this.shape,this.dtype)},r}(),It=null,P=null,Es=null,_e=function(){function r(t,e,n,o){this.kept=!1,this.isDisposedInternal=!1,this.shape=t.slice(),this.dtype=e||"float32",this.size=Q(t),this.strides=gt(t),this.dataId=n,this.id=o,this.rankType=this.rank<5?this.rank.toString():"higher"}return r.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},r.prototype.asScalar=function(){return this.throwIfDisposed(),E(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},r.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},r.prototype.as2D=function(t,e){return this.throwIfDisposed(),this.reshape([t,e])},r.prototype.as3D=function(t,e,n){return this.throwIfDisposed(),this.reshape([t,e,n])},r.prototype.as4D=function(t,e,n,o){return this.throwIfDisposed(),this.reshape([t,e,n,o])},r.prototype.as5D=function(t,e,n,o,a){return this.throwIfDisposed(),this.reshape([t,e,n,o,a])},r.prototype.asType=function(t){return this.throwIfDisposed(),P.cast(this,t)},Object.defineProperty(r.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),r.prototype.buffer=function(){return Y(this,void 0,void 0,function(){var t;return $(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,P.buffer(this.shape,this.dtype,t)]}})})},r.prototype.bufferSync=function(){return P.buffer(this.shape,this.dtype,this.dataSync())},r.prototype.array=function(){return Y(this,void 0,void 0,function(){var t;return $(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,Ko(this.shape,t)]}})})},r.prototype.arraySync=function(){return Ko(this.shape,this.dataSync())},r.prototype.data=function(){return Y(this,void 0,void 0,function(){var t,e;return $(this,function(n){switch(n.label){case 0:return this.throwIfDisposed(),t=It().read(this.dataId),"string"!==this.dtype?[3,2]:[4,t];case 1:e=n.sent();try{return[2,e.map(function(o){return ur(o)})]}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}n.label=2;case 2:return[2,t]}})})},r.prototype.dataSync=function(){this.throwIfDisposed();var t=It().readSync(this.dataId);if("string"===this.dtype)try{return t.map(function(e){return ur(e)})}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return t},r.prototype.bytes=function(){return Y(this,void 0,void 0,function(){var t;return $(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),[4,It().read(this.dataId)];case 1:return t=e.sent(),"string"===this.dtype?[2,t]:[2,new Uint8Array(t.buffer)]}})})},r.prototype.dispose=function(){this.isDisposed||(It().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(r.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),r.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},r.prototype.toFloat=function(){return this.asType("float32")},r.prototype.toInt=function(){return this.asType("int32")},r.prototype.toBool=function(){return this.asType("bool")},r.prototype.print=function(t){return void 0===t&&(t=!1),P.print(this,t)},r.prototype.reshape=function(t){return this.throwIfDisposed(),P.reshape(this,t)},r.prototype.reshapeAs=function(t){return this.throwIfDisposed(),this.reshape(t.shape)},r.prototype.expandDims=function(t){return void 0===t&&(t=0),P.expandDims(this,t)},r.prototype.cumsum=function(t,e,n){return void 0===t&&(t=0),void 0===e&&(e=!1),void 0===n&&(n=!1),P.cumsum(this,t,e,n)},r.prototype.squeeze=function(t){return this.throwIfDisposed(),P.squeeze(this,t)},r.prototype.clone=function(){return this.throwIfDisposed(),P.clone(this)},r.prototype.oneHot=function(t,e,n){return this.throwIfDisposed(),P.oneHot(this,t,e,n)},r.prototype.toString=function(t){return void 0===t&&(t=!1),function Eh(r,t,e,n){var o=gt(t),a=function(c,l,h,f){var d=Q(l),p=f[f.length-1],m=new Array(p).fill(0),v=l.length,g="complex64"===h?hr(c):c;if(v>1)for(var x=0;x<d/p;x++)for(var b=x*p,y=0;y<p;y++)m[y]=Math.max(m[y],lr(g[b+y],0,h).length);return m}(r,t,e,o),i=t.length,s=function c(l,h,f,d,p,m){void 0===m&&(m=!0);var v="complex64"===f?2:1,g=h[0],x=h.length;if(0===x)return"complex64"===f?[lr(hr(l)[0],0,f)]:"bool"===f?[Cs(l[0])]:[l[0].toString()];if(1===x){if(g>20){var y=Array.from(l.slice(0,3*v)),w=Array.from(l.slice((g-3)*v,g*v));return"complex64"===f&&(y=hr(y),w=hr(w)),["["+y.map(function(B,U){return lr(B,p[U],f)}).join(", ")+", ..., "+w.map(function(B,U){return lr(B,p[g-3+U],f)}).join(", ")+"]"]}return["["+("complex64"===f?hr(l):Array.from(l)).map(function(B,U){return lr(B,p[U],f)}).join(", ")+"]"]}var C=h.slice(1),S=d.slice(1),k=d[0]*v,I=[];if(g>20){for(var R=0;R<3;R++){var F=(T=R*k)+k;I.push.apply(I,c(l.slice(T,F),C,f,S,p,!1))}for(I.push("..."),R=g-3;R<g;R++)F=(T=R*k)+k,I.push.apply(I,c(l.slice(T,F),C,f,S,p,R===g-1))}else for(R=0;R<g;R++){var T;F=(T=R*k)+k,I.push.apply(I,c(l.slice(T,F),C,f,S,p,R===g-1))}var L=2===x?",":"";for(I[0]="["+I[0]+L,R=1;R<I.length-1;R++)I[R]=" "+I[R]+L;var O=",\n";for(R=2;R<x;R++)O+="\n";return I[I.length-1]=" "+I[I.length-1]+"]"+(m?"":O),I}(r,t,e,o,a),u=["Tensor"];return n&&(u.push("  dtype: "+e),u.push("  rank: "+i),u.push("  shape: ["+t+"]"),u.push("  values:")),u.push(s.map(function(c){return"    "+c}).join("\n")),u.join("\n")}(this.dataSync(),this.shape,this.dtype,t)},r.prototype.tile=function(t){return this.throwIfDisposed(),P.tile(this,t)},r.prototype.gather=function(t,e){return void 0===e&&(e=0),this.throwIfDisposed(),P.gather(this,t,e)},r.prototype.matMul=function(t,e,n){return void 0===e&&(e=!1),void 0===n&&(n=!1),this.throwIfDisposed(),P.matMul(this,t,e,n)},r.prototype.dot=function(t){return this.throwIfDisposed(),P.dot(this,t)},r.prototype.norm=function(t,e,n){return void 0===t&&(t="euclidean"),void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),P.norm(this,t,e,n)},r.prototype.slice=function(t,e){return this.throwIfDisposed(),P.slice(this,t,e)},r.prototype.reverse=function(t){return this.throwIfDisposed(),P.reverse(this,t)},r.prototype.concat=function(t,e){return void 0===e&&(e=0),this.throwIfDisposed(),t instanceof r&&(t=[t]),P.concat([this].concat(t),e)},r.prototype.split=function(t,e){return void 0===e&&(e=0),this.throwIfDisposed(),P.split(this,t,e)},r.prototype.stack=function(t,e){return void 0===e&&(e=0),P.stack([this,t],e)},r.prototype.unstack=function(t){return void 0===t&&(t=0),P.unstack(this,t)},r.prototype.pad=function(t,e){return void 0===e&&(e=0),P.pad(this,t,e)},r.prototype.batchNormalization=function(t,e,n,o,a){return void 0===n&&(n=.001),Es("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(t,e,a,o,n)},r.prototype.batchNorm=function(t,e,n,o,a){return void 0===a&&(a=.001),this.throwIfDisposed(),P.batchNorm(this,t,e,n,o,a)},r.prototype.all=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.all(this,t,e)},r.prototype.any=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.any(this,t,e)},r.prototype.logSumExp=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.logSumExp(this,t,e)},r.prototype.sum=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.sum(this,t,e)},r.prototype.prod=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.prod(this,t,e)},r.prototype.mean=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.mean(this,t,e)},r.prototype.min=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.min(this,t,e)},r.prototype.max=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),P.max(this,t,e)},r.prototype.argMin=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),P.argMin(this,t)},r.prototype.argMax=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),P.argMax(this,t)},r.prototype.cast=function(t){return this.throwIfDisposed(),P.cast(this,t)},r.prototype.add=function(t){return this.throwIfDisposed(),P.add(this,t)},r.prototype.addStrict=function(t){return this.throwIfDisposed(),P.addStrict(this,t)},r.prototype.atan2=function(t){return this.throwIfDisposed(),P.atan2(this,t)},r.prototype.sub=function(t){return this.throwIfDisposed(),P.sub(this,t)},r.prototype.subStrict=function(t){return this.throwIfDisposed(),P.subStrict(this,t)},r.prototype.pow=function(t){return this.throwIfDisposed(),P.pow(this,t)},r.prototype.powStrict=function(t){return this.throwIfDisposed(),P.powStrict(this,t)},r.prototype.mul=function(t){return this.throwIfDisposed(),P.mul(this,t)},r.prototype.mulStrict=function(t){return this.throwIfDisposed(),P.mulStrict(this,t)},r.prototype.div=function(t){return this.throwIfDisposed(),P.div(this,t)},r.prototype.divNoNan=function(t){return this.throwIfDisposed(),P.divNoNan(this,t)},r.prototype.floorDiv=function(t){return this.throwIfDisposed(),P.floorDiv(this,t)},r.prototype.divStrict=function(t){return this.throwIfDisposed(),P.divStrict(this,t)},r.prototype.minimum=function(t){return this.throwIfDisposed(),P.minimum(this,t)},r.prototype.minimumStrict=function(t){return this.throwIfDisposed(),P.minimumStrict(this,t)},r.prototype.maximum=function(t){return this.throwIfDisposed(),P.maximum(this,t)},r.prototype.maximumStrict=function(t){return this.throwIfDisposed(),P.maximumStrict(this,t)},r.prototype.mod=function(t){return this.throwIfDisposed(),P.mod(this,t)},r.prototype.modStrict=function(t){return this.throwIfDisposed(),P.modStrict(this,t)},r.prototype.squaredDifferenceStrict=function(t){return this.throwIfDisposed(),P.squaredDifferenceStrict(this,t)},r.prototype.transpose=function(t){return this.throwIfDisposed(),P.transpose(this,t)},r.prototype.notEqual=function(t){return this.throwIfDisposed(),P.notEqual(this,t)},r.prototype.notEqualStrict=function(t){return this.throwIfDisposed(),P.notEqualStrict(this,t)},r.prototype.less=function(t){return this.throwIfDisposed(),P.less(this,t)},r.prototype.lessStrict=function(t){return this.throwIfDisposed(),P.lessStrict(this,t)},r.prototype.equal=function(t){return this.throwIfDisposed(),P.equal(this,t)},r.prototype.equalStrict=function(t){return this.throwIfDisposed(),P.equalStrict(this,t)},r.prototype.lessEqual=function(t){return this.throwIfDisposed(),P.lessEqual(this,t)},r.prototype.lessEqualStrict=function(t){return this.throwIfDisposed(),P.lessEqualStrict(this,t)},r.prototype.greater=function(t){return this.throwIfDisposed(),P.greater(this,t)},r.prototype.greaterStrict=function(t){return this.throwIfDisposed(),P.greaterStrict(this,t)},r.prototype.greaterEqual=function(t){return this.throwIfDisposed(),P.greaterEqual(this,t)},r.prototype.greaterEqualStrict=function(t){return this.throwIfDisposed(),P.greaterEqualStrict(this,t)},r.prototype.logicalAnd=function(t){return this.throwIfDisposed(),P.logicalAnd(this,t)},r.prototype.logicalOr=function(t){return this.throwIfDisposed(),P.logicalOr(this,t)},r.prototype.logicalNot=function(){return this.throwIfDisposed(),P.logicalNot(this)},r.prototype.logicalXor=function(t){return this.throwIfDisposed(),P.logicalXor(this,t)},r.prototype.where=function(t,e){return this.throwIfDisposed(),P.where(t,this,e)},r.prototype.neg=function(){return this.throwIfDisposed(),P.neg(this)},r.prototype.ceil=function(){return this.throwIfDisposed(),P.ceil(this)},r.prototype.floor=function(){return this.throwIfDisposed(),P.floor(this)},r.prototype.sign=function(){return this.throwIfDisposed(),P.sign(this)},r.prototype.isNaN=function(){return this.throwIfDisposed(),P.isNaN(this)},r.prototype.isInf=function(){return this.throwIfDisposed(),P.isInf(this)},r.prototype.isFinite=function(){return this.throwIfDisposed(),P.isFinite(this)},r.prototype.exp=function(){return this.throwIfDisposed(),P.exp(this)},r.prototype.expm1=function(){return this.throwIfDisposed(),P.expm1(this)},r.prototype.log=function(){return this.throwIfDisposed(),P.log(this)},r.prototype.log1p=function(){return this.throwIfDisposed(),P.log1p(this)},r.prototype.sqrt=function(){return this.throwIfDisposed(),P.sqrt(this)},r.prototype.rsqrt=function(){return this.throwIfDisposed(),P.rsqrt(this)},r.prototype.square=function(){return this.throwIfDisposed(),P.square(this)},r.prototype.reciprocal=function(){return this.throwIfDisposed(),P.reciprocal(this)},r.prototype.abs=function(){return this.throwIfDisposed(),P.abs(this)},r.prototype.clipByValue=function(t,e){return this.throwIfDisposed(),P.clipByValue(this,t,e)},r.prototype.relu=function(){return this.throwIfDisposed(),P.relu(this)},r.prototype.relu6=function(){return this.throwIfDisposed(),P.relu6(this)},r.prototype.elu=function(){return this.throwIfDisposed(),P.elu(this)},r.prototype.selu=function(){return this.throwIfDisposed(),P.selu(this)},r.prototype.leakyRelu=function(t){return void 0===t&&(t=.2),this.throwIfDisposed(),P.leakyRelu(this,t)},r.prototype.prelu=function(t){return this.throwIfDisposed(),P.prelu(this,t)},r.prototype.sigmoid=function(){return this.throwIfDisposed(),P.sigmoid(this)},r.prototype.logSigmoid=function(){return this.throwIfDisposed(),P.logSigmoid(this)},r.prototype.softplus=function(){return this.throwIfDisposed(),P.softplus(this)},r.prototype.zerosLike=function(){return this.throwIfDisposed(),P.zerosLike(this)},r.prototype.onesLike=function(){return this.throwIfDisposed(),P.onesLike(this)},r.prototype.sin=function(){return this.throwIfDisposed(),P.sin(this)},r.prototype.cos=function(){return this.throwIfDisposed(),P.cos(this)},r.prototype.tan=function(){return this.throwIfDisposed(),P.tan(this)},r.prototype.asin=function(){return this.throwIfDisposed(),P.asin(this)},r.prototype.acos=function(){return this.throwIfDisposed(),P.acos(this)},r.prototype.atan=function(){return this.throwIfDisposed(),P.atan(this)},r.prototype.sinh=function(){return this.throwIfDisposed(),P.sinh(this)},r.prototype.cosh=function(){return this.throwIfDisposed(),P.cosh(this)},r.prototype.tanh=function(){return this.throwIfDisposed(),P.tanh(this)},r.prototype.asinh=function(){return this.throwIfDisposed(),P.asinh(this)},r.prototype.acosh=function(){return this.throwIfDisposed(),P.acosh(this)},r.prototype.atanh=function(){return this.throwIfDisposed(),P.atanh(this)},r.prototype.erf=function(){return this.throwIfDisposed(),P.erf(this)},r.prototype.round=function(){return this.throwIfDisposed(),P.round(this)},r.prototype.step=function(t){return void 0===t&&(t=0),this.throwIfDisposed(),P.step(this,t)},r.prototype.softmax=function(t){return void 0===t&&(t=-1),this.throwIfDisposed(),P.softmax(this,t)},r.prototype.logSoftmax=function(t){return void 0===t&&(t=-1),this.throwIfDisposed(),P.logSoftmax(this,t)},r.prototype.resizeBilinear=function(t,e){return void 0===e&&(e=!1),this.throwIfDisposed(),P.image.resizeBilinear(this,t,e)},r.prototype.resizeNearestNeighbor=function(t,e){return void 0===e&&(e=!1),this.throwIfDisposed(),P.image.resizeNearestNeighbor(this,t,e)},r.prototype.conv1d=function(t,e,n,o,a,i){return void 0===o&&(o="NWC"),void 0===a&&(a=1),this.throwIfDisposed(),P.conv1d(this,t,e,n,o,a,i)},r.prototype.conv2d=function(t,e,n,o,a,i){return void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]),this.throwIfDisposed(),P.conv2d(this,t,e,n,o,a,i)},r.prototype.conv2dTranspose=function(t,e,n,o,a){return this.throwIfDisposed(),P.conv2dTranspose(this,t,e,n,o,a)},r.prototype.depthwiseConv2D=function(t,e,n,o,a,i){return void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]),this.throwIfDisposed(),P.depthwiseConv2d(this,t,e,n,o,a,i)},r.prototype.separableConv2d=function(t,e,n,o,a,i){return void 0===a&&(a=[1,1]),void 0===i&&(i="NHWC"),this.throwIfDisposed(),P.separableConv2d(this,t,e,n,o,a,i)},r.prototype.avgPool=function(t,e,n,o){return this.throwIfDisposed(),P.avgPool(this,t,e,n,o)},r.prototype.maxPool=function(t,e,n,o){return this.throwIfDisposed(),P.maxPool(this,t,e,n,o)},r.prototype.localResponseNormalization=function(t,e,n,o){return void 0===t&&(t=5),void 0===e&&(e=1),void 0===n&&(n=1),void 0===o&&(o=.5),P.localResponseNormalization(this,t,e,n,o)},r.prototype.pool=function(t,e,n,o,a){return this.throwIfDisposed(),P.pool(this,t,e,n,o,a)},r.prototype.variable=function(t,e,n){return void 0===t&&(t=!0),this.throwIfDisposed(),It().makeVariable(this,t,e,n)},r.prototype.unsortedSegmentSum=function(t,e){return this.throwIfDisposed(),P.unsortedSegmentSum(this,t,e)},r.prototype.batchToSpaceND=function(t,e){return this.throwIfDisposed(),P.batchToSpaceND(this,t,e)},r.prototype.spaceToBatchND=function(t,e){return this.throwIfDisposed(),P.spaceToBatchND(this,t,e)},r.prototype.topk=function(t,e){return void 0===t&&(t=1),void 0===e&&(e=!0),this.throwIfDisposed(),P.topk(this,t,e)},r.prototype.stridedSlice=function(t,e,n,o,a,i,s,u){return void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===u&&(u=0),this.throwIfDisposed(),P.stridedSlice(this,t,e,n,o,a,i,s,u)},r.prototype.depthToSpace=function(t,e){return this.throwIfDisposed(),P.depthToSpace(this,t,e)},r.prototype.fft=function(){return this.throwIfDisposed(),P.spectral.fft(this)},r.prototype.ifft=function(){return this.throwIfDisposed(),P.spectral.ifft(this)},r.prototype.rfft=function(){return this.throwIfDisposed(),P.spectral.rfft(this)},r.prototype.irfft=function(){return this.throwIfDisposed(),P.spectral.irfft(this)},r}();Object.defineProperty(_e,Symbol.hasInstance,{value:function(r){return!!r&&null!=r.dataId&&null!=r.shape&&null!=r.dtype}});var Is,Jo,Zo,ea,ta,r,Bn=function(r){function t(e,n,o,a){var i=r.call(this,e.shape,e.dtype,e.dataId,a)||this;return i.trainable=n,i.name=o,i}return mt(t,r),t.prototype.assign=function(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!Ne(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");It().disposeTensor(this),this.dataId=e.dataId,It().incRef(this,null)},t.prototype.dispose=function(){It().disposeVariable(this),this.isDisposedInternal=!0},t}(_e);Object.defineProperty(Bn,Symbol.hasInstance,{value:function(r){return r instanceof _e&&null!=r.assign&&r.assign instanceof Function}}),(r=Is||(Is={})).R0="R0",r.R1="R1",r.R2="R2",r.R3="R3",r.R4="R4",r.R5="R5",r.R6="R6",function(r){r.float32="float32",r.int32="int32",r.bool="int32",r.complex64="complex64"}(Jo||(Jo={})),function(r){r.float32="float32",r.int32="int32",r.bool="bool",r.complex64="complex64"}(Zo||(Zo={})),function(r){r.float32="float32",r.int32="float32",r.bool="float32",r.complex64="complex64"}(ea||(ea={})),function(r){r.float32="complex64",r.int32="complex64",r.bool="complex64",r.complex64="complex64"}(ta||(ta={}));var Ih={float32:ea,int32:Jo,bool:Zo,complex64:ta};function Ve(r,t){if("string"===r||"string"===t){if("string"===r&&"string"===t)return"string";throw new Error("Can not upcast "+r+" with "+t)}return Ih[r][t]}function na(r){return Ve(r,"int32")}function Ie(r,t){if(r.dtype===t.dtype)return[r,t];var e=Ve(r.dtype,t.dtype);return[r.cast(e),t.cast(e)]}function Rs(r,t){E(r.dtype===t.dtype,function(){return"The dtypes of the first("+r.dtype+") and second("+t.dtype+") input must match"})}function ra(r){var t=[];return function e(n,o,a){if(null!=n){if(n instanceof _e)return void o.push(n);if(i=n,Array.isArray(i)||"object"==typeof i){var i,s=n;for(var u in s){var c=s[u];a.has(c)||(a.add(c),e(c,o,a))}}}}(r,t,new Set),t}Object.freeze({makeTypesMatch:Ie,assertTypesMatch:Rs,isTensorInList:function(r,t){return t.some(function(e){return e.id===r.id})},getTensorsInContainer:ra});var oa,ks=function(){function r(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return r.prototype.dispose=function(){for(var t in this.registeredVariables)this.registeredVariables[t].dispose()},r}(),Rh=function(){function r(t){this.ENV=t,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new ks}return r.prototype.ready=function(){return Y(this,void 0,void 0,function(){var t,e,n;return $(this,function(o){switch(o.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];t=this.getSortedBackends(),e=0,o.label=1;case 1:return e<t.length?[4,this.initializeBackend(n=t[e]).success]:[3,5];case 2:return o.sent()?[4,this.setBackend(n)]:[3,4];case 3:return o.sent(),[2];case 4:return e++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(r.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var t=this.initializeBackendsAndReturnBest(),e=t.name;if(t.asyncInit)throw new Error("The highest priority backend '"+e+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(e)}return this.backendInstance},enumerable:!0,configurable:!0}),r.prototype.backendNames=function(){return Object.keys(this.registryFactory)},r.prototype.findBackend=function(t){return t in this.registry||t in this.registryFactory&&!this.initializeBackend(t).asyncInit?this.registry[t]:null},r.prototype.findBackendFactory=function(t){return t in this.registryFactory?this.registryFactory[t].factory:null},r.prototype.registerBackend=function(t,e,n){return void 0===n&&(n=1),t in this.registryFactory?(console.warn(t+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[t]={factory:e,priority:n},!0)},r.prototype.setBackend=function(t){return Y(this,void 0,void 0,function(){var e,n,o;return $(this,function(a){switch(a.label){case 0:if(null==this.registryFactory[t])throw new Error("Backend name '"+t+"' not found in registry");return this.backendName=t,null!=this.registry[t]?[3,4]:(this.backendInstance=null,e=this.initializeBackend(t),n=e.success,e.asyncInit?[4,n]:[3,2]);case 1:return o=a.sent(),[3,3];case 2:o=n,a.label=3;case 3:if(!o)return[2,!1];a.label=4;case 4:return this.backendInstance=this.registry[t],this.setupRegisteredKernels(),this.profiler=new _h(this.backendInstance),[2,!0]}})})},r.prototype.setupRegisteredKernels=function(){var t=this;us(this.backendName).forEach(function(e){null!=e.setupFunc&&e.setupFunc(t.backendInstance)})},r.prototype.disposeRegisteredKernels=function(t){var e=this;us(t).forEach(function(n){null!=n.disposeFunc&&n.disposeFunc(e.registry[t])})},r.prototype.initializeBackend=function(t){var e=this,n=this.registryFactory[t];if(null==n)throw new Error("Cannot initialize backend "+t+", no registration found.");try{var o=n.factory();if(Promise.resolve(o)===o){var a=++this.pendingBackendInitId,i=o.then(function(s){return!(a<e.pendingBackendInitId||(e.registry[t]=s,e.pendingBackendInit=null,0))}).catch(function(s){return!(a<e.pendingBackendInitId||(e.pendingBackendInit=null,console.warn("Initialization of backend "+t+" failed"),console.warn(s.stack||s.message),1))});return this.pendingBackendInit=i,{success:i,asyncInit:!0}}return this.registry[t]=o,{success:!0,asyncInit:!1}}catch(s){return console.warn("Initialization of backend "+t+" failed"),console.warn(s.stack||s.message),{success:!1,asyncInit:!1}}},r.prototype.removeBackend=function(t){if(!(t in this.registryFactory))throw new Error(t+" backend not found in registry");this.backendName===t&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,t in this.registry&&(this.disposeRegisteredKernels(t),this.registry[t].dispose(),delete this.registry[t]),delete this.registryFactory[t],this.backendName===t&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},r.prototype.getSortedBackends=function(){var t=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(e,n){return t.registryFactory[n].priority-t.registryFactory[e].priority})},r.prototype.initializeBackendsAndReturnBest=function(){for(var t=this.getSortedBackends(),e=0;e<t.length;e++){var n=t[e],o=this.initializeBackend(n),i=o.asyncInit;if(i||o.success)return{name:n,asyncInit:i}}throw new Error("Could not initialize any backends, all backend initializations failed.")},r.prototype.moveData=function(t,e){var n=this.state.tensorInfo.get(e),o=n.backend,a=this.readSync(e);o.disposeData(e),n.backend=t,t.move(e,a,n.shape,n.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},r.prototype.tidy=function(t,e){var n,o=this,a=null;if(null==e){if("function"!=typeof t)throw new Error("Please provide a function to tidy()");e=t}else{if("string"!=typeof t&&!(t instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof e)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");a=t}return this.scopedRun(function(){return o.startScope(a)},function(){return o.endScope(n)},function(){return(n=e())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),n})},r.prototype.scopedRun=function(t,e,n){t();try{var o=n();return e(),o}catch(a){throw e(),a}},r.prototype.nextTensorId=function(){return r.nextTensorId++},r.prototype.nextVariableId=function(){return r.nextVariableId++},r.prototype.clone=function(t){var e=this.makeTensorFromDataId(t.dataId,t.shape,t.dtype);return this.addTapeNode(this.state.activeScope.name,{x:t},[e],function(o){return{x:function(){return o.toFloat()}}},[]),e},r.prototype.runKernel=function(t,e,n,o,a){return this.runKernelFunc(null,e,null,t,n,o,a)},r.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},r.prototype.checkKernelForMemLeak=function(t,e,n){var o=this.backend.numDataIds(),a=0;n.forEach(function(u){a+="complex64"===u.dtype?3:1});var s=o-e-a-this.state.numDataMovesStack[this.state.numDataMovesStack.length-1];if(s>0)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+s+" data ids) after running '"+t+"'")},r.prototype.runKernelFunc=function(t,e,n,o,a,i,s){var u,c=this;void 0===i&&(i=[]),void 0===s&&(s=[]);var l=[],h=this.isTapeOn();null==o&&(o=null!=this.state.activeScope?this.state.activeScope.name:"");var f,d=function(x){h&&(l=x.map(function(b){return c.keep(c.clone(b))}))},p=this.state.numBytes,m=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var v,g=ss(o,this.backendName);return f=null!=g?function(){var x=c.backend.numDataIds();v=g.kernelFunc({inputs:e,attrs:a,backend:c.backend});var b=Array.isArray(v)?v:[v];c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(o,x,b);var y=b.map(function(C){return c.makeTensorFromDataId(C.dataId,C.shape,C.dtype)}),w=y.filter(function(C,S){return s[S]});return d((i||[]).slice().concat(w)),y}:function(){var x=c.backend.numDataIds();v=c.tidy(function(){return t(c.backend,d)});var b=Array.isArray(v)?v:[v];return c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(o,x,b),b},this.scopedRun(function(){return c.state.kernelDepth++},function(){return c.state.kernelDepth--},function(){u=c.ENV.getBool("DEBUG")?c.profiler.profileKernel(o,e,function(){return f()}):f()}),h&&this.addTapeNode(o,e,u,n,l),this.state.profiling&&this.state.activeProfile.kernels.push({name:o,bytesAdded:this.state.numBytes-p,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-m,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(e).map(function(x){return e[x].shape}),outputShapes:u.map(function(x){return x.shape})}),Array.isArray(v)?u:u[0]},r.prototype.makeTensor=function(t,e,n,o){if(null==t)throw new Error("Values passed to engine.makeTensor() are null");o=o||this.backend;var a=t;"string"===(n=n||"float32")&&tn(t[0])&&(a=t.map(function(l){return bs(l)}));var i=o.write(a,e,n),s=new _e(e,n,i,this.nextTensorId());if(this.incRef(s,o),"string"===n){var u=this.state.tensorInfo.get(i),c=gs(a);this.state.numBytes+=c-u.bytes,u.bytes=c}return s},r.prototype.makeTensorFromDataId=function(t,e,n,o){var a=new _e(e,n=n||"float32",t,this.nextTensorId());return this.incRef(a,o),a},r.prototype.makeVariable=function(t,e,n,o){void 0===e&&(e=!0),n=n||this.nextVariableId().toString(),null!=o&&o!==t.dtype&&(t=t.asType(o));var a=new Bn(t,e,n,this.nextTensorId());if(null!=this.state.registeredVariables[a.name])throw new Error("Variable with name "+a.name+" was already registered");return this.state.registeredVariables[a.name]=a,this.incRef(a,this.backend),a},r.prototype.incRef=function(t,e){var n=this.state.tensorInfo.has(t.dataId)?this.state.tensorInfo.get(t.dataId).refCount:0;if(this.state.numTensors++,"string"===t.dtype&&this.state.numStringTensors++,0===n){this.state.numDataBuffers++;var o=0;"complex64"!==t.dtype&&"string"!==t.dtype&&(o=t.size*jo(t.dtype)),this.state.tensorInfo.set(t.dataId,{backend:e||this.backend,dtype:t.dtype,shape:t.shape,bytes:o,refCount:0}),this.state.numBytes+=o}this.state.tensorInfo.get(t.dataId).refCount++,t instanceof Bn||this.track(t)},r.prototype.disposeTensor=function(t){if(this.state.tensorInfo.has(t.dataId)){this.state.numTensors--,"string"===t.dtype&&this.state.numStringTensors--;var e=this.state.tensorInfo.get(t.dataId);e.refCount<=1?("complex64"!==t.dtype&&(this.state.numBytes-=e.bytes),this.state.numDataBuffers--,e.backend.disposeData(t.dataId),this.state.tensorInfo.delete(t.dataId)):this.state.tensorInfo.get(t.dataId).refCount--}},r.prototype.disposeVariables=function(){for(var t in this.state.registeredVariables)this.disposeVariable(this.state.registeredVariables[t])},r.prototype.disposeVariable=function(t){this.disposeTensor(t),null!=this.state.registeredVariables[t.name]&&delete this.state.registeredVariables[t.name]},r.prototype.memory=function(){var t=this.backend.memory();return t.numTensors=this.state.numTensors,t.numDataBuffers=this.state.numDataBuffers,t.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(t.unreliable=!0,null==t.reasons&&(t.reasons=[]),t.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),t},r.prototype.profile=function(t){return Y(this,void 0,void 0,function(){var e,n;return $(this,function(o){return this.state.profiling=!0,e=this.state.numBytes,n=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=t(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(a){return a.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-e,this.state.activeProfile.newTensors=this.state.numTensors-n,[2,this.state.activeProfile]})})},r.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&0===this.state.kernelDepth},r.prototype.addTapeNode=function(t,e,n,o,a){var i=this,s={id:this.state.nextTapeNodeId++,kernelName:t,inputs:e,outputs:n,saved:a},u=function bh(r){return ir.get(r)}(t);null!=u&&(o=u.gradFunc),null!=o&&(s.gradient=function(c){return c=c.map(function(l,h){if(null==l){var f=n[h],d=On(f.size,f.dtype);return i.makeTensor(d,f.shape,f.dtype)}return l}),o(c.length>1?c:c[0],a)}),this.state.activeTape.push(s)},r.prototype.keep=function(t){return t.kept=!0,t},r.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},r.prototype.endTape=function(){this.state.gradientDepth--},r.prototype.startScope=function(t){var e={track:[],name:"unnamed scope",id:this.state.nextScopeId++};t&&(e.name=t),this.state.scopeStack.push(e),this.state.activeScope=e},r.prototype.endScope=function(t){for(var e=this,n=ra(t),o=new Set(n.map(function(u){return u.id})),a=0;a<this.state.activeScope.track.length;a++){var i=this.state.activeScope.track[a];i.kept||o.has(i.id)||i.dispose()}var s=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],n.forEach(function(u){u.kept||u.scopeId!==s.id||e.track(u)})},r.prototype.gradients=function(t,e,n,o){var a=this;if(void 0===o&&(o=!1),E(e.length>0,function(){return"gradients() received an empty list of xs."}),null!=n&&"float32"!==n.dtype)throw new Error("dy must have 'float32' dtype, but has '"+n.dtype+"'");var i=this.scopedRun(function(){return a.startTape()},function(){return a.endTape()},function(){return a.tidy("forward",t)});E(i instanceof _e,function(){return"The result y returned by f() must be a tensor."});var s=function(u,c,l){for(var h={},f={},d=0;d<c.length;d++)h[c[d].id]=!0;for(d=0;d<u.length;d++){var p=(C=u[d]).inputs;for(var m in p){for(var v=p[m],g=!1,x=0;x<c.length;x++)if(h[v.id]){C.outputs.forEach(function(R){return h[R.id]=!0}),g=!0,f[C.id]=!0;break}if(g)break}}var b={};b[l.id]=!0;var y={};for(d=u.length-1;d>=0;d--)for(p=(C=u[d]).inputs,x=0;x<C.outputs.length;x++)if(b[C.outputs[x].id]){for(var m in p)b[p[m].id]=!0,y[C.id]=!0;break}var w=[];for(d=0;d<u.length;d++){var C;if(f[(C=u[d]).id]&&y[C.id]){var S={};for(var m in C.inputs){var k=C.inputs[m];h[k.id]&&(S[m]=k)}var I=Object.assign({},C);I.inputs=S,I.outputs=C.outputs,w.push(I)}}return w}(this.state.activeTape,e,i);if(!o&&0===s.length&&e.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var u,c,l={};l[i.id]=n??(c=Xo(Q(u=i.shape),"float32"),D.makeTensor(c,u,"float32")),function(f,d){for(var m=function(g){var x=d[g],b=[];if(x.outputs.forEach(function(S){var k=f[S.id];b.push(null!=k?k:null)}),null==x.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+x.kernelName+".");var y=x.gradient(b),w=function(S){if(!(S in y))throw new Error("Cannot backprop through input "+S+". Available gradients found: "+Object.keys(y)+".");var k=a.tidy(function(){return y[S]()});if("float32"!==k.dtype)throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input "+S+" must have 'float32' dtype, but has '"+k.dtype+"'");var I=x.inputs[S];if(!Ne(k.shape,I.shape))throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input '"+S+"' has shape '"+k.shape+"', which does not match the shape of the input '"+I.shape+"'");if(null==f[I.id])f[I.id]=k;else{var R=f[I.id];f[I.id]=R.add(k),R.dispose()}};for(var C in x.inputs)w(C)},v=d.length-1;v>=0;v--)m(v)}(l,s);var h=e.map(function(f){return l[f.id]});return 0===a.state.gradientDepth&&(a.state.activeTape.forEach(function(f){for(var d=0,p=f.saved;d<p.length;d++)p[d].dispose()}),a.state.activeTape=null),{value:i,grads:h}})},r.prototype.customGrad=function(t){var e=this;return E(nn(t),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var n,o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];E(o.every(function(s){return s instanceof _e}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var i={};return o.forEach(function(s,u){i[u]=s}),e.runKernelFunc(function(s,u){return E((n=t.apply(void 0,o.concat([u]))).value instanceof _e,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),E(nn(n.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),n.value},i,function(s,u){var c=n.gradFunc(s,u),l=Array.isArray(c)?c:[c];E(l.length===o.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),E(l.every(function(f){return f instanceof _e}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var h={};return l.forEach(function(f,d){h[d]=function(){return f}}),h})}},r.prototype.readSync=function(t){return this.state.tensorInfo.get(t).backend.readSync(t)},r.prototype.read=function(t){return this.state.tensorInfo.get(t).backend.read(t)},r.prototype.time=function(t){return Y(this,void 0,void 0,function(){var e,n;return $(this,function(o){switch(o.label){case 0:return e=yt(),[4,this.backend.time(t)];case 1:return(n=o.sent()).wallMs=yt()-e,[2,n]}})})},r.prototype.track=function(t){return null!=this.state.activeScope&&(t.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(t)),t},Object.defineProperty(r.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),r.prototype.reset=function(){for(var t in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new ks,this.registry)this.disposeRegisteredKernels(t),this.registry[t].dispose(),delete this.registry[t];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},r.nextTensorId=0,r.nextVariableId=0,r}(),D=function(){var r=function(){if(null==oa){var e=void 0;if(typeof window<"u")e=window;else if(typeof global<"u")e=global;else if(typeof process<"u")e=process;else{if(typeof self>"u")throw new Error("Could not find a global object");e=self}oa=e}return oa}();if(null==r._tfengine){var t=new yh(r);r._tfengine=new Rh(t)}return is=r._tfengine.ENV,It=function(){return r._tfengine},r._tfengine}();function Ss(){return typeof window<"u"&&null!=window.document||typeof WorkerGlobalScope<"u"}var zt=M();zt.registerFlag("DEBUG",function(){return!1},function(r){r&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),zt.registerFlag("IS_BROWSER",function(){return Ss()}),zt.registerFlag("IS_NODE",function(){return typeof process<"u"&&void 0!==process.versions&&void 0!==process.versions.node}),zt.registerFlag("IS_CHROME",function(){return typeof navigator<"u"&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),zt.registerFlag("PROD",function(){return!1}),zt.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return zt.getBool("DEBUG")}),zt.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),zt.registerFlag("IS_TEST",function(){return!1});var dr,at,it,yn={},aa={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function Ds(r,t){yn[r]=t}function Rt(r){r in yn||(yn[r]=function(e){if(1!==e&&2!==e)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var n=function(o){if(typeof OffscreenCanvas<"u"&&2===o)return new OffscreenCanvas(300,150);if(typeof document<"u")return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}(e);return n.addEventListener("webglcontextlost",function(o){o.preventDefault(),delete yn[e]},!1),1===e?n.getContext("webgl",aa)||n.getContext("experimental-webgl",aa):n.getContext("webgl2",aa)}(r));var t=yn[r];return t.isContextLost()?(delete yn[r],Rt(r)):(t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.disable(t.BLEND),t.disable(t.DITHER),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SAMPLE_COVERAGE),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),yn[r])}function Gr(r,t){return[t,r]}function pr(r){var t=Q(r);return Vr(Math.ceil(t/4))}function vr(r,t){return[Math.max(1,Math.ceil(t/2)),Math.max(1,Math.ceil(r/2))]}function ia(r,t){var e,n,o,a,i,s,u,c,l,h=r;return 2===M().getNumber("WEBGL_VERSION")?(e=h.R32F,n=h.R16F,o=h.RGBA16F,a=h.RGBA32F,i=h.RED,s=4,u=1,c=h.HALF_FLOAT,l=h.FLOAT):(e=r.RGBA,n=r.RGBA,o=r.RGBA,a=h.RGBA,i=r.RGBA,s=4,u=4,c=null!=t?t.HALF_FLOAT_OES:null,l=r.FLOAT),{internalFormatFloat:e,internalFormatHalfFloat:n,internalFormatPackedHalfFloat:o,internalFormatPackedFloat:a,textureFormatFloat:i,downloadTextureFormat:r.RGBA,downloadUnpackNumChannels:s,defaultNumChannels:u,textureTypeHalfFloat:c,textureTypeFloat:l}}function X(r,t,e){var n=e();return t&&function(o){var a=o.getError();if(a!==o.NO_ERROR)throw new Error("WebGL Error: "+Ts(o,a))}(r),n}function As(r){return!!(M().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===r||5.96e-8<Math.abs(r)&&Math.abs(r)<65504)}function Ts(r,t){switch(t){case r.NO_ERROR:return"NO_ERROR";case r.INVALID_ENUM:return"INVALID_ENUM";case r.INVALID_VALUE:return"INVALID_VALUE";case r.INVALID_OPERATION:return"INVALID_OPERATION";case r.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case r.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case r.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+t}}function mr(r,t,e){return Vt(r,t,function(){return r.getExtension(e)},'Extension "'+e+'" not supported on this browser.')}function Fs(r,t,e){var n=Vt(r,t,function(){return r.createShader(r.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(X(r,t,function(){return r.shaderSource(n,e)}),X(r,t,function(){return r.compileShader(n)}),!1===r.getShaderParameter(n,r.COMPILE_STATUS))throw console.log(r.getShaderInfoLog(n)),new Error("Failed to compile vertex shader.");return n}function Ns(r,t,e){var n=Vt(r,t,function(){return r.createShader(r.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(X(r,t,function(){return r.shaderSource(n,e)}),X(r,t,function(){return r.compileShader(n)}),!1===r.getShaderParameter(n,r.COMPILE_STATUS))throw function(o,a){var i=Dh.exec(a);if(null==i)return console.log("Couldn't parse line number in error: "+a),void console.log(o);for(var s=+i[1],u=o.split("\n"),c=u.length.toString().length+2,l=u.map(function(v,g){return gn((g+1).toString(),c)+v}),h=0,f=0;f<l.length;f++)h=Math.max(l[f].length,h);var d=l.slice(0,s-1),p=l.slice(s-1,s),m=l.slice(s);console.log(d.join("\n")),console.log(a.split("\n")[0]),console.log("%c "+gn(p[0],h),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(m.join("\n"))}(e,r.getShaderInfoLog(n)),new Error("Failed to compile fragment shader.");return n}(function(r){r[r.DENSE=0]="DENSE",r[r.SHARED_BATCH=1]="SHARED_BATCH"})(dr||(dr={})),function(r){r[r.RENDER=0]="RENDER",r[r.UPLOAD=1]="UPLOAD",r[r.PIXELS=2]="PIXELS",r[r.DOWNLOAD=3]="DOWNLOAD"}(at||(at={})),function(r){r[r.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",r[r.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",r[r.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",r[r.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",r[r.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(it||(it={}));var Hr,jr,Dh=/ERROR: [0-9]+:([0-9]+):/g;function Ps(r,t){return Vt(r,t,function(){return r.createProgram()},"Unable to create WebGLProgram.")}function Ms(r,t,e){if(X(r,t,function(){return r.linkProgram(e)}),!1===r.getProgramParameter(e,r.LINK_STATUS))throw console.log(r.getProgramInfoLog(e)),new Error("Failed to link vertex and fragment shaders.")}function qr(r,t,e){if(X(r,t,function(){return r.validateProgram(e)}),!1===r.getProgramParameter(e,r.VALIDATE_STATUS))throw console.log(r.getProgramInfoLog(e)),new Error("Shader program validation failed.")}function Os(r,t,e){var n=Vt(r,t,function(){return r.createBuffer()},"Unable to create WebGLBuffer");return X(r,t,function(){return r.bindBuffer(r.ARRAY_BUFFER,n)}),X(r,t,function(){return r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW)}),n}function Bs(r,t,e){var n=Vt(r,t,function(){return r.createBuffer()},"Unable to create WebGLBuffer");return X(r,t,function(){return r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n)}),X(r,t,function(){return r.bufferData(r.ELEMENT_ARRAY_BUFFER,e,r.STATIC_DRAW)}),n}function Ls(r,t){return Vt(r,t,function(){return r.createTexture()},"Unable to create WebGLTexture.")}function Ws(r,t){var e=M().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(r<=0||t<=0){var n="["+r+"x"+t+"]";throw new Error("Requested texture size "+n+" is invalid.")}if(r>e||t>e)throw n="["+r+"x"+t+"]",new Error("Requested texture size "+n+" greater than WebGL maximum on this browser / GPU ["+e+"x"+e+"].")}function zs(r,t){return Vt(r,t,function(){return r.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function sa(r,t,e,n,o,a,i,s){var u=r.getAttribLocation(e,n);return-1!==u&&(X(r,t,function(){return r.bindBuffer(r.ARRAY_BUFFER,o)}),X(r,t,function(){return r.vertexAttribPointer(u,a,r.FLOAT,!1,i,s)}),X(r,t,function(){return r.enableVertexAttribArray(u)}),!0)}function Vs(r,t,e,n){qs(r,n),X(r,t,function(){return r.activeTexture(r.TEXTURE0+n)}),X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,e)})}function Us(r,t,e,n){return Vt(r,t,function(){return r.getUniformLocation(e,n)},'uniform "'+n+'" not present in program.')}function Gs(r,t,e){return r.getUniformLocation(t,e)}function Hs(r,t,e,n,o,a){X(r,t,function(){return Vs(r,t,n,a)}),X(r,t,function(){return r.uniform1i(o,a)})}function Kr(r,t,e,n){X(r,t,function(){return r.bindFramebuffer(r.FRAMEBUFFER,n)}),X(r,t,function(){return r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0)})}function ua(r,t,e){X(r,t,function(){return r.bindFramebuffer(r.FRAMEBUFFER,e)}),X(r,t,function(){return r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,null,0)})}function gr(r){var t=r.checkFramebufferStatus(r.FRAMEBUFFER);if(t!==r.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+js(r,t))}function js(r,t){switch(t){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case r.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+t}}function Vt(r,t,e,n){var o=X(r,t,function(){return e()});if(null==o)throw new Error(n);return o}function qs(r,t){var e=r.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,n=t+r.TEXTURE0;if(n<r.TEXTURE0||n>e)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+e+"].")}function yr(r,t){return void 0===t&&(t=2),Q(r.slice(0,r.length-t))}function xr(r){if(0===r.length)throw Error("Cannot get rows and columns of an empty shape array.");return[r.length>1?r[r.length-2]:1,r[r.length-1]]}function Xr(r){var t=[1,1,1];return 0===r.length||1===r.length&&1===r[0]||(t=[yr(r)].concat(xr(r))),t}function Ks(r,t){var e;void 0===t&&(t=!1);var n=M().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(t&&(n*=2,1===(r=r.map(function(c,l){return l>=r.length-2?Go(r[l]):r[l]})).length&&(r=[2,r[0]])),2!==r.length){var o=en(r);r=o.newShape}var a=Q(r);if(r.length<=1&&a<=n)return[1,a];if(2===r.length&&r[0]<=n&&r[1]<=n)return r;if(3===r.length&&r[0]*r[1]<=n&&r[2]<=n)return[r[0]*r[1],r[2]];if(3===r.length&&r[0]<=n&&r[1]*r[2]<=n)return[r[0],r[1]*r[2]];if(4===r.length&&r[0]*r[1]*r[2]<=n&&r[3]<=n)return[r[0]*r[1]*r[2],r[3]];if(4===r.length&&r[0]<=n&&r[1]*r[2]*r[3]<=n)return[r[0],r[1]*r[2]*r[3]];if(t){var i=yr(r),s=2,u=2;return r.length&&(s=(e=xr(r))[0],u=e[1]),Vr(a=i*(s/2)*(u/2)).map(function(c){return 2*c})}return Vr(a)}function Yr(r){return r%2==0}function br(r,t){if(Ne(r=r.slice(-2),t=t.slice(-2))||!r.length||!t.length||0===r[0]||0===r[1]||0===t[0]||0===t[1])return!0;if(r.length!==t.length){var e=r.slice(-1)[0],n=t.slice(-1)[0];if(e===n||Yr(e)&&Yr(n)&&(1===r[0]||1===t[0]))return!0}return r[1]===t[1]&&Yr(r[0])&&Yr(t[0])}function Xs(r){if(null==Hr){var t=Rt(r);Hr=t.getParameter(t.MAX_TEXTURE_SIZE)}return Hr}function Ys(r){if(null==jr){var t=Rt(r);jr=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,jr)}function $s(r){if(0===r)return 0;var t=Rt(r);return st(t,"EXT_disjoint_timer_query_webgl2")&&2===r?2:st(t,"EXT_disjoint_timer_query")?1:0}function st(r,t){return null!=r.getExtension(t)}function ca(r){try{if(null!=Rt(r))return!0}catch{return!1}return!1}function Qs(r){if(0===r)return!1;var t=Rt(r);if(1===r){if(!st(t,"OES_texture_float"))return!1}else if(!st(t,"EXT_color_buffer_float"))return!1;return la(t)}function Js(r){if(0===r)return!1;var t=Rt(r);if(1!==r){if(st(t,"EXT_color_buffer_float"))return la(t);if(st(t,"EXT_color_buffer_half_float")){var e=t.getExtension("EXT_color_buffer_half_float");return function(n,o){var a=ia(n,o),i=n.createTexture();n.bindTexture(n.TEXTURE_2D,i),n.texImage2D(n.TEXTURE_2D,0,a.internalFormatHalfFloat,1,1,0,a.textureFormatFloat,a.textureTypeHalfFloat,null);var s=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,s),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,i,0);var u=n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE;return n.bindTexture(n.TEXTURE_2D,null),n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteTexture(i),n.deleteFramebuffer(s),u}(t,e)}return!1}return!!st(t,"OES_texture_float")&&!!st(t,"WEBGL_color_buffer_float")&&la(t)}function la(r){var t=ia(r),e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e),r.texImage2D(r.TEXTURE_2D,0,t.internalFormatFloat,1,1,0,t.textureFormatFloat,t.textureTypeFloat,null);var n=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0);var o=r.checkFramebufferStatus(r.FRAMEBUFFER)===r.FRAMEBUFFER_COMPLETE;return r.bindTexture(r.TEXTURE_2D,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteTexture(e),r.deleteFramebuffer(n),o}function Zs(r){return 2===r&&null!=Rt(r).fenceSync}var Ah=Object.freeze({callAndCheck:X,canBeRepresented:As,getWebGLErrorMessage:Ts,getExtensionOrThrow:mr,createVertexShader:Fs,createFragmentShader:Ns,createProgram:Ps,linkProgram:Ms,validateProgram:qr,createStaticVertexBuffer:Os,createStaticIndexBuffer:Bs,getNumChannels:function(){return 2===M().getNumber("WEBGL_VERSION")?1:4},createTexture:Ls,validateTextureSize:Ws,createFramebuffer:zs,bindVertexBufferToProgramAttribute:sa,bindTextureUnit:Vs,unbindTextureUnit:function(r,t,e){qs(r,e),X(r,t,function(){return r.activeTexture(r.TEXTURE0+e)}),X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:Us,getProgramUniformLocation:Gs,bindTextureToProgramUniformSampler:Hs,bindCanvasToFramebuffer:function(r,t){X(r,t,function(){return r.bindFramebuffer(r.FRAMEBUFFER,null)}),X(r,t,function(){return r.viewport(0,0,r.canvas.width,r.canvas.height)}),X(r,t,function(){return r.scissor(0,0,r.canvas.width,r.canvas.height)})},bindColorTextureToFramebuffer:Kr,unbindColorTextureFromFramebuffer:ua,validateFramebuffer:gr,getFramebufferErrorMessage:js,getBatchDim:yr,getRowsCols:xr,getShapeAs3D:Xr,getTextureShapeFromLogicalShape:Ks,isReshapeFree:br,getWebGLMaxTextureSize:Xs,resetMaxTextureSize:function(){Hr=null},resetMaxTexturesInShader:function(){jr=null},getMaxTexturesInShader:Ys,getWebGLDisjointQueryTimerVersion:$s,hasExtension:st,isWebGLVersionEnabled:ca,isCapableOfRenderingToFloatTexture:Qs,isDownloadFloatTextureEnabled:Js,isWebGLFenceEnabled:Zs}),re=M();function eu(r){M().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(r+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function K(r,t){return D.tidy(r,t)}function tt(r){ra(r).forEach(function(t){return t.dispose()})}function $r(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];M().getBool("IS_TEST")||console.warn.apply(console,r)}function kt(r,t){var e=r;if(He(r))return"string"===t?[]:[r.length];if(!Array.isArray(r))return[];for(var n=[];Array.isArray(e)||He(e)&&"string"!==t;)n.push(e.length),e=e[0];return Array.isArray(r)&&M().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function o(a,i,s){if(s=s||[],Array.isArray(a)||He(a)){E(i.length>0,function(){return"Element arr["+s.join("][")+"] should be a primitive, but is an array of "+a.length+" elements"}),E(a.length===i[0],function(){return"Element arr["+s.join("][")+"] should have "+i[0]+" elements, but has "+a.length+" elements"});for(var u=i.slice(1),c=0;c<a.length;++c)o(a[c],u,s.concat(c))}else E(0===i.length,function(){return"Element arr["+s.join("][")+"] is a primitive, but should be an array/TypedArray of "+i[0]+" elements"})}(r,n,[]),n}function tu(r,t,e,n){if(null!=r&&("numeric"!==r&&r!==t||"numeric"===r&&"string"===t))throw new Error("Argument '"+e+"' passed to '"+n+"' must be "+r+" tensor, but got "+t+" tensor")}function _(r,t,e,n){if(void 0===n&&(n="numeric"),r instanceof _e)return tu(n,r.dtype,t,e),r;var o=Mn(r);if("string"!==o&&["bool","int32","float32"].indexOf(n)>=0&&(o=n),tu(n,o,t,e),null==r||!He(r)&&!Array.isArray(r)&&"number"!=typeof r&&"boolean"!=typeof r&&"string"!=typeof r)throw new Error("Argument '"+t+"' passed to '"+e+"' must be a Tensor or TensorLike, but got '"+(null==r?"null":r.constructor.name)+"'");var i=kt(r,o);He(r)||Array.isArray(r)||(r=[r]);var s="string"!==o?qo(r,o,M().getBool("DEBUG")):Wt(r,[],!0);return D.makeTensor(s,i,o)}function wr(r,t,e,n){if(void 0===n&&(n="numeric"),!Array.isArray(r))throw new Error("Argument "+t+" passed to "+e+" must be a `Tensor[]` or `TensorLike[]`");return r.map(function(o,a){return _(o,t+"["+a+"]",e)},n)}function ha(r,t){for(var e=0;e<r.length;++e)if(r[r.length-e-1]!==t-1-e)return!1;return!0}function nu(r,t,e){for(var n=r.length+t.length,o=[],a=0,i=0,s=0;s<n;s++)-1===e.indexOf(s)?o.push(r[a++]):o.push(t[i++]);return o}function je(r,t){for(var e=[],n=r.length,o=0;o<n;o++)-1===t.indexOf(o)&&e.push(r[o]);return[e,t.map(function(a){return r[a]})]}function Ze(r,t){return nu(r,t.map(function(e){return 1}),t)}function nt(r,t,e){E(ha(t,e),function(){return r+" supports only inner-most axes for now. Got axes "+t+" and rank-"+e+" input."})}function xt(r,t){if(ha(r,t))return null;for(var e=[],n=0;n<t;++n)-1===r.indexOf(n)&&e.push(n);return r.forEach(function(o){return e.push(o)}),e}function Qr(r){return r.map(function(t,e){return[e,t]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}function bt(r,t){for(var e=[],n=t-r;n<t;++n)e.push(n);return e}function ru(r,t){var e=r[0].length;r.forEach(function(o,a){E(o.length===e,function(){return"Error in concat"+e+"D: rank of tensors["+a+"] must be the same as the rank of the rest ("+e+")"})}),E(t>=0&&t<e,function(){return"Error in concat"+e+"D: axis must be between 0 and "+(e-1)+"."});var n=r[0];r.forEach(function(o,a){for(var i=0;i<e;i++)E(i===t||o[i]===n[i],function(){return"Error in concat"+e+"D: Shape of tensors["+a+"] ("+o+") does not match the shape of the rest ("+n+") along the non-concatenated axis "+a+"."})})}function xn(r,t){for(var e=r[0].slice(),n=1;n<r.length;n++)e[t]+=r[n][t];return e}function A(r){var t=Object.keys(r);if(1!==t.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+t.length+" keys.");var e=t[0],n=r[e];e.endsWith("_")&&(e=e.substring(0,e.length-1));var o=function(){for(var a=[],i=0;i<arguments.length;i++)a[i]=arguments[i];D.startScope(e);try{var s=n.apply(void 0,a);return s instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),D.endScope(s),s}catch(u){throw D.endScope(null),u}};return Object.defineProperty(o,"name",{value:e,configurable:!0}),o}re.registerFlag("HAS_WEBGL",function(){return re.getNumber("WEBGL_VERSION")>0}),re.registerFlag("WEBGL_VERSION",function(){return ca(2)?2:ca(1)?1:0}),re.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===re.get("WEBGL_VERSION")}),re.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),re.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),re.registerFlag("WEBGL_PACK",function(){return re.getBool("HAS_WEBGL")}),re.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_CLIP",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),re.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_PACK_REDUCE",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_LAZILY_UNPACK",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_CONV_IM2COL",function(){return re.getBool("WEBGL_PACK")}),re.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return Xs(re.getNumber("WEBGL_VERSION"))}),re.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return Ys(re.getNumber("WEBGL_VERSION"))}),re.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var r=re.getNumber("WEBGL_VERSION");return 0===r?0:$s(r)}),re.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return re.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&(r=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(r)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(r.substr(0,4))));var r}),re.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return Qs(re.getNumber("WEBGL_VERSION"))}),re.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!re.getBool("WEBGL_FORCE_F16_TEXTURES")&&re.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),re.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return Js(re.getNumber("WEBGL_VERSION"))}),re.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return Zs(re.getNumber("WEBGL_VERSION"))}),re.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return re.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),Es=eu;var qe=A({complex_:function(r,t){var e=_(r,"real","complex"),n=_(t,"imag","complex");return pe(e.shape,n.shape,"real and imag shapes, "+e.shape+" and "+n.shape+", must match in call to tf.complex()."),D.runKernelFunc(function(o){return o.complex(e,n)},{$real:e,$imag:n})}}),ft=A({real_:function(r){var t=_(r,"input","real");return D.runKernelFunc(function(e){return e.real(t)},{$input:t})}}),St=A({imag_:function(r){var t=_(r,"input","imag");return D.runKernelFunc(function(e){return e.imag(t)},{$input:t})}});function Ke(r,t,e){return rn(r,t,kt(r,e),e)}function rn(r,t,e,n){if(null==n&&(n=Mn(r)),"complex64"===n)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!He(r)&&!Array.isArray(r)&&"number"!=typeof r&&"boolean"!=typeof r&&"string"!=typeof r)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=t){Yo(t);var o=Q(t),a=Q(e);E(o===a,function(){return"Based on the provided shape, ["+t+"], the tensor should have "+o+" values but has "+a});for(var i=0;i<e.length;++i){var u=i!==e.length-1||e[i]!==Q(t.slice(i));E(e[i]===t[i]||!u,function(){return"Error creating a new Tensor. Inferred shape ("+e+") does not match the provided shape ("+t+"). "})}}return He(r)||Array.isArray(r)||(r=[r]),t=t||e,r="string"!==n?qo(r,n,M().getBool("DEBUG")):Wt(r,[],!0),D.makeTensor(r,t,n)}function j(r,t){if((He(r)&&"string"!==t||Array.isArray(r))&&"complex64"!==t)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===t&&He(r)&&!(r instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return rn(r,[],[],t)}function Me(r,t){mn(r);var e=kt(r,t);if(1!==e.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return rn(r,null,e,t)}function on(r,t,e){if(mn(r),null!=t&&2!==t.length)throw new Error("tensor2d() requires shape to have two numbers");var n=kt(r,e);if(2!==n.length&&1!==n.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===n.length&&null==t)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return rn(r,t,n,e)}function fa(r,t,e){if(mn(r),null!=t&&3!==t.length)throw new Error("tensor3d() requires shape to have three numbers");var n=kt(r,e);if(3!==n.length&&1!==n.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===n.length&&null==t)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return rn(r,t,n,e)}function rt(r,t,e){if(mn(r),null!=t&&4!==t.length)throw new Error("tensor4d() requires shape to have four numbers");var n=kt(r,e);if(4!==n.length&&1!==n.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===n.length&&null==t)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return rn(r,t,n,e)}function Ln(r,t){if(void 0===t&&(t="float32"),"complex64"===t){var e=Ln(r,"float32"),n=Ee(r,"float32");return qe(e,n)}var o=Xo(Q(r),t);return D.makeTensor(o,r,t)}function Ee(r,t){if(void 0===t&&(t="float32"),"complex64"===t){var e=Ee(r,"float32"),n=Ee(r,"float32");return qe(e,n)}var o=On(Q(r),t);return D.makeTensor(o,r,t)}function Dt(r,t,e){return D.runKernelFunc(function(n){return n.fill(r,t,e)},{})}function Jr(r,t,e,n){if(void 0===e&&(e=1),void 0===n&&(n="float32"),0===e)throw new Error("Cannot have a step of zero");if(r===t||r<t&&e<0||t<r&&e>1)return Ee([0],n);var o=On(Math.abs(Math.ceil((t-r)/e)),n);t<r&&1===e&&(e=-1),o[0]=r;for(var a=1;a<o.length;a++)o[a]=o[a-1]+e;return Me(o,n)}var ou=A({onesLike_:function(r){var t=_(r,"x","onesLike");if("complex64"===t.dtype){var e=ou(ft(t)),n=ve(St(t));return qe(e,n)}return D.runKernelFunc(function(o){return o.onesLike(t)},{$x:t},function(o,a){return{$x:function(){return ve(o)}}})}}),ve=A({zerosLike_:function(r){var t=_(r,"x","zerosLike");return D.runKernelFunc(function(e){return e.zerosLike(t)},{$x:t},function(e,n){return{$x:function(){return ve(e)}}})}}),Be=A({concat_:function(r,t){void 0===t&&(t=0),E(r.length>=1,function(){return"Pass at least one tensor to concat"});var e=wr(r,"tensors","concat");"complex64"===e[0].dtype&&e.forEach(function(s){if("complex64"!==s.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+s.dtype+". ")}),t=Pe(t,e[0].shape)[0];var n=xn(e.map(function(s){return s.shape}),t);if(0===Q(n))return Ke([],n);if(1===(e=e.filter(function(s){return s.size>0})).length)return e[0];var o=e.map(function(s){return s.shape});return ru(o,t),D.runKernelFunc(function(s){return s.concat(e,t)},e,function(s){var u=o.map(function(c){return c[t]});return da(s,u,t).map(function(c){return function(){return c}})},"Concat",{axis:t})}}),Oh=A({concat1d_:function(r){return Be(r,0)}}),Bh=A({concat2d_:function(r,t){return Be(r,t)}}),Lh=A({concat3d_:function(r,t){return Be(r,t)}}),Wh=A({concat4d_:function(r,t){return Be(r,t)}}),da=A({split_:function(r,t,e){void 0===e&&(e=0);var n,o=_(r,"x","split");return e=Pe(e,o.shape)[0],"number"==typeof t?(E(o.shape[e]%t==0,function(){return"Number of splits must evenly divide the axis."}),n=new Array(t).fill(o.shape[e]/t)):(E(o.shape[e]===t.reduce(function(a,i){return a+i}),function(){return"The sum of sizes must match the size of the axis dimension."}),n=t),D.runKernelFunc(function(a){return a.split(o,n,e)},{$x:o},function(a){return{$x:function(){return Be(a,e)}}})}});function bn(r,t){return r(t={exports:{}},t.exports),t.exports}typeof globalThis<"u"||typeof window<"u"||typeof global<"u"&&global;var zh=bn(function(r){!function(t,e){function o(s){var u,c=this,l=(u=4022871197,function(h){h=h.toString();for(var f=0;f<h.length;f++){var d=.02519603282416938*(u+=h.charCodeAt(f));d-=u=d>>>0,u=(d*=u)>>>0,u+=4294967296*(d-=u)}return 2.3283064365386963e-10*(u>>>0)});c.next=function(){var h=2091639*c.s0+2.3283064365386963e-10*c.c;return c.s0=c.s1,c.s1=c.s2,c.s2=h-(c.c=0|h)},c.c=1,c.s0=l(" "),c.s1=l(" "),c.s2=l(" "),c.s0-=l(s),c.s0<0&&(c.s0+=1),c.s1-=l(s),c.s1<0&&(c.s1+=1),c.s2-=l(s),c.s2<0&&(c.s2+=1),l=null}function a(s,u){return u.c=s.c,u.s0=s.s0,u.s1=s.s1,u.s2=s.s2,u}function i(s,u){var c=new o(s),l=u&&u.state,h=c.next;return h.int32=function(){return 4294967296*c.next()|0},h.double=function(){return h()+11102230246251565e-32*(2097152*h()|0)},h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.alea=i}(0,r)}),Vh=bn(function(r){!function(t,e){function o(s){var u=this,c="";u.x=0,u.y=0,u.z=0,u.w=0,u.next=function(){var h=u.x^u.x<<11;return u.x=u.y,u.y=u.z,u.z=u.w,u.w^=u.w>>>19^h^h>>>8},s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),u.next()}function a(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xor128=i}(0,r)}),Uh=bn(function(r){!function(t,e){function o(s){var u=this,c="";u.next=function(){var h=u.x^u.x>>>2;return u.x=u.y,u.y=u.z,u.z=u.w,u.w=u.v,(u.d=u.d+362437|0)+(u.v=u.v^u.v<<4^h^h<<1)|0},u.x=0,u.y=0,u.z=0,u.w=0,u.v=0,s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),l==c.length&&(u.d=u.x<<10^u.x>>>4),u.next()}function a(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u.v=s.v,u.d=s.d,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xorwow=i}(0,r)}),Gh=bn(function(r){!function(t,e){function o(s){var u=this;u.next=function(){var c,l,h=u.x,f=u.i;return c=h[f],l=(c^=c>>>7)^c<<24,l^=(c=h[f+1&7])^c>>>10,l^=(c=h[f+3&7])^c>>>3,l^=(c=h[f+4&7])^c<<7,c=h[f+7&7],l^=(c^=c<<13)^c<<9,h[f]=l,u.i=f+1&7,l},function(c,l){var h,f=[];if(l===(0|l))f[0]=l;else for(l=""+l,h=0;h<l.length;++h)f[7&h]=f[7&h]<<15^l.charCodeAt(h)+f[h+1&7]<<13;for(;f.length<8;)f.push(0);for(h=0;h<8&&0===f[h];++h);for(8==h&&(f[7]=-1),c.x=f,c.i=0,h=256;h>0;--h)c.next()}(u,s)}function a(s,u){return u.x=s.x.slice(),u.i=s.i,u}function i(s,u){null==s&&(s=+new Date);var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&(l.x&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xorshift7=i}(0,r)}),Hh=bn(function(r){!function(t,e){function o(s){var u=this;u.next=function(){var c,l,h=u.w,f=u.X,d=u.i;return u.w=h=h+1640531527|0,l=f[d+34&127],c=f[d=d+1&127],l^=l<<13,c^=c<<17,l=f[d]=(l^=l>>>15)^(c^=c>>>12),u.i=d,l+(h^h>>>16)|0},function(c,l){var h,f,d,p,m,v=[],g=128;for(l===(0|l)?(f=l,l=null):(l+="\0",f=0,g=Math.max(g,l.length)),d=0,p=-32;p<g;++p)l&&(f^=l.charCodeAt((p+32)%l.length)),0===p&&(m=f),f^=f<<10,f^=f>>>15,f^=f<<4,f^=f>>>13,p>=0&&(d=0==(h=v[127&p]^=f+(m=m+1640531527|0))?d+1:0);for(d>=128&&(v[127&(l&&l.length||0)]=-1),d=127,p=512;p>0;--p)f=v[d+34&127],h=v[d=d+1&127],f^=f<<13,h^=h<<17,v[d]=(f^=f>>>15)^(h^=h>>>12);c.w=m,c.X=v,c.i=d}(u,s)}function a(s,u){return u.i=s.i,u.w=s.w,u.X=s.X.slice(),u}function i(s,u){null==s&&(s=+new Date);var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&(l.X&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.xor4096=i}(0,r)}),jh=bn(function(r){!function(t,e){function o(s){var u=this,c="";u.next=function(){var h=u.b,f=u.c,d=u.d,p=u.a;return h=h<<25^h>>>7^f,f=f-d|0,d=d<<24^d>>>8^p,p=p-h|0,u.b=h=h<<20^h>>>12^f,u.c=f=f-d|0,u.d=d<<16^f>>>16^p,u.a=p-h|0},u.a=0,u.b=0,u.c=-1640531527,u.d=1367130551,s===Math.floor(s)?(u.a=s/4294967296|0,u.b=0|s):c+=s;for(var l=0;l<c.length+20;l++)u.b^=0|c.charCodeAt(l),u.next()}function a(s,u){return u.a=s.a,u.b=s.b,u.c=s.c,u.d=s.d,u}function i(s,u){var c=new o(s),l=u&&u.state,h=function(){return(c.next()>>>0)/4294967296};return h.double=function(){do{var f=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===f);return f},h.int32=c.next,h.quick=h,l&&("object"==typeof l&&a(l,c),h.state=function(){return a(c,{})}),h}e&&e.exports?e.exports=i:this.tychei=i}(0,r)}),wn=bn(function(r){!function(t,e){var n,o=this,a=256,s="random",u=e.pow(a,6),c=e.pow(2,52),l=2*c,h=255;function f(g,x,b){var y=[],w=m(function k(I,R){var F,T=[],L=typeof I;if(R&&"object"==L)for(F in I)try{T.push(k(I[F],R-1))}catch{}return T.length?T:"string"==L?I:I+"\0"}((x=1==x?{entropy:!0}:x||{}).entropy?[g,v(t)]:g??function(){try{var k;return n&&(k=n.randomBytes)?k=k(a):(k=new Uint8Array(a),(o.crypto||o.msCrypto).getRandomValues(k)),v(k)}catch{var I=o.navigator,R=I&&I.plugins;return[+new Date,o,R,o.screen,v(t)]}}(),3),y),C=new d(y),S=function(){for(var k=C.g(6),I=u,R=0;k<c;)k=(k+R)*a,I*=a,R=C.g(1);for(;k>=l;)k/=2,I/=2,R>>>=1;return(k+R)/I};return S.int32=function(){return 0|C.g(4)},S.quick=function(){return C.g(4)/4294967296},S.double=S,m(v(C.S),t),(x.pass||b||function(k,I,R,F){return F&&(F.S&&p(F,C),k.state=function(){return p(C,{})}),R?(e[s]=k,I):k})(S,w,"global"in x?x.global:this==e,x.state)}function d(g){var x,b=g.length,y=this,w=0,C=y.i=y.j=0,S=y.S=[];for(b||(g=[b++]);w<a;)S[w]=w++;for(w=0;w<a;w++)S[w]=S[C=h&C+g[w%b]+(x=S[w])],S[C]=x;(y.g=function(k){for(var I,R=0,F=y.i,T=y.j,L=y.S;k--;)I=L[F=h&F+1],R=R*a+L[h&(L[F]=L[T=h&T+I])+(L[T]=I)];return y.i=F,y.j=T,R})(a)}function p(g,x){return x.i=g.i,x.j=g.j,x.S=g.S.slice(),x}function m(g,x){for(var b,y=g+"",w=0;w<y.length;)x[h&w]=h&(b^=19*x[h&w])+y.charCodeAt(w++);return v(x)}function v(g){return String.fromCharCode.apply(0,g)}if(e["seed"+s]=f,m(e.random(),t),r.exports){r.exports=f;try{n=vt(8082)}catch{}}}([],Math)});wn.alea=zh,wn.xor128=Vh,wn.xorwow=Uh,wn.xorshift7=Gh,wn.xor4096=Hh,wn.tychei=jh;var Zr=wn.alea,pa=function(){function r(t,e,n,o,a){this.mean=t,this.stdDev=e,this.dtype=n,this.nextVal=NaN,this.truncated=o,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var i=a||Math.random();this.random=Zr(i.toString())}return r.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var t=this.nextVal;return this.nextVal=NaN,t}for(var e,n,o=!1;!o;){var a=void 0,i=void 0,s=void 0;do{s=(a=2*this.random()-1)*a+(i=2*this.random()-1)*i}while(s>=1||0===s);var u=Math.sqrt(-2*Math.log(s)/s);e=this.mean+this.stdDev*a*u,n=this.mean+this.stdDev*i*u,this.truncated&&!this.isValidTruncated(e)||(o=!0)}return this.truncated&&!this.isValidTruncated(n)||(this.nextVal=this.convertValue(n)),this.convertValue(e)},r.prototype.convertValue=function(t){return null==this.dtype||"float32"===this.dtype?t:Math.round(t)},r.prototype.isValidTruncated=function(t){return t<=this.upper&&t>=this.lower},r}(),qh=function(){function r(t,e,n,o){this.alpha=t,this.beta=1/e,this.dtype=n;var a=o||Math.random();this.randu=Zr(a.toString()),this.randn=new pa(0,1,n,!1,this.randu()),this.d=t<1?t+2/3:t-1/3,this.c=1/Math.sqrt(9*this.d)}return r.prototype.nextValue=function(){for(var t,e,n,o,a,i;;){do{o=this.randn.nextValue(),i=1+this.c*o}while(i<=0);if(e=1-.331*(t=o*o)*t,n=.5*t+this.d*(1-(i*=i*i)+Math.log(i)),(a=this.randu())<e||Math.log(a)<n)break}return i*=1/this.beta*this.d,this.alpha<1&&(i*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(i)},r.prototype.convertValue=function(t){return"float32"===this.dtype?t:Math.round(t)},r}(),Kh=function(){function r(t,e,n,o){var a=this;if(void 0===t&&(t=0),void 0===e&&(e=1),this.canReturnFloat=function(){return null==a.dtype||"float32"===a.dtype},this.min=t,this.range=e-t,this.dtype=n,null==o&&(o=Math.random()),"number"==typeof o&&(o=o.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+t+" - "+e+" <= 1 and dtype is not float");this.random=Zr(o)}return r.prototype.convertValue=function(t){return this.canReturnFloat()?t:Math.round(t)},r.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},r}();function ae(r,t,e){return void 0===t&&(t="float32"),t=t||"float32",Yo(r),new fr(r,t,e)}var au=A({batchToSpaceND_:function(r,t,e){var n=_(r,"x","batchToSpaceND"),o=t.reduce(function(a,i){return a*i});return E(n.rank>=1+t.length,function(){return"input rank is "+n.rank+" but should be > than blockShape.length "+t.length}),E(e.length===t.length,function(){return"crops.length is "+e.length+" but should be equal to blockShape.length  "+t.length}),E(n.shape[0]%o==0,function(){return"input tensor batch is "+n.shape[0]+" but is not divisible by the product of the elements of blockShape "+t.join(" * ")+" === "+o}),D.runKernelFunc(function(a){return a.batchToSpaceND(n,t,e)},{$x:n},function(a){return{$x:function(){return a.spaceToBatchND(t,e)}}})}}),Yh=A({broadcastTo_:function(r,t){var e=_(r,"broadcastTo","x"),n=e.shape;if(t.some(function(u){return!(u>0)||u%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+t+"].");if(t.length<e.rank)throw new Error("broadcastTo(): shape.length="+t.length+" < input.rank="+e.rank+".");if(t.length>e.rank){for(var o=e.shape.slice();o.length<t.length;)o.unshift(1);e=e.reshape(o)}for(var a=Array.from(t),i=t.length-1;i>=0;i--)if(e.shape[i]===t[i])a[i]=1;else if(1!==e.shape[i])throw new Error("broadcastTo(): ["+n+"] cannot be broadcast to ["+t+"].");var s=a.map(function(u,c){return u>1?c:-1}).filter(function(u){return u>=0});return 0===s.length?e.clone():D.runKernelFunc(function(u){return u.tile(e,a)},{input:e},function(u){return{input:function(){return u.sum(s,!0)}}})}}),$h=A({cast_:function(r,t){var e=_(r,"x","cast");if(!vs(t))throw new Error("Failed to cast to unknown dtype "+t);if("string"===t&&"string"!==e.dtype||"string"!==t&&"string"===e.dtype)throw new Error("Only strings can be casted to strings");return D.runKernelFunc(function(o){return o.cast(e,t)},{x:e},function(o){return{x:function(){return o.clone()}}},"Cast",{dtype:t})}}),Qh=A({clone_:function(r){var t=_(r,"x","clone",null);return D.runKernelFunc(function(){return D.makeTensorFromDataId(t.dataId,t.shape,t.dtype)},{$x:t},function(e){return{$x:function(){return e.toFloat()}}})}}),Jh=A({cumsum_:function(r,t,e,n){void 0===t&&(t=0),void 0===e&&(e=!1),void 0===n&&(n=!1);var o=_(r,"x","cumsum"),a=xt([t|=0],o.rank),i=o;null!=a&&(i=o.transpose(a));var s=bt(1,o.rank)[0],u=D.runKernelFunc(function(c){return c.cumsum(i,s,e,n)},{permutedX:i},function(c){return{permutedX:function(){return c.cumsum(t,e,!n)}}});return null!=a&&(u=u.transpose(a)),u}}),Zh=A({depthToSpace_:function(r,t,e){void 0===e&&(e="NHWC");var n=_(r,"x","depthToSpace"),o="NHWC"===e?n.shape[1]:n.shape[2],a="NHWC"===e?n.shape[2]:n.shape[3],i="NHWC"===e?n.shape[3]:n.shape[1];return E(o*t>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+o+" and "+t+"  for depthToSpace with input shape\n      "+n.shape}),E(a*t>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+a+" and "+t+" for depthToSpace with input shape\n          "+n.shape}),E(i%(t*t)==0,function(){return"Dimension size must be evenly divisible by "+t*t+" but is "+i+" for depthToSpace with input shape "+n.shape}),D.runKernelFunc(function(s){return s.depthToSpace(n,t,e)},{$x:n})}}),dt=A({expandDims_:function(r,t){void 0===t&&(t=0);var e=_(r,"x","expandDims",null);E(t<=e.rank,function(){return"Axis must be <= rank of the tensor"});var n=e.shape.slice();return t<0&&(E(-(e.rank+1)<=t,function(){return"Axis must be in the interval ["+-(e.rank+1)+", "+e.rank+"]"}),t=e.rank+t+1),n.splice(t,0,1),wt(e,n)}}),iu=A({eye_:function(r,t,e,n){void 0===n&&(n="float32"),null==t&&(t=r);for(var o=ae([r,t],n),a=r<=t?r:t,i=0;i<a;++i)o.set(1,i,i);var s=o.toTensor().as2D(r,t);if(null==e)return s;if(1===e.length)return Wn(dt(s,0),[e[0],1,1]);if(2===e.length)return Wn(dt(dt(s,0),0),[e[0],e[1],1,1]);if(3===e.length)return Wn(dt(dt(dt(s,0),0),0),[e[0],e[1],e[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+e.length+"D.")}}),ef=A({multinomial_:function(r,t,e,n){void 0===n&&(n=!1);var o=_(r,"logits","multinomial"),a=o.size,i=o.rank;if(a<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+a+".");if(i>2)throw new Error("Rank of probabilities must be 1 or 2, but is "+i);e=e||Math.random();var s=1===i?o.as2D(1,-1):o,u=D.runKernelFunc(function(c){return c.multinomial(s,n,t,e)},{logits2D:s});return 1===i?u.as1D():u}}),va=A({oneHot_:function(r,t,e,n){if(void 0===e&&(e=1),void 0===n&&(n=0),t<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+t);var o=_(r,"indices","oneHot","int32"),a=o.shape.concat([t]);return o=o.flatten(),D.runKernelFunc(function(i){return i.oneHot(o,t,e,n)},{$indices:o},function(i){return{$indices:function(){return Ee(o.shape,"float32")}}}).reshape(a)}}),_n=A({pad_:function(r,t,e){void 0===e&&(e=0);var n=_(r,"x","pad");if(0===n.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");return D.runKernelFunc(function(a){return a.pad(n,t,e)},{x:n},function(a){var i=t.map(function(s){return s[0]});return{x:function(){return a.slice(i,n.shape)}}},"PadV2",{paddings:t,constantValue:e})}}),tf=A({pad1d_:function(r,t,e){return void 0===e&&(e=0),E(2===t.length,function(){return"Invalid number of paddings. Must be length of 2."}),_n(r,[t],e)}}),nf=A({pad2d_:function(r,t,e){return void 0===e&&(e=0),E(2===t.length&&2===t[0].length&&2===t[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),_n(r,t,e)}}),rf=A({pad3d_:function(r,t,e){return void 0===e&&(e=0),E(3===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),_n(r,t,e)}}),of=A({pad4d_:function(r,t,e){return void 0===e&&(e=0),E(4===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length&&2===t[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),_n(r,t,e)}}),af=A({rand_:function(r,t,e){var n=Q(r),o=null;if(null==e||"float32"===e)o=new Float32Array(n);else if("int32"===e)o=new Int32Array(n);else{if("bool"!==e)throw new Error("Unknown data type "+e);o=new Uint8Array(n)}for(var a=0;a<n;a++)o[a]=t();return D.makeTensor(o,r,e)}}),sf=A({randomNormal_:function(r,t,e,n,o){if(void 0===t&&(t=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);for(var a=new pa(t,e,n,!1,o),i=ae(r,n),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),uf=A({randomGamma_:function(r,t,e,n,o){if(void 0===e&&(e=1),void 0===n&&(n="float32"),null==e&&(e=1),null==n&&(n="float32"),"float32"!==n&&"int32"!==n)throw new Error("Unsupported data type "+n);for(var a=new qh(t,e,n,o),i=ae(r,n),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),su=A({randomUniform_:function(r,t,e,n,o){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n="float32");for(var a=ae(r,n),i=new Kh(t,e,null,o),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),wt=A({reshape_:function(r,t){var e=_(r,"x","reshape",null);return t=ds(t,e.size),E(e.size===Q(t),function(){return"new shape and old shape must have the same number of elements."}),D.runKernelFunc(function(o){return o.reshape(e,t)},{x:e},function(o){return{x:function(){return o.reshape(e.shape)}}},"Reshape",{shape:t})}}),uu=A({spaceToBatchND_:function(r,t,e){var n=_(r,"x","spaceToBatchND");return E(n.rank>=1+t.length,function(){return"input rank "+n.rank+" should be > than [blockShape] "+t.length}),E(e.length===t.length,function(){return"paddings.shape[0] "+e.length+" must be equal to [blockShape] "+t.length}),E(n.shape.reduce(function(o,a,i){return i>0&&i<=t.length?o&&(a+e[i-1][0]+e[i-1][1])%t[i-1]==0:o},!0),function(){return"input spatial dimensions "+n.shape.slice(1)+" with paddings "+e.toString()+" must be divisible by blockShapes "+t.toString()}),D.runKernelFunc(function(o){return o.spaceToBatchND(n,t,e)},{$x:n},function(o){return{$x:function(){return o.batchToSpaceND(t,e)}}})}}),cu=A({squeeze_:function(r,t){var e=_(r,"x","squeeze");return wt(e,en(e.shape,t).newShape)}}),ut=A({stack_:function(r,t){void 0===t&&(t=0);var e=wr(r,"tensors","stack");if(E(e.length>=1,function(){return"Pass at least one tensor to tf.stack"}),1===e.length)return e[0].expandDims(t);var o=e[0].shape,a=e[0].dtype;E(t<=e[0].rank,function(){return"Axis must be <= rank of the tensor"}),e.forEach(function(s){pe(o,s.shape,"All tensors passed to stack must have matching shapes")}),e.forEach(function(s){E(a===s.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var i=e.map(function(s){return s.expandDims(t)});return Be(i,t)}}),Wn=A({tile_:function(r,t){var e=_(r,"x","tile",null);return E(e.rank===t.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of reps "+t+"."}),D.runKernelFunc(function(a,i){var s=a.tile(e,t);return i([e]),s},{x:e},function(a,i){var s=i[0];return{x:function(){var u=ve(s);if(1===s.rank)for(var c=0;c<t[0];++c)u=u.add(a.slice([c*s.shape[0]],[s.shape[0]]));else if(2===s.rank)for(c=0;c<t[0];++c)for(var l=0;l<t[1];++l)u=u.add(a.slice([c*s.shape[0],l*s.shape[1]],[s.shape[0],s.shape[1]]));else if(3===s.rank)for(c=0;c<t[0];++c)for(l=0;l<t[1];++l)for(var h=0;h<t[2];++h)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2]],[s.shape[0],s.shape[1],s.shape[2]]));else{if(4!==s.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+s.rank+" tensors yet.");for(c=0;c<t[0];++c)for(l=0;l<t[1];++l)for(h=0;h<t[2];++h)for(var f=0;f<t[3];++f)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2],f*s.shape[3]],[s.shape[0],s.shape[1],s.shape[2],s.shape[3]]))}return u}}},"Tile",{reps:t},[e])}}),cf=A({truncatedNormal_:function(r,t,e,n,o){if(void 0===t&&(t=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);for(var a=new pa(t,e,n,!0,o),i=ae(r,n),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),Le=A({unstack_:function(r,t){void 0===t&&(t=0),t=t||0;var e=_(r,"x","unstack");return E(t>=-e.shape.length&&t<e.shape.length,function(){return"Axis = "+t+" is not in [-"+e.shape.length+", "+e.shape.length+")"}),t<0&&(t+=e.shape.length),D.runKernelFunc(function(o){return o.unstack(e,t)},{x:e},function(o){return{x:function(){return ut(o,t)}}},"Unpack",{axis:t})}});function eo(r,t,e,n){void 0===n&&(n=!0);var o=[];if(n)(o=o.concat(t.slice(0))).push(r[0]/e),o=o.concat(r.slice(1));else{o=o.concat(r[0]);for(var a=t.length,i=0;i<a;++i)o=o.concat([r[i+1]/t[i],t[i]]);o=o.concat(r.slice(a+1))}return o}function to(r,t,e){void 0===e&&(e=!0);var n=[];if(e){n.push(t);for(var o=t+1;o<r;++o)o<=2*t?(n.push(o),n.push(o-(t+1))):n.push(o)}else{var a=[],i=[];for(o=1;o<r;++o)o>=2*t+1||o%2==1?i.push(o):a.push(o);n.push.apply(n,a),n.push(0),n.push.apply(n,i)}return n}function no(r,t,e,n){void 0===n&&(n=!0);var o=[];o.push(n?r[0]/e:r[0]*e);for(var a=1;a<r.length;++a)o.push(a<=t.length?n?t[a-1]*r[a]:r[a]/t[a-1]:r[a]);return o}function lu(r,t){for(var e=[0],n=0;n<t;++n)e.push(r[n][0]);return e}function hu(r,t,e){for(var n=r.slice(0,1),o=0;o<e;++o)n.push(r[o+1]-t[o][0]-t[o][1]);return n}function ma(r,t){if(r.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+r.rank+".");if(t.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if("int32"!==t.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+t.dtype+".");if(t.shape[t.rank-1]>r.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+t.shape[t.rank-1]+" vs. "+r.rank);if(0===r.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+r.shape+".");for(var e=t.shape,n=e[e.length-1],o=1,a=0;a<e.length-1;++a)o*=e[a];var i=r.shape,s=e.slice();s.pop();var u=1;for(a=n;a<r.rank;++a)u*=i[a],s.push(i[a]);var c=gt(r.shape).map(function(l){return l/u}).concat([1]).slice(0,n);return[s,o,u,c]}function ro(r){return r<=30?r:Ur(r,Math.floor(Math.sqrt(r)))}function fu(r,t,e){var n=t.rank>1?t.shape[t.rank-1]:1,o=t.rank>1?t.rank-1:1,a="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+e.shape+", indices.shape: "+t.shape+", shape: "+r+", sliceDim: "+n+", and batchDim: "+o+".";if(e.rank<o)throw new Error(a+" update.rank < "+o+". ");if(r.length<n+(e.rank-o))throw new Error(a+" Output shape length < "+(n+(e.rank-o)));if(e.rank!==o+r.length-n)throw new Error(a+" update.rank != "+(o+r.length-n));for(var i=0;i<o;++i)if(e.shape[i]!==t.shape[i])throw new Error(a+" updates.shape["+i+"] ("+e.shape[i]+") != indices.shape["+i+"] ("+t.shape[i]+").");for(i=0;i<e.rank-o;++i)if(e.shape[i+o]!==r[i+n])throw new Error(a+" updates.shape["+(i+o)+"] ("+e.shape[i+o]+") != shape["+(i+o)+"] ("+r[i+o]+")")}function du(r,t,e){if(t.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if(r.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+r.rank+".");if("int32"!==t.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+t.dtype);if(e.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+e);if(0===e.length){if(0===t.size)throw new Error("Indices specified for empty output. indices shape: "+t.shape);if(0===r.size)throw new Error("Updates specified for empty output. updates shape: "+r.shape)}fu(e,t,r)}function _r(r,t,e){for(var n=t.shape.length,o=n>1?t.shape[n-1]:1,a=e.length,i=1,s=o;s<a;++s)i*=e[s];var u=o<1?1:o;return{sliceRank:o,numUpdates:Q(t.shape)/u,sliceSize:i,strides:gt(e.slice(0,o)).concat([1]),outputSize:Q(e)}}function pu(r,t,e){E(r.rank===t.length,function(){return"Error in slice"+r.rank+"D: Length of begin "+t+" must match the rank of the array ("+r.rank+")."}),E(r.rank===e.length,function(){return"Error in slice"+r.rank+"D: Length of size "+e+" must match the rank of the array ("+r.rank+")."});for(var n=function(a){E(t[a]+e[a]<=r.shape[a],function(){return"Error in slice"+r.rank+"D: begin["+a+"] + size["+a+"] ("+(t[a]+e[a])+") would overflow input.shape["+a+"] ("+r.shape[a]+")"})},o=0;o<r.rank;++o)n(o)}function ya(r){for(var t=[],e=0;r>0;)1&r&&t.push(e),r/=2,e++;return t}function oo(r,t,e){for(var n=[],o=0;o<r.length;o++)n[o]=Math.ceil((t[o]-r[o])/e[o]);return n}function vu(r,t,e,n,o){var a=t[o];(r&1<<o||null==a)&&(a=(e[o]||1)>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var s=n[o];return a<0&&(a+=s),zr(0,a,s-1)}function mu(r,t,e,n,o){var a=t[o],i=e[o]||1;(r&1<<o||null==a)&&(a=i>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var s=n[o];return a<0&&(a+=s),i>0?zr(0,a,s):zr(-1,a,s-1)}function xa(r,t,e){for(var n=e.length,o=0;o<e.length;o++)if(e[o]>1){n=o;break}for(o=n+1;o<e.length;o++)if(t[o]>0||e[o]!==r[o])return!1;return!0}function ba(r,t){for(var e=r.length>0?r[r.length-1]:1,n=0;n<r.length-1;n++)e+=r[n]*t[n];return e}function ao(r){return D.customGrad(r)}Object.freeze({prepareAndValidate:ma}),Object.freeze({validateUpdateShape:fu,validateInput:du,calculateShapes:_r}),Object.freeze({assertParamsValid:pu,maskToAxes:ya,computeOutShape:oo,startForAxis:vu,stopForAxis:mu,isSliceContinous:xa,computeFlatOffset:ba});var Ut=A({softmax_:function(r,t){void 0===t&&(t=-1);var e=_(r,"logits","softmax","float32");if(-1===t&&(t=e.rank-1),t!==e.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and dim was "+t);return D.runKernelFunc(function(n,o){var a=n.softmax(e,t);return o([a]),a},{logits:e},function(n,o){var a=o[0],i=n.mul(a);return{logits:function(){return i.sub(i.sum([t],!0).mul(a))}}},"Softmax",{dim:t},[],[!0])}}),ff=A({logSoftmax_:function(r,t){void 0===t&&(t=-1);var e=_(r,"logits","logSoftmax");if(-1===t&&(t=e.rank-1),t!==e.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and axis was "+t);return ao(function(n,o){var a=n.max(t,!0),i=n.sub(a),s=i.toFloat().sub(i.exp().sum(t,!0).log());return o([s]),{value:s,gradFunc:function(u,c){var l=c[0].exp();return u.sub(u.sum(t,!0).mul(l))}}})(e)}}),gu=function(){function r(t,e){this.backend=t,this.dataMover=e,this.data=new WeakMap,this.dataIdsCount=0}return r.prototype.get=function(t){return this.data.has(t)||this.dataMover.moveData(this.backend,t),this.data.get(t)},r.prototype.set=function(t,e){this.dataIdsCount++,this.data.set(t,e)},r.prototype.has=function(t){return this.data.has(t)},r.prototype.delete=function(t){return this.dataIdsCount--,this.data.delete(t)},r.prototype.numDataIds=function(){return this.dataIdsCount},r}(),yu=function(){function r(){}return r.prototype.time=function(t){return N("time")},r.prototype.read=function(t){return N("read")},r.prototype.readSync=function(t){return N("readSync")},r.prototype.numDataIds=function(){return N("numDataIds")},r.prototype.disposeData=function(t){return N("disposeData")},r.prototype.write=function(t,e,n){return N("write")},r.prototype.move=function(t,e,n,o){return N("move")},r.prototype.memory=function(){return N("memory")},r.prototype.floatPrecision=function(){return N("floatPrecision")},r.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},r.prototype.batchMatMul=function(t,e,n,o){return N("batchMatMul")},r.prototype.fusedBatchMatMul=function(t){return N("fusedBatchMatMul")},r.prototype.slice=function(t,e,n){return N("slice")},r.prototype.stridedSlice=function(t,e,n,o){return N("stridedSlice")},r.prototype.unstack=function(t,e){return N("unstack")},r.prototype.reverse=function(t,e){return N("reverse")},r.prototype.concat=function(t,e){return N("concat")},r.prototype.neg=function(t){return N("neg")},r.prototype.add=function(t,e){return N("add")},r.prototype.addN=function(t){return N("addN")},r.prototype.subtract=function(t,e){return N("subtract")},r.prototype.multiply=function(t,e){return N("multiply")},r.prototype.realDivide=function(t,e){return N("realDivide")},r.prototype.floorDiv=function(t,e){return N("floorDiv")},r.prototype.sum=function(t,e){return N("sum")},r.prototype.prod=function(t,e){return N("prod")},r.prototype.unsortedSegmentSum=function(t,e,n){return N("unsortedSegmentSum")},r.prototype.argMin=function(t,e){return N("argMin")},r.prototype.argMax=function(t,e){return N("argMax")},r.prototype.equal=function(t,e){return N("equal")},r.prototype.notEqual=function(t,e){return N("notEqual")},r.prototype.less=function(t,e){return N("less")},r.prototype.lessEqual=function(t,e){return N("lessEqual")},r.prototype.greater=function(t,e){return N("greater")},r.prototype.greaterEqual=function(t,e){return N("greaterEqual")},r.prototype.logicalNot=function(t){return N("logicalNot")},r.prototype.logicalAnd=function(t,e){return N("logicalAnd")},r.prototype.logicalOr=function(t,e){return N("logicalOr")},r.prototype.where=function(t){return N("where")},r.prototype.select=function(t,e,n){return N("select")},r.prototype.topk=function(t,e,n){return N("topk")},r.prototype.min=function(t,e){return N("min")},r.prototype.minimum=function(t,e){return N("minimum")},r.prototype.mod=function(t,e){return N("mod")},r.prototype.max=function(t,e){return N("max")},r.prototype.maximum=function(t,e){return N("maximum")},r.prototype.all=function(t,e){return N("all")},r.prototype.any=function(t,e){return N("any")},r.prototype.squaredDifference=function(t,e){return N("squaredDifference")},r.prototype.ceil=function(t){return N("ceil")},r.prototype.floor=function(t){return N("floor")},r.prototype.round=function(t){return N("round")},r.prototype.sign=function(t){return N("sign")},r.prototype.isNaN=function(t){return N("isNaN")},r.prototype.isInf=function(t){return N("isInf")},r.prototype.isFinite=function(t){return N("isFinite")},r.prototype.pow=function(t,e){return N("pow")},r.prototype.exp=function(t){return N("exp")},r.prototype.expm1=function(t){return N("expm1")},r.prototype.softmax=function(t,e){return N("softmax")},r.prototype.log=function(t){return N("log")},r.prototype.log1p=function(t){return N("log1p")},r.prototype.sqrt=function(t){return N("sqrt")},r.prototype.rsqrt=function(t){return N("rsqrt")},r.prototype.square=function(t){return N("square")},r.prototype.reciprocal=function(t){return N("reciprocal")},r.prototype.relu=function(t){return N("relu")},r.prototype.relu6=function(t){return N("relu6")},r.prototype.prelu=function(t,e){return N("prelu")},r.prototype.elu=function(t){return N("elu")},r.prototype.eluDer=function(t,e){return N("eluDer")},r.prototype.selu=function(t){return N("selu")},r.prototype.int=function(t){return N("int")},r.prototype.clip=function(t,e,n){return N("clip")},r.prototype.abs=function(t){return N("abs")},r.prototype.complexAbs=function(t){return N("complexAbs")},r.prototype.sigmoid=function(t){return N("sigmoid")},r.prototype.softplus=function(t){return N("softplus")},r.prototype.sin=function(t){return N("sin")},r.prototype.cos=function(t){return N("cos")},r.prototype.tan=function(t){return N("tan")},r.prototype.asin=function(t){return N("asin")},r.prototype.acos=function(t){return N("acos")},r.prototype.atan=function(t){return N("atan")},r.prototype.atan2=function(t,e){return N("atan2")},r.prototype.sinh=function(t){return N("sinh")},r.prototype.cosh=function(t){return N("cosh")},r.prototype.tanh=function(t){return N("tanh")},r.prototype.asinh=function(t){return N("asinh")},r.prototype.acosh=function(t){return N("acosh")},r.prototype.atanh=function(t){return N("atanh")},r.prototype.erf=function(t){return N("erf")},r.prototype.step=function(t,e){return N("step")},r.prototype.fusedConv2d=function(t){return N("fusedConv2d")},r.prototype.conv2d=function(t,e,n){return N("conv2d")},r.prototype.conv2dDerInput=function(t,e,n){return N("conv2dDerInput")},r.prototype.conv2dDerFilter=function(t,e,n){return N("conv2dDerFilter")},r.prototype.fusedDepthwiseConv2D=function(t){return N("fusedDepthwiseConv2D")},r.prototype.depthwiseConv2D=function(t,e,n){return N("depthwiseConv2D")},r.prototype.depthwiseConv2DDerInput=function(t,e,n){return N("depthwiseConv2DDerInput")},r.prototype.depthwiseConv2DDerFilter=function(t,e,n){return N("depthwiseConv2DDerFilter")},r.prototype.conv3d=function(t,e,n){return N("conv3d")},r.prototype.conv3dDerInput=function(t,e,n){return N("conv3dDerInput")},r.prototype.conv3dDerFilter=function(t,e,n){return N("conv3dDerFilter")},r.prototype.maxPool=function(t,e){return N("maxPool")},r.prototype.maxPoolBackprop=function(t,e,n,o){return N("maxPoolBackprop")},r.prototype.avgPool=function(t,e){return N("avgPool")},r.prototype.avgPoolBackprop=function(t,e,n){return N("avgPoolBackprop")},r.prototype.avgPool3d=function(t,e){return N("avgPool3d")},r.prototype.avgPool3dBackprop=function(t,e,n){return N("avgPool3dBackprop")},r.prototype.maxPool3d=function(t,e){return N("maxPool3d")},r.prototype.maxPool3dBackprop=function(t,e,n,o){return N("maxPool3dBackprop")},r.prototype.reshape=function(t,e){return N("reshape")},r.prototype.cast=function(t,e){return N("cast")},r.prototype.tile=function(t,e){return N("tile")},r.prototype.pad=function(t,e,n){return N("pad")},r.prototype.transpose=function(t,e){return N("transpose")},r.prototype.gather=function(t,e,n){return N("gather")},r.prototype.gatherND=function(t,e){return N("gatherND")},r.prototype.scatterND=function(t,e,n){return N("scatterND")},r.prototype.batchToSpaceND=function(t,e,n){return N("batchToSpaceND")},r.prototype.spaceToBatchND=function(t,e,n){return N("spaceToBatchND")},r.prototype.resizeBilinear=function(t,e,n,o){return N("resizeBilinear")},r.prototype.resizeBilinearBackprop=function(t,e,n){return N("resizeBilinearBackprop")},r.prototype.resizeNearestNeighbor=function(t,e,n,o){return N("resizeNearestNeighbor")},r.prototype.resizeNearestNeighborBackprop=function(t,e,n){return N("resizeNearestNeighborBackprop")},r.prototype.batchNormalization=function(t,e,n,o,a,i){return N("batchNormalization")},r.prototype.localResponseNormalization4D=function(t,e,n,o,a){return N("localResponseNormalization4D")},r.prototype.LRNGrad=function(t,e,n,o,a,i,s){return N("LRNGrad")},r.prototype.multinomial=function(t,e,n,o){return N("multinomial")},r.prototype.oneHot=function(t,e,n,o){return N("oneHot")},r.prototype.cumsum=function(t,e,n,o){return N("cumsum")},r.prototype.nonMaxSuppression=function(t,e,n,o,a){return N("nonMaxSuppression")},r.prototype.fft=function(t){return N("fft")},r.prototype.ifft=function(t){return N("ifft")},r.prototype.complex=function(t,e){return N("complex")},r.prototype.real=function(t){return N("real")},r.prototype.imag=function(t){return N("imag")},r.prototype.cropAndResize=function(t,e,n,o,a,i){return N("cropAndResize")},r.prototype.depthToSpace=function(t,e,n){return N("depthToSpace")},r.prototype.split=function(t,e,n){return N("split")},r.prototype.sparseToDense=function(t,e,n,o){return N("sparseToDense")},r.prototype.diag=function(t){return N("diag")},r.prototype.fill=function(t,e,n){return N("fill")},r.prototype.onesLike=function(t){return N("onesLike")},r.prototype.zerosLike=function(t){return N("zerosLike")},r.prototype.linspace=function(t,e,n){return N("linspace")},r.prototype.dispose=function(){return N("dispose")},r}();function N(r){throw new Error("'"+r+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function Gt(r,t){for(var e=r.length,n=[],o=0;o<e;o++){var a=e-1-o;(t[t.length-1-o]||1)>1&&1===(r[a]||1)&&n.unshift(a)}return n}function Oe(r,t){for(var e=[],n=0;n<t.length;n++){var o=r[r.length-n-1],a=t.length-n-1;(null==o||1===o&&t[a]>1)&&e.unshift(a)}return e}function ce(r,t){for(var e=[],n=Math.max(r.length,t.length),o=0;o<n;o++){var a=r[r.length-o-1];null==a&&(a=1);var i=t[t.length-o-1];if(null==i&&(i=1),1===a)e.unshift(i);else if(1===i)e.unshift(a);else{if(a!==i)throw Error("Operands could not be broadcast together with shapes "+r+" and "+t+".");e.unshift(a)}}return e}function zn(r,t,e,n,o,a,i){void 0===i&&(i="channelsLast");var s,u=so(t),c=u[0],l=u[1];if("channelsLast"===i)s=[c,l,r[3],r[3]];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);s=[c,l,r[1],r[1]]}return an(r,s,e,n,o,a,!1,i)}function Cr(r,t,e,n,o,a,i){void 0===i&&(i="NDHWC");var s,u,c=_a(t),l=c[0],h=c[1],f=c[2];if("NDHWC"===i)u="channelsLast",s=[l,h,f,r[4],r[4]];else{if("NCDHW"!==i)throw new Error("Unknown dataFormat "+i);u="channelsFirst",s=[l,h,f,r[1],r[1]]}return Er(r,s,e,n,o,!1,u,a)}function an(r,t,e,n,o,a,i,s){void 0===i&&(i=!1),void 0===s&&(s="channelsLast");var u=[-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3];if("channelsLast"===s)c=r[0],l=r[1],h=r[2],f=r[3];else{if("channelsFirst"!==s)throw new Error("Unknown dataFormat "+s);c=r[0],f=r[1],l=r[2],h=r[3]}var d,p=t[0],m=t[1],v=t[3],g=so(e),x=g[0],b=g[1],y=so(n),w=y[0],C=y[1],S=Vn(p,w),k=Vn(m,C),I=function(O,B,U,z,W,G,H,q){var te,ne,se;if("number"==typeof O){te={top:O,bottom:O,left:O,right:O,type:0===O?"VALID":"NUMBER"};var ue=function(de,we,be,Te,Se){null==Te&&(Te=wa(de,we,be));var Ot=de[1],Bt=Ir((de[0]-we+2*Te)/be+1,Se);E(Re(Bt),function(){return"The output # of rows ("+Bt+") must be an integer. Change the stride and/or zero pad parameters"});var ht=Ir((Ot-we+2*Te)/be+1,Se);return E(Re(ht),function(){return"The output # of columns ("+ht+") must be an integer. Change the stride and/or zero pad parameters"}),[Bt,ht]}([B,U],G,z,O,q);ne=ue[0],se=ue[1]}else if("same"===O){ne=Math.ceil(B/z),se=Math.ceil(U/W);var he=Math.max(0,(ne-1)*z+G-B),me=Math.max(0,(se-1)*W+H-U),fe=Math.floor(he/2),ge=he-fe,Fe=Math.floor(me/2);te={top:fe,bottom:ge,left:Fe,right:me-Fe,type:"SAME"}}else{if("valid"!==O)throw Error("Unknown padding parameter: "+O);te={top:0,bottom:0,left:0,right:0,type:"VALID"},ne=Math.ceil((B-G+1)/z),se=Math.ceil((U-H+1)/W)}return{padInfo:te,outHeight:ne,outWidth:se}}(o,l,h,x,b,S,k,a),F=I.outHeight,T=I.outWidth,L=i?v*f:v;return"channelsFirst"===s?d=[c,L,F,T]:"channelsLast"===s&&(d=[c,F,T,L]),{batchSize:c,dataFormat:s,inHeight:l,inWidth:h,inChannels:f,outHeight:F,outWidth:T,outChannels:L,padInfo:I.padInfo,strideHeight:x,strideWidth:b,filterHeight:p,filterWidth:m,effectiveFilterHeight:S,effectiveFilterWidth:k,dilationHeight:w,dilationWidth:C,inShape:r,outShape:d,filterShape:t}}function Er(r,t,e,n,o,a,i,s){void 0===a&&(a=!1),void 0===i&&(i="channelsLast");var u=[-1,-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3],d=u[4];if("channelsLast"===i)c=r[0],l=r[1],h=r[2],f=r[3],d=r[4];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);c=r[0],d=r[1],l=r[2],h=r[3],f=r[4]}var p,m=t[0],v=t[1],g=t[2],x=t[4],b=_a(e),y=b[0],w=b[1],C=b[2],S=_a(n),k=S[0],I=S[1],R=S[2],F=Vn(m,k),T=Vn(v,I),L=Vn(g,R),O=function(H,q,te,ne,se,ue,he,me,fe,ge,Fe){var de,we,be,Te;if("number"==typeof H){de={top:H,bottom:H,left:H,right:H,front:H,back:H,type:0===H?"VALID":"NUMBER"};var Se=function(nr,Zt,Zi,rr,Lt,es){null==Lt&&(Lt=wa(nr,Zt,rr));var K0=nr[1],X0=nr[2],ts=Ir((nr[0]-Zt+2*Lt)/rr+1,es);E(Re(ts),function(){return"The output # of depths ("+ts+") must be an integer. Change the stride and/or zero pad parameters"});var ns=Ir((K0-Zt+2*Lt)/rr+1,es);E(Re(ns),function(){return"The output # of rows ("+ns+") must be an integer. Change the stride and/or zero pad parameters"});var rs=Ir((X0-Zt+2*Lt)/rr+1,es);return E(Re(rs),function(){return"The output # of columns ("+rs+") must be an integer. Change the stride and/or zero pad parameters"}),[ts,ns,rs,1]}([q,te,ne,1],me,0,se,H,Fe);we=Se[0],be=Se[1],Te=Se[2]}else if("same"===H){var De=((we=Math.ceil(q/se))-1)*se+me-q,Ot=((be=Math.ceil(te/ue))-1)*ue+fe-te,Bt=((Te=Math.ceil(ne/he))-1)*he+ge-ne,ht=Math.floor(De/2),tr=De-ht,Qt=Math.floor(Ot/2),vn=Ot-Qt,Jt=Math.floor(Bt/2);de={top:Qt,bottom:vn,left:Jt,right:Bt-Jt,front:ht,back:tr,type:"SAME"}}else{if("valid"!==H)throw Error("Unknown padding parameter: "+H);de={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},we=Math.ceil((q-me+1)/se),be=Math.ceil((te-fe+1)/ue),Te=Math.ceil((ne-ge+1)/he)}return{padInfo:de,outDepth:we,outHeight:be,outWidth:Te}}(o,l,h,f,y,w,C,F,T,L,s),U=O.outDepth,z=O.outHeight,W=O.outWidth,G=a?x*d:x;return"channelsFirst"===i?p=[c,G,U,z,W]:"channelsLast"===i&&(p=[c,U,z,W,G]),{batchSize:c,dataFormat:i,inDepth:l,inHeight:h,inWidth:f,inChannels:d,outDepth:U,outHeight:z,outWidth:W,outChannels:G,padInfo:O.padInfo,strideDepth:y,strideHeight:w,strideWidth:C,filterDepth:m,filterHeight:v,filterWidth:g,effectiveFilterDepth:F,effectiveFilterHeight:T,effectiveFilterWidth:L,dilationDepth:k,dilationHeight:I,dilationWidth:R,inShape:r,outShape:p,filterShape:t}}function wa(r,t,e,n){void 0===n&&(n=1);var o=Vn(t,n);return Math.floor((r[0]*(e-1)-e+o)/2)}function so(r){return"number"==typeof r?[r,r,r]:2===r.length?[r[0],r[1],1]:r}function _a(r){return"number"==typeof r?[r,r,r]:r}function Vn(r,t){return t<=1?r:r+(r-1)*(t-1)}function Ir(r,t){if(!t)return r;switch(t){case"round":return Math.round(r);case"ceil":return Math.ceil(r);case"floor":return Math.floor(r);default:throw new Error("Unknown roundingMode "+t)}}function Cn(r){var t=so(r);return 1===t[0]&&1===t[1]&&1===t[2]}function et(r,t){return Cn(r)||Cn(t)}function uo(r){if("NHWC"===r)return"channelsLast";if("NCHW"===r)return"channelsFirst";throw new Error("Unknown dataFormat "+r)}function Ca(r,t,e){if("complex64"===t){if("complex64"===r.dtype)return r.clone();var n=Ee(r.shape),o=r.toFloat(),a=e.complex(o,n);return n.dispose(),o.dispose(),a}if(!ms(r.dtype,t))return D.makeTensorFromDataId(r.dataId,r.shape,t);if("complex64"===r.dtype){var i=e.real(r);return a=i.cast(t),i.dispose(),a}if("int32"===t)return e.int(r);if("bool"===t){var s=j(0,r.dtype);return a=e.notEqual(r,s),s.dispose(),a}throw new Error("Error in Cast: failed to cast "+r.dtype+" to "+t)}function co(r,t){return D.makeTensorFromDataId(r.dataId,t,r.dtype)}function Ea(r,t,e){var n=(t-r)/(e-1),o=On(e,"float32");o[0]=r;for(var a=1;a<o.length;a++)o[a]=o[a-1]+n;return Me(o,"float32")}function Ia(r,t){if(r.length!==t.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+r.length+", imag: "+t.length+".");for(var e=new Float32Array(2*r.length),n=0;n<e.length;n+=2)e[n]=r[n/2],e[n+1]=t[n/2];return e}function xu(r,t){return{real:r[2*t],imag:r[2*t+1]}}function df(r,t,e,n){r[2*n]=t,r[2*n+1]=e}function pf(r,t,e){var n=(e?2:-2)*Math.PI*(r/t);return{real:Math.cos(n),imag:Math.sin(n)}}function vf(r,t,e){var n=function(u,c,l){for(var h=0,f=u.length,d=0,p=!1;h<f;){var m=l(c,u[d=h+(f-h>>>1)]);m>0?h=d+1:(f=d,p=!m)}return p?h:-h-1}(r,t,e||mf);r.splice(n<0?-(n+1):n,0,t)}function mf(r,t){return r>t?1:r<t?-1:0}function Ra(r,t,e,n,o){return bu(r,t,e,n,o,0).selectedIndices}function ka(r,t,e,n,o,a){var i=bu(r,t,e,n,o,a,!0);return i.numValidOutputs.dispose(),{selectedIndices:i.selectedIndices,selectedScores:i.selectedScores}}function bu(r,t,e,n,o,a,i,s){void 0===i&&(i=!1),void 0===s&&(s=!1);for(var u=Array.from(t).map(function(y,w){return{score:y,boxIndex:w,suppressBeginIndex:0}}).filter(function(y){return y.score>o}).sort(wu),c=a>0?-.5/a:0,l=[],h=[];l.length<e&&u.length>0;){var f=u.pop(),d=f.score,p=f.boxIndex,m=f.suppressBeginIndex;if(d<o)break;for(var v=!1,g=l.length-1;g>=m;--g){var x=gf(r,p,l[g]);if(x>=n){v=!0;break}if(f.score=f.score*yf(n,c,x),f.score<=o)break}f.suppressBeginIndex=l.length,v||(f.score===d?(l.push(p),h.push(f.score)):f.score>o&&vf(u,f,wu))}var b=l.length;return s&&(l.fill(0,b),h.fill(0,b)),{selectedIndices:Me(l,"int32"),selectedScores:Me(h,"float32"),numValidOutputs:j(b,"int32")}}function gf(r,t,e){var n=r.subarray(4*t,4*t+4),o=r.subarray(4*e,4*e+4),a=Math.min(n[0],n[2]),i=Math.min(n[1],n[3]),s=Math.max(n[0],n[2]),u=Math.max(n[1],n[3]),c=Math.min(o[0],o[2]),l=Math.min(o[1],o[3]),h=Math.max(o[0],o[2]),f=Math.max(o[1],o[3]),d=(s-a)*(u-i),p=(h-c)*(f-l);if(d<=0||p<=0)return 0;var m=Math.max(a,c),v=Math.max(i,l),g=Math.min(s,h),x=Math.min(u,f),b=Math.max(g-m,0)*Math.max(x-v,0);return b/(d+p-b)}function yf(r,t,e){var n=Math.exp(t*e*e);return e<=r?n:0}function wu(r,t){return r.score-t.score||r.score===t.score&&t.boxIndex-r.boxIndex}function _u(r,t,e){var n=new Array(r.rank).fill(0),o=r.shape.slice();return t.map(function(a){o[e]=a;var i=r.slice(n,o);return n[e]+=a,i})}function Cu(r,t){for(var e=new Array(r.rank),n=0;n<e.length;n++)e[n]=r.shape[n]*t[n];var o=ae(e,r.dtype);for(n=0;n<o.values.length;++n){for(var a=o.indexToLoc(n),i=new Array(r.rank),s=0;s<i.length;s++)i[s]=a[s]%r.shape[s];var u=r.locToIndex(i);o.values[n]=r.values[u]}return o.toTensor()}function Eu(r,t,e,n,o){for(var a=t[t.length-1],i=[r.length/a,a],s=i[0],u=i[1],c=Pn(e,s*n),l=Pn("int32",s*n),h=0;h<s;h++){for(var f=h*u,d=r.subarray(f,f+u),p=[],m=0;m<d.length;m++)p.push({value:d[m],index:m});p.sort(function(y,w){return w.value-y.value});var v=h*n,g=c.subarray(v,v+n),x=l.subarray(v,v+n);for(m=0;m<n;m++)g[m]=p[m].value,x[m]=p[m].index}var b=t.slice();return b[b.length-1]=n,[Ke(c,b,e),Ke(l,b,"int32")]}function Sa(r,t){for(var e=[],n=0;n<t.length;n++)t[n]&&e.push(n);var o=ae(r,"int32"),a=ae([e.length,r.length],"int32");for(n=0;n<e.length;n++){var i=o.indexToLoc(e[n]);a.values.set(i,n*r.length)}return a.toTensor()}Object.freeze({castTensor:Ca,reshapeTensor:co,linspaceImpl:Ea,upcastType:Ve,axesAreInnerMostDims:ha,combineLocations:nu,computeOutAndReduceShapes:je,expandShapeToKeepDim:Ze,assertAxesAreInnerMostDims:nt,getAxesPermutation:xt,getUndoAxesPermutation:Qr,getInnerMostAxes:bt,getBroadcastDims:Gt,getReductionAxes:Oe,assertAndGetBroadcastShape:ce,assertParamsConsistent:ru,computeOutShape:xn,computePool2DInfo:zn,computePool3DInfo:Cr,computeConv2DInfo:an,computeConv3DInfo:Er,computeDefaultPad:wa,tupleValuesAreOne:Cn,eitherStridesOrDilationsAreOne:et,convertConv2DDataFormat:uo,PARALLELIZE_THRESHOLD:30,computeOptimalWindowSize:ro});var xf=function(r,t){this.outputShape=[],this.outputShape=r,this.variableNames=t.map(function(o,a){return"T"+a});var e=[];this.variableNames.forEach(function(o){e.push("float v"+o+" = get"+o+"AtOutCoords();")});var n=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+e.join("\n        ")+"\n\n        float result = "+n+";\n        setOutput(result);\n      }\n    "},bf=function(r,t){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r,this.variableNames=t.map(function(o,a){return"T"+a});var e=[];this.variableNames.forEach(function(o){e.push("vec4 v"+o+" = get"+o+"AtOutCoords();")});var n=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+e.join("\n        ")+"\n\n        vec4 result = "+n+";\n        setOutput(result);\n      }\n    "},wf=function(r,t,e){this.variableNames=["A"];var n=r.windowSize,o=r.batchSize,i=Math.ceil(r.inSize/n);e||this.variableNames.push("bestIndicesA"),this.outputShape=[o,i],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+n+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+n+"; i++) {\n          int inIdx = "+(e?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===t?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};function Iu(r,t){return["x","y","z","w","u","v"].slice(0,t).map(function(e){return r+"."+e})}function ot(r,t){return 1===t?[r]:Iu(r,t)}function Xe(){var r,t,e,n,o,a,i,s,u,c;return 2===M().getNumber("WEBGL_VERSION")?(r="#version 300 es",t="in",e="out",n="in",o="texture",a="outputColor",i="out vec4 outputColor;",s="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",u="",c="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(r="",t="attribute",e="varying",n="varying",o="texture2D",a="gl_FragColor",i="",s="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",u="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",c="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:r,attribute:t,varyingVs:e,varyingFs:n,texture2D:o,output:a,defineOutput:i,defineSpecialNaN:s,defineSpecialInf:u,defineRound:c}}function En(r,t,e){void 0===e&&(e="index");var n=gt(t);return n.map(function(o,a){return"int "+r[a]+" = "+e+" / "+o+"; "+(a===n.length-1?"int "+r[a+1]+" = "+e+" - "+r[a]+" * "+o:"index -= "+r[a]+" * "+o)+";"}).join("")}function Da(r){var t=gt(r).map(function(e){return e.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+t[0]+" + coords.y * "+t[1]+" + coords.z;\n  }\n"}var Ru="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function _f(r,t,e,n){var o=[];r.forEach(function(d){var p=Q(d.shapeInfo.logicalShape);d.shapeInfo.isUniform?o.push("uniform float "+d.name+(p>1?"["+p+"]":"")+";"):(o.push("uniform sampler2D "+d.name+";"),o.push("uniform int offset"+d.name+";"))});var a,i,d,s=o.join("\n"),u=r.map(function(d){return function(p,m,v){void 0===v&&(v=!1);var g="";return g+=v?ku(p):Un(p),p.shapeInfo.logicalShape.length<=m.logicalShape.length&&(g+=v?function(y,w){var C,U,S=y.name,k=S.charAt(0).toUpperCase()+S.slice(1),I="get"+k+"AtOutCoords",R=y.shapeInfo.logicalShape.length,F=w.logicalShape.length,T=Gt(y.shapeInfo.logicalShape,w.logicalShape),L=Ce(F),O=F-R,B=["x","y","z","w","u","v"];C=0===R?"":F<2&&T.length>=1?"coords = 0;":T.map(function(te){return"coords."+B[te+O]+" = 0;"}).join("\n"),U=F<2&&R>0?"coords":y.shapeInfo.logicalShape.map(function(te,ne){return"coords."+B[ne+O]}).join(", ");var z="return outputValue;",W=1===Q(y.shapeInfo.logicalShape),G=1===Q(w.logicalShape);if(1!==R||W||G){if(W&&!G)z=1===F?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(T.length){var H=R-2,q=R-1;T.indexOf(H)>-1&&T.indexOf(q)>-1?z="return vec4(outputValue.x);":T.indexOf(H)>-1?z="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":T.indexOf(q)>-1&&(z="return vec4(outputValue.xx, outputValue.zz);")}}else z="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+I+"() {\n      "+L+" coords = getOutputCoords();\n      "+C+"\n      vec4 outputValue = get"+k+"("+U+");\n      "+z+"\n    }\n  "}(p,m):function(y,w){var C=y.name,S=C.charAt(0).toUpperCase()+C.slice(1),k="get"+S+"AtOutCoords",F=y.shapeInfo.logicalShape.length,T=w.logicalShape.length;if(!y.shapeInfo.isUniform&&F===T&&null==y.shapeInfo.flatOffset&&Ne(y.shapeInfo.texShape,w.texShape))return"\n      float "+k+"() {\n        return sampleTexture("+C+", resultUV);\n      }\n    ";var O=Ce(T),B=Gt(y.shapeInfo.logicalShape,w.logicalShape),U=T-F,z=["x","y","z","w","u","v"];return"\n    float "+k+"() {\n      "+O+" coords = getOutputCoords();\n      "+(0===F?"":T<2&&B.length>=1?"coords = 0;":B.map(function(G){return"coords."+z[G+U]+" = 0;"}).join("\n"))+"\n      return get"+S+"("+(T<2&&F>0?"coords":y.shapeInfo.logicalShape.map(function(G,H){return"coords."+z[H+U]}).join(", "))+");\n    }\n  "}(p,m)),g}(d,t,n)}).join("\n"),c=t.texShape,l=Xe(),h="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+l.texture2D+"(textureSampler, uv).r;\n    }\n  ",f=(d=l).version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+d.varyingFs+" vec2 resultUV;\n    "+d.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+d.defineSpecialNaN+"\n    "+d.defineSpecialInf+"\n    "+d.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+Cf+"\n    "+Ef+"\n    "+If+"\n  ";return t.isPacked?(a=function(d,p){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return w=p,1===(C=[Math.ceil(w[0]/2),Math.ceil(w[1]/2)])[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+C[1]+".0);\n      }\n    ":1===C[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+C[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+C[0]+", "+C[1]+"));\n      return 2 * (resTexRC.x * "+C[1]+" + resTexRC.y);\n    }\n  ";case 2:return function(y,w){var C=[Math.ceil(w[0]/2),Math.ceil(w[1]/2)];if(Ne(y,w))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+C[0]+", "+C[1]+"));\n      }\n    ";var S=Math.ceil(y[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+C[0]+", "+C[1]+"));\n\n      int index = resTexRC.x * "+C[1]+" + resTexRC.y;\n      int r = 2 * (index / "+S+");\n      int c = imod(index, "+S+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(d,p);case 3:return m=d,v=p,g=[Math.ceil(v[0]/2),Math.ceil(v[1]/2)],b=(x=Math.ceil(m[2]/2))*Math.ceil(m[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+g[0]+", "+g[1]+"));\n      int index = resTexRC.x * "+g[1]+" + resTexRC.y;\n\n      int b = index / "+b+";\n      index -= b * "+b+";\n\n      int r = 2 * (index / "+x+");\n      int c = imod(index, "+x+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(y,w){for(var C=[Math.ceil(w[0]/2),Math.ceil(w[1]/2)],S=Math.ceil(y[y.length-1]/2),k=S*Math.ceil(y[y.length-2]/2),I=k,R="",F="b, r, c",T=2;T<y.length-1;T++)R="\n      int b"+T+" = index / "+(I*=y[y.length-T-1])+";\n      index -= b"+T+" * "+I+";\n    "+R,F="b"+T+", "+F;return"\n    ivec"+y.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+C[0]+", "+C[1]+"));\n      int index = resTexRC.x * "+C[1]+" + resTexRC.y;\n\n      "+R+"\n\n      int b = index / "+k+";\n      index -= b * "+k+";\n\n      int r = 2 * (index / "+S+");\n      int c = imod(index, "+S+") * 2;\n\n      return ivec"+y.length+"("+F+");\n    }\n  "}(d,p)}var w,C,m,v,g,x,b}(t.logicalShape,c),i=function(d){return"\n    void setOutput(vec4 val) {\n      "+d.output+" = val;\n    }\n  "}(l)):(a=function(d,p){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(x=p)[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+x[1]+".0);\n      }\n    ":1===x[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+x[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+x[0]+", "+x[1]+"));\n      return resTexRC.x * "+x[1]+" + resTexRC.y;\n    }\n  ";case 2:return function(g,x){return Ne(g,x)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+x[0]+", "+x[1]+"));\n      }\n    ":1===g[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+x[0]+", "+x[1]+"));\n        int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===g[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+x[0]+", "+x[1]+"));\n        int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n      int r = index / "+g[1]+";\n      int c = index - r * "+g[1]+";\n      return ivec2(r, c);\n    }\n  "}(d,p);case 3:return m=p,v=En(["r","c","d"],d),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+m[0]+", "+m[1]+"));\n      int index = resTexRC.x * "+m[1]+" + resTexRC.y;\n      "+v+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return function(g,x){var b=En(["r","c","d","d2"],g);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n      "+b+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(d,p);case 5:return function(g,x){var b=En(["r","c","d","d2","d3"],g);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+x[0]+",\n                             "+x[1]+"));\n\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n\n      "+b+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(d,p);case 6:return function(g,x){var b=En(["r","c","d","d2","d3","d4"],g);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+x[0]+", "+x[1]+"));\n      int index = resTexRC.x * "+x[1]+" + resTexRC.y;\n\n      "+b+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(d,p);default:throw new Error(d.length+"-D output sampling is not yet supported")}var x,m,v}(t.logicalShape,c),i=function(d){return"\n    void setOutput(float val) {\n      "+d.output+" = vec4(val, 0, 0, 0);\n    }\n  "}(l)),n&&(f+=Rf),[f,h,i,s,a,u,e].join("\n")}function Un(r){var t=r.shapeInfo.logicalShape;switch(t.length){case 0:return function(e){var n=e.name,o="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return"float "+o+"() {return "+n+";}";var a=e.shapeInfo.texShape;if(1===a[0]&&1===a[1])return"\n      float "+o+"() {\n        return sampleTexture("+n+", halfCR);\n      }\n    ";var u=e.shapeInfo.texShape;return"\n    float "+o+"() {\n      vec2 uv = uvFromFlat("+u[0]+", "+u[1]+", "+In(n)+");\n      return sampleTexture("+n+", uv);\n    }\n  "}(r);case 1:return function(e){var n=e.name,o="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return"\n      float "+o+"(int index) {\n        "+Gn(e)+"\n      }\n    ";var a=e.shapeInfo.texShape,i=a[0],s=a[1];if(1===s&&1===i)return"\n      float "+o+"(int index) {\n        return sampleTexture("+n+", halfCR);\n      }\n    ";var u=In(n);return 1===s?"\n      float "+o+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+u+") + 0.5) / "+i+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":1===i?"\n      float "+o+"(int index) {\n        vec2 uv = vec2((float(index + "+u+") + 0.5) / "+s+".0, 0.5);\n        return sampleTexture("+n+", uv);\n      }\n    ":"\n    float "+o+"(int index) {\n      vec2 uv = uvFromFlat("+i+", "+s+", index + "+u+");\n      return sampleTexture("+n+", uv);\n    }\n  "}(r);case 2:return function(e){var n=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=e.shapeInfo.texShape;if(null!=i&&Ne(n,i))return"\n    float "+a+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+i[1]+".0, "+i[0]+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ";var c=en(n),l=c.newShape,h=c.keptDims;if(l.length<n.length)return"\n      "+Un(Hn(e,l))+"\n      float "+a+"(int row, int col) {\n        return "+a+"("+jn(["row","col"],h)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+n[1]+", 1)));\n        "+Gn(e)+"\n      }\n    ";var p=i[0],m=i[1],v=In(o);return 1===m?"\n    float "+a+"(int row, int col) {\n      float index = dot(vec3(row, col, "+v+"), vec3("+n[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+p+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ":1===p?"\n    float "+a+"(int row, int col) {\n      float index = dot(vec3(row, col, "+v+"), vec3("+n[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+m+".0, 0.5);\n      return sampleTexture("+o+", uv);\n    }\n  ":"\n  float "+a+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+n[1]+" + col + "+v+";\n    vec2 uv = uvFromFlat("+p+", "+m+", index);\n    return sampleTexture("+o+", uv);\n  }\n"}(r);case 3:return function(e){var n=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=n[1]*n[2],s=n[2],u=en(n),c=u.newShape,l=u.keptDims;if(c.length<n.length)return"\n        "+Un(Hn(e,c))+"\n        float "+a+"(int row, int col, int depth) {\n          return "+a+"("+jn(["row","col","depth"],l)+");\n        }\n      ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+i+", "+s+", 1)));\n        "+Gn(e)+"\n      }\n    ";var d=e.shapeInfo.texShape,p=d[0],m=d[1],v=e.shapeInfo.flatOffset;return m===i&&null==v?"\n        float "+a+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+s+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+m+".0, "+p+".0);\n          return sampleTexture("+o+", uv);\n        }\n      ":m===s&&null==v?"\n    float "+a+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+n[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+m+".0, "+p+".0);\n      return sampleTexture("+o+", uv);\n    }\n  ":"\n      float "+a+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+i+" + col * "+s+" + depth + "+In(o)+";\n        vec2 uv = uvFromFlat("+p+", "+m+", index);\n        return sampleTexture("+o+", uv);\n      }\n  "}(r);case 4:return function(e){var n=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=n[3],s=n[2]*i,u=n[1]*s,c=en(n),l=c.newShape,h=c.keptDims;if(l.length<n.length)return"\n      "+Un(Hn(e,l))+"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        return "+a+"("+jn(["row","col","depth","depth2"],h)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+u+", "+s+", "+i+", 1)));\n        "+Gn(e)+"\n      }\n    ";var d=e.shapeInfo.flatOffset,p=e.shapeInfo.texShape,m=p[0],v=p[1];return v===u&&null==d?"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+s+", "+i+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+v+".0, "+m+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":v===i&&null==d?"\n      float "+a+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+n[1]*n[2]+", "+n[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+v+".0, "+m+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+u+" + col * "+s+" +\n          depth * "+i+" + depth2;\n      vec2 uv = uvFromFlat("+m+", "+v+", index + "+In(o)+");\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);case 5:return function(e){var n=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=n[4],s=n[3]*i,u=n[2]*s,c=n[1]*u,l=en(n),h=l.newShape,f=l.keptDims;if(h.length<n.length)return"\n      "+Un(Hn(e,h))+"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+a+"("+jn(["row","col","depth","depth2","depth3"],f)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+c+", "+u+", "+s+", "+i+")) +\n          depth3;\n        "+Gn(e)+"\n      }\n    ";var p=e.shapeInfo.flatOffset,m=e.shapeInfo.texShape,v=m[0],g=m[1];return g===c&&null==p?"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+u+", "+s+", "+i+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+g+".0, "+v+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":g===i&&null==p?"\n      float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+n[1]*n[2]*n[3]+",\n               "+n[2]*n[3]+", "+n[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+g+".0, "+v+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+c+" + col * "+u+" + depth * "+s+" +\n          depth2 * "+i+" + depth3 + "+In(o)+";\n      vec2 uv = uvFromFlat("+v+", "+g+", index);\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);case 6:return function(e){var n=e.shapeInfo.logicalShape,o=e.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),i=en(n),s=i.newShape,u=i.keptDims;if(s.length<n.length)return"\n      "+Un(Hn(e,s))+"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+a+"("+jn(["row","col","depth","depth2","depth3","depth4"],u)+");\n      }\n    ";var l=n[5],h=n[4]*l,f=n[3]*h,d=n[2]*f,p=n[1]*d;if(e.shapeInfo.isUniform)return"\n      float "+a+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+p+", "+d+", "+f+", "+h+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+l+", 1)));\n        "+Gn(e)+"\n      }\n    ";var m=e.shapeInfo.flatOffset,v=e.shapeInfo.texShape,g=v[0],x=v[1];return x===p&&null==m?"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+d+", "+f+", "+h+", "+l+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+x+".0, "+g+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":x===l&&null==m?"\n      float "+a+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+n[1]*n[2]*n[3]*n[4]+",\n               "+n[2]*n[3]*n[4]+",\n               "+n[3]*n[4]+",\n               "+n[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+x+".0, "+g+".0);\n        return sampleTexture("+o+", uv);\n      }\n    ":"\n    float "+a+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+p+" + col * "+d+" + depth * "+f+" +\n          depth2 * "+h+" + depth3 * "+l+" + depth4 + "+In(o)+";\n      vec2 uv = uvFromFlat("+g+", "+x+", index);\n      return sampleTexture("+o+", uv);\n    }\n  "}(r);default:throw new Error(t.length+"-D input sampling is not yet supported")}}function ku(r){var t,o,a,i,s,u,c;switch(r.shapeInfo.logicalShape.length){case 0:return"\n    vec4 get"+(t=r.name).charAt(0).toUpperCase()+t.slice(1)+"() {\n      return "+Xe().texture2D+"("+t+", halfCR);\n    }\n  ";case 1:return i="get"+(a=(o=r).name).charAt(0).toUpperCase()+a.slice(1),s=o.shapeInfo.texShape,u=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)],c=Xe(),"\n    vec4 "+i+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+u[0]+", "+u[1]+", index);\n      return "+c.texture2D+"("+a+", uv);\n    }\n  ";case 2:return function(o){var a=o.shapeInfo.logicalShape,i=o.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),u=o.shapeInfo.texShape,c=u[0],l=u[1],h=Xe();if(null!=u&&Ne(a,u))return"\n      vec4 "+s+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+l+".0, "+c+".0);\n\n        return "+h.texture2D+"("+i+", uv);\n      }\n    ";var f=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)];return"\n    vec4 "+s+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(a[1]/2)+", "+f[0]+", "+f[1]+", row, col);\n      return "+h.texture2D+"("+i+", uv);\n    }\n  "}(r);case 3:return function(o){var a=o.shapeInfo.logicalShape,i=o.name,s="get"+i.charAt(0).toUpperCase()+i.slice(1),u=o.shapeInfo.texShape,c=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)];if(1===a[0])return"\n        "+ku(Hn(o,a.slice(1)))+"\n        vec4 "+s+"(int b, int row, int col) {\n          return "+s+"("+jn(["b","row","col"],[1,2])+");\n        }\n      ";var f=c[0],d=c[1],p=Math.ceil(a[2]/2);return"\n    vec4 "+s+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+f+", "+d+", "+p*Math.ceil(a[1]/2)+", "+p+", b, row, col);\n      return "+Xe().texture2D+"("+i+", uv);\n    }\n  "}(r);default:return function(o){for(var a=o.shapeInfo.logicalShape,i=a.length,s=o.name,u="get"+s.charAt(0).toUpperCase()+s.slice(1),c=o.shapeInfo.texShape,l=[Math.ceil(c[0]/2),Math.ceil(c[1]/2)],h=l[0],f=l[1],d=Math.ceil(a[i-1]/2),p=d*Math.ceil(a[i-2]/2),m="int b, int row, int col",v="b * "+p+" + (row / 2) * "+d+" + (col / 2)",g=2;g<i-1;g++)m="int b"+g+", "+m,v="b"+g+" * "+(p*=a[i-g-1])+" + "+v;return"\n    vec4 "+u+"("+m+") {\n      int index = "+v+";\n      int texR = index / "+f+";\n      int texC = index - texR * "+f+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+f+", "+h+");\n      return "+Xe().texture2D+"("+s+", uv);\n    }\n  "}(r)}}var Cf="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",Ef="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",If="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",Rf="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function In(r){return"offset"+r}function Gn(r){var t=r.name,e=Q(r.shapeInfo.logicalShape);return e<2?"return "+t+";":"\n    for (int i = 0; i < "+e+"; i++) {\n      if (i == index) {\n        return "+t+"[i];\n      }\n    }\n  "}function Ce(r){if(r<=1)return"int";if(2===r)return"ivec2";if(3===r)return"ivec3";if(4===r)return"ivec4";if(5===r)return"ivec5";if(6===r)return"ivec6";throw Error("GPU for rank "+r+" is not yet supported")}function Hn(r,t){var e=JSON.parse(JSON.stringify(r));return e.shapeInfo.logicalShape=t,e}function jn(r,t){return t.map(function(e){return r[e]}).join(", ")}var kf=function(r,t,e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,E(r.length>2,function(){return"Packed arg"+(e.charAt(0).toUpperCase()+e.slice(1))+" supports only inputs with rank above 2."});var a=Math.ceil(r[r.length-1]/t);this.outputShape=r.slice(0,-1),a>1&&this.outputShape.push(a),n||this.variableNames.push("bestIndicesA");var i,s,u=this.outputShape,c=u.length,l=Ce(c),h=ot("coords",c);if(1===a){var f=Ce(s=c+1);i="\n        "+f+" sourceLocR = "+f+"("+h.join()+", 0);\n        ++"+h[c-1]+";\n        "+f+" sourceLocG = "+f+"("+h.join()+", 0);\n        ++"+h[c-2]+";\n        "+f+" sourceLocA = "+f+"("+h.join()+", 0);\n        --"+h[c-1]+";\n        "+f+" sourceLocB = "+f+"("+h.join()+", 0);\n        --"+h[c-2]+";"}else s=c,i="\n        "+l+" sourceLocR = coords;\n        ++"+h[c-1]+";\n        "+l+" sourceLocG = coords;\n        ++"+h[c-2]+";\n        "+l+" sourceLocA = coords;\n        --"+h[c-1]+";\n        "+l+" sourceLocB = coords;\n        --"+h[c-2]+";";var d=["x","y","z","w","u","v"].slice(0,s),p="."+d[s-1],m=d.map(function(k){return"int "+k}),v=ot("sourceLocR",s-1).concat("inIdx.r"),g=ot("sourceLocG",s-1).concat("inIdx.g"),x=ot("sourceLocB",s-1).concat("inIdx.b"),b=ot("sourceLocA",s-1).concat("inIdx.a"),y="max"===e?"greaterThan":"lessThan",w=n?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+v.join()+"),\n                             getBestIndicesAChannel("+g.join()+"),\n                             getBestIndicesAChannel("+x.join()+"),\n                             getBestIndicesAChannel("+b.join()+")));",C="vec4(\n            getAChannel("+v.join()+"),\n            hasNextCol ? getAChannel("+g.join()+") : 0.,\n            hasNextRow ? getAChannel("+x.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+b.join()+") : 0.)",S=n?"":"\n      float getBestIndicesAChannel("+m.join()+") {\n        return getChannel(getBestIndicesA("+d.join()+"),\n                                          vec2("+d.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+m.join()+") {\n        return getChannel(getA("+d.join()+"),\n                               vec2("+d.slice(-2).join()+"));\n      }\n      "+S+"\n      void main() {\n        "+l+" coords = getOutputCoords();\n        bool hasNextCol = "+h[c-1]+" < "+(u[c-1]-1)+";\n        bool hasNextRow = "+h[c-2]+" < "+(u[c-2]-1)+";\n        "+i+"\n        ivec4 srcIdx = ivec4(sourceLocR"+p+", sourceLocG"+p+",\n          sourceLocB"+p+", sourceLocA"+p+") * "+t+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+C+";\n\n        for (int i = 0; i < "+t+"; i++) {\n          inIdx = srcIdx;\n          "+w+"\n          vec4 candidate = "+C+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+y+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "},Sf=function(r){this.variableNames=["dy"],this.outputShape=r.inShape;var s=r.effectiveFilterHeight,u=r.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(s-1-r.padInfo.top)+", "+(u-1-r.padInfo.left)+");\n      const float avgMultiplier = float("+1/(r.filterHeight*r.filterWidth)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+s+";\n            wR += "+r.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+u+";\n            wC+= "+r.dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Df=function(r){this.variableNames=["dy"],this.outputShape=r.inShape;var l=r.effectiveFilterDepth,h=r.effectiveFilterHeight,f=r.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(l-1-r.padInfo.front)+", "+(h-1-r.padInfo.top)+", "+(f-1-r.padInfo.left)+");\n      const float avgMultiplier = float("+1/(r.filterDepth*r.filterHeight*r.filterWidth)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+r.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+r.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+r.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+h+";\n              wR += "+r.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+f+";\n                wC += "+r.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Af=function(r,t,e,n,o,a){this.outputShape=[],this.variableNames=["x","mean","variance"],ce(r,t),ce(r,e);var i="0.0";null!=n&&(ce(r,n),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="1.0";null!=o&&(ce(r,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=r,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+i+";\n        float scale = "+s+";\n        float inv = scale * inversesqrt(variance + float("+a+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "},Tf=function(r,t,e,n,o,a){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],ce(r,t),ce(r,e);var i="vec4(0.0)";null!=n&&(ce(r,n),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="vec4(1.0)";null!=o&&(ce(r,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=r,this.userCode="\n      void main() {\n        vec4 offset = "+i+";\n        vec4 scale = "+s+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+a+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "},Su=function(r,t,e){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=ce(t,e),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+r+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "},Aa="return a + b;",Ta="return a - b;",Du="return a * b;",Au="return (a < 0.) ? b * a : a;",Ae=function(r,t,e){this.variableNames=["A","B"],this.outputShape=ce(t,e),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+r+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "},Tu="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",Ht=function(r,t,e,n){void 0===n&&(n=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=ce(t,e);var o=this.outputShape.length,a="";if(n)if(0===o||1===Q(this.outputShape))a="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(a="\n          "+Ce(o)+" coords = getOutputCoords();\n        ",1===o)a+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var i=ot("coords",o);a+="\n            bool nextRowOutOfBounds =\n              ("+i[o-2]+" + 1) >= "+this.outputShape[o-2]+";\n            bool nextColOutOfBounds =\n              ("+i[o-1]+" + 1) >= "+this.outputShape[o-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+r+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+a+"\n\n        setOutput(result);\n      }\n    "},Pf=function(){function r(t){this.variableNames=["A"],this.outputShape=t,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(o,a){null==n.minLoc&&(n.minLoc=o.getUniformLocationNoThrow(a,"minVal"),n.maxLoc=o.getUniformLocationNoThrow(a,"maxVal")),o.gl.uniform1f(n.minLoc,t),o.gl.uniform1f(n.maxLoc,e)}},r}(),Mf=function(){function r(t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(o,a){null==n.minLoc&&(n.minLoc=o.getUniformLocationNoThrow(a,"minVal"),n.maxLoc=o.getUniformLocationNoThrow(a,"maxVal")),o.gl.uniform1f(n.minLoc,t),o.gl.uniform1f(n.maxLoc,e)}},r}(),Of=function(r){this.variableNames=["real","imag"],this.outputShape=r,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "},Bf=function(r){this.outputShape=[],this.outputShape=xn(r,1),this.variableNames=r.map(function(s,u){return"T"+u});var t=new Array(r.length-1);t[0]=r[0][1];for(var e=1;e<t.length;e++)t[e]=t[e-1]+r[e][1];var n=["if (yC < "+t[0]+") setOutput(getT0(yR, yC));"];for(e=1;e<t.length;e++)n.push("else if (yC < "+t[e]+") setOutput(getT"+e+"(yR, yC-"+t[e-1]+"));");n.push("else setOutput(getT"+t.length+"(yR, yC-"+t[t.length-1]+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+n.join("\n        ")+"\n      }\n    "},Lf=function(r,t){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=xn(r,t);var e=this.outputShape,n=e.length,o=Ce(n),a=ot("coords",n),i=["x","y","z","w","u","v"].slice(0,n);this.variableNames=r.map(function(v,g){return"T"+g});var s=new Array(r.length-1);s[0]=r[0][t];for(var u=1;u<s.length;u++)s[u]=s[u-1]+r[u][t];var c=i[t],l=i.slice(-2),h=i.join(),f="if ("+c+" < "+s[0]+") {\n        return getChannel(\n            getT0("+h+"), vec2("+l.join()+"));\n        }";for(u=1;u<s.length;u++){var d=s[u-1];f+="\n        if ("+c+" < "+s[u]+"  && "+c+" >= "+s[u-1]+") {\n          return getChannel(\n            getT"+u+"("+lo(i,c,d)+"),\n            vec2("+lo(l,c,d)+"));\n        }"}var m=s[s.length-1];f+="\n        return getChannel(\n          getT"+s.length+"("+lo(i,c,m)+"),\n          vec2("+lo(l,c,m)+"));",this.userCode="\n      float getValue("+i.map(function(v){return"int "+v})+") {\n        "+f+"\n      }\n\n      void main() {\n        "+o+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+a+"), 0., 0., 0.);\n\n        "+a[n-1]+" = "+a[n-1]+" + 1;\n        if ("+a[n-1]+" < "+e[n-1]+") {\n          result.g = getValue("+a+");\n        }\n\n        "+a[n-2]+" = "+a[n-2]+" + 1;\n        if ("+a[n-2]+" < "+e[n-2]+") {\n          result.a = getValue("+a+");\n        }\n\n        "+a[n-1]+" = "+a[n-1]+" - 1;\n        if ("+a[n-2]+" < "+e[n-2]+" &&\n            "+a[n-1]+" < "+e[n-1]+") {\n          result.b = getValue("+a+");\n        }\n        setOutput(result);\n      }\n    "};function lo(r,t,e){var n=r.indexOf(t);return r.map(function(o,a){return a===n?o+" - "+e:o}).join()}var Wf=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n            int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n              int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              if ("+("channelsLast"===r.dataFormat)+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},zf=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var t=r.filterHeight,e=r.filterWidth,a="channelsLast"===r.dataFormat;this.userCode="\n      const ivec2 pads = ivec2("+(t-1-r.padInfo.top)+", "+(e-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(a?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(a?1:2)+"], coords["+(a?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+t+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+t+" - 1 - wR;\n\n          for (int wC = 0; wC < "+e+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+e+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+r.outChannels+"; d2++) {\n\n              if ("+a+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Vf=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yF = 0; yF < "+r.outDepth+"; yF++) {\n            int xF = wF + yF * "+r.strideDepth+" - "+r.padInfo.front+";\n\n            if (xF < 0 || xF >= "+r.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n              int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n              if (xR < 0 || xR >= "+r.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n                int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n                if (xC < 0 || xC >= "+r.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Uf=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var t=r.filterDepth,e=r.filterHeight,n=r.filterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(t-1-r.padInfo.front)+", "+(e-1-r.padInfo.top)+", "+(n-1-r.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+t+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+r.strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+r.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+t+" - 1 - wF;\n\n          for (int wR = 0; wR < "+e+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+e+" - 1 - wR;\n\n            for (int wC = 0; wC < "+n+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+n+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+r.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Gf=function(r){this.variableNames=["x","dy"],this.outputShape=r.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+r.outChannels/r.inChannels+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+r.batchSize+"; b++) {\n          for (int yR = 0; yR < "+r.outHeight+"; yR++) {\n            int xR = wR + yR * "+r.strideHeight+" - "+r.padInfo.top+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+r.outWidth+"; yC++) {\n              int xC = wC + yC * "+r.strideWidth+" - "+r.padInfo.left+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Hf=function(r){this.variableNames=["dy","W"],this.outputShape=r.inShape;var t=r.filterHeight,e=r.filterWidth,s=r.outChannels/r.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+(t-1-r.padInfo.top)+", "+(e-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+t+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+t+" - 1 - wR;\n\n          for (int wC = 0; wC < "+e+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+e+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+s+"; dm++) {\n              int d2 = d1 * "+s+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Fu=function(r,t,e,n){void 0===t&&(t=!1),void 0===e&&(e=null),void 0===n&&(n=!1),this.variableNames=["x","W"],this.outputShape=r.outShape;var o=r.padInfo.top,a=r.padInfo.left,i=r.strideHeight,s=r.strideWidth,u=r.dilationHeight,c=r.dilationWidth,l=r.filterHeight,h=r.filterWidth,f=4*Math.floor(r.inChannels/4),d=r.inChannels%4,p="channelsLast"===r.dataFormat,m=p?1:2,v=p?2:3,g=p?3:1,x="",b="";e&&(x=n?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"\n          float activation(float x) {\n            "+e+"\n          }\n        ",b="result = activation(result);");var y=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+x+"\n\n      const ivec2 strides = ivec2("+i+", "+s+");\n      const ivec2 pads = ivec2("+o+", "+a+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+g+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+m+"], coords["+v+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+l+"; wR++) {\n          int xR = xRCorner + wR * "+u+";\n\n          if (xR < 0 || xR >= "+r.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+h+"; wC++) {\n            int xC = xCCorner + wC * "+c+";\n\n            if (xC < 0 || xC >= "+r.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+f+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+p+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1===d)+") {\n\n              if ("+p+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+f+") *\n                    getW(wR, wC, "+f+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+f+", xR, xC) *\n                    getW(wR, wC, "+f+", d2);\n              }\n\n            } else if ("+(2===d)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2)\n              );\n\n              if ("+p+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3===d)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2),\n                getW(wR, wC, "+f+" + 2, d2)\n              );\n\n              if ("+p+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1),\n                  getX(batch, xR, xC, "+f+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC),\n                  getX(batch, "+f+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+y+"\n        "+b+"\n        setOutput(result);\n      }\n    "},jf=function(r){this.variableNames=["x","W"],this.outputShape=r.outShape;var t=r.padInfo.front,e=r.padInfo.top,n=r.padInfo.left,o=r.strideDepth,a=r.strideHeight,i=r.strideWidth,s=r.dilationDepth,u=r.dilationHeight,c=r.dilationWidth,l=r.filterDepth,h=r.filterHeight,f=r.filterWidth,d=4*Math.floor(r.inChannels/4),p=r.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+t+", "+e+", "+n+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+l+"; wF++) {\n          int xF = xFCorner + wF * "+s+";\n\n          if (xF < 0 || xF >= "+r.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+"; wR++) {\n            int xR = xRCorner + wR * "+u+";\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+f+"; wC++) {\n              int xC = xCCorner + wC * "+c+";\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+d+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1===p)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+d+") *\n                  getW(wF, wR, wC, "+d+", d2);\n              } else if ("+(2===p)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+d+"),\n                  getX(batch, xF, xR, xC, "+d+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+d+", d2),\n                  getW(wF, wR, wC, "+d+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3===p)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+d+"),\n                  getX(batch, xF, xR, xC, "+d+" + 1),\n                  getX(batch, xF, xR, xC, "+d+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+d+", d2),\n                  getW(wF, wR, wC, "+d+" + 1, d2),\n                  getW(wF, wR, wC, "+d+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Nu=function(r,t,e,n){void 0===t&&(t=!1),void 0===e&&(e=null),void 0===n&&(n=!1),this.variableNames=["x","W"],this.outputShape=r.outShape;var o=r.inHeight,a=r.inWidth,i=r.padInfo.top,s=r.padInfo.left,u=r.strideHeight,c=r.strideWidth,l=r.dilationHeight,h=r.dilationWidth,f=r.filterHeight,d=r.filterWidth,p=r.outChannels/r.inChannels,m="",v="";e&&(m=n?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"\n          float activation(float x) {\n            "+e+"\n          }\n        ",v="result = activation(result);");var g=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+m+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+p+";\n        int q = d2 - d1 * "+p+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+f+"; wR++) {\n          int xR = xRCorner + wR * "+l+";\n\n          if (xR < 0 || xR >= "+o+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+d+"; wC++) {\n            int xC = xCCorner + wC * "+h+";\n\n            if (xC < 0 || xC >= "+a+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+g+"\n        "+v+"\n        setOutput(result);\n      }\n    "},Pu=function(r,t,e,n){void 0===t&&(t=!1),void 0===e&&(e=null),void 0===n&&(n=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r.outShape;for(var o=r.inHeight,a=r.inWidth,i=r.padInfo.top,s=r.padInfo.left,u=r.strideHeight,c=r.strideWidth,l=r.dilationHeight,h=r.dilationWidth,f=r.filterHeight,d=r.filterWidth,p=d,m="int xR; int xC; int xCOffset;",v=0;v<f;v++)for(var g=0;g<d;g++)m+="\n          vec4 xTexelR"+v+"C"+2*g+" = vec4(0.);\n          vec4 wR"+v+"C"+g+" = vec4(0.);\n          vec4 xR"+v+"C"+g+" = vec4(0.);";for(v=0;v<f;v++)for(var x=0;x<p;x++){if(m+="\n          xR = xRCorner + "+v*l+";\n          xC = xCCorner + "+(g=2*x)*h+";\n        ",1===c){if(g<d&&(m+=s%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+g+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    xTexelR"+v+"C"+g+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+v+"C"+g+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+v+"C"+g+" = vec4(previous.zw, xTexelR"+v+"C"+g+".xy);\n                } else {\n                  xR"+v+"C"+g+" = vec4(0, 0, xTexelR"+v+"C"+g+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+o+" && xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+g+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+g+" = vec4(0.);\n                }\n\n                xR"+v+"C"+g+" = xTexelR"+v+"C"+g+";\n              ",g+1<d)){var b=s%2==0?Go(h):h;h%2==0&&s%2==1||h%2!=0&&s%2!=1?(m+="\n                  xCOffset = xC + "+s%2+" + "+b+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(g+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",h>1&&(m+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+o+" &&\n                      xCOffset >= 0 && xCOffset < "+a+") {\n                      xTexelR"+v+"C"+g+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+v+"C"+g+" = vec4(0.);\n                    }\n                  "),m+="\n                  xR"+v+"C"+(g+1)+" = vec4(\n                    xTexelR"+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+".xy);\n                "):m+="\n                  xCOffset = xC + "+b+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(g+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+v+"C"+(g+1)+" = xTexelR"+v+"C"+(g+2)+";\n                "}}else g<d&&(m+="\n              if(xR >= 0 && xR < "+o+") {\n            ",s%2==1?(m+="\n                xCOffset = xC + 1 - "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+g+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+g+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+a+") {\n                  xTexelR"+v+"C"+(g+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+v+"C"+(g+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+g+" = vec4(\n                  xTexelR"+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+".zw);\n              ",g+1<d&&(m+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+c+";\n                  if(xCOffset >= 0 && xCOffset < "+a+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+v+"C"+(g+1)+" = vec4(xTexelR"+v+"C"+(g+2)+".xy, final.xy);\n                ")):(m+="\n                if(xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+g+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+g+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+(g+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+(g+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+g+" = vec4(\n                  xTexelR"+v+"C"+g+".xy, xTexelR"+v+"C"+(g+2)+".xy);\n              ",g+1<d&&(m+="\n                  xR"+v+"C"+(g+1)+" = vec4(\n                    xTexelR"+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+".zw);\n                ")),m+="}");g<d&&(m+="\n            vec4 wTexelR"+v+"C"+g+" = getW("+v+", "+g+", d1, q);\n            wR"+v+"C"+g+" = vec4(wTexelR"+v+"C"+g+".xz, wTexelR"+v+"C"+g+".xz);\n          ",g+1<d&&(m+="\n              vec4 wTexelR"+v+"C"+(g+1)+" = getW("+v+", "+(g+1)+", d1, q);\n              wR"+v+"C"+(g+1)+" =\n                vec4(wTexelR"+v+"C"+(g+1)+".xz, wTexelR"+v+"C"+(g+1)+".xz);"))}for(v=0;v<f;v++)for(g=0;g<d;g++)m+="dotProd += xR"+v+"C"+g+" * wR"+v+"C"+g+";";var y="",w="";e&&(y=n?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+e+"\n        }":"vec4 activation(vec4 x) {\n          "+e+"\n        }",w="result = activation(result);");var C=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+y+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+m+"\n\n        vec4 result = dotProd;\n        "+C+"\n        "+w+"\n        setOutput(result);\n      }\n    "},qf=function(r,t,e,n,o){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var a=r[0],i=r[1],s=r[2],l=e[0],h=e[1];this.outputShape=[t[0],l,h,r[3]];var d=[i-1+".0",s-1+".0"],p=d[0],m=d[1],v=l>1?[""+(i-1)/(l-1),"(y2-y1) * height_ratio","y1*"+p+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+p],y=h>1?[""+(s-1)/(h-1),"(x2-x1) * width_ratio","x1*"+m+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+m];this.userCode="\n      const float height_ratio = float("+v[0]+");\n      const float width_ratio = float("+y[0]+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+a+") {\n          return;\n        }\n\n        float height_scale = "+v[1]+";\n        float width_scale = "+y[1]+";\n\n        float in_y = "+v[2]+";\n        if( in_y < 0.0 || in_y > "+p+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n        float in_x = "+y[2]+";\n        if( in_x < 0.0 || in_x > "+m+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+("bilinear"===n?1:0)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "},Kf=function(r,t,e){this.variableNames=["x"],this.outputShape=r;var n=r.length,o=r[r.length-1],a=e?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(e?"return "+o+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+Ce(n)+" coords = getOutputCoords();\n        int end = "+Mu(n,"coords")+";\n        float val = 0.0;\n        for (int i = "+o+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+a+" end) {\n            continue;\n          }\n          if (idx == end && "+t+") {\n            continue;\n          }\n          "+Mu(n,"coords")+" = idx;\n          val += getX("+function(i,s){if(1===i)return""+s;if(2===i)return s+".x, "+s+".y";if(3===i)return s+".x, "+s+".y, "+s+".z";if(4===i)return s+".x, "+s+".y, "+s+".z, "+s+".w";throw Error("Cumulative sum for rank "+i+" is not yet supported")}(n,"coords")+");\n        }\n        setOutput(val);\n      }\n    "};function Mu(r,t){if(1===r)return""+t;if(2===r)return t+".y";if(3===r)return t+".z";if(4===r)return t+".w";throw Error("Cumulative sum for rank "+r+" is not yet supported")}var Xf=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=dr.DENSE;var t=pr(r),e=Xe();this.outputShape=r,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+En(["r","c","d"],r)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+t[0]+", "+t[1]+"));\n        int index = 4 * (resTexRC.x * "+t[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+e.output+" = result;\n      }\n    "},Yf=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=dr.DENSE;var t=pr(r),e=Xe();this.outputShape=r,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+En(["r","c","d"],r)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+t[0]+", "+t[1]+"));\n        int index = 4 * (resTexRC.x * "+t[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+e.output+" = result;\n      }\n    "},$f=function(){function r(t,e,n){this.variableNames=["x"],this.outputShape=[],this.outputShape=t,this.blockSize=e,this.dataFormat=n,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+e+";\n      int offset_h = imod(h, "+e+");\n      int in_w = w / "+e+";\n      int offset_w = imod(w, "+e+");\n      int offset_d = (offset_h * "+e+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return r.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},r.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},r.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},r.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},r.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},r}(),Qf=function(r){this.variableNames=["X"],this.outputShape=[r,r],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "},Jf=function(r){this.variableNames=["A"],this.outTexUsage=at.DOWNLOAD;var t=Xe();this.outputShape=r,this.userCode="\n      "+Ru+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+t.output+" = encode_float(x);\n      }\n    "},Zf=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=at.DOWNLOAD;var t=Xe();this.outputShape=r,this.userCode="\n      "+Ru+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+t.output+" = encode_float(x);\n      }\n    "},ed=function(r,t,e){void 0===e&&(e=!1),this.variableNames=["A"];var n=Xe(),o=t[0],a=t[1];this.outputShape=r;var i="result";e&&(i="floor(result * 255. + 0.5)"),this.userCode="\n      "+Da(r)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+a+";\n        int c = imod(flatIndex, "+a+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n        vec4 values = "+n.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+n.output+" = vec4("+i+", 0., 0., 0.);\n      }\n    "},td=function(r,t,e){void 0===e&&(e=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var n=Xe(),o=t[0],a=t[1];this.outputShape=r;var i="",s="result";e&&(s="floor(result * 255. + 0.5)");for(var u=0;u<=1;u++)for(var c=0;c<=1;c++){var l=2*u+c;i+="\n          localCoords = coords;\n          if(localCoords[2] + "+c+" < "+r[2]+") {\n            localCoords[2] += "+c+";\n            if(localCoords[1] + "+u+" < "+r[1]+") {\n              localCoords[1] += "+u+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+a+";\n              c = imod(flatIndex, "+a+");\n              uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n              values = "+n.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+l+"] = values[0];\n              } else if(offset == 1) {\n                result["+l+"] = values[1];\n              } else if(offset == 2) {\n                result["+l+"] = values[2];\n              } else {\n                result["+l+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+Da(r)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+i+"\n\n        "+n.output+" = "+s+";\n      }\n    "},Ou=function(r,t,e){this.variableNames=["real","imag"];var n=t[1];this.outputShape=t;var o=e?"2.0 * "+Math.PI:"-2.0 * "+Math.PI;this.userCode="\n      const float exponentMultiplier = "+o+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+r+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+n+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+n+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+(e?n+".0":"1.0")+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "},od=function(){function r(t,e){this.outputShape=[],this.variableNames=["x"],this.outputShape=t,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,o){null==e.valueLoc&&(e.valueLoc=n.getUniformLocationNoThrow(o,"value")),n.gl.uniform1f(e.valueLoc,t)}},r}(),ad=function(r,t,e){this.variableNames=["A","indices"];var n=r.slice();n[e]=t,this.outputShape=n,this.rank=n.length;var o=Ce(this.rank),a=function(i,s){var u=i.length;if(u>4)throw Error("Gather for rank "+u+" is not yet supported");if(1===u)return"int(getIndices(resRC))";for(var c=["resRC.x","resRC.y","resRC.z","resRC.w"],l=[],h=0;h<i.length;h++)l.push(h===s?"int(getIndices("+c[h]+"))":""+c[h]);return l.join()}(r,e);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},id=function(r,t,e){this.sliceDim=r,this.strides=t,this.variableNames=["x","indices"],this.outputShape=e;var n=Ce(t.length),o=Ce(e.length);this.userCode="\n        "+n+" strides = "+n+"("+this.strides+");\n         void main() {\n          "+o+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+(this.sliceDim>1?"strides[j]":"strides")+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};function Bu(r,t){var e=Xe();return Fs(r,t,e.version+"\n    precision highp float;\n    "+e.attribute+" vec3 clipSpacePos;\n    "+e.attribute+" vec2 uv;\n    "+e.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function Lu(r,t){return Os(r,t,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function Wu(r,t){return Bs(r,t,new Uint16Array([0,1,2,2,1,3]))}function Rr(r,t,e,n,o,a,i){Ws(e,n);var s=Ls(r,t),u=r.TEXTURE_2D;return X(r,t,function(){return r.bindTexture(u,s)}),X(r,t,function(){return r.texParameteri(u,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE)}),X(r,t,function(){return r.texParameteri(u,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)}),X(r,t,function(){return r.texParameteri(u,r.TEXTURE_MIN_FILTER,r.NEAREST)}),X(r,t,function(){return r.texParameteri(u,r.TEXTURE_MAG_FILTER,r.NEAREST)}),X(r,t,function(){return r.texImage2D(u,0,o,e,n,0,a,i,null)}),X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,null)}),s}function zu(r,t,e,n,o){var a=Gr(e,n);return Rr(r,t,a[0],a[1],o.internalFormatFloat,o.textureFormatFloat,r.FLOAT)}function Vu(r,t,e,n,o){var a=Gr(e,n);return Rr(r,t,a[0],a[1],o.internalFormatHalfFloat,o.textureFormatFloat,o.textureTypeHalfFloat)}function Uu(r,t,e,n,o){var a=Gr(e,n);return Rr(r,t,a[0],a[1],r.RGBA,r.RGBA,r.UNSIGNED_BYTE)}function Gu(r,t,e,n,o){var a=vr(e,n);return Rr(r,t,a[0],a[1],o.internalFormatPackedFloat,r.RGBA,r.FLOAT)}function Hu(r,t,e,n,o){var a=vr(e,n);return Rr(r,t,a[0],a[1],o.internalFormatPackedHalfFloat,r.RGBA,o.textureTypeHalfFloat)}function ju(r,t,e,n){return X(r,t,function(){return r.bindBuffer(r.ARRAY_BUFFER,n)}),sa(r,t,e,"clipSpacePos",n,3,20,0)&&sa(r,t,e,"uv",n,2,20,12)}function qu(r,t,e,n,o,a,i){var s,u,c;X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,e)}),a instanceof Uint8Array?(s=new Uint8Array(n*o*4),u=r.UNSIGNED_BYTE,c=r.RGBA):(s=new Float32Array(n*o*4),u=r.FLOAT,c=i.internalFormatPackedFloat),s.set(a),X(r,t,function(){return r.texImage2D(r.TEXTURE_2D,0,c,n,o,0,r.RGBA,u,s)}),X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,null)})}function Ku(r,t,e,n){X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,e)}),n.data instanceof Uint8Array?X(r,t,function(){return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,n.width,n.height,0,r.RGBA,r.UNSIGNED_BYTE,n.data)}):X(r,t,function(){return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,n)}),X(r,t,function(){return r.bindTexture(r.TEXTURE_2D,null)})}function Xu(r,t,e,n,o){var a=r.createBuffer();X(r,t,function(){return r.bindBuffer(r.PIXEL_PACK_BUFFER,a)});var i=16*e*n;return X(r,t,function(){return r.bufferData(r.PIXEL_PACK_BUFFER,i,r.STREAM_READ)}),X(r,t,function(){return r.readPixels(0,0,n,e,r.RGBA,r.FLOAT,0)}),X(r,t,function(){return r.bindBuffer(r.PIXEL_PACK_BUFFER,null)}),a}function Yu(r,t,e){var n=r,o=new Float32Array(e);return n.bindBuffer(n.PIXEL_PACK_BUFFER,t),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,o),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),o}function $u(r,t,e,n,o){var a=Gr(e,n),i=a[0],s=a[1],u=new Uint8Array(e*n*4);return X(r,t,function(){return r.readPixels(0,0,i,s,o.downloadTextureFormat,r.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function Qu(r,t,e,n,o,a,i,s){var f,u=r,c=new Float32Array((f=vr(a,i))[0]*f[1]*4);return u.bindBuffer(u.PIXEL_PACK_BUFFER,t),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,c),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),c}function Ju(r,t,e,n){var o=new Float32Array(e*n*4);return X(r,t,function(){return r.readPixels(0,0,n,e,r.RGBA,r.FLOAT,o)}),o}var sd=Object.freeze({createVertexShader:Bu,createVertexBuffer:Lu,createIndexBuffer:Wu,createFloat32MatrixTexture:zu,createFloat16MatrixTexture:Vu,createUnsignedBytesMatrixTexture:Uu,createPackedMatrixTexture:Gu,createFloat16PackedMatrixTexture:Hu,bindVertexProgramAttributeStreams:ju,uploadDenseMatrixToTexture:qu,uploadPixelDataToTexture:Ku,createBufferFromOutputTexture:Xu,downloadFloat32MatrixFromBuffer:Yu,downloadByteEncodedFloatMatrixFromOutputTexture:$u,downloadPackedMatrixFromBuffer:Qu,downloadMatrixFromPackedOutputTexture:Ju}),Zu=function(){function r(t){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var e=M().getNumber("WEBGL_VERSION");null!=t?(this.gl=t,Ds(e,t)):this.gl=Rt(e);var n="WEBGL_color_buffer_float";if(1===M().getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=mr(this.gl,this.debug,"OES_texture_float"),st(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=mr(this.gl,this.debug,"OES_texture_half_float");else if(M().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(n),st(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=mr(this.gl,this.debug,"EXT_color_buffer_half_float");else if(M().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(st(this.gl,n="EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension(n);else{if(!st(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=Lu(this.gl,this.debug),this.indexBuffer=Wu(this.gl,this.debug),this.framebuffer=zs(this.gl,this.debug),this.textureConfig=ia(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(r.prototype,"debug",{get:function(){return M().getBool("DEBUG")},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){var t=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var e=this.gl;X(e,this.debug,function(){return e.finish()}),X(e,this.debug,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),X(e,this.debug,function(){return e.deleteFramebuffer(t.framebuffer)}),X(e,this.debug,function(){return e.bindBuffer(e.ARRAY_BUFFER,null)}),X(e,this.debug,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}),X(e,this.debug,function(){return e.deleteBuffer(t.indexBuffer)}),this.disposed=!0}},r.prototype.createFloat32MatrixTexture=function(t,e){return this.throwIfDisposed(),zu(this.gl,this.debug,t,e,this.textureConfig)},r.prototype.createFloat16MatrixTexture=function(t,e){return this.throwIfDisposed(),Vu(this.gl,this.debug,t,e,this.textureConfig)},r.prototype.createUnsignedBytesMatrixTexture=function(t,e){return this.throwIfDisposed(),Uu(this.gl,this.debug,t,e)},r.prototype.uploadPixelDataToTexture=function(t,e){this.throwIfDisposed(),Ku(this.gl,this.debug,t,e)},r.prototype.uploadDenseMatrixToTexture=function(t,e,n,o){this.throwIfDisposed(),qu(this.gl,this.debug,t,e,n,o,this.textureConfig)},r.prototype.createFloat16PackedMatrixTexture=function(t,e){return this.throwIfDisposed(),Hu(this.gl,this.debug,t,e,this.textureConfig)},r.prototype.createPackedMatrixTexture=function(t,e){return this.throwIfDisposed(),Gu(this.gl,this.debug,t,e,this.textureConfig)},r.prototype.deleteMatrixTexture=function(t){var e=this;this.throwIfDisposed(),this.outputTexture===t&&(ua(this.gl,this.debug,this.framebuffer),this.outputTexture=null),X(this.gl,this.debug,function(){return e.gl.deleteTexture(t)})},r.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(t,e,n){var o=this;return this.downloadMatrixDriver(t,function(){return $u(o.gl,o.debug,e,n,o.textureConfig)})},r.prototype.downloadPackedMatrixFromBuffer=function(t,e,n,o,a,i){return Qu(this.gl,t,0,0,0,a,i)},r.prototype.downloadFloat32MatrixFromBuffer=function(t,e){return Yu(this.gl,t,e)},r.prototype.createBufferFromTexture=function(t,e,n){this.bindTextureToFrameBuffer(t);var o=Xu(this.gl,this.debug,e,n);return this.unbindTextureToFrameBuffer(),o},r.prototype.createAndWaitForFence=function(){var t=this.createFence(this.gl);return this.pollFence(t)},r.prototype.createFence=function(t){var e,n,o=this;if(M().getBool("WEBGL_FENCE_API_ENABLED")){var a=t,i=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush(),n=function(){var s=a.clientWaitSync(i,0,0);return s===a.ALREADY_SIGNALED||s===a.CONDITION_SATISFIED},e=i}else M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(e=this.beginQuery(),this.endQuery(),n=function(){return o.isQueryAvailable(e,M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):n=function(){return!0};return{query:e,isFencePassed:n}},r.prototype.downloadMatrixFromPackedTexture=function(t,e,n){var o=this;return this.downloadMatrixDriver(t,function(){return Ju(o.gl,o.debug,e,n)})},r.prototype.createProgram=function(t){this.throwIfDisposed();var e=this.gl,n=Ns(e,this.debug,t),o=Bu(e,this.debug),a=Ps(e,this.debug);return X(e,this.debug,function(){return e.attachShader(a,o)}),X(e,this.debug,function(){return e.attachShader(a,n)}),Ms(e,this.debug,a),this.debug&&qr(e,this.debug,a),this.vertexAttrsAreBound||(this.setProgram(a),this.vertexAttrsAreBound=ju(e,this.debug,this.program,this.vertexBuffer)),a},r.prototype.deleteProgram=function(t){var e=this;this.throwIfDisposed(),t===this.program&&(this.program=null),null!=t&&X(this.gl,this.debug,function(){return e.gl.deleteProgram(t)})},r.prototype.setProgram=function(t){var e=this;this.throwIfDisposed(),this.program=t,null!=this.program&&this.debug&&qr(this.gl,this.debug,this.program),X(this.gl,this.debug,function(){return e.gl.useProgram(t)})},r.prototype.getUniformLocation=function(t,e,n){return void 0===n&&(n=!0),this.throwIfDisposed(),n?Us(this.gl,this.debug,t,e):Gs(this.gl,t,e)},r.prototype.getAttributeLocation=function(t,e){var n=this;return this.throwIfDisposed(),X(this.gl,this.debug,function(){return n.gl.getAttribLocation(t,e)})},r.prototype.getUniformLocationNoThrow=function(t,e){return this.throwIfDisposed(),this.gl.getUniformLocation(t,e)},r.prototype.setInputMatrixTexture=function(t,e,n){this.throwIfDisposed(),this.throwIfNoProgram(),Hs(this.gl,this.debug,0,t,e,n)},r.prototype.setOutputMatrixTexture=function(t,e,n){this.setOutputMatrixTextureDriver(t,n,e)},r.prototype.setOutputPackedMatrixTexture=function(t,e,n){this.throwIfDisposed();var o=vr(e,n);this.setOutputMatrixTextureDriver(t,o[0],o[1])},r.prototype.setOutputMatrixWriteRegion=function(t,e,n,o){this.setOutputMatrixWriteRegionDriver(n,t,o,e)},r.prototype.setOutputPackedMatrixWriteRegion=function(t,e,n,o){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},r.prototype.debugValidate=function(){null!=this.program&&qr(this.gl,this.debug,this.program),gr(this.gl)},r.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var t=this.gl;this.debug&&this.debugValidate(),X(t,this.debug,function(){return t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)})},r.prototype.blockUntilAllProgramsCompleted=function(){var t=this;this.throwIfDisposed(),X(this.gl,this.debug,function(){return t.gl.finish()})},r.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=mr(this.gl,this.debug,2===M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},r.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},r.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},r.prototype.beginQuery=function(){if(2===M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var t=this.gl,e=this.getQueryTimerExtensionWebGL2(),n=t.createQuery();return t.beginQuery(e.TIME_ELAPSED_EXT,n),n}var o=this.getQueryTimerExtensionWebGL1(),a=o.createQueryEXT();return o.beginQueryEXT(o.TIME_ELAPSED_EXT,a),a},r.prototype.endQuery=function(){if(2!==M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var t=this.getQueryTimerExtensionWebGL1();t.endQueryEXT(t.TIME_ELAPSED_EXT)}else{var e=this.gl,n=this.getQueryTimerExtensionWebGL2();e.endQuery(n.TIME_ELAPSED_EXT)}},r.prototype.waitForQueryAndGetTime=function(t){return Y(this,void 0,void 0,function(){var e=this;return $(this,function(n){switch(n.label){case 0:return[4,Ho(function(){return e.disposed||e.isQueryAvailable(t,M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return n.sent(),[2,this.getQueryTime(t,M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},r.prototype.getQueryTime=function(t,e){if(0===e)return null;if(2===e){var n=this.gl;return n.getQueryParameter(t,n.QUERY_RESULT)/1e6}var o=this.getQueryTimerExtensionWebGL1();return o.getQueryObjectEXT(t,o.QUERY_RESULT_EXT)/1e6},r.prototype.isQueryAvailable=function(t,e){if(0===e)return!0;if(2===e){var n=this.gl,o=this.getQueryTimerExtensionWebGL2(),a=n.getQueryParameter(t,n.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(o.GPU_DISJOINT_EXT)),a&&!this.disjoint}return a=(o=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(t,o.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(o.GPU_DISJOINT_EXT)),a&&!this.disjoint},r.prototype.pollFence=function(t){var e=this;return new Promise(function(n){e.addItemToPoll(function(){return t.isFencePassed()},function(){return n()})})},r.prototype.pollItems=function(){for(var t=function(n){for(var o=0;o<n.length&&n[o]();++o);return o-1}(this.itemsToPoll.map(function(n){return n.isDoneFn})),e=0;e<=t;++e)(0,this.itemsToPoll[e].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(t+1)},r.prototype.addItemToPoll=function(t,e){var n=this;this.itemsToPoll.push({isDoneFn:t,resolveFn:e}),this.itemsToPoll.length>1||Ho(function(){return n.pollItems(),0===n.itemsToPoll.length})},r.prototype.bindTextureToFrameBuffer=function(t){this.throwIfDisposed(),Kr(this.gl,this.debug,t,this.framebuffer),this.debug&&gr(this.gl)},r.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(Kr(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&gr(this.gl)):ua(this.gl,this.debug,this.framebuffer)},r.prototype.downloadMatrixDriver=function(t,e){this.bindTextureToFrameBuffer(t);var n=e();return this.unbindTextureToFrameBuffer(),n},r.prototype.setOutputMatrixTextureDriver=function(t,e,n){this.throwIfDisposed();var o=this.gl;Kr(o,this.debug,t,this.framebuffer),this.debug&&gr(o),this.outputTexture=t,X(o,this.debug,function(){return o.viewport(0,0,e,n)}),X(o,this.debug,function(){return o.scissor(0,0,e,n)})},r.prototype.setOutputMatrixWriteRegionDriver=function(t,e,n,o){var a=this;this.throwIfDisposed(),X(this.gl,this.debug,function(){return a.gl.scissor(t,e,n,o)})},r.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},r.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},r}();function ec(r,t){if(r.length!==t.length)throw Error("Binary was compiled with "+r.length+" inputs, but was executed with "+t.length+" inputs");r.forEach(function(e,n){var o=e.logicalShape,a=t[n],i=a.shape;if(!Ne(o,i))throw Error("Binary was compiled with different shapes than the current args. Shapes "+o+" and "+i+" must match");if(!e.isUniform||!a.isUniform){var s=e.texShape,u=a.isUniform?null:a.texData.texShape;if(!Ne(s,u))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+s+" and "+u+" must match")}})}var ud=function(r,t,e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r;for(var o=e.inChannels,a=e.strideWidth,i=e.strideHeight,s=e.padInfo,u=e.outWidth,c=e.dilationWidth,l=e.dilationHeight,h=e.dataFormat,f=s.left,d=s.top,p=o*e.filterWidth,m=Xe(),v="channelsLast"===h,g=v?0:1,x=v?1:2,b="",y=0;y<=1;y++)for(var w=0;w<=1;w++)b+="\n          blockIndex = rc.y + "+w+";\n          pos = rc.x + "+y+";\n\n          if(blockIndex < "+r[1]+" && pos < "+r[0]+") {\n            offsetY = int(blockIndex / ("+u+")) * "+i+" - "+d+";\n            d0 = offsetY + "+l+" * (pos / "+p+");\n\n            if(d0 < "+t[g]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+u+".) * "+a+". - "+f+".);\n              d1 = offsetX + "+c+" * (int(mod(float(pos), "+p+".) / "+o+".));\n\n              if(d1 < "+t[x]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+o+".));\n\n                if ("+v+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*y+w)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*y+w)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+b+"\n\n        "+m.output+" = result;\n      }\n    "},cd=function(r,t,e,n,o){this.variableNames=["x"],this.outputShape=[];var i=t,s=r[3]-1;this.outputShape=r;var u="float("+e+") + float("+n+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+i+"; j <= "+i+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+s+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(val);\n      }\n    "},ld=function(r,t,e,n,o){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=r,this.depth=r[3],this.depthRadius=t,this.bias=e,this.alpha=n,this.beta=o,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+t+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+t+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+n+") * norm + float("+e+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+n+")\n                * float("+o+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+o+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "},hd=function(r,t,e,n,o){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var i=t,s=r[3]-1;this.outputShape=r;var u="float("+e+") + float("+n+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+i+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+i+"; j <= "+i+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+s+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(result);\n      }\n    "},fd=function(r){this.variableNames=["dy","maxPos"],this.outputShape=r.inShape;var o=r.effectiveFilterHeight,a=r.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(o-1-r.padInfo.top)+", "+(a-1-r.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+o+";\n          wR += "+r.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+r.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+a+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(o*a-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+a+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},dd=function(r){this.variableNames=["dy","maxPos"],this.outputShape=r.inShape;var s=r.effectiveFilterDepth,u=r.effectiveFilterHeight,c=r.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(s-1-r.padInfo.front)+", "+(u-1-r.padInfo.top)+", "+(c-1-r.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+s+";\n           wD += "+r.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+r.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+r.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+r.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+r.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+r.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+r.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+r.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+r.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(s*u*c-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+u+" * "+c+" +\n                  wR * "+c+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Fa=function(r,t,e,n,o,a,i){void 0===e&&(e=!1),void 0===n&&(n=!1),void 0===o&&(o=!1),void 0===a&&(a=null),void 0===i&&(i=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t;var u=Math.ceil((e?r[1]:r[2])/2),c=e?"i * 2, rc.y":"rc.y, i * 2",l=n?"rc.z, i * 2":"i * 2, rc.z",h=e?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],f=n?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],d="",p="";a&&(d=i?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+a+"\n        }":"vec4 activation(vec4 x) {\n          "+a+"\n        }",p="result = activation(result);");var m=o?"result += getBiasAtOutCoords();":"";o&&this.variableNames.push("bias"),i&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+d+"\n\n      const float sharedDimension = "+u+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+u+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+c+");\n          vec4 b = getMatrixB(rc.x, "+l+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+h[0]+" * "+f[0]+");\n          result += ("+h[1]+" * "+f[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+m+"\n\n        "+p+"\n\n        setOutput(result);\n      }\n    "},pd=function(){function r(t,e,n){this.variableNames=["probs"],this.outputShape=[t,n],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(e-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(e-1)+"));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,o){null==e.seedLoc&&(e.seedLoc=n.getUniformLocation(o,"seed")),n.gl.uniform1f(e.seedLoc,t)}},r}(),vd=function(r,t,e,n){this.variableNames=["indices"],this.outputShape=[r,t],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+n+"), float("+e+"),\n                      float(index == coords.y)));\n      }\n    "},md=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=r;var s,c,l,t=r.length;if(0===t)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var e=ot("rc",t),n=Ce(t),o=function(s,u,c){if(1===s)return"rc > "+u[0];for(var l="",h=s-2;h<s;h++)l+=c[h]+" >= "+u[h],h<s-1&&(l+="||");return l}(t,r,e),a=function(s,u,c,l){if(1===s)return"";var h=l.slice(-2);return"\n    int r = "+h[0]+";\n    int c = "+h[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+u+";\n    bool rEdge = rp1 >= "+c+";\n  "}(t,r[r.length-1],r[r.length-2],e),i=(l=function(h,f){for(var d=[],p=0;p<=1;p++)for(var m=0;m<=1;m++){for(var v=(0===p?"r":"rp1")+", "+(0===m?"c":"cp1"),g=2;g<h;g++)v=f[f.length-1-g]+","+v;d.push(v)}return d}(c=(s=r).length,e),1===c?"getA(rc),\n            rc + 1 >= "+s[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+l[0]+"),\n          cEdge ? 0. : getA("+l[1]+"),\n          rEdge ? 0. : getA("+l[2]+"),\n          rEdge || cEdge ? 0. : getA("+l[3]+")");this.userCode="\n        void main() {\n          "+n+" rc = getOutputCoords();\n\n          if("+o+") {\n            setOutput(vec4(0));\n          } else {\n            "+a+"\n\n            setOutput(vec4("+i+"));\n          }\n        }\n      "}},gd=function(r,t,e){this.variableNames=["x"],this.outputShape=t.map(function(u,c){return u[0]+r[c]+u[1]});var n=r.length,o=Ce(n),a=t.map(function(u){return u[0]}).join(","),i=t.map(function(u,c){return u[0]+r[c]}).join(","),s=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,n);this.userCode=1!==n?"\n      "+o+" start = "+o+"("+a+");\n      "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+e+"));\n        } else {\n          "+o+" coords = outC - start;\n          setOutput(getX("+s+"));\n        }\n      }\n    ":"\n        int start = "+a+";\n        int end = "+i+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+e+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "},yd=function(r,t,e){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t.map(function(v,g){return v[0]+r[g]+v[1]});for(var n=r.length,o=Ce(n),a=t.map(function(v){return v[0]}).join(","),i=t.map(function(v,g){return v[0]+r[g]}).join(","),s=ot("rc",n),u=ot("source",n),c=s[n-1]+" < "+this.outputShape[n-1],l=1===n?"source":"vec2("+u.slice(-2).join()+")",h=[o+" rc = outputLoc;",s[n-1]+" += 1;\n       if("+c+") {\n      ",1===n?"":"}\n       rc = outputLoc;\n       "+s[n-2]+" += 1;\n       if("+s[n-2]+" < "+this.outputShape[n-2]+") {",1===n?"":"  "+s[n-1]+" += 1;\n         if("+c+") {"],f=1===n?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",d="",p=0,m=1===n?2:4;p<m;p++)d+="\n        "+h[p]+"\n        if ("+f+") {\n          result["+p+"] = float("+e+");\n        } else {\n          "+o+" source = rc - start;\n          result["+p+"] = getChannel(getX("+u.join()+"), "+l+");\n        }\n      ";this.userCode="\n      const "+o+" start = "+o+"("+a+");\n      const "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+(d+=1===n?"} ":"}}")+"\n        setOutput(result);\n      }\n    "},Na=function(r,t,e){if(this.variableNames=["x"],"avg"===t&&e)throw new Error("Cannot compute positions for average pool.");var n=r.filterWidth,o=r.strideHeight,a=r.strideWidth,i=r.dilationHeight,s=r.dilationWidth,u=r.effectiveFilterHeight,c=r.effectiveFilterWidth,l=r.padInfo.top,h=r.padInfo.left;this.outputShape=r.outShape;var f="avg"===t,d="0.0";if(f||(d="-1.0 / 1e-20"),e)this.userCode="\n        const ivec2 strides = ivec2("+o+", "+a+");\n        const ivec2 pads = ivec2("+l+", "+h+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+i+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+s+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+r.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+c+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var p=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===t&&(p="avgValue / count");var m=4*Math.floor(n/4),v=n%4,g="\n      if ("+f+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+o+", "+a+");\n      const ivec2 pads = ivec2("+l+", "+h+");\n      const float initializationValue = "+d+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+r.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+d+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+u+";\n            wR += "+i+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+r.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+m+"; wC += 4) {\n            int xC = xCCorner + wC * "+s+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              getValue(batch, xR, xC + 3 * "+s+", d)\n            );\n\n            "+g+"\n          }\n\n          int xC = xCCorner + "+m+";\n          if ("+(1===v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+g+"\n          } else if ("+(2===v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+g+"\n          } else if ("+(3===v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              initializationValue\n            );\n\n            "+g+"\n          }\n        }\n        setOutput("+p+");\n      }\n    "}},Pa=function(r,t,e){if(this.variableNames=["x"],"avg"===t&&e)throw new Error("Cannot compute positions for average pool.");var n=r.filterWidth,o=r.strideDepth,a=r.strideHeight,i=r.strideWidth,s=r.dilationDepth,u=r.dilationHeight,c=r.dilationWidth,l=r.effectiveFilterDepth,h=r.effectiveFilterHeight,f=r.effectiveFilterWidth,d=r.padInfo.front,p=r.padInfo.top,m=r.padInfo.left;this.outputShape=r.outShape;var v="avg"===t,g="0.0";if(v||(g="-1.0 / 1e-20"),e)this.userCode="\n        const ivec3 strides =\n            ivec3("+o+", "+a+", "+i+");\n        const ivec3 pads = ivec3("+d+", "+p+", "+m+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+l+";\n              wD += "+s+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+r.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+h+";\n                wR += "+u+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+r.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+f+";\n                  wC += "+c+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+r.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+h+" * "+f+" +\n                      wR * "+f+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var x=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===t&&(x="avgValue / count");var b=4*Math.floor(n/4),y=n%4,w="\n      if ("+v+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+d+", "+p+", "+m+");\n      const float initializationValue = "+g+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+r.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+g+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+s+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+r.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+";\n            wR += "+u+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+r.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+b+"; wC += 4) {\n              int xC = xCCorner + wC * "+c+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+c+", ch)\n              );\n\n              "+w+"\n            }\n\n            int xC = xCCorner + "+b+";\n            if ("+(1===y)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+w+"\n            } else if ("+(2===y)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+w+"\n            } else if ("+(3===y)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                initializationValue\n              );\n\n              "+w+"\n            }\n          }\n          setOutput("+x+");\n        }\n      }\n    "}},xd=function(r,t){this.variableNames=["x"];var e=r.windowSize,n=r.batchSize,o=r.inSize,a=Math.ceil(o/e);this.outputShape=[n,a];var i="0.0",s="";"prod"===t?i="1.0":"min"===t?(i="1.0 / 1e-20",s="min"):"max"===t&&(i="-1.0 / 1e-20",s="max");var u=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===t?u="sumValue":"prod"===t?u="prodValue":"all"===t?u="allValue":"any"===t&&(u="anyValue");var c=4*Math.floor(e/4),l=e%4,h="\n      if ("+("sum"===t)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===t)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+s+"(values, minMaxValue);\n      }\n    ",f="vec4";"all"===t?(i="1.0",h="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",f="bvec4"):"any"===t&&(i="0.0",h="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",f="bvec4");var d="";o%e>0&&(d="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+i+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+d+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+e+";\n\n        vec4 minMaxValue = vec4("+i+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+c+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+h+"\n        }\n\n        int inIdx = inOffset + "+c+";\n        if ("+(1===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(2===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(3===l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+h+"\n        }\n        setOutput("+u+");\n      }\n    "},bd=function(r,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r;for(var e="",n=0;n<4;n++){var o="thisRC = rc;";n%2==1&&(o+="thisRC.z += 1;"),n>1&&(o+="thisRC.y += 1;"),e+="\n        "+o+"\n        "+(n>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+n+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(n>0?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+En(["r","c","d"],t)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+Da(r)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+r[1]+";\n        int cols = "+r[2]+";\n\n        "+e+"\n\n        setOutput(result);\n      }\n    "},wd=function(r,t,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var n=t.shape,o=n[1],a=n[2],i=r.shape,s=i[1],u=i[2],c=[e&&s>1?o-1:o,e&&u>1?a-1:a],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],h=c[0]/l[0],f=c[1]/l[1],d=1/h,p=1/f,m=2*Math.ceil(d)+2,v=2*Math.ceil(p)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+d+");\n        const float invWidthScale = float("+p+");\n\n        const int winHeight = int("+m+");\n        const int winWidth = int("+v+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(o-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(a-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},_d=function(r,t,e,n){this.variableNames=["A"],this.outputShape=[];var a=r[1],i=r[2];this.outputShape=[r[0],t,e,r[3]];var u=[n&&t>1?a-1:a,n&&e>1?i-1:i],c=[n&&t>1?t-1:t,n&&e>1?e-1:e];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "},Cd=function(r,t,e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var a=r[1],i=r[2],s=r[3];this.outputShape=[r[0],t,e,s];var u=[n&&t>1?a-1:a,n&&e>1?i-1:i],c=[n&&t>1?t-1:t,n&&e>1?e-1:e];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+",\n          "+u[1]/c[1]+");\n      const vec3 inputShapeRC = vec3("+a+".0, "+i+".0,\n                                     "+i+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(s-1)+";\n        bool hasNextRow = coords.z < "+(e-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "},Ed=function(r,t,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var n=t.shape,o=n[1],a=n[2],i=r.shape,s=i[1],u=i[2],c=[e&&s>1?o-1:o,e&&u>1?a-1:a],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],h=c[0]/l[0],f=c[1]/l[1],d=1/h,p=1/f,m=2*Math.ceil(d)+2,v=2*Math.ceil(p)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+d+");\n        const float invWidthScale = float("+p+");\n\n        const int winHeight = int("+m+");\n        const int winWidth = int("+v+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+c[0]+") *\n                (float(dyR) / float("+l[0]+"));\n\n            float sourceFracCol =\n                float("+c[1]+") *\n                  (float(dyC) / float("+l[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+o+") - 1),\n                "+e+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+a+") - 1),\n                "+e+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},Id=function(r,t,e,n){this.variableNames=["A"],this.outputShape=[];var a=r[1],i=r[2];this.outputShape=[r[0],t,e,r[3]];var u=[n&&t>1?a-1:a,n&&e>1?i-1:i],c=[n&&t>1?t-1:t,n&&e>1?e-1:e];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(n?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "},Rd=function(r,t){this.variableNames=["x"];var e=r.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");if(this.outputShape=r,1!==e){var n=r.map(function(a,i){return-1!==t.indexOf(s=i)&&1!==r[s]?r[s]+" - coords["+s+"] - 1":"coords["+s+"]";var s}).join(","),o=Ce(e);this.userCode="\n      void main() {\n        "+o+" coords = getOutputCoords();\n        setOutput(getX("+n+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+r[0]+" - coord - 1));\n        }\n      "},kd=function(r,t){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var e=r.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");this.outputShape=r;var u,n=ot("rc",e),o=n[e-1]+" + 1 < "+this.outputShape[e-1],a=n[e-2]+" + 1 < "+this.outputShape[e-2],i=Ce(e);function s(u){var c=r.map(function(l,h){return d=u,-1!==t.indexOf(f=h)&&1!==r[f]?r[f]+" - "+d[f]+" - 1":""+d[f];var f,d});return"getChannel(getX("+c.join(",")+"), vec2("+c.slice(-2).join(",")+"))"}this.userCode=1===e?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+r[0]+" - rc - 1),\n            "+r[0]+" - rc - 1);\n          if("+o+"){\n              result.g = getChannel(getX("+r[0]+" - (rc  + 1) - 1),\n                "+r[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+i+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+s(n.slice())+";\n          if("+o+"){\n            result.g = "+((u=n.slice())[e-1]="("+u[e-1]+" + 1)",s(u)+";\n          }\n          if(")+a+") {\n            result.b = "+function(u){return u[e-2]="("+u[e-2]+" + 1)",s(u)}(n.slice())+";\n            if("+o+") {\n              result.a = "+function(u){return u[e-1]="("+u[e-1]+" + 1)",u[e-2]="("+u[e-2]+" + 1)",s(u)}(n.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "},tc=function(r,t,e,n,o,a,i){void 0===i&&(i=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=a;var s=Ce(o.length),u=Ce(a.length),c="";1===e?c="i":2===e&&(c="i, j");var h="";1===n?h="i":2===n&&(h="i, coords[1]"),this.userCode="\n        "+s+" strides = "+s+"("+o+");\n\n        void main() {\n          "+u+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+r+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+t+"; j++) {\n              int index = round(getIndices("+c+"));\n              flattenedIndex += index * "+(t>1?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += getUpdates("+h+");\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "},Sd=function(r,t){this.variableNames=["x","segmentIds"];var e=r.windowSize,n=r.batchSize,o=r.inSize,a=r.numSegments,i=a*Math.ceil(o/e);this.outputShape=[n,i];var s=4*Math.floor(e/4),u=e%4,c="\n        sumValue += dot(values, segFilter);\n    ",l="";o%e>0&&(l="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      ");var h="";o%e>0&&(h="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+l+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+h+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+a+")) * float("+e+"));\n        int currentSeg = int(mod(float(outIdx), float("+a+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+s+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+c+"\n        }\n\n        int inIdx = inOffset + "+s+";\n        if ("+(1===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+c+"\n        } else if ("+(2===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+c+"\n        } else if ("+(3===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+c+"\n        }\n        setOutput(sumValue);\n      }\n    "},Dd=function(r,t,e){var n,o;if(this.variableNames=["c","a","b"],this.outputShape=t,e>4)throw Error("Where for rank "+e+" is not yet supported");if(1===e)o="resRC",n="resRC";else{for(var a=["resRC.x","resRC.y","resRC.z","resRC.w"],i=[],s=[],u=0;u<t.length;u++)s.push(""+a[u]),u<r&&i.push(""+a[u]);n=i.join(),o=s.join()}var c=Ce(e);this.userCode="\n      void main() {\n        "+c+" resRC = getOutputCoords();\n        float cVal = getC("+n+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+o+"));\n        } else {\n          setOutput(getB("+o+"));\n        }\n      }\n    "},Ad=function(){function r(t){this.variableNames=["source"],this.outputShape=t,this.rank=t.length;var e,n=Ce(this.rank),o="uniform int start["+this.rank+"];",a=function(i){if(1===i)return"sourceLoc";if(i<=6)return Ma.slice(0,i).map(function(s){return"sourceLoc."+s}).join(",");throw Error("Slicing for rank "+i+" is not yet supported")}(this.rank);e="\n        "+n+" sourceLoc;\n        "+n+" coords = getOutputCoords();\n        "+t.map(function(i,s){return"sourceLoc."+Ma[s]+" = start["+s+"] + coords."+Ma[s]+";"}).join("\n")+"\n      ",this.userCode="\n      "+o+"\n      void main() {\n        "+e+"\n        setOutput(getSource("+a+"));\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,o){null==e.startLoc&&(e.startLoc=n.getUniformLocationNoThrow(o,"start"),null==e.startLoc)||n.gl.uniform1iv(e.startLoc,t)}},r}(),Ma=["x","y","z","w","u","v"],Td=function(){function r(t){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t,this.rank=t.length;var e=Ce(this.rank),n=ot("coords",this.rank),o=ot("sourceLoc",this.rank),a=1===this.rank?"sourceLoc":"vec2("+o.slice(-2).join()+")",i="getChannel(getSource("+o.join()+"), "+a+")",s="\n      result.x = "+i+";\n      if (++"+n[this.rank-1]+" < "+t[this.rank-1]+") {\n        ++"+o[this.rank-1]+";\n        result.y = "+i+";\n        --"+o[this.rank-1]+";\n      }\n    ",u=1===this.rank?"":"\n      --"+n[this.rank-1]+";\n      if (++"+n[this.rank-2]+" < "+t[this.rank-2]+") {\n        ++"+o[this.rank-2]+";\n        result.z = "+i+";\n        if (++"+n[this.rank-1]+" < "+t[this.rank-1]+") {\n          ++"+o[this.rank-1]+";\n          result.w = "+i+";\n        }\n      }\n    ",c=this.rank<=4?"sourceLoc = coords +\n            "+e+"("+t.map(function(l,h){return"start["+h+"]"}).join()+");":t.map(function(l,h){return o[h]+" = "+n[h]+" + start["+h+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+e+" coords = getOutputCoords();\n        "+e+" sourceLoc;\n        "+c+"\n        vec4 result = vec4(0.);\n        "+s+"\n        "+u+"\n        setOutput(result);\n      }\n    "}return r.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,o){null==e.startLoc&&(e.startLoc=n.getUniformLocationNoThrow(o,"start"),null==e.startLoc)||n.gl.uniform1iv(e.startLoc,t)}},r}(),Fd=function(r,t,e){this.variableNames=["x"],this.outputShape=e;var n=e.length,o=Ce(e.length),a=Ce(e.length),i="";if(1===n)i="coords * strides + begin";else{var s=0;i=e.map(function(u,c){return s++,1===e.length?"coords * strides["+c+"] + begin["+c+"]":"coords["+(s-1)+"] * strides["+c+"] + begin["+c+"]"}).join(",")}this.userCode="\n      "+o+" begin = "+o+"("+r+");\n      "+o+" strides = "+o+"("+t+");\n\n      void main() {\n        "+a+" coords = getOutputCoords();\n        setOutput(getX("+i+"));\n      }\n    "},Nd=function(){function r(t){this.gpgpu=t,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return r.prototype.acquireTexture=function(t,e,n){var o,a=nc(e,n),i=rc(t,a,n);if(i in this.freeTextures||(this.freeTextures[i]=[]),i in this.usedTextures||(this.usedTextures[i]=[]),this.freeTextures[i].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var s=this.freeTextures[i].shift();return this.usedTextures[i].push(s),s}return this.numUsedTextures++,this.log(),a===it.PACKED_2X2_FLOAT32?o=this.gpgpu.createPackedMatrixTexture(t[0],t[1]):a===it.PACKED_2X2_FLOAT16?o=this.gpgpu.createFloat16PackedMatrixTexture(t[0],t[1]):a===it.UNPACKED_FLOAT32?o=this.gpgpu.createFloat32MatrixTexture(t[0],t[1]):a===it.UNPACKED_FLOAT16?o=this.gpgpu.createFloat16MatrixTexture(t[0],t[1]):a===it.PACKED_4X1_UNSIGNED_BYTE&&(o=this.gpgpu.createUnsignedBytesMatrixTexture(t[0],t[1])),this.usedTextures[i].push(o),o},r.prototype.releaseTexture=function(t,e,n,o){if(null!=this.freeTextures){var a=rc(e,nc(n,o),o);a in this.freeTextures||(this.freeTextures[a]=[]),this.freeTextures[a].push(t),this.numFreeTextures++,this.numUsedTextures--;var i=this.usedTextures[a],s=i.indexOf(t);if(s<0)throw new Error("Cannot release a texture that was never provided by this texture manager");i.splice(s,1),this.log()}},r.prototype.log=function(){this.logEnabled&&console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+(this.numFreeTextures+this.numUsedTextures)+")")},r.prototype.getNumUsedTextures=function(){return this.numUsedTextures},r.prototype.getNumFreeTextures=function(){return this.numFreeTextures},r.prototype.dispose=function(){var t=this;if(null!=this.freeTextures){for(var e in this.freeTextures)this.freeTextures[e].forEach(function(n){t.gpgpu.deleteMatrixTexture(n)});for(var e in this.usedTextures)this.usedTextures[e].forEach(function(o){t.gpgpu.deleteMatrixTexture(o)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},r}();function nc(r,t){if(r===at.UPLOAD)return it.PACKED_2X2_FLOAT32;if(r===at.RENDER||null==r)return e=t,M().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?e?it.PACKED_2X2_FLOAT32:it.UNPACKED_FLOAT32:e?it.PACKED_2X2_FLOAT16:it.UNPACKED_FLOAT16;var e;if(r===at.DOWNLOAD||r===at.PIXELS)return it.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+r)}function rc(r,t,e){return r[0]+"_"+r[1]+"_"+t+"_"+e}var Pd=function(r,t){this.variableNames=["A"];for(var e=new Array(r.length),n=0;n<e.length;n++)e[n]=r[n]*t[n];this.outputShape=e,this.rank=e.length;var o=Ce(this.rank),a=function(i){var s=i.length;if(s>5)throw Error("Tile for rank "+s+" is not yet supported");if(1===s)return"imod(resRC, "+i[0]+")";for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],c=[],l=0;l<i.length;l++)c.push("imod("+u[l]+", "+i[l]+")");return c.join()}(r);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},Md=function(r,t){this.variableNames=["A"];for(var e=new Array(r.length),n=0;n<e.length;n++)e[n]=r[t[n]];this.outputShape=e,this.rank=e.length;var o=Ce(this.rank),a=function(i){var s=i.length;if(s>6)throw Error("Transpose for rank "+s+" is not yet supported");for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],c=new Array(s),l=0;l<i.length;l++)c[i[l]]=u[l];return c.join()}(t);this.userCode="\n    void main() {\n      "+o+" resRC = getOutputCoords();\n      setOutput(getA("+a+"));\n    }\n    "},Od=function(r,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var e=new Array(r.length),n=0;n<e.length;n++)e[n]=r[t[n]];if(this.outputShape=e,this.rank=e.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var o=Ce(this.rank),a=Iu("rc",this.rank),i=new Array(this.rank);for(n=0;n<t.length;n++)i[t[n]]=a[n];var s="vec2("+i.slice(-2).join()+")",u="++"+a[this.rank-1]+" < "+e[this.rank-1],c="getChannel(getA("+i.join()+"), "+s+")";this.userCode="\n    void main() {\n      "+o+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+c+";\n      if("+u+") {\n        result[1] = "+c+";\n      }\n      --"+a[this.rank-1]+";\n      if(++"+a[this.rank-2]+" < "+e[this.rank-2]+") {\n        result[2] = "+c+";\n        if("+u+") {\n          result[3] = "+c+";\n        }\n      }\n      setOutput(result);\n    }\n    "},Oa=1.7580993408473768,Ba=1.0507009873554805,ie=function(r,t){this.variableNames=["A"],this.outputShape=r,this.userCode="\n      float unaryOperation(float x) {\n        "+t+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},_t="if (isnan(x)) return x;",oc="return abs(x);",ac=_t+"\n  return (x < 0.0) ? 0.0 : x;\n",ic=_t+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",sc="return (x >= 0.0) ? x : (exp(x) - 1.0);",Ld="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+Oa+";\n  float scale = "+Ba+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",uc="return -x;",cc="return ceil(x);",lc="return floor(x);",hc="return exp(x);",fc="return exp(x) - 1.0;",Wd=_t+"\n  return sin(x);\n",zd=_t+"\n  return cos(x);\n",Vd=_t+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n",Ud=_t+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n",Gd=_t+"\n  return atan(x);\n",Hd=_t+"return log(x + sqrt(x * x + 1.0));",jd=_t+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",qd=_t+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",ho="return x;",dc="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",pc="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",vc="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",kr=function(r,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=r,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+t+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Xd=function(r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=r;var t=r.length,e=ot("rc",t),n=Ce(t),o=function(s,u){if(1===s)return"rc";for(var c="",l=0;l<s;l++)c+=u[l],l<s-1&&(c+=",");return c}(t,e),a=e.slice(-2),i=t<=1?"rc":"vec2("+a.join(",")+")";this.userCode="\n      void main() {\n        "+n+" rc = getOutputCoords();\n        vec4 packedInput = getA("+o+");\n\n        setOutput(getChannel(packedInput, "+i+"));\n      }\n    "},fo={};function po(r,t){if(void 0===t&&(t=!1),"linear"===r)return"return x;";if("relu"===r)return t?dc:ac;if("elu"===r)return t?vc:sc;if("relu6"===r)return t?pc:ic;if("prelu"===r)return t?Tu:Au;throw new Error("Activation "+r+" has not been implemented for the WebGL backend.")}var mc=function(r){function t(e){var n,o=r.call(this)||this;if(o.pendingRead=new WeakMap,o.pendingDisposal=new WeakSet,o.dataRefCount=new WeakMap,o.numBytesInGPU=0,o.uploadWaitMs=0,o.downloadWaitMs=0,o.warnedAboutMemory=!1,o.pendingDeletes=0,o.disposed=!1,!M().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==e){var a=Rt(M().getNumber("WEBGL_VERSION"));o.binaryCache=((n=M().getNumber("WEBGL_VERSION"))in fo||(fo[n]={}),fo[n]),o.gpgpu=new Zu(a),o.canvas=a.canvas,o.gpgpuCreatedLocally=!0}else o.gpgpu=e,o.binaryCache={},o.gpgpuCreatedLocally=!1,o.canvas=e.gl.canvas;return o.textureManager=new Nd(o.gpgpu),o.numMBBeforeWarning=null==M().global.screen?1024:M().global.screen.height*M().global.screen.width*window.devicePixelRatio*600/1024/1024,o.texData=new gu(o,D),o}return mt(t,r),t.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},t.prototype.write=function(e,n,o){if(M().getBool("DEBUG")&&this.checkNumericalProblems(e),"complex64"===o&&null!=e)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var a={};return this.texData.set(a,{shape:n,dtype:o,values:e,usage:at.UPLOAD}),a},t.prototype.move=function(e,n,o,a){if(M().getBool("DEBUG")&&this.checkNumericalProblems(n),"complex64"===a)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:o,dtype:a,values:n,usage:at.UPLOAD})},t.prototype.readSync=function(e){var n=this.texData.get(e),o=n.values,a=n.dtype,i=n.complexTensors,u=n.shape;if(null!=n.slice){var l;l=n.isPacked?new kr(u,ho):new ie(u,ho);var h=this.runWebGLProgram(l,[{dataId:e,shape:u,dtype:a}],a),f=this.readSync(h.dataId);return this.disposeData(h.dataId),f}if(null!=o)return this.convertAndCacheOnCPU(e);if("string"===a)return o;var d,p,m=null!=this.activeTimers;return m&&(d=yt()),p="complex64"===a?Ia(i.real.dataSync(),i.imag.dataSync()):this.getValuesFromTexture(e),m&&(this.downloadWaitMs+=yt()-d),this.convertAndCacheOnCPU(e,p)},t.prototype.read=function(e){return Y(this,void 0,void 0,function(){var n,o,a,i,u,c,l,h,f,d,p,m,v,g,x,w,C,S,k;return $(this,function(I){switch(I.label){case 0:if(this.pendingRead.has(e))return n=this.pendingRead.get(e),[2,new Promise(function(R){return n.push(R)})];if(o=this.texData.get(e),a=o.values,i=o.shape,u=o.dtype,c=o.complexTensors,l=o.isPacked,null!=o.slice)return h=l?new kr(i,ho):new ie(i,ho),f=this.runWebGLProgram(h,[{dataId:e,shape:i,dtype:u}],u),d=this.read(f.dataId),this.disposeData(f.dataId),[2,d];if(null!=a)return[2,this.convertAndCacheOnCPU(e)];if(!M().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===M().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return p=null,"complex64"!==u&&M().get("WEBGL_BUFFER_SUPPORTED")&&(m=this.decode(e),v=this.texData.get(m.dataId),p=(k=this.gpgpu).createBufferFromTexture.apply(k,[v.texture].concat(pr(i)))),this.pendingRead.set(e,[]),"complex64"===u?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:I.sent(),I.label=2;case 2:return"complex64"!==u?[3,4]:[4,Promise.all([c.real.data(),c.imag.data()])];case 3:return x=I.sent(),g=Ia(x[0],x[1]),[3,5];case 4:null==p?g=this.getValuesFromTexture(e):(w=Q(i),g=this.gpgpu.downloadFloat32MatrixFromBuffer(p,w)),I.label=5;case 5:return null!=m&&this.disposeData(m.dataId),C=this.convertAndCacheOnCPU(e,g),S=this.pendingRead.get(e),this.pendingRead.delete(e),S.forEach(function(R){return R(C)}),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e),this.pendingDeletes--),[2,C]}})})},t.prototype.checkNumericalProblems=function(e){if(null!=e)for(var n=0;n<e.length;n++){var o=e[n];if(!As(o))throw M().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error("The value "+o+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'"):Error("The value "+o+" cannot be represented on this device.")}},t.prototype.getValuesFromTexture=function(e){var n,o=this.texData.get(e),a=o.shape,i=o.dtype,s=o.isPacked,u=Q(a);if(M().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var c=this.decode(e),l=this.texData.get(c.dataId),h=(n=this.gpgpu).downloadMatrixFromPackedTexture.apply(n,[l.texture].concat(pr(a))).subarray(0,u);return this.disposeData(c.dataId),h}var f=M().getBool("WEBGL_PACK")&&!0===s,d=f?Xr(a):a,p=f?new Zf(d):new Jf(d),m=this.runWebGLProgram(p,[{shape:d,dtype:i,dataId:e}],"float32"),v=this.texData.get(m.dataId),g=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(v.texture,v.texShape[0],v.texShape[1]).subarray(0,u);return this.disposeData(m.dataId),g},t.prototype.time=function(e){return Y(this,void 0,void 0,function(){var n,o,a,i,s,u,c;return $(this,function(l){switch(l.label){case 0:return n=this.activeTimers,o=[],a=!1,null==this.programTimersStack?(this.programTimersStack=o,a=!0):this.activeTimers.push(o),this.activeTimers=o,e(),i=Wt(this.activeTimers.map(function(h){return h.query})).filter(function(h){return null!=h}),s=Wt(this.activeTimers.map(function(h){return h.name})).filter(function(h){return null!=h}),this.activeTimers=n,a&&(this.programTimersStack=null),u={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[4,Promise.all(i)]:[3,2];case 1:return c=l.sent(),u.kernelMs=hs(c),u.getExtraProfileInfo=function(){return c.map(function(h,f){return{name:s[f],ms:h}}).map(function(h){return h.name+": "+h.ms}).join(", ")},[3,3];case 2:u.kernelMs={error:"WebGL query timers are not supported in this environment."},l.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,u]}})})},t.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},t.prototype.startTimer=function(){return M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:yt(),endMs:null}},t.prototype.endTimer=function(e){return M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),e):(e.endMs=yt(),e)},t.prototype.getQueryTime=function(e){return Y(this,void 0,void 0,function(){var n;return $(this,function(o){return M().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[2,this.gpgpu.waitForQueryAndGetTime(e)]:[2,(n=e).endMs-n.startMs]})})},t.prototype.disposeData=function(e){if(!this.pendingDisposal.has(e)){if(this.pendingRead.has(e))return this.pendingDisposal.add(e),void this.pendingDeletes++;if(this.texData.has(e)){this.releaseGPUData(e);var n=this.texData.get(e).complexTensors;null!=n&&(n.real.dispose(),n.imag.dispose()),this.texData.delete(e)}}},t.prototype.releaseGPUData=function(e){var n=this.texData.get(e),o=n.texture,a=n.dtype,i=n.texShape,s=n.usage,u=n.isPacked,c=n.slice,l=c&&c.origDataId||e,h=this.dataRefCount.get(l);h>1?this.dataRefCount.set(l,h-1):(this.dataRefCount.delete(l),null!=o&&(this.numBytesInGPU-=this.computeBytes(i,a),this.textureManager.releaseTexture(o,i,s,u)));var f=this.texData.get(e);f.texture=null,f.texShape=null,f.isPacked=!1,f.slice=null},t.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},t.prototype.getDataInfo=function(e){return this.texData.get(e)},t.prototype.getCPUBackend=function(){return M().getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=D.findBackend("cpu")),this.cpuBackend):null},t.prototype.shouldExecuteOnCPU=function(e,n){var o=this;return void 0===n&&(n=128),null!=this.getCPUBackend()&&e.every(function(a){return null==o.texData.get(a.dataId).texture&&a.size<n})},t.prototype.getGPGPUContext=function(){return this.gpgpu},t.prototype.complex=function(e,n){var o=this.makeOutput(e.shape,"complex64");return this.texData.get(o.dataId).complexTensors={real:D.keep(e.clone()),imag:D.keep(n.clone())},o},t.prototype.real=function(e){return this.texData.get(e.dataId).complexTensors.real.clone()},t.prototype.imag=function(e){return this.texData.get(e.dataId).complexTensors.imag.clone()},t.prototype.slice=function(e,n,o){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,n,o);if(0===Q(o))return Ke([],o,e.dtype);var a=this.texData.get(e.dataId).isPacked,i=xa(e.shape,n,o);if(a||!i){var s=M().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Td(o):new Ad(o),u=s.getCustomSetupFunc(n);return this.compileAndRun(s,[e],null,u)}return this.uploadToGPU(e.dataId),this.shallowSlice(e,n,o)},t.prototype.shallowSlice=function(e,n,o){var a=this.texData.get(e.dataId),i=this.makeOutput(o,e.dtype),s=this.texData.get(i.dataId);Object.assign(s,a),s.shape=o,s.dtype=e.dtype;var u=ba(n,e.strides);a.slice&&(u+=a.slice.flatOffset),s.slice={flatOffset:u,origDataId:a.slice&&a.slice.origDataId||e.dataId};var c=this.dataRefCount.get(s.slice.origDataId)||1;return this.dataRefCount.set(s.slice.origDataId,c+1),i},t.prototype.stridedSlice=function(e,n,o,a){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.stridedSlice(e,n,o,a);var i=oo(n,o,a);if(i.some(function(u){return 0===u}))return Ke([],i);var s=new Fd(n,a,i);return this.compileAndRun(s,[e])},t.prototype.reverse=function(e,n){var o=M().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new kd(e.shape,n):new Rd(e.shape,n);return this.compileAndRun(o,[e])},t.prototype.concat=function(e,n){if("complex64"===e[0].dtype){var o=e.map(function(d){return ft(d)}),a=e.map(function(d){return St(d)});return qe(this.concat(o,n),this.concat(a,n))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,n);if(1===e.length)return e[0];if(e.length>M().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var i=Math.floor(e.length/2),s=this.concat(e.slice(0,i),n),u=this.concat(e.slice(i),n);return this.concat([s,u],n)}if(M().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&e[0].rank>1){var c=new Lf(e.map(function(d){return d.shape}),n);return this.compileAndRun(c,e)}var l=xn(e.map(function(d){return d.shape}),n),h=e.map(function(d){return d.as2D(-1,Q(d.shape.slice(n)))}),f=new Bf(h.map(function(d){return d.shape}));return this.compileAndRun(f,h).reshape(l)},t.prototype.neg=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.neg(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,uc,e.dtype);var n=new ie(e.shape,uc);return this.compileAndRun(n,[e])},t.prototype.batchMatMul=function(e,n,o,a){var i=o?e.shape[2]:e.shape[1],s=a?n.shape[1]:n.shape[2],u=o?e.shape[1]:e.shape[2],c=e.shape[0];if((1===i||1===s)&&u>1e3){o&&(e=e.transpose([0,2,1])),a&&(n=n.transpose([0,2,1]));var l=1===s?e:e.as3D(c,u,1),h=1===s?2:1,f=1===s?n.as3D(c,1,u):n;return this.multiply(l,f).sum(h,!0)}var d=Ve(e.dtype,n.dtype),p=new Fa(e.shape,[c,i,s],o,a);return this.compileAndRun(p,[e,n],d)},t.prototype.fusedBatchMatMul=function(e){var n=e.a,o=e.b,a=e.transposeA,i=e.transposeB,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=a?n.shape[2]:n.shape[1],h=i?o.shape[1]:o.shape[2],f=n.shape[0],d=Ve(n.dtype,o.dtype),p=null!=s,m=null!=c,v=u?po(u,!0):null,g=new Fa(n.shape,[f,l,h],a,i,p,v,m),x=[n,o];return s&&x.push(s),c&&x.push(c),this.compileAndRun(g,x,d)},t.prototype.multiply=function(e,n){if("complex64"===e.dtype){var o=this.texData.get(e.dataId),a=this.texData.get(n.dataId),i=new Su("return areal * breal - aimag * bimag;",e.shape,n.shape),s=new Su("return areal * bimag + aimag * breal;",e.shape,n.shape),u=[this.makeComplexComponentTensorInfo(e,o.complexTensors.real),this.makeComplexComponentTensorInfo(e,o.complexTensors.imag),this.makeComplexComponentTensorInfo(n,a.complexTensors.real),this.makeComplexComponentTensorInfo(n,a.complexTensors.imag)],c=this.compileAndRun(i,u),l=this.compileAndRun(s,u),h=this.complex(c,l);return c.dispose(),l.dispose(),h}if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.multiply(e,n);if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Du,e.dtype);var f=new Ae(Du,e.shape,n.shape);return this.compileAndRun(f,[e,n],e.dtype)},t.prototype.batchNormalization=function(e,n,o,a,i,s){var u=[e,n,o],c=null;null!=s&&(c=s.shape,u.push(s));var l=null;if(null!=i&&(l=i.shape,u.push(i)),M().getBool("WEBGL_PACK_NORMALIZATION")){var h=new Tf(e.shape,n.shape,o.shape,c,l,a);return this.compileAndRun(h,u)}var f=new Af(e.shape,n.shape,o.shape,c,l,a);return this.compileAndRun(f,u)},t.prototype.localResponseNormalization4D=function(e,n,o,a,i){var s=M().getBool("WEBGL_PACK_NORMALIZATION")?new hd(e.shape,n,o,a,i):new cd(e.shape,n,o,a,i);return this.compileAndRun(s,[e])},t.prototype.LRNGrad=function(e,n,o,a,i,s,u){var c=new ld(n.shape,a,i,s,u);return this.compileAndRun(c,[n,o,e])},t.prototype.tile=function(e,n){if("string"===e.dtype){var o=this.readSync(e.dataId).map(function(i){return ur(i)});return Cu(ae(e.shape,e.dtype,o),n)}var a=new Pd(e.shape,n);return this.compileAndRun(a,[e])},t.prototype.pad=function(e,n,o){var a=M().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new yd(e.shape,n,o):new gd(e.shape,n,o);return this.compileAndRun(a,[e])},t.prototype.transpose=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,n);var o=M().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Od(e.shape,n):new Md(e.shape,n);return this.compileAndRun(o,[e])},t.prototype.gather=function(e,n,o){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.gather(e,n,o);var a=new ad(e.shape,n.size,o);return this.compileAndRun(a,[e,n])},t.prototype.batchToSpaceND=function(e,n,o){E(e.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var a=n.reduce(function(h,f){return h*f}),i=eo(e.shape,n,a),s=to(i.length,n.length),u=no(e.shape,n,a),c=lu(o,n.length),l=hu(u,o,n.length);return e.reshape(i).transpose(s).reshape(u).slice(c,l)},t.prototype.spaceToBatchND=function(e,n,o){E(e.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var a=n.reduce(function(f,d){return f*d}),i=[[0,0]];i.push.apply(i,o);for(var s=1+n.length;s<e.shape.length;++s)i.push([0,0]);var u=e.pad(i),c=eo(u.shape,n,a,!1),l=to(c.length,n.length,!1),h=no(u.shape,n,a,!1);return u.reshape(c).transpose(l).reshape(h)},t.prototype.reduce=function(e,n,o){var a=e.shape[0],i=e.shape[1],s=ro(i),u=new xd({windowSize:s,inSize:i,batchSize:a},n),c=this.compileAndRun(u,[e],o);return 1===c.shape[1]?c:this.reduce(c,n,o)},t.prototype.argReduce=function(e,n,o){void 0===o&&(o=null);var a=e.shape[0],i=e.shape[1];null!=o&&(a=o.shape[0],i=o.shape[1]);var s=ro(i),u=new wf({windowSize:s,inSize:i,batchSize:a},n,null==o),c=[e];null!=o&&c.push(o);var l=this.compileAndRun(u,c,"int32");return 1===l.shape[1]?l:this.argReduce(e,n,l)},t.prototype.argReducePacked=function(e,n,o){void 0===o&&(o=null);var a=null!=o?o.shape:e.shape,i=ro(a[a.length-1]),s=new kf(a,i,n,null==o),c=this.compileAndRun(s,null==o?[e]:[e,o],"int32");return c.rank===e.rank?this.argReducePacked(e,n,c):c},t.prototype.sum=function(e,n){nt("sum",n,e.rank);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i),u=na(e.dtype);return this.reduce(s,"sum",u).reshape(a)},t.prototype.prod=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.prod(e,n);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i),u=na(e.dtype);return this.reduce(s,"prod",u).reshape(a)},t.prototype.unsortedSegmentSum=function(e,n,o){var a=0,i=xt([a],e.rank),s=e;null!=i&&(s=e.transpose(i),a=bt(1,e.rank)[0]);var u=function(d,p,m){for(var v=[],g=d.length,x=0;x<g;x++)v.push(x!==p?d[x]:m);return v}(s.shape,a,o),c=Q([s.shape[a]]),l=s.as2D(-1,c),h=na(e.dtype),f=this.segOpCompute(l,"unsortedSegmentSum",n,h,o).reshape(u);return null!=i&&(f=f.transpose(Qr(i))),f},t.prototype.segOpCompute=function(e,n,o,a,i){var s=e.shape[0],u=e.shape[1],c=function(f,d){var p,m=!1;for(f<=30?(p=f,m=!0):p=Ur(f,Math.floor(Math.sqrt(f)));!m;)p>d||p===f?m=!0:p=Ur(f,p+1);return p}(u,i),l=new Sd({windowSize:c,inSize:u,batchSize:s,numSegments:i},n),h=this.compileAndRun(l,[e,o],a);return h.shape[1]===i?h:(o=Jr(0,i).tile([u/c]),this.segOpCompute(h,n,o,a,i))},t.prototype.argMinMaxReduce=function(e,n,o){var a=[n];if(nt("arg"+o.charAt(0).toUpperCase()+o.slice(1),a,e.rank),!M().getBool("WEBGL_PACK_REDUCE")||e.rank<=2){var i=je(e.shape,a),s=i[0],u=Q(i[1]),c=e.as2D(-1,u);return this.argReduce(c,o).reshape(s)}return this.argReducePacked(e,o)},t.prototype.argMin=function(e,n){return this.argMinMaxReduce(e,n,"min")},t.prototype.argMax=function(e,n){return this.argMinMaxReduce(e,n,"max")},t.prototype.cumsum=function(e,n,o,a){if(n!==e.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(e.rank-1)+" but got axis="+n);var i=new Kf(e.shape,o,a);return this.compileAndRun(i,[e])},t.prototype.equal=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(equal(a, b));\n","bool");var o=new Ae("return float(a == b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.notEqual=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(notEqual(a, b));\n","bool");var o=new Ae("return float(a != b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.less=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.less(e,n);if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThan(a, b));\n","bool");var o=new Ae("return float(a < b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.lessEqual=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThanEqual(a, b));\n","bool");var o=new Ae("return float(a <= b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.greater=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.greater(e,n);if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThan(a, b));\n","bool");var o=new Ae("return float(a > b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.greaterEqual=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var o=new Ae("return float(a >= b);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.logicalNot=function(e){var n=new ie(e.shape,"return float(!(x >= 1.0));");return this.compileAndRun(n,[e])},t.prototype.logicalAnd=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var o=new Ae("return float(a >= 1.0 && b >= 1.0);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.logicalOr=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var o=new Ae("return float(a >= 1.0 || b >= 1.0);",e.shape,n.shape);return this.compileAndRun(o,[e,n],"bool")},t.prototype.select=function(e,n,o){var a=new Dd(e.rank,n.shape,n.rank);return this.compileAndRun(a,[e,n,o],Ve(n.dtype,o.dtype))},t.prototype.where=function(e){$r("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var n=e.dataSync();return Sa(e.shape,n)},t.prototype.topk=function(e,n,o){return Eu(e.dataSync(),e.shape,e.dtype,n)},t.prototype.min=function(e,n){nt("min",n,e.rank);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i);return this.reduce(s,"min",s.dtype).reshape(a)},t.prototype.minimum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.minimum(e,n);var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Ae("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.mod=function(e,n){var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Ae("if (b == 0.0) return NAN;\n  return mod(a, b);",e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.max=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.max(e,n);nt("max",n,e.rank);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i);return this.reduce(s,"max",s.dtype).reshape(a)},t.prototype.maximum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.maximum(e,n);var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Ae("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.all=function(e,n){nt("all",n,e.rank);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i);return this.reduce(s,"all",s.dtype).reshape(a)},t.prototype.any=function(e,n){nt("any",n,e.rank);var o=je(e.shape,n),a=o[0],i=Q(o[1]),s=e.as2D(-1,i);return this.reduce(s,"any",s.dtype).reshape(a)},t.prototype.realDivide=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var o=new Ae("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",e.shape,n.shape);return this.compileAndRun(o,[e,n],"float32")},t.prototype.floorDiv=function(e,n){if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var o=new Ae("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",e.shape,n.shape);return this.compileAndRun(o,[e,n],"int32")},t.prototype.add=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,Aa);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.add(e,n);var o=Ve(e.dtype,n.dtype);if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Aa,o);var a=new Ae(Aa,e.shape,n.shape);return this.compileAndRun(a,[e,n],o)},t.prototype.packedUnaryOp=function(e,n,o){var a=new kr(e.shape,n);return this.compileAndRun(a,[e],o)},t.prototype.packedBinaryOp=function(e,n,o,a,i){void 0===i&&(i=!1);var s=new Ht(o,e.shape,n.shape,i);return this.compileAndRun(s,[e,n],a)},t.prototype.complexSeparableBinaryOp=function(e,n,o){var a=this,i=this.texData.get(e.dataId),s=this.texData.get(n.dataId),u=[[i.complexTensors.real,s.complexTensors.real],[i.complexTensors.imag,s.complexTensors.imag]].map(function(f){var d=f[0],p=f[1],m=a.makeComplexComponentTensorInfo(e,d),v=a.makeComplexComponentTensorInfo(n,p),g=new Ae(o,e.shape,n.shape);return a.compileAndRun(g,[m,v],Ve(d.dtype,p.dtype))}),c=u[0],l=u[1],h=this.complex(c,l);return c.dispose(),l.dispose(),h},t.prototype.makeComplexComponentTensorInfo=function(e,n){return{dataId:n.dataId,dtype:n.dtype,shape:e.shape}},t.prototype.addN=function(e){if(1===e.length)return e[0];if(e.length>M().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var n=Math.floor(e.length/2),o=this.addN(e.slice(0,n)),a=this.addN(e.slice(n));return this.addN([o,a])}var i=e.map(function(c){return c.dtype}).reduce(function(c,l){return Ve(c,l)}),s=e.map(function(c){return c.shape}),u=M().getBool("WEBGL_PACK")?new bf(e[0].shape,s):new xf(e[0].shape,s);return this.compileAndRun(u,e,i)},t.prototype.subtract=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,Ta);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.subtract(e,n);var o=Ve(e.dtype,n.dtype);if(M().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Ta,e.dtype);var a=new Ae(Ta,e.shape,n.shape);return this.compileAndRun(a,[e,n],o)},t.prototype.pow=function(e,n){var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Ae("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",e.shape,n.shape),a=Ve(e.dtype,n.dtype);return this.compileAndRun(o,[e,n],a)},t.prototype.ceil=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.ceil(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,cc,e.dtype);var n=new ie(e.shape,cc);return this.compileAndRun(n,[e])},t.prototype.floor=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.floor(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,lc,e.dtype);var n=new ie(e.shape,lc);return this.compileAndRun(n,[e])},t.prototype.sign=function(e){var n=new ie(e.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(n,[e])},t.prototype.isNaN=function(e){var n=new ie(e.shape,"return float(isnan(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.isInf=function(e){var n=new ie(e.shape,"return float(isinf(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.isFinite=function(e){var n=new ie(e.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.round=function(e){var n=new ie(e.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(n,[e])},t.prototype.exp=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.exp(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,hc,e.dtype);var n=new ie(e.shape,hc);return this.compileAndRun(n,[e])},t.prototype.expm1=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.expm1(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,fc,e.dtype);var n=new ie(e.shape,fc);return this.compileAndRun(n,[e])},t.prototype.softmax=function(e,n){var o=Pe([n],e.shape),a=this.max(e,o),i=Ze(a.shape,o),s=this.subtract(e,a.reshape(i)),u=this.exp(s),c=this.sum(u,o).reshape(i);return this.realDivide(u,c)},t.prototype.log=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.log(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",e.dtype);var n=new ie(e.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(n,[e])},t.prototype.log1p=function(e){var n=new ie(e.shape,"return log(1.0 + x);");return this.compileAndRun(n,[e])},t.prototype.sqrt=function(e){var n=new ie(e.shape,"return sqrt(x);");return this.compileAndRun(n,[e])},t.prototype.rsqrt=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.rsqrt(e);var n=new ie(e.shape,"return inversesqrt(x);");return this.compileAndRun(n,[e])},t.prototype.reciprocal=function(e){var n=new ie(e.shape,"return 1.0 / x;");return this.compileAndRun(n,[e])},t.prototype.relu=function(e){var n;return n=M().getBool("WEBGL_PACK")?new kr(e.shape,dc):new ie(e.shape,ac),this.compileAndRun(n,[e])},t.prototype.relu6=function(e){var n;return n=M().getBool("WEBGL_PACK")?new kr(e.shape,pc):new ie(e.shape,ic),this.compileAndRun(n,[e])},t.prototype.prelu=function(e,n){var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht(Tu,e.shape,n.shape):new Ae(Au,e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.elu=function(e){if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,vc,e.dtype);var n=new ie(e.shape,sc);return this.compileAndRun(n,[e])},t.prototype.eluDer=function(e,n){var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",e.shape,n.shape):new Ae("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.selu=function(e){var n=new ie(e.shape,Ld);return this.compileAndRun(n,[e])},t.prototype.int=function(e){var n=new ie(e.shape,"return float(int(x));");return this.compileAndRun(n,[e],"int32")},t.prototype.clip=function(e,n,o){var a,i=(a=M().getBool("WEBGL_PACK_CLIP")?new Mf(e.shape):new Pf(e.shape)).getCustomSetupFunc(n,o);return this.compileAndRun(a,[e],null,i)},t.prototype.abs=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.abs(e);if(M().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,oc,e.dtype);var n=new ie(e.shape,oc);return this.compileAndRun(n,[e])},t.prototype.complexAbs=function(e){var n=this.texData.get(e.dataId),o=new Of(e.shape),a=[this.makeComplexComponentTensorInfo(e,n.complexTensors.real),this.makeComplexComponentTensorInfo(e,n.complexTensors.imag)];return this.compileAndRun(o,a)},t.prototype.sigmoid=function(e){var n=new ie(e.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(n,[e])},t.prototype.softplus=function(e){var n=new ie(e.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(n,[e])},t.prototype.sin=function(e){var n=new ie(e.shape,Wd);return this.compileAndRun(n,[e])},t.prototype.cos=function(e){var n=new ie(e.shape,zd);return this.compileAndRun(n,[e])},t.prototype.tan=function(e){var n=new ie(e.shape,"return tan(x);");return this.compileAndRun(n,[e])},t.prototype.asin=function(e){var n=new ie(e.shape,Vd);return this.compileAndRun(n,[e])},t.prototype.acos=function(e){var n=new ie(e.shape,Ud);return this.compileAndRun(n,[e])},t.prototype.atan=function(e){var n=new ie(e.shape,Gd);return this.compileAndRun(n,[e])},t.prototype.atan2=function(e,n){var o=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Ae("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",e.shape,n.shape);return this.compileAndRun(o,[e,n])},t.prototype.sinh=function(e){var n=new ie(e.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(n,[e])},t.prototype.cosh=function(e){var n=new ie(e.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(n,[e])},t.prototype.tanh=function(e){var n=new ie(e.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(n,[e])},t.prototype.asinh=function(e){var n=new ie(e.shape,Hd);return this.compileAndRun(n,[e])},t.prototype.acosh=function(e){var n=new ie(e.shape,jd);return this.compileAndRun(n,[e])},t.prototype.atanh=function(e){var n=new ie(e.shape,qd);return this.compileAndRun(n,[e])},t.prototype.erf=function(e){var n=new ie(e.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(n,[e])},t.prototype.step=function(e,n){var a,o=new ie(e.shape,(void 0===(a=n)&&(a=0),_t+"\n    return x > 0.0 ? 1.0 : float("+a+");\n  "));return this.compileAndRun(o,[e])},t.prototype.conv2dByMatMul=function(e,n,o,a,i,s){var u=e.shape,c=this.texData.get(e.dataId),d="channelsLast"===o.dataFormat,m=u[2]%2!=0&&!!c.isPacked;if((1==u[0]*u[1]*u[2]||1===o.outChannels)&&o.inChannels>1e3||!M().getBool("WEBGL_LAZILY_UNPACK")||!M().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!m){var g=this.reshape(e,[1,d?u[0]*u[1]*u[2]:u[0]*u[2]*u[3],o.inChannels]),x=this.reshape(n,[1,o.inChannels,o.outChannels]);return this.reshape(this.fusedBatchMatMul({a:g,b:x,transposeA:!1,transposeB:!1,bias:a,activation:i,preluActivationWeights:s}),o.outShape)}var y={dataId:e.dataId,shape:[1,d?u[0]*u[1]*(u[2]+1):u[0]*u[2]*(u[3]+1),o.inChannels],dtype:e.dtype},w=c.shape;c.shape=c.shape.slice(),c.shape[c.shape.length-2]++,E(br(c.shape,y.shape),function(){return"packed reshape "+c.shape+" to "+y.shape+" isn't free"});var C=this.reshape(n,[1,o.inChannels,o.outChannels]),S=this.fusedBatchMatMul({a:y,b:C,transposeA:!1,transposeB:!1,bias:a,activation:i,preluActivationWeights:s}),k=this.texData.get(S.dataId);return E(k.isPacked,function(){return"batchMatMul result is expected to be packed"}),c.shape=w,k.shape=o.outShape,D.makeTensorFromDataId(S.dataId,o.outShape,S.dtype)},t.prototype.conv2dWithIm2Row=function(e,n,o,a,i,s){var h=o.outWidth,f=o.outHeight,d="channelsLast"===o.dataFormat,p=o.filterWidth*o.filterHeight*o.inChannels,m=f*h,v=[p,m],g=e.squeeze([0]),x=n.reshape([1,p,-1]),b=new ud(v,g.shape,o),y=this.compileAndRun(b,[g]).reshape([1,v[0],v[1]]),w=null!=a,C=null!=s,S=i?po(i,!0):null,k=new Fa(y.shape,[1,m,o.outChannels],!0,!1,w,S,C),I=[y,x];return a&&I.push(a),C&&I.push(s),this.compileAndRun(k,I).reshape(d?[1,f,h,o.outChannels]:[1,o.outChannels,f,h])},t.prototype.fusedConv2d=function(e){var n=e.input,o=e.filter,a=e.convInfo,i=e.bias,s=e.activation,u=e.preluActivationWeights;if(1===a.filterHeight&&1===a.filterWidth&&1===a.dilationHeight&&1===a.dilationWidth&&1===a.strideHeight&&1===a.strideWidth&&("SAME"===a.padInfo.type||"VALID"===a.padInfo.type))return this.conv2dByMatMul(n,o,a,i,s,u);if(M().getBool("WEBGL_CONV_IM2COL")&&1===n.shape[0])return this.conv2dWithIm2Row(n,o,a,i,s,u);var c=null!=i,l=null!=u,h=s?po(s,!1):null,f=new Fu(a,c,h,l),d=[n,o];return i&&d.push(i),u&&d.push(u),this.compileAndRun(f,d)},t.prototype.conv2d=function(e,n,o){if(1===o.filterHeight&&1===o.filterWidth&&1===o.dilationHeight&&1===o.dilationWidth&&1===o.strideHeight&&1===o.strideWidth&&("SAME"===o.padInfo.type||"VALID"===o.padInfo.type))return this.conv2dByMatMul(e,n,o);if(M().getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,n,o);var a=new Fu(o);return this.compileAndRun(a,[e,n])},t.prototype.conv2dDerInput=function(e,n,o){var a=new zf(o);return this.compileAndRun(a,[e,n])},t.prototype.conv2dDerFilter=function(e,n,o){var a=new Wf(o);return this.compileAndRun(a,[e,n])},t.prototype.fusedDepthwiseConv2D=function(e){var n,o=e.input,a=e.filter,i=e.convInfo,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=M().getBool("WEBGL_PACK_DEPTHWISECONV")&&i.strideWidth<=2&&i.outChannels/i.inChannels==1,h=u?po(u,l):null,f=[o,a],d=null!=s,p=null!=c;return d&&f.push(s),p&&f.push(c),l?(n=new Pu(i,d,h,p),this.compileAndRun(n,f)):(n=new Nu(i,d,h,p),this.compileAndRun(n,f))},t.prototype.depthwiseConv2D=function(e,n,o){var a;return M().getBool("WEBGL_PACK_DEPTHWISECONV")&&o.strideWidth<=2&&o.outChannels/o.inChannels==1?(a=new Pu(o),this.compileAndRun(a,[e,n])):(a=new Nu(o),this.compileAndRun(a,[e,n]))},t.prototype.depthwiseConv2DDerInput=function(e,n,o){var a=new Hf(o);return this.compileAndRun(a,[e,n])},t.prototype.depthwiseConv2DDerFilter=function(e,n,o){var a=new Gf(o);return this.compileAndRun(a,[e,n])},t.prototype.conv3d=function(e,n,o){var a=new jf(o);return this.compileAndRun(a,[e,n])},t.prototype.conv3dDerInput=function(e,n,o){var a=new Uf(o);return this.compileAndRun(a,[e,n])},t.prototype.conv3dDerFilter=function(e,n,o){var a=new Vf(o);return this.compileAndRun(a,[e,n])},t.prototype.maxPool=function(e,n){var o=new Na(n,"max",!1);return this.compileAndRun(o,[e])},t.prototype.avgPool=function(e,n){var o=new Na(n,"avg",!1);return this.compileAndRun(o,[e],"float32")},t.prototype.maxPoolBackprop=function(e,n,o,a){var i=new Na(a,"max",!0),s=this.compileAndRun(i,[n]),u=new fd(a),c=this.compileAndRun(u,[e,s],n.dtype);return s.dispose(),c},t.prototype.avgPoolBackprop=function(e,n,o){var a=new Sf(o);return this.compileAndRun(a,[e],n.dtype)},t.prototype.cast=function(e,n){return Ca(e,n,this)},t.prototype.unstack=function(e,n){for(var o=e.shape[n],a=new Array(e.rank-1),i=0,s=0;s<e.rank;s++)s!==n&&(a[i++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[n]=1;var l=new Array(o);for(s=0;s<l.length;s++)u[n]=s,l[s]=this.slice(e,u,c).reshape(a);return l},t.prototype.avgPool3d=function(e,n){var o=new Pa(n,"avg",!1);return this.compileAndRun(o,[e],"float32")},t.prototype.avgPool3dBackprop=function(e,n,o){var a=new Df(o);return this.compileAndRun(a,[e],n.dtype)},t.prototype.maxPool3d=function(e,n){var o=new Pa(n,"max",!1);return this.compileAndRun(o,[e],"float32")},t.prototype.maxPool3dBackprop=function(e,n,o,a){var i=new Pa(a,"max",!0),s=this.compileAndRun(i,[n]),u=new dd(a),c=this.compileAndRun(u,[e,s],n.dtype);return s.dispose(),c},t.prototype.reshape=function(e,n){var o=this.texData.get(e.dataId);if(o.isPacked&&!br(e.shape,n)&&(null===o.texture||!br(o.shape,n))){var a=this.packedReshape(e,n);return D.makeTensorFromDataId(a.dataId,a.shape,a.dtype)}return co(e,n)},t.prototype.resizeBilinear=function(e,n,o,a){var i=M().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new Cd(e.shape,n,o,a):new _d(e.shape,n,o,a);return this.compileAndRun(i,[e],"float32")},t.prototype.resizeBilinearBackprop=function(e,n,o){var a=new wd(e,n,o);return this.compileAndRun(a,[e])},t.prototype.resizeNearestNeighbor=function(e,n,o,a){var i=new Id(e.shape,n,o,a);return this.compileAndRun(i,[e])},t.prototype.resizeNearestNeighborBackprop=function(e,n,o){var a=new Ed(e,n,o);return this.compileAndRun(a,[e])},t.prototype.multinomial=function(e,n,o,a){var i=n?e:Ut(e),c=new pd(i.shape[0],i.shape[1],o),l=c.getCustomSetupFunc(a);return this.compileAndRun(c,[i],"int32",l)},t.prototype.oneHot=function(e,n,o,a){var i=new vd(e.size,n,o,a);return this.compileAndRun(i,[e])},t.prototype.diag=function(e){var n=new Qf(e.size);return this.compileAndRun(n,[e])},t.prototype.nonMaxSuppression=function(e,n,o,a,i){return $r("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),Ra(e.dataSync(),n.dataSync(),o,a,i)},t.prototype.cropAndResize=function(e,n,o,a,i,s){var u=new qf(e.shape,n.shape,a,i,s);return this.compileAndRun(u,[e,n,o],"float32")},t.prototype.depthToSpace=function(e,n,o){E(n>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});var a=e.shape[0],c=("NHWC"===o?e.shape[1]:e.shape[2])*n,l=("NHWC"===o?e.shape[2]:e.shape[3])*n,h=("NHWC"===o?e.shape[3]:e.shape[1])/(n*n),f=new $f("NHWC"===o?[a,c,l,h]:[a,h,c,l],n,o);return this.compileAndRun(f,[e])},t.prototype.split=function(e,n,o){return _u(e,n,o)},t.prototype.scatterND=function(e,n,o){var a=_r(0,e,o),i=a.sliceRank,s=a.numUpdates,u=a.sliceSize,c=a.strides,l=a.outputSize,h=[l/u,u],f=e.reshape([s,i]),d=n.reshape([s,u]);if(0===l)return co(Ke([]),o);var p=j(0),m=new tc(s,i,f.rank,d.rank,c,h);return this.compileAndRun(m,[d,f,p]).reshape(o)},t.prototype.sparseToDense=function(e,n,o,a){var i=_r(0,e,o),h=new tc(i.numUpdates,i.sliceRank,e.rank,n.rank,i.strides,[i.outputSize,1],!1);return this.compileAndRun(h,[n,e,a]).reshape(o)},t.prototype.fft=function(e){return this.fftImpl(e,!1)},t.prototype.ifft=function(e){return this.fftImpl(e,!0)},t.prototype.fftImpl=function(e,n){var o=this.texData.get(e.dataId),a=new Ou("return real * expR - imag * expI;",e.shape,n),i=new Ou("return real * expI + imag * expR;",e.shape,n),s=[this.makeComplexComponentTensorInfo(e,o.complexTensors.real),this.makeComplexComponentTensorInfo(e,o.complexTensors.imag)],u=this.compileAndRun(a,s),c=this.compileAndRun(i,s),l=this.complex(u,c).as2D(e.shape[0],e.shape[1]);return u.dispose(),c.dispose(),l},t.prototype.gatherND=function(e,n){var o=n.shape,a=o[o.length-1],i=ma(e,n),s=i[0],u=i[1],c=i[2],l=i[3],h=n.reshape([u,a]),f=e.reshape([e.size/c,c]),d=new id(a,l,[u,c]);return this.compileAndRun(d,[f,h]).reshape(s)},t.prototype.fill=function(e,n,o){if("string"===(o=o||Mn(n))){var a=sr(o,Q(e));return a.fill(n),D.makeTensor(a,e,o,this)}var i=new od(e,n),s=i.getCustomSetupFunc(n);return this.compileAndRun(i,[],o,s)},t.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(e.shape,1,e.dtype)},t.prototype.zerosLike=function(e){return this.fill(e.shape,"string"===e.dtype?"":0,e.dtype)},t.prototype.linspace=function(e,n,o){return Ea(e,n,o)},t.prototype.makeTensorInfo=function(e,n){var o=this.write(null,e,n);return this.texData.get(o).usage=null,{dataId:o,shape:e,dtype:n}},t.prototype.makeOutput=function(e,n){var o=this.makeTensorInfo(e,n).dataId;return D.makeTensorFromDataId(o,e,n,this)},t.prototype.unpackTensor=function(e){var n=new Xd(e.shape);return this.runWebGLProgram(n,[e],e.dtype)},t.prototype.packTensor=function(e){var n=new md(e.shape);return this.runWebGLProgram(n,[e],e.dtype,null,!0)},t.prototype.packedReshape=function(e,n){var o=[yr(e.shape)].concat(xr(e.shape)),a={dtype:e.dtype,shape:o,dataId:e.dataId},i=[yr(n)].concat(xr(n)),s=new bd(i,o),u=this.runWebGLProgram(s,[a],e.dtype,null,!0);return{dataId:u.dataId,shape:n,dtype:u.dtype}},t.prototype.decode=function(e){var n,o=this.texData.get(e),a=o.isPacked,i=o.shape,s=o.dtype,u=Xr(i);return n=a?new Yf(u):new Xf(u),{dtype:s,shape:i,dataId:this.runWebGLProgram(n,[{shape:u,dtype:s,dataId:e}],s,null,!0).dataId}},t.prototype.runWebGLProgram=function(e,n,o,a,i){var s=this;void 0===i&&(i=!1);var u=this.makeTensorInfo(e.outputShape,o),c=this.texData.get(u.dataId);if(e.packedOutput&&(c.isPacked=!0),e.outPackingScheme===dr.DENSE){var l=pr(e.outputShape);c.texShape=l.map(function(b){return 2*b})}if(null!=e.outTexUsage&&(c.usage=e.outTexUsage),0===Q(u.shape))return c.values=Pn(u.dtype,0),u;var h=[],f=n.map(function(b){if("complex64"===b.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var y=s.texData.get(b.dataId);if(null==y.texture){if(!e.packedInputs&&Q(b.shape)<=M().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:b.shape,texData:null,isUniform:!0,uniformValues:y.values};e.packedInputs&&(y.isPacked=!0,y.shape=b.shape)}else if(!!y.isPacked!=!!e.packedInputs)b=y.isPacked?s.unpackTensor(b):s.packTensor(b),h.push(b),y=s.texData.get(b.dataId);else if(y.isPacked&&!br(y.shape,b.shape)){var w=b,C=b.shape;b.shape=y.shape,b=s.packedReshape(b,C),h.push(b),y=s.texData.get(b.dataId),w.shape=C}return s.uploadToGPU(b.dataId),{shape:b.shape,texData:y,isUniform:!1}});this.uploadToGPU(u.dataId);var d,b,C,p={shape:u.shape,texData:c,isUniform:!1},m=(b=e,C="",f.concat(p).forEach(function(I){C+=I.shape+"_"+(I.isUniform?"uniform":I.texData.texShape)+"_"+(null!=I.texData&&null!=I.texData.slice&&I.texData.slice.flatOffset>0)}),b.constructor.name+"_"+C+"_"+b.userCode),v=this.getAndSaveBinary(m,function(){return function(b,y,w,C){var S=y.userCode,k=w.map(function(W,G){var H={logicalShape:W.shape,texShape:W.isUniform?null:W.texData.texShape,isUniform:W.isUniform,isPacked:!W.isUniform&&W.texData.isPacked,flatOffset:null};return null!=W.texData&&null!=W.texData.slice&&W.texData.slice.flatOffset>0&&(H.flatOffset=W.texData.slice.flatOffset),{name:y.variableNames[G],shapeInfo:H}}),I=k.map(function(W){return W.shapeInfo}),R={logicalShape:C.shape,texShape:C.texData.texShape,isUniform:!1,isPacked:C.texData.isPacked,flatOffset:null},F=_f(k,R,S,y.packedInputs),T=b.createProgram(F),L=null,O=b.getUniformLocation(T,"NAN",!1);1===M().getNumber("WEBGL_VERSION")&&(L=b.getUniformLocation(T,"INFINITY",!1));for(var B={},U=0;U<y.variableNames.length;U++){var z=y.variableNames[U];B[z]=b.getUniformLocation(T,z,!1),B["offset"+z]=b.getUniformLocation(T,"offset"+z,!1)}return{program:y,source:F,webGLProgram:T,uniformLocations:B,inShapeInfos:I,outShapeInfo:R,infLoc:L,nanLoc:O}}(s.gpgpu,e,f,p)}),g=null!=this.activeTimers;if(g&&(d=this.startTimer()),function(b,y,w,C,S){ec(y.inShapeInfos,w),ec([y.outShapeInfo],[C]);var k=C.texData.texture,I=C.texData.texShape;C.texData.isPacked?b.setOutputPackedMatrixTexture(k,I[0],I[1]):b.setOutputMatrixTexture(k,I[0],I[1]),b.setProgram(y.webGLProgram),1===M().getNumber("WEBGL_VERSION")&&null!==y.infLoc&&b.gl.uniform1f(y.infLoc,1/0),null!==y.nanLoc&&b.gl.uniform1f(y.nanLoc,NaN),w.forEach(function(R,F){var T=y.program.variableNames[F],L=y.uniformLocations[T],O=y.uniformLocations["offset"+T];if(null!=L)if(R.isUniform)if(Q(R.shape)<2)b.gl.uniform1f(L,R.uniformValues[0]);else{var B=R.uniformValues;B instanceof Float32Array||(B=new Float32Array(B)),b.gl.uniform1fv(L,B)}else null!=R.texData.slice&&null!=O&&b.gl.uniform1i(O,R.texData.slice.flatOffset),b.setInputMatrixTexture(R.texData.texture,L,F)}),S?.(b,y.webGLProgram),b.executeProgram()}(this.gpgpu,v,f,p,a),h.forEach(function(b){return s.disposeData(b.dataId)}),g&&(d=this.endTimer(d),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(d)})),!M().getBool("WEBGL_LAZILY_UNPACK")&&c.isPacked&&!1===i){var x=this.unpackTensor(u);return this.disposeData(u.dataId),x}return u},t.prototype.compileAndRun=function(e,n,o,a,i){void 0===i&&(i=!1);var s=this.runWebGLProgram(e,n,o=o||n[0].dtype,a,i);return D.makeTensorFromDataId(s.dataId,s.shape,s.dtype)},t.prototype.getAndSaveBinary=function(e,n){return e in this.binaryCache||(this.binaryCache[e]=n()),this.binaryCache[e]},t.prototype.getTextureManager=function(){return this.textureManager},t.prototype.dispose=function(){var e=this;this.disposed||(M().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(n){e.gpgpu.deleteProgram(e.binaryCache[n].webGLProgram),delete e.binaryCache[n]}),this.textureManager.dispose(),null!=this.canvas&&typeof HTMLCanvasElement<"u"&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},t.prototype.floatPrecision=function(){var e=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=K(function(){if(!M().get("WEBGL_RENDER_FLOAT32_ENABLED")){var n=M().getBool("DEBUG");M().set("DEBUG",!1);var o=e.abs(j(1e-8)).dataSync()[0];if(M().set("DEBUG",n),o>0)return 32}return 16})),this.floatPrecisionValue},t.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},t.prototype.uploadToGPU=function(e){var n,o=this.texData.get(e),a=o.shape,i=o.dtype,s=o.values,c=o.usage,l=o.isPacked;if(null==o.texture){var h,f=null!=this.activeTimers;f&&(h=yt());var d=o.texShape;if(null==d&&(d=Ks(a,l),o.texShape=d),null!=s){var p=Xr(a),m=void 0,v=d[1],g=d[0],x=s instanceof Uint8Array;l?(v=(n=vr(d[0],d[1]))[0],m=new td(p,[g=n[1],v],x)):m=new ed(p,[g,v],x);var b=this.makeTensorInfo([g,v],i);this.texData.get(b.dataId).usage=x?at.PIXELS:at.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(b.dataId),v,g,s);var y=this.runWebGLProgram(m,[b],i,null,!0),w=this.texData.get(y.dataId);o.texture=w.texture,o.texShape=w.texShape,o.isPacked=w.isPacked,o.usage=w.usage,this.disposeData(b.dataId),this.texData.delete(y.dataId),o.values=null,f&&(this.uploadWaitMs+=yt()-h)}else{var C=this.acquireTexture(d,c,i,l);o.texture=C}}},t.prototype.convertAndCacheOnCPU=function(e,n){var o=this.texData.get(e),a=o.dtype;return this.releaseGPUData(e),null!=n&&(o.values=function(i,s){if("float32"===s||"complex64"===s)return i;if("int32"===s||"bool"===s){for(var u="int32"===s?new Int32Array(i.length):new Uint8Array(i.length),c=0;c<u.length;++c)u[c]=Math.round(i[c]);return u}throw new Error("Unknown dtype "+s)}(n,a)),o.values},t.prototype.acquireTexture=function(e,n,o,a){if(this.numBytesInGPU+=this.computeBytes(e,o),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var i=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+i+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(e,n,a)},t.prototype.computeBytes=function(e,n){return e[0]*e[1]*jo(n)},t}(yu);Ss()&&D.registerBackend("webgl",function(){return new mc},2);var $d=A({square_:function(r){var t=_(r,"x","square");return D.runKernelFunc(function(n,o){return o([t]),n.square(t)},{x:t},null,"Square",{},[t],[])}}),Sr="SquaredDifference",gc=A({squaredDifference_:function(r,t){var e,n=_(r,"a","squaredDifference"),o=_(t,"b","squaredDifference");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(s,u){var c=s.squaredDifference(n,o);return u([n,o]),c},{a:n,b:o},function(s,u){var c=u[0],l=u[1],h=j(2);return{a:function(){return s.mul(c.sub(l).mul(h))},b:function(){return s.mul(l.sub(c).mul(h))}}},Sr,{},[n,o],[])}}),Qd=A({abs_:function(r){var t=_(r,"x","abs");return"complex64"===t.dtype?D.runKernelFunc(function(e){return e.complexAbs(t)},{$x:t}):D.runKernelFunc(function(e,n){var o=e.abs(t);return n([t]),o},{x:t},function(e,n){var o=n[0];return{x:function(){return e.mul(o.toFloat().step(-1))}}},"Abs")}}),Jd=A({acos_:function(r){var t=_(r,"x","acos");return D.runKernelFunc(function(e,n){var o=e.acos(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.divStrict(j(1).sub(o.toFloat().square()).sqrt()).neg()}}})}}),Zd=A({acosh_:function(r){var t=_(r,"x","acosh");return D.runKernelFunc(function(e,n){var o=e.acosh(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.divStrict(o.toFloat().square().sub(1).sqrt())}}})}}),ep=A({asin_:function(r){var t=_(r,"x","asin");return D.runKernelFunc(function(e,n){var o=e.asin(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.divStrict(j(1).sub(o.toFloat().square()).sqrt())}}})}}),tp=A({asinh_:function(r){var t=_(r,"x","asinh");return D.runKernelFunc(function(e,n){var o=e.asinh(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.divStrict(j(1).add(o.toFloat().square()).sqrt())}}})}}),np=A({atan_:function(r){var t=_(r,"x","atan");return D.runKernelFunc(function(e,n){var o=e.atan(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(o.toFloat().square().add(1))}}})}}),rp=A({atanh_:function(r){var t=_(r,"x","atanh");return D.runKernelFunc(function(e,n){var o=e.atanh(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(j(1).sub(o.toFloat().square()))}}})}}),op=A({ceil_:function(r){var t=_(r,"x","ceil");return D.runKernelFunc(function(e){return e.ceil(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),La=A({clipByValue_:function(r,t,e){var n=_(r,"x","clipByValue");return E(t<=e,function(){return"Error in clip: min ("+t+") must be less than or equal to max ("+e+")."}),D.runKernelFunc(function(i,s){var u=i.clip(n,t,e);return s([n]),u},{x:n},function(i,s){var u=s[0];return{x:function(){return i.where(u.greaterEqual(t).logicalAnd(u.lessEqual(e)),ve(i))}}},"ClipByValue",{min:t,max:e},[n])}}),ap=A({cos_:function(r){var t=_(r,"x","cos");return D.runKernelFunc(function(n,o){var a=n.cos(t);return o([t]),a},{x:t},function(n,o){var a=o[0];return{x:function(){return a.toFloat().sin().neg().mul(n)}}},"Cos",{},[t])}}),ip=A({cosh_:function(r){var t=_(r,"x","cosh");return D.runKernelFunc(function(e,n){var o=e.cosh(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return o.toFloat().sinh().mulStrict(e)}}})}}),sp=A({erf_:function(r){var t=_(r,"x","erf");return E("int32"===t.dtype||"float32"===t.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===t.dtype&&(t=t.toFloat()),D.runKernelFunc(function(e,n){var o=e.erf(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.mul(o.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),Wa=A({exp_:function(r){var t=_(r,"x","exp");return D.runKernelFunc(function(e,n){var o=e.exp(t);return n([o]),o},{x:t},function(e,n){return{x:function(){return e.mulStrict(n[0])}}},"Exp",{},[],[!0])}}),up=A({expm1_:function(r){var t=_(r,"x","expm1");return D.runKernelFunc(function(e,n){var o=e.expm1(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.mul(o.exp())}}})}}),cp=A({floor_:function(r){var t=_(r,"x","floor");return D.runKernelFunc(function(e){return e.floor(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),lp=A({log_:function(r){var t=_(r,"x","log");return D.runKernelFunc(function(n,o){var a=n.log(t);return o([t]),a},{x:t},function(n,o){var a=o[0];return{x:function(){return n.div(a.toFloat())}}},"Log",{},[t])}}),hp=A({log1p_:function(r){var t=_(r,"x","log1p");return D.runKernelFunc(function(e,n){var o=e.log1p(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(o.add(1))}}})}}),fp=A({logSigmoid_:function(r){var t=_(r,"x","logSigmoid");return D.runKernelFunc(function(e,n){var o=e.softplus(t.neg()).neg();return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.mul(o.neg().sigmoid())}}})}}),vo=A({neg_:function(r){var t=_(r,"x","neg");return D.runKernelFunc(function(n){return n.neg(t)},{x:t},function(n){return{x:function(){return n.neg()}}},"Neg",{},[t])}}),dp=A({reciprocal_:function(r){var t=_(r,"x","reciprocal");return D.runKernelFunc(function(e,n){var o=e.reciprocal(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(o.square().neg())}}})}}),pp=A({round_:function(r){var t=_(r,"x","round");return D.runKernelFunc(function(e){return e.round(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),yc=A({rsqrt_:function(r){var t=_(r,"x","rsqrt");return D.runKernelFunc(function(n,o){var a=n.rsqrt(t);return o([t]),a},{x:t},function(n,o){var a=o[0];return{x:function(){return n.div(a.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},[t])}}),xc=A({sigmoid_:function(r){var t=_(r,"x","sigmoid");return D.runKernelFunc(function(e,n){var o=e.sigmoid(t);return n([o]),o},{x:t},function(e,n){var o=n[0];return{x:function(){return e.mul(o.mul(j(1).sub(o)))}}},"Sigmoid")}}),vp=A({sign_:function(r){var t=_(r,"x","sign");return D.runKernelFunc(function(e){return e.sign(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),mp=A({isNaN_:function(r){var t=_(r,"x","isNaN");return D.runKernelFunc(function(e){return e.isNaN(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),gp=A({isInf_:function(r){var t=_(r,"x","isInf");return D.runKernelFunc(function(e){return e.isInf(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),yp=A({isFinite_:function(r){var t=_(r,"x","isFinite");return D.runKernelFunc(function(e){return e.isFinite(t)},{$x:t},function(e){return{$x:function(){return ve(e)}}})}}),xp=A({sin_:function(r){var t=_(r,"x","sin");return D.runKernelFunc(function(n,o){var a=n.sin(t);return o([t]),a},{x:t},function(n,o){var a=o[0];return{x:function(){return a.toFloat().cos().mul(n)}}},"Sin",{},[t])}}),bp=A({sinh_:function(r){var t=_(r,"x","sinh");return D.runKernelFunc(function(e,n){var o=e.sinh(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return o.toFloat().cosh().mulStrict(e)}}})}}),wp=A({softplus_:function(r){var t=_(r,"x","softplus");return D.runKernelFunc(function(e,n){var o=e.softplus(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.mul(o.sigmoid())}}})}}),_p=A({sqrt_:function(r){var t=_(r,"x","sqrt");return D.runKernelFunc(function(e,n){var o=e.sqrt(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(o.toFloat().sqrt().mul(2))}}})}}),Cp=A({step_:function(r,t){void 0===t&&(t=0);var e=_(r,"x","step");return D.runKernelFunc(function(n){return n.step(e,t)},{$x:e},function(n){return{$x:function(){return ve(n)}}})}}),Ep=A({tan_:function(r){var t=_(r,"x","tan");return D.runKernelFunc(function(e,n){var o=e.tan(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return e.div(o.cos().square())}}})}}),Ip=A({tanh_:function(r){var t=_(r,"x","tanh");return D.runKernelFunc(function(e,n){var o=e.tanh(t);return n([o]),o},{x:t},function(e,n){var o=n[0];return{x:function(){return j(1).sub(o.square()).mulStrict(e)}}},"Tanh",{},null,[!0])}});function bc(r,t,e,n,o,a){var i,s,u=_(r,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=n&&(s=_(n,"offset","batchNorm")),E(2===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),E(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),E(2===l.rank||1===l.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+l.rank+"."}),null!=i&&E(2===i.rank||1===i.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+i.rank+"."}),null!=s&&E(2===s.rank||1===s.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),Dr(u,c,l,s,i,a)}function wc(r,t,e,n,o,a){var i,s,u=_(r,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=n&&(s=_(n,"offset","batchNorm")),E(3===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),E(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),E(3===l.rank||1===l.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+l.rank+"."}),null!=i&&E(3===i.rank||1===i.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+i.rank+"."}),null!=s&&E(3===s.rank||1===s.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),Dr(u,c,l,s,i,a)}function _c(r,t,e,n,o,a){var i,s,u=_(r,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=n&&(s=_(n,"offset","batchNorm")),E(4===u.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),E(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),E(4===l.rank||1===l.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+l.rank+"."}),null!=i&&E(4===i.rank||1===i.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+i.rank+"."}),null!=s&&E(4===s.rank||1===s.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),Dr(u,c,l,s,i,a)}function Dr(r,t,e,n,o,a){null==a&&(a=.001);var i,s,u,c=_(r,"x","batchNorm"),l=_(t,"mean","batchNorm"),h=_(e,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=n&&(s=_(n,"offset","batchNorm")),E(l.rank===h.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),E(null==s||l.rank===s.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),E(null==i||l.rank===i.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),u=0===c.rank||1===c.rank?c.as4D(1,1,1,c.size):2===c.rank?c.as4D(1,1,c.shape[0],c.shape[1]):3===c.rank?c.as4D(1,c.shape[0],c.shape[1],c.shape[2]):c,D.runKernelFunc(function(d,p){var m=d.batchNormalization(u,mo(l),mo(h),a,mo(i),mo(s));return p([c,l,h,i]),m},{x:c,mean:l,variance:h,scale:i,offset:s},function(d,p){var v=p[0],g=p[1],x=p[2],y=p[3]??j(1),w=Oe(g.shape,u.shape),C=[];if(1===g.rank){for(var S=0;S<u.shape.length-1;++S)C.push(u.shape[S]);C.push(1)}var k=v.sub(g),I=d.mul(y),R=yc(x.add(j(a))),F=R.mul(R).mul(R).mul(j(-.5));return{x:function(){return 1===g.rank?d.mul(Wn(R.as4D(1,1,1,g.shape[0]),C)).mul(y).reshape(v.shape):d.mul(R).mul(y).reshape(v.shape)},mean:function(){var T=R.mul(j(-1)).mul(I);return 1===g.rank&&(T=T.sum(w)),T.reshape(g.shape)},variance:function(){var T=F.mul(k).mul(I);return 1===g.rank&&(T=T.sum(w)),T.reshape(g.shape)},scale:function(){var T=k.mul(R),L=d.mul(T);return 1===g.rank&&(L=L.sum(w)),L.reshape(g.shape)},offset:function(){var T=d;return 1===g.rank&&(T=T.sum(w)),T.reshape(g.shape)}}},"BatchNormalization",{varianceEpsilon:a},[c,l,h,i]).reshape(c.shape)}function mo(r){return null==r?null:0===r.rank?r.as1D():1===r.rank?r:2===r.rank?r.as4D(1,1,r.shape[0],r.shape[1]):3===r.rank?r.as4D(1,r.shape[0],r.shape[1],r.shape[2]):r}function go(){eu("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var Rp=A({batchNormalization2d_:function(r,t,e,n,o,a){return void 0===n&&(n=.001),go(),bc(r,t,e,a,o,n)}}),kp=A({batchNormalization3d_:function(r,t,e,n,o,a){return void 0===n&&(n=.001),go(),wc(r,t,e,a,o,n)}}),Sp=A({batchNormalization4d_:function(r,t,e,n,o,a){return void 0===n&&(n=.001),go(),_c(r,t,e,a,o,n)}}),Dp=A({batchNormalization_:function(r,t,e,n,o,a){return void 0===n&&(n=.001),go(),Dr(r,t,e,a,o,n)}}),Cc=A({batchNorm_:Dr}),Ap=A({batchNorm2d_:bc}),Tp=A({batchNorm3d_:wc}),Fp=A({batchNorm4d_:_c}),yo=A({logicalAnd_:function(r,t){var e=_(r,"a","logicalAnd","bool"),n=_(t,"b","logicalAnd","bool");return ce(e.shape,n.shape),D.runKernelFunc(function(o){return o.logicalAnd(e,n)},{a:e,b:n},null,"LogicalAnd")}}),Np=A({logicalNot_:function(r){var t=_(r,"x","logicalNot","bool");return D.runKernelFunc(function(e){return e.logicalNot(t)},{$x:t})}}),Ec=A({logicalOr_:function(r,t){var e=_(r,"a","logicalOr","bool"),n=_(t,"b","logicalOr","bool");return ce(e.shape,n.shape),D.runKernelFunc(function(o){return o.logicalOr(e,n)},{$a:e,$b:n})}}),Pp=A({logicalXor_:function(r,t){var e=_(r,"a","logicalXor","bool"),n=_(t,"b","logicalXor","bool");return ce(e.shape,n.shape),Ec(r,t).logicalAnd(yo(r,t).logicalNot())}}),Rn=A({where_:function(r,t,e){var n=_(t,"a","where"),o=_(e,"b","where"),a=_(r,"condition","where","bool");return pe(n.shape,o.shape,"Error in where: "),1===a.rank?E(a.shape[0]===n.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):pe(a.shape,o.shape,"Error in where: "),D.runKernelFunc(function(i,s){var u=i.select(a,n,o);return s([a]),u},{$condition:a,$a:n,$b:o},function(i,s){var u=s[0];return{$condition:function(){return ve(u).toFloat()},$a:function(){return i.mul(u.cast(i.dtype))},$b:function(){return i.mul(u.logicalNot().cast(i.dtype))}}})}}),Ic=function(r){return Y(this,void 0,void 0,function(){var t,e,n;return $(this,function(o){switch(o.label){case 0:return[4,(t=_(r,"condition","whereAsync","bool")).data()];case 1:return e=o.sent(),n=Sa(t.shape,e),r!==t&&t.dispose(),[2,n]}})})},le=A({add_:function(r,t){var e,n=_(r,"a","add"),o=_(t,"b","add");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i){return i.add(n,o)},{a:n,b:o},function(i){return{a:function(){var s=i,u=Oe(n.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(n.shape)},b:function(){var s=i,u=Oe(o.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(o.shape)}}},"Add")}}),Mp=A({addN_:function(r){E(Array.isArray(r),function(){return"The argument passed to tf.addN() must be a list of tensors"}),E(r.length>=1,function(){return"Must pass at least one tensor to tf.addN(), but got "+r.length});var t=r.map(function(o,a){return _(o,"tensors"+a,"addN")}),e=t[0];return t.forEach(function(o){if(o.dtype!==e.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),t.forEach(function(o){if(!Ne(o.shape,e.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")}),D.runKernelFunc(function(o){return o.addN(t)},t,function(o){var a={};return t.forEach(function(i,s){a[s]=function(){return o.clone()}}),a},"AddN")}}),Op=A({addStrict_:function(r,t){var e=_(r,"a","addStrict"),n=_(t,"b","addStrict");return pe(e.shape,n.shape,"Error in addStrict: "),e.add(n)}}),Bp=A({atan2_:function(r,t){var e,n=_(r,"a","atan2"),o=_(t,"b","atan2");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i,s){var u=i.atan2(n,o);return s([n,o]),u},{$a:n,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=le(u.square(),c.square()),h=i.mul(c.div(l)),f=Oe(u.shape,a);return f.length>0&&(h=h.sum(f)),h.reshape(u.shape)},$b:function(){var l=le(u.square(),c.square()),h=vo(i.mul(u.div(l))),f=Oe(c.shape,a);return f.length>0&&(h=h.sum(f)),h.reshape(c.shape)}}})}}),Ct=A({div_:function(r,t){var e,n=_(r,"a","div"),o=_(t,"b","div");if(e=Ie(n,o),o=e[1],"int32"===(n=e[0]).dtype&&"int32"===o.dtype)return Rc(n,o);var a=ce(n.shape,o.shape);return D.runKernelFunc(function(i,s){var u=i.realDivide(n,o);return s([n,o]),u},{a:n,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=Oe(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Oe(c.shape,a);h.length>0&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"Div")}}),Lp=A({divNoNan_:function(r,t){var e,n=_(r,"a","div"),o=_(t,"b","div");n=(e=Ie(n,o))[0];var a=Ct(n,o=e[1]),i=ve(a),s=o.equal(i);return Rn(s,i,a)}}),Wp=A({divStrict_:function(r,t){var e=_(r,"a","div"),n=_(t,"b","div");return pe(e.shape,n.shape,"Error in divideStrict: "),e.div(n)}}),Rc=A({floorDiv_:function(r,t){var e,n=_(r,"a","floorDiv"),o=_(t,"b","floorDiv");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i,s){var u=i.floorDiv(n,o);return s([n,o]),u},{a:n,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=Oe(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Oe(c.shape,a);h.length>0&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"FloorDiv")}}),za=A({maximum_:function(r,t){var e,n=_(r,"a","maximum"),o=_(t,"b","maximum");return e=Ie(n,o),o=e[1],"bool"===(n=e[0]).dtype&&(n=n.toInt(),o=o.toInt()),ce(n.shape,o.shape),D.runKernelFunc(function(a,i){var s=a.maximum(n,o);return i([n,o]),s},{a:n,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.greaterEqual(u).toFloat())},b:function(){return a.mul(s.less(u).toFloat())}}},"Maximum")}}),zp=A({maximumStrict_:function(r,t){var e=_(r,"a","maximumStrict"),n=_(t,"b","maximumStrict");return pe(e.shape,n.shape,"Error in maximumStrict: "),e.maximum(n)}}),kc=A({minimum_:function(r,t){var e,n=_(r,"a","minimum"),o=_(t,"b","minimum");return e=Ie(n,o),o=e[1],"bool"===(n=e[0]).dtype&&(n=n.toInt(),o=o.toInt()),ce(n.shape,o.shape),D.runKernelFunc(function(a,i){var s=a.minimum(n,o);return i([n,o]),s},{a:n,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.lessEqual(u).toFloat())},b:function(){return a.mul(s.greater(u).toFloat())}}},"Minimum")}}),Vp=A({minimumStrict_:function(r,t){var e=_(r,"a","minimumStrict"),n=_(t,"b","minimumStrict");return pe(e.shape,n.shape,"Error in minimumStrict: "),e.minimum(n)}}),Up=A({mod_:function(r,t){var e,n=_(r,"a","mod"),o=_(t,"b","mod");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i,s){var u=i.mod(n,o);return s([n,o]),u},{$a:n,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=Oe(u.shape,a);return l.length>0?i.sum(l).reshape(u.shape):i},$b:function(){var l=i.mul(u.div(c).floor().neg()),h=Oe(c.shape,a);return h.length>0?l.sum(h).reshape(c.shape):l}}})}}),Gp=A({modStrict_:function(r,t){var e=_(r,"a","modStrict"),n=_(t,"b","modStrict");return pe(e.shape,n.shape,"Error in modStrict: "),e.mod(n)}}),Ye=A({mul_:function(r,t){var e,n=_(r,"a","mul"),o=_(t,"b","mul");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i,s){var u=i.multiply(n,o);return s([n,o]),u},{a:n,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.mul(c.toFloat()),h=Oe(u.shape,a);return h.length>0?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Oe(c.shape,a);return h.length>0?l.sum(h).reshape(c.shape):l}}},"Mul")}}),Hp=A({mulStrict_:function(r,t){var e=_(r,"a","mul"),n=_(t,"b","mul");return pe(e.shape,n.shape,"Error in multiplyStrict: "),e.mul(n)}}),xo=A({pow_:function(r,t){var e,n=_(r,"base","pow"),o=_(t,"exp","pow");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(s,u){var c=s.pow(n,o);return u([n,o,c]),c},{a:n,b:o},function(s,u){var c=u[0],l=u[1],h=u[2];return{a:function(){var f=l.toFloat(),d=s.mul(f.mul(c.pow(f.sub(j(1))))),p=Oe(c.shape,a);return p.length>0&&(d=d.sum(p)),d.reshape(c.shape)},b:function(){var f=c.greater(0),d=c.log().where(f,ve(c)),p=s.mul(h.mul(d)),m=Oe(l.shape,a);return m.length>0&&(p=p.sum(m)),p.reshape(l.shape)}}},"Pow",{},[n,o],[!0])}}),jp=A({powStrict_:function(r,t){return pe(r.shape,t.shape,"Error in powStrict: "),r.pow(t)}}),qp=A({squaredDifferenceStrict_:function(r,t){var e=_(r,"a","squaredDifferenceStrict"),n=_(t,"b","squaredDifferenceStrict");return pe(e.shape,n.shape,"Error in squaredDifferenceStrict: "),e.squaredDifference(n)}}),We=A({sub_:function(r,t){var e,n=_(r,"a","sub"),o=_(t,"b","sub");e=Ie(n,o);var a=ce((n=e[0]).shape,(o=e[1]).shape);return D.runKernelFunc(function(i){return i.subtract(n,o)},{a:n,b:o},function(i){return{a:function(){var s=i,u=Oe(n.shape,a);return u.length>0&&(s=s.sum(u)),s.reshape(n.shape)},b:function(){var s=i,u=Oe(o.shape,a);return u.length>0&&(s=s.sum(u)),s.neg().reshape(o.shape)}}},"Sub")}}),Kp=A({subStrict_:function(r,t){var e=_(r,"a","subStrict"),n=_(t,"b","subStrict");return pe(e.shape,n.shape,"Error in subStrict: "),e.sub(n)}}),Sc=A({equal_:function(r,t){var e,n=_(r,"a","equal"),o=_(t,"b","equal");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a){return a.equal(n,o)},{$a:n,$b:o})}}),Xp=A({equalStrict_:function(r,t){var e=_(r,"a","equalStrict"),n=_(t,"b","equalStrict");return pe(e.shape,n.shape,"Error in equalStrict: "),e.equal(n)}}),Yp=A({greater_:function(r,t){var e,n=_(r,"a","greater"),o=_(t,"b","greater");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a){return a.greater(n,o)},{a:n,b:o},null,"Greater")}}),Dc=A({greaterEqual_:function(r,t){var e,n=_(r,"a","greaterEqual"),o=_(t,"b","greaterEqual");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a,i){var s=a.greaterEqual(n,o);return i([n,o]),s},{a:n,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return ve(s)},b:function(){return ve(u)}}},"GreaterEqual")}}),$p=A({greaterEqualStrict_:function(r,t){var e=_(r,"a","greaterEqualStrict"),n=_(t,"b","greaterEqualStrict");return pe(e.shape,n.shape,"Error in greaterEqualStrict: "),e.greaterEqual(n)}}),Qp=A({greaterStrict_:function(r,t){var e=_(r,"a","greaterStrict"),n=_(t,"b","greaterStrict");return pe(e.shape,n.shape,"Error in greaterStrict: "),e.greater(n)}}),Jp=A({less_:function(r,t){var e,n=_(r,"a","less"),o=_(t,"b","less");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a){return a.less(n,o)},{a:n,b:o},null,"Less")}}),Zp=A({lessEqual_:function(r,t){var e,n=_(r,"a","lessEqual"),o=_(t,"b","lessEqual");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a,i){var s=a.lessEqual(n,o);return i([n,o]),s},{a:n,b:o},null,"LessEqual")}}),ev=A({lessEqualStrict_:function(r,t){var e=_(r,"a","lessEqualStrict"),n=_(t,"b","lessEqualStrict");return pe(e.shape,n.shape,"Error in lessEqualStrict: "),e.lessEqual(n)}}),tv=A({lessStrict_:function(r,t){var e=_(r,"a","lessStrict"),n=_(t,"b","lessStrict");return pe(e.shape,n.shape,"Error in lessStrict: "),e.less(n)}}),nv=A({notEqual_:function(r,t){var e,n=_(r,"a","notEqual"),o=_(t,"b","notEqual");return e=Ie(n,o),ce((n=e[0]).shape,(o=e[1]).shape),D.runKernelFunc(function(a){return a.notEqual(n,o)},{a:n,b:o},null,"NotEqual")}}),rv=A({notEqualStrict_:function(r,t){var e=_(r,"a","notEqualStrict"),n=_(t,"b","notEqualStrict");return pe(e.shape,n.shape,"Error in notEqualStrict: "),e.notEqual(n)}});function Ac(r,t){for(var e=[],n=r;n<t;++n)e.push(n);return e}function Tc(r){for(var t=[],e=0;e<r.length;++e)for(var n=0;n<r[e].length;++n)t.push(r[e][n]);return t}var Va=A({gather_:function(r,t,e){void 0===e&&(e=0);var n=_(r,"x","gather"),o=_(t,"indices","gather","int32");e=Pe(e,n.shape)[0];var a=function(i,s,u){for(var c=i.shape[u],l=[],h=1,f=1,d=0;d<u;d++)l.push(i.shape[d]),h*=i.shape[d];for(d=0;d<s.rank;d++)l.push(s.shape[d]);for(d=u+1;d<i.rank;d++)l.push(i.shape[d]),f*=i.shape[d];return{batchSize:h,sliceSize:f,dimSize:c,outputShape:l}}(n,o,e);return D.runKernelFunc(function(i,s){var u=i.gather(n,o.flatten(),e);return s([o]),u},{x:n,indices:o},function(i,s){var u=s[0];return{x:function(){var c=n.shape,l=u.size,h=c.slice(0,e),f=h.length,d=c.slice(e,c.length).slice(1),p=d.length,m=Ac(0,f),v=Ac(f+1,f+1+p),g=Tc([h,[l],d]),x=i.reshape(g),b=u.reshape([l]),y=Tc([[f],m,v]),w=x.transpose(y),C=Fc(w,b,n.shape[e]),S=Qr(y);return C.transpose(S)},indices:function(){return u}}},"Gather",{axis:e}).reshape(a.outputShape)}}),Fc=A({unsortedSegmentSum_:function(r,t,e){var n=_(r,"x","unsortedSegmentSum"),o=_(t,"segmentIds","unsortedSegmentSum","int32");return E(Re(e),function(){return"numSegments must be of dtype int"}),D.runKernelFunc(function(a,i){var s=a.unsortedSegmentSum(n,o,e);return i([o]),s},{$x:n},function(a,i){var s=i[0];return{$x:function(){return function(u,c){for(var l=za(c,ve(c)),h=Va(u,l),f=Dc(c,j(0,"int32")),d=h.rank-f.rank,p=0;p<d;++p)f=dt(f,p+1);f=yo(f,Ln(h.shape,"bool"));var m=ve(h);return Rn(f,h,m)}(a,s)}}})}});function Nc(r,t,e,n,o,a,i){void 0===a&&(a="NHWC"),E(r.length===t.rank,function(){return"Length of inShape ("+r.length+") and rank of dy ("+t.rank+") must match"});var s=r,u=t,c=!1;3===t.rank&&(c=!0,u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]),s=[1,r[0],r[1],r[2]]),E(4===s.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+s.length+"."}),E(4===u.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),E(4===e.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+e.rank});var l="NHWC"===a?s[3]:s[1],h="NHWC"===a?u.shape[3]:u.shape[1];E(l===e.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+e.shape[2]+"."}),E(h===e.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+h+") must match output depth for filter "+e.shape[3]+"."}),null!=i&&E(Re(o),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var f=uo(a),d=an(s,e.shape,n,1,o,i,!1,f),p=D.runKernelFunc(function(m,v){var g=m.conv2dDerInput(u,e,d);return v([e,u]),g},{dy4D:u,filter:e},function(m,v){var g=v[0],x=v[1];return{dy4D:function(){return pt(m,g,n,o,a,1,i)},filter:function(){return Ga(m,x,g.shape,n,o,a,i)}}});return c?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p}function Ua(r){var a,t="number"==typeof(a=r)?[a,a,a]:2===a.length?[a[0],a[1],1]:a;return 1===t[0]&&1===t[1]&&1===t[2]}function Pc(r,t,e,n,o){E(r.length===t.rank,function(){return"Length of inShape ("+r.length+") and rank of dy ("+t.rank+") must match"});var a=r,i=t,s=!1;4===t.rank&&(s=!0,i=t.as5D(1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]),a=[1,r[0],r[1],r[2],r[3]]);var u=a[4],c=i.shape[4];E(5===a.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+a.length+"."}),E(5===i.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+i.rank}),E(5===e.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+e.rank}),E(u===e.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+e.shape[3]+"."}),E(c===e.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+c+") must match output depth for filter "+e.shape[4]+"."});var l=Er(a,e.shape,n,1,o),h=D.runKernelFunc(function(f){return f.conv3dDerInput(i,e,l)},{dy5D:i});return s?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}var av=A({conv1d_:function(r,t,e,n,o,a,i){void 0===o&&(o="NWC"),void 0===a&&(a=1);var s=_(r,"x","conv1d"),u=_(t,"filter","conv1d"),c=s,l=!1;2===s.rank&&(l=!0,c=s.as3D(1,s.shape[0],s.shape[1])),E(3===c.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+c.rank+"."}),E(3===u.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),null!=i&&E(Re(n),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+n+"."}),E(c.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+c.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),E(et(e,a),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+e+" and dilation '"+a+"'"}),E("NWC"===o,function(){return"Error in conv1d: got dataFormat of "+o+" but only NWC is currently supported."});var h=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),f=c.as4D(c.shape[0],1,c.shape[1],c.shape[2]),d=pt(f,h,[1,e],n,"NHWC",[1,a],i);return l?d.as2D(d.shape[2],d.shape[3]):d.as3D(d.shape[0],d.shape[2],d.shape[3])}}),pt=A({conv2d_:function(r,t,e,n,o,a,i){void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]);var s=_(r,"x","conv2d"),u=_(t,"filter","conv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),E(4===c.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+c.rank+"."}),E(4===u.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+u.rank+"."}),null!=i&&E(Re(n),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+n+"."});var h="NHWC"===o?c.shape[3]:c.shape[1];E(h===u.shape[2],function(){return"Error in conv2d: depth of input ("+h+") must match input depth for filter "+u.shape[2]+"."}),E(et(e,a),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"});var f=uo(o),d=an(c.shape,u.shape,e,a,n,i,!1,f),m=D.runKernelFunc(function(v,g){var x=v.conv2d(c,u,d);return g([u,c]),x},{x:c,filter:u},function(v,g){var b=g[0],y=g[1];return E(Cn(a),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"}),{x:function(){return Mc(y.shape,v,b,e,n,o)},filter:function(){return Ga(y,v,b.shape,e,n,o)}}},"Conv2D",d,[u,c]);return l?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}}),iv=A({conv3d_:function(r,t,e,n,o,a){void 0===o&&(o="NDHWC"),void 0===a&&(a=[1,1,1]);var d,i=_(r,"x","conv3d"),s=_(t,"filter","conv3d"),u=i,c=!1;4===i.rank&&(c=!0,u=i.as5D(1,i.shape[0],i.shape[1],i.shape[2],i.shape[3])),E(5===u.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+u.rank+"."}),E(5===s.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+s.rank+"."}),E(u.shape[4]===s.shape[3],function(){return"Error in conv3d: depth of input ("+u.shape[4]+") must match input depth for filter "+s.shape[3]+"."}),E((d=a,Ua(e)||Ua(d)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),E("NDHWC"===o,function(){return"Error in conv3d: got dataFormat of "+o+" but only NDHWC is currently supported."});var l=Er(u.shape,s.shape,e,a,n),h=D.runKernelFunc(function(f,d){var p=f.conv3d(u,s,l);return d([u,s]),p},{x:u,$filter:s},function(f,d){E(Ua(a),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"});var p=d[0],m=d[1];return{x:function(){return Pc(p.shape,f,m,e,n)},$filter:function(){return function(v,g,x,b,y){var w=v;4===v.rank&&(w=v.as5D(1,v.shape[0],v.shape[1],v.shape[2],v.shape[3]));var C=g;4===C.rank&&(C=g.as5D(1,g.shape[0],g.shape[1],g.shape[2],g.shape[3])),E(5===w.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+w.shape+"."}),E(5===C.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+C.shape+"."}),E(5===x.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+x+"."}),E(w.shape[4]===x[3],function(){return"Error in conv3dDerFilter: depth of input "+w.shape[4]+") must match input depth in filter ("+x[3]+"."}),E(C.shape[4]===x[4],function(){return"Error in conv3dDerFilter: depth of dy ("+C.shape[4]+") must match output depth for filter ("+x[4]+")."});var S=Er(w.shape,x,b,1,y);return D.runKernelFunc(function(k){return k.conv3dDerFilter(w,C,S)},{x5D:w,dy5D:C})}(p,f,m.shape,e,n)}}});return c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),Ga=A({conv2dDerFilter_:function(r,t,e,n,o,a,i){void 0===a&&(a="NHWC");var s=r;3===r.rank&&(s=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var u=t;3===u.rank&&(u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),E(4===s.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),E(4===u.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),E(4===e.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+e+"."});var c="NHWC"===a?s.shape[3]:s.shape[1],l="NHWC"===a?u.shape[3]:u.shape[1];E(c===e[2],function(){return"Error in conv2dDerFilter: depth of input "+c+") must match input depth in filter ("+e[2]+"."}),E(l===e[3],function(){return"Error in conv2dDerFilter: depth of dy ("+l+") must match output depth for filter ("+e[3]+")."}),null!=i&&E(Re(o),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var h=uo(a),f=an(s.shape,e,n,1,o,i,!1,h);return D.runKernelFunc(function(d){return d.conv2dDerFilter(s,u,f)},{x4D:s,dy4D:u})}}),Mc=A({conv2dDerInput_:Nc}),bo=A({depthwiseConv2d_:function(r,t,e,n,o,a,i){void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]);var s=_(r,"x","depthwiseConv2d"),u=_(t,"filter","depthwiseConv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),E(4===c.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),E(4===u.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+u.rank+"."}),E(c.shape[3]===u.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+u.shape[2]+"."}),null==a&&(a=[1,1]),E(et(e,a),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),null!=i&&E(Re(n),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+n+"."});var h=an(c.shape,u.shape,e,a,n,i,!0),d=D.runKernelFunc(function(p,m){var v=p.depthwiseConv2D(c,u,h);return m([c,u]),v},{x:c,filter:u},function(p,m){E(Cn(a),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"});var v=m[0],g=m[1];return{x:function(){return Oc(v.shape,p,g,h)},filter:function(){return Bc(v,p,g.shape,h)}}},"DepthwiseConv2dNative",h,[c,u]);return l?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}}),Oc=A({depthwiseConv2dDerInput_:function(r,t,e,n){var o=t,a=!1;3===t.rank&&(a=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var i=D.runKernelFunc(function(s){return s.depthwiseConv2DDerInput(o,e,n)},{dy4D:o});return a?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),Bc=A({depthwiseConv2dDerFilter_:function(r,t,e,n){var o=r;3===r.rank&&(o=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var a=t;return 3===a.rank&&(a=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),D.runKernelFunc(function(i){return i.depthwiseConv2DDerFilter(o,a,n)},{x4D:o,dy4D:a})}}),Ha=A({separableConv2d_:function(r,t,e,n,o,a,i){void 0===a&&(a=[1,1]),void 0===i&&(i="NHWC");var s=_(r,"x","separableConv2d"),u=_(t,"depthwiseFilter","separableConv2d"),c=_(e,"pointwiseFilter","separableConv2d"),l=s,h=!1;if(3===s.rank&&(h=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),"NCHW"===i)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");E(4===l.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+l.rank+"."}),E(4===u.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+u.rank+"."}),E(4===c.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+u.rank+"."}),E(1===c.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+c.shape[0]+"."}),E(1===c.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+c.shape[1]+"."});var f=u.shape[2],d=u.shape[3];E(c.shape[2]===f*d,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+f*d+", but got "+c.shape[2]+"."});var p=bo(l,u,n,o,i,a),m=pt(p,c,1,"valid",i);return h?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}}),sv=A({conv2dTranspose_:function(r,t,e,n,o,a){return Nc(e,_(r,"x","conv2dTranspose"),_(t,"filter","conv2dTranspose"),n,o,"NHWC",a)}}),uv=A({conv3dTranspose_:function(r,t,e,n,o){return Pc(e,_(r,"x","conv3dTranspose"),_(t,"filter","conv3dTranspose"),n,o)}}),wo=A({matMul_:function(r,t,e,n){var o;void 0===e&&(e=!1),void 0===n&&(n=!1);var a=_(r,"a","matMul"),i=_(t,"b","matMul");o=Ie(a,i),a=o[0],i=o[1];var s=e?a.shape[a.rank-2]:a.shape[a.rank-1],u=n?i.shape[i.rank-1]:i.shape[i.rank-2],c=e?a.shape[a.rank-1]:a.shape[a.rank-2],l=n?i.shape[i.rank-2]:i.shape[i.rank-1],h=a.shape.slice(0,-2),f=i.shape.slice(0,-2),d=Q(h),p=Q(f);E(a.rank>=2&&i.rank>=2&&a.rank===i.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+i.rank+"."}),E(Ne(h,f),function(){return"Error in matMul: outer dimensions ("+h+") and ("+f+") of Tensors with shapes "+a.shape+" and "+i.shape+" must match."}),E(s===u,function(){return"Error in matMul: inner shapes ("+s+") and ("+u+") of Tensors with shapes "+a.shape+" and "+i.shape+" and transposeA="+e+" and transposeB="+n+" must match."});var m=a.shape.slice(0,-2).concat([c,l]),v=e?a.as3D(d,s,c):a.as3D(d,c,s),g=n?i.as3D(p,l,u):i.as3D(p,u,l);return D.runKernelFunc(function(b,y){var w=b.batchMatMul(v,g,e,n);return y([v,g]),w},{a:v,b:g},function(b,y){var C=y[0],S=y[1];return e||n?!e&&n?{a:function(){return b.matMul(S,!1,!1)},b:function(){return b.matMul(C,!0,!1)}}:e&&!n?{a:function(){return S.matMul(b,!1,!0)},b:function(){return C.matMul(b,!1,!1)}}:{a:function(){return S.matMul(b,!0,!0)},b:function(){return b.matMul(C,!0,!0)}}:{a:function(){return b.matMul(S,!1,!0)},b:function(){return C.matMul(b,!0,!1)}}},"BatchMatMul",{transposeA:e,transposeB:n}).reshape(m)}}),cv=A({dot_:function(r,t){var e=_(r,"t1","dot"),n=_(t,"t2","dot");E(!(1!==e.rank&&2!==e.rank||1!==n.rank&&2!==n.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+e.rank+" and "+n.rank+"."});var o=1===e.rank?e.size:e.shape[1],a=1===n.rank?n.size:n.shape[0];return E(o===a,function(){return"Error in dot: inner dimensions of inputs must match, but got "+o+" and "+a+"."}),1===e.rank&&1===n.rank?e.as2D(1,-1).matMul(n.as2D(-1,1)).asScalar():1===e.rank&&2===n.rank?e.as2D(1,-1).matMul(n.as2D(n.shape[0],n.shape[1])).as1D():2===e.rank&&1===n.rank?e.matMul(n.as2D(-1,1)).as1D():e.matMul(n.as2D(n.shape[0],n.shape[1]))}}),lv=A({outerProduct_:function(r,t){var e=_(r,"v1","outerProduct"),n=_(t,"v2","outerProduct");return E(1===e.rank&&1===n.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+e.rank+" and "+n.rank+"."}),e.as2D(-1,1).matMul(n.as2D(1,-1))}}),Ar=A({reverse_:function(r,t){var e=_(r,"x","reverse");if(0===e.rank)return e.clone();var n=Pe(t,e.shape);return D.runKernelFunc(function(o){return o.reverse(e,n)},{$x:e},function(o){return{$x:function(){return o.reverse(n)}}}).reshapeAs(e)}}),hv=A({reverse1d_:function(r){var t=_(r,"x","reverse");return E(1===t.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+t.rank+"."}),Ar(t,0)}}),fv=A({reverse2d_:function(r,t){var e=_(r,"x","reverse");return E(2===e.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+e.rank+"."}),Ar(e,t)}}),dv=A({reverse3d_:function(r,t){var e=_(r,"x","reverse");return E(3===e.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+e.rank+"."}),Ar(e,t)}}),pv=A({reverse4d_:function(r,t){var e=_(r,"x","reverse");return E(4===e.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+e.rank+"."}),Ar(e,t)}});function Lc(r,t,e,n,o,a){var i=_(r,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),null==n&&(n=[1,1]),E(4===s.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),E(et(e,n),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+n+"'"}),null!=a&&E(Re(o),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=zn(s.shape,t,e,n,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Ne(c.inShape,c.outShape))return i.clone();var h=D.runKernelFunc(function(f,d){var p=f.maxPool(s,c);return d([s,p]),p},{x:s},function(f,d){var p=d[0],m=d[1];return{x:function(){return function(v,g,x,b,y,w,C){var k=_(v,"dy","maxPoolBackprop"),I=_(g,"input","maxPoolBackprop"),R=_(x,"output","maxPoolBackprop");E(I.rank===k.rank,function(){return"Rank of input ("+I.rank+") does not match rank of dy ("+k.rank+")"}),null==w&&(w=[1,1]),E(et(y,w),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+y+" and dilations '"+w+"'"}),E(4===k.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+k.rank+"."}),E(4===I.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+I.rank+"."});var F=zn(I.shape,b,y,w,C,void 0);return D.runKernelFunc(function(T){return T.maxPoolBackprop(k,I,R,F)},{$dy:k,$input:I})}(f,p,m,t,e,n,o)}}},"MaxPool",c,[s]);return u?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}function Wc(r,t,e,n,o,a){var i=_(r,"x","avgPool","float32");null==n&&(n=[1,1]),E(et(e,n),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+n+"'"});var s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),E(4===s.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),null!=a&&E(Re(o),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=zn(s.shape,t,e,n,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Ne(c.inShape,c.outShape))return i.clone();var l=D.runKernelFunc(function(h){return h.avgPool(s,c)},{x:s},function(h){return{x:function(){return function(f,d,p,m,v,g){var x=_(f,"dy","avgPoolBackprop"),b=_(d,"input","avgPoolBackprop");E(b.rank===x.rank,function(){return"Rank of input ("+b.rank+") does not match rank of dy ("+x.rank+")"}),null==v&&(v=[1,1]),E(et(m,v),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+m+" and dilations '"+v+"'"});var y=b,w=x,C=!1;3===b.rank&&(C=!0,y=b.as4D(1,b.shape[0],b.shape[1],b.shape[2]),w=x.as4D(1,x.shape[0],x.shape[1],x.shape[2])),E(4===w.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+w.rank+"."}),E(4===y.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+y.rank+"."});var S=zn(y.shape,p,m,v,g),k=D.runKernelFunc(function(I){return I.avgPoolBackprop(w,y,S)},{dy4D:w,input4D:y});return C?k.as3D(k.shape[1],k.shape[2],k.shape[3]):k}(h,s,t,e,n,o)}}},"AvgPool",c);return l=l.cast(i.dtype),u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l}var Ue=A({maxPool_:function(r,t,e,n,o){return Lc(r,t,e,1,n,o)}}),Tr=A({avgPool_:function(r,t,e,n,o){return Wc(r,t,e,1,n,o)}}),vv=A({pool_:function(r,t,e,n,o,a){null==o&&(o=[1,1]),null==a&&(a=1),0===n&&(n="valid");var i=_(r,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),E(et(a,o),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+o+"'"});var c,w,C,S,k,l=zn(s.shape,t,a,o,n),h=[l.dilationHeight,l.dilationWidth];c="same"===n?(w=h,C=[l.filterHeight,l.filterWidth].map(function(I,R){return I+(I-1)*(w[R]-1)}).map(function(I){return I-1}),S=C.map(function(I){return Math.floor(I/2)}),k=C.map(function(I,R){return I-S[R]}),C.map(function(I,R){return[S[R],k[R]]})):[[0,0],[0,0]];var f=1===h[0]&&1===h[1],d=function(y,w,C){var S=C.map(function(O){return O[0]}),k=C.map(function(O){return O[1]}),I=y.concat(S,k),R=w.map(function(O,B){return(O-I[B]%O)%O}),F=k.map(function(O,B){return O+R[B]});return[w.map(function(O,B){return[S[B],F[B]]}),w.map(function(O,B){return[0,R[B]]})]}([l.inHeight,l.inWidth],h,c),m=d[1],v=f?n:"valid",g=f?s:uu(s,h,d[0]),x=("avg"===e?function(){return Wc(g,t,a,1,v)}:function(){return Lc(g,t,a,1,v)})(),b=f?x:au(x,h,m);return u?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}}),mv=A({maxPool3d_:function(r,t,e,n,o,a,i){void 0===a&&(a="NDHWC");var s=_(r,"x","maxPool3d"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),E(5===u.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),E("NDHWC"===a,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),E(et(e,i),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+i+"'"}),null!=o&&E(Re(n),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+n+"."});var l=Cr(u.shape,t,e,i,n,o,a),h=D.runKernelFunc(function(f,d){var p=f.maxPool3d(u,l);return d([u,p]),p},{x:u},function(f,d){var p=d[0],m=d[1];return{x:function(){return function(v,g,x,b,y,w,C,S){var k=_(v,"dy","maxPool3dBackprop"),I=_(g,"input","maxPool3dBackprop"),R=_(x,"output","maxPool3dBackprop"),F=k,T=I,L=R,O=!1;4===I.rank&&(O=!0,F=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3]),T=I.as5D(1,I.shape[0],I.shape[1],I.shape[2],I.shape[3]),L=R.as5D(1,R.shape[0],R.shape[1],R.shape[2],R.shape[3])),E(5===F.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+F.rank+"."}),E(5===T.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+T.rank+"."}),E(5===L.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+L.rank+"."}),null==w&&(w=[1,1,1]),E(et(y,w),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+y+" and dilations '"+w+"'"}),null!=S&&E(Re(C),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+S+" but got pad "+C+"."});var B=Cr(T.shape,b,y,w,C,S),U=D.runKernelFunc(function(z){return z.maxPool3dBackprop(F,T,L,B)},{dy5D:F,input5D:T});return O?U.as4D(U.shape[1],U.shape[2],U.shape[3],U.shape[4]):U}(f,p,m,t,e,i,n,o)}}});return c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),gv=A({avgPool3d_:function(r,t,e,n,o,a,i){void 0===a&&(a="NDHWC");var s=_(r,"x","avgPool3d","float32"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),E(5===u.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),E("NDHWC"===a,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),E(et(e,i),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+i+"'"}),null!=o&&E(Re(n),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+n+"."});var l=Cr(u.shape,t,e,i,n,o,a),h=D.runKernelFunc(function(f){return f.avgPool3d(u,l)},{x:u},function(f){return{x:function(){return function(d,p,m,v,g,x,b){var y=_(d,"dy","avgPool3dBackprop"),w=_(p,"input","avgPool3dBackprop"),C=y,S=w,k=!1;4===w.rank&&(k=!0,C=y.as5D(1,y.shape[0],y.shape[1],y.shape[2],y.shape[3]),S=w.as5D(1,w.shape[0],w.shape[1],w.shape[2],w.shape[3])),E(5===C.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+C.rank+"."}),E(5===S.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+S.rank+"."}),null==g&&(g=[1,1,1]),E(et(v,g),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+v+" and dilations '"+g+"'"}),null!=b&&E(Re(x),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+b+" but got pad "+x+"."});var I=Cr(S.shape,m,v,g,x,b),R=D.runKernelFunc(function(F){return F.avgPool3dBackprop(C,S,I)},{dy5D:C,input5D:S});return k?R.as4D(R.shape[1],R.shape[2],R.shape[3],R.shape[4]):R}(f,u,t,e,i,n,o)}}});return h=h.cast(u.dtype),c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),At=A({slice_:function(r,t,e){var n,o,a=_(r,"x","slice");if(0===a.rank)throw new Error("Slicing scalar is not possible");(n="number"==typeof t?[t].concat(new Array(a.rank-1).fill(0)):t.length<a.rank?t.concat(new Array(a.rank-t.length).fill(0)):t.slice()).forEach(function(u){E(-1!==u,function(){return"slice() does not support negative begin indexing."})}),o=(o=null==e?new Array(a.rank).fill(-1):"number"==typeof e?[e].concat(new Array(a.rank-1).fill(-1)):e.length<a.rank?e.concat(new Array(a.rank-e.length).fill(-1)):e).map(function(u,c){return u>=0?u:(E(-1===u,function(){return"Negative size values should be exactly -1 but got "+u+" for the slice() size at index "+c+"."}),a.shape[c]-n[c])}),pu(a,n,o);var i=a.shape;return D.runKernelFunc(function(u){return u.slice(a,n,o)},{x:a},function(u){for(var c=[],l=0;l<u.rank;l++)c.push([n[l],i[l]-n[l]-o[l]]);return{x:function(){return u.pad(c)}}},"Slice",{begin:n,size:o})}}),yv=A({slice1d_:function(r,t,e){var n=_(r,"x","slice1d");return E(1===n.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+n.rank+" tensor"}),At(n,[t],[e])}}),xv=A({slice2d_:function(r,t,e){var n=_(r,"x","slice2d");return E(2===n.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+n.rank+" tensor"}),At(n,t,e)}}),zc=A({slice3d_:function(r,t,e){var n=_(r,"x","slice3d");return E(3===n.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+n.rank+" tensor"}),At(n,t,e)}}),bv=A({slice4d_:function(r,t,e){var n=_(r,"x","slice4d");return E(4===n.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+n.rank+" tensor"}),At(n,t,e)}});function Vc(r,t,e,n,o){return t.rank<e.rank&&(t=t.reshape(Ze(t.shape,n))),r.rank<e.rank&&(r=r.reshape(Ze(r.shape,n))),{x:function(){var a=r.mul(e.equal(t).cast(r.dtype));return null==o?a:a.transpose(o)}}}var wv=A({all_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","all","bool"),o=Pe(t,n.shape),a=o,i=xt(a,n.rank);null!=i&&(n=n.transpose(i),a=bt(a.length,n.rank));var s=D.runKernelFunc(function(c){return c.all(n,a)},{$x:n});if(e){var u=Ze(s.shape,o);return s.reshape(u)}return s}}),_v=A({any_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","any","bool"),o=Pe(t,n.shape),a=o,i=xt(a,n.rank);null!=i&&(n=n.transpose(i),a=bt(a.length,n.rank));var s=D.runKernelFunc(function(c){return c.any(n,a)},{$x:n});if(e){var u=Ze(s.shape,o);return s.reshape(u)}return s}}),Cv=A({argMax_:function(r,t){void 0===t&&(t=0);var e=_(r,"x","argMax");null==t&&(t=0);var n=Pe(t,e.shape),o=xt(n,e.rank);return null!=o&&(e=e.transpose(o),n=bt(n.length,e.rank)),D.runKernelFunc(function(s,u){var c=s.argMax(e,n[0]);return u([e]),c},{x:e},function(s,u){var c=u[0];return{x:function(){return ve(c)}}},"ArgMax",{axis:n[0]},[e])}}),Ev=A({argMin_:function(r,t){void 0===t&&(t=0);var e=_(r,"x","argMin");null==t&&(t=0);var n=Pe(t,e.shape),o=xt(n,e.rank);return null!=o&&(e=e.transpose(o),n=bt(n.length,e.rank)),D.runKernelFunc(function(a,i){var s=a.argMin(e,n[0]);return i([e]),s},{$x:e},function(a,i){var s=i[0];return{$x:function(){return ve(s)}}})}}),Iv=A({logSumExp_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","logSumExp"),o=Pe(t,n.shape),a=n.max(o,!0),i=n.sub(a).exp().sum(o).log(),s=a.reshape(i.shape).add(i);if(e){var u=Ze(s.shape,o);return s.reshape(u)}return s}}),_o=A({max_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","max"),o=n,a=Pe(t,n.shape),i=a,s=xt(i,n.rank);null!=s&&(n=n.transpose(s),i=bt(i.length,n.rank));var c=D.runKernelFunc(function(h,f){var d=h.max(n,i);return f([o,d]),d},{x:n},function(h,f){return Vc(h,f[1],f[0],a,s)},"Max",{axes:i},[n],[!0]);if(e){var l=Ze(c.shape,a);c=c.reshape(l)}return c}}),Rv=A({mean_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","mean"),o=Pe(t,n.shape),a=Q(je(n.shape,o)[1]);return ao(function(i){var s=j(a);return{value:(s.dtype===i.dtype?i:i.cast(s.dtype)).div(s).sum(t,e),gradFunc:function(u){var c=i.shape.slice();return o.forEach(function(l){c[l]=1}),u.reshape(c).mul(Ln(i.shape,"float32")).div(a)}}})(n)}}),kv=A({min_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","min"),o=n,a=Pe(t,n.shape),i=a,s=xt(i,n.rank);null!=s&&(n=n.transpose(s),i=bt(i.length,n.rank));var c=D.runKernelFunc(function(h,f){var d=h.min(n,i);return f([o,d]),d},{x:n},function(h,f){return Vc(h,f[1],f[0],a,s)},"Min",{axes:i},[n],[!0]);if(e){var l=Ze(c.shape,a);c=c.reshape(l)}return c}}),Sv=A({moments_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=Pe(t,(r=_(r,"x","moments")).shape),o=r.mean(n,e),a=o.shape;e||(a=Ze(o.shape,n));var i=r.toFloat().sub(o.reshape(a)).square();return{mean:o,variance:i.mean(n,e)}}}),Uc=A({sum_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","sum");"bool"===n.dtype&&(n=n.toInt());var o=Pe(t,n.shape);return ao(function(a){var i=xt(o,a.rank),s=o,u=a;null!=i&&(u=a.transpose(i),s=bt(s.length,a.rank));var c=function(d){var p=a.shape.slice();return o.forEach(function(m){p[m]=1}),d.reshape(p).mul(Ln(a.shape,"float32"))},h=D.runKernelFunc(function(d){return d.sum(u,s)},{x:u},function(d){return{x:function(){return c(d)}}},"Sum",{axes:s});if(e){var f=Ze(h.shape,o);h=h.reshape(f)}return{value:h,gradFunc:c}})(n)}}),Dv=A({prod_:function(r,t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n=_(r,"x","prod");"bool"===n.dtype&&(n=n.toInt());var o=Pe(t,n.shape),a=xt(o,n.rank),i=o,s=n;null!=a&&(s=n.transpose(a),i=bt(i.length,n.rank));var u=D.runKernelFunc(function(l){return l.prod(s,i)},{permutedX:s});if(e){var c=Ze(u.shape,o);u=u.reshape(c)}return u}}),Gc=A({elu_:function(r){var t=_(r,"x","elu");return D.runKernelFunc(function(e,n){var o=e.elu(t);return n([o]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){return D.runKernelFunc(function(a){return a.eluDer(e,o)},{dy:e,y:o})}}})}}),Av=A({leakyRelu_:function(r,t){void 0===t&&(t=.2);var e=_(r,"x","leakyRelu");return za(j(t).mul(e),e)}}),Hc=A({prelu_:function(r,t){var e=_(r,"x","prelu"),n=_(t,"alpha","prelu");return D.runKernelFunc(function(o,a){var i=o.prelu(e,n);return a([e,n]),i},{x:e,alpha:n},function(o,a){var i=a[0],s=a[1],u=i.greater(0);return{x:function(){return Rn(u,o,o.mul(s))},alpha:function(){var c=Rn(u,ve(o),o.mul(i)),l=Oe(s.shape,o.shape);return l.length>0&&(c=c.sum(l)),c.reshape(s.shape)}}},"Prelu")}}),ke=A({relu_:function(r){var t=_(r,"x","relu");return"bool"===t.dtype?t.toInt():D.runKernelFunc(function(e,n){var o=e.relu(t);return n([t]),o},{x:t},function(e,n){var o=n[0];return{x:function(){return e.mulStrict(o.step().toFloat())}}},"Relu")}}),jc=A({relu6_:function(r){var t=_(r,"x","relu6");return"bool"===t.dtype?t.toInt():D.runKernelFunc(function(e,n){var o=e.relu6(t);return n([t]),o},{x:t},function(e,n){var o=n[0],a=o.lessEqual(6).mul(o.step());return{x:function(){return e.mulStrict(a.toFloat())}}},"Relu6")}}),Tv=A({selu_:function(r){var t=_(r,"x","selu");return D.runKernelFunc(function(e,n){var o=e.selu(t);return n([t]),o},{$x:t},function(e,n){var o=n[0];return{$x:function(){var a=o.greater(j(0)),i=j(Oa),s=j(Ba),u=e.mul(s),c=e.mul(i).mul(o.toFloat().exp());return Rn(a,u,c)}}})}}),sn=A({transpose_:function(r,t){var e=_(r,"x","transpose");return null==t&&(t=e.shape.map(function(o,a){return a}).reverse()),E(e.rank===t.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of perm "+t+"."}),t.forEach(function(o){E(o>=0&&o<e.rank,function(){return"All entries in 'perm' must be between 0 and "+(e.rank-1)+" but got "+t})}),e.rank<=1?e.clone():D.runKernelFunc(function(o){return o.transpose(e,t)},{x:e},function(o){var a=Qr(t);return{x:function(){return o.transpose(a)}}},"Transpose",{perm:t})}}),Fv=A({localResponseNormalization_:function(r,t,e,n,o){void 0===t&&(t=5),void 0===e&&(e=1),void 0===n&&(n=1),void 0===o&&(o=.5);var a=_(r,"x","localResponseNormalization");E(4===a.rank||3===a.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+a.rank+"."}),E(Re(t),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+t+"."});var i=a,s=!1;3===a.rank&&(s=!0,i=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var u=D.runKernelFunc(function(c,l){var h=c.localResponseNormalization4D(i,t,e,n,o);return l([i,h]),h},{x4D:i},function(c,l){var h=l[0],f=l[1];return{x4D:function(){return D.runKernelFunc(function(d){return d.LRNGrad(c,h,f,t,e,n,o)},{})}}});return s?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),qc=A({norm_:function(r,t,e,n){void 0===t&&(t="euclidean"),void 0===e&&(e=null),void 0===n&&(n=!1);var o=function s(u,c,l){if(void 0===l&&(l=null),0===u.rank)return u.abs();if(1!==u.rank&&null===l)return s(u.reshape([-1]),c,l);if(1===u.rank||"number"==typeof l||Array.isArray(l)&&1===l.length){if(1===c)return u.abs().sum(l);if(c===1/0)return u.abs().max(l);if(c===-1/0)return u.abs().min(l);if("euclidean"===c||2===c)return u.abs().pow(j(2,"int32")).sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(l)&&2===l.length){if(1===c)return u.abs().sum(l[0]).max(l[1]-1);if(c===1/0)return u.abs().sum(l[1]).max(l[0]);if(c===-1/0)return u.abs().sum(l[1]).min(l[0]);if("fro"===c||"euclidean"===c)return u.square().sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}throw new Error("Error in norm: invalid axis: "+l)}(r=_(r,"x","norm"),t,e),a=o.shape;if(n){var i=Pe(e,r.shape);a=Ze(o.shape,i)}return o.reshape(a)}}),Nv=A({basicLSTMCell_:function(r,t,e,n,o,a){var i=_(r,"forgetBias","basicLSTMCell"),s=_(t,"lstmKernel","basicLSTMCell"),u=_(e,"lstmBias","basicLSTMCell"),c=_(n,"data","basicLSTMCell"),l=_(o,"c","basicLSTMCell"),h=_(a,"h","basicLSTMCell"),f=c.concat(h,1).matMul(s).add(u),p=f.shape[1]/4,m=[f.shape[0],p],v=f.slice([0,0],m),g=f.slice([0,p],m),x=f.slice([0,2*p],m),b=f.slice([0,3*p],m),y=v.sigmoid().mulStrict(g.tanh()).addStrict(l.mulStrict(i.add(x).sigmoid())),w=y.tanh().mulStrict(b.sigmoid());return[y,w]}}),Pv=A({multiRNNCell_:function(r,t,e,n){for(var o=_(t,"data","multiRNNCell"),a=wr(e,"c","multiRNNCell"),i=wr(n,"h","multiRNNCell"),s=o,u=[],c=0;c<r.length;c++){var l=r[c](s,a[c],i[c]);u.push(l[0]),u.push(l[1]),s=l[1]}var h=[],f=[];for(c=0;c<u.length;c+=2)h.push(u[c]),f.push(u[c+1]);return[h,f]}}),Mv=A({movingAverage_:function(r,t,e,n,o){void 0===o&&(o=!0);var a=_(r,"v","movingAverage"),i=_(t,"x","movingAverage"),s=_(e,"decay","movingAverage");Rs(a,i),E(Ne(a.shape,i.shape),function(){return"Shape mismatch in v and x"});var u=j(1),c=u.sub(s),l=i.sub(a).mul(c);if(o){E(null!=n,function(){return"When using zeroDebias: true, step is required."});var h=_(n,"step","movingAverage");l=l.div(u.sub(xo(s,h)))}return a.add(l)}}),Ov=A({stridedSlice_:function(r,t,e,n,o,a,i,s,u){if(void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===u&&(u=0),null==n&&(n=new Array(t.length)),0!==i)throw new Error("ellipsis mask is not yet supported");var c=_(r,"x","stridedSlice"),l=ya(s),h=c.shape.slice();l.forEach(function(v){t[v]=0,e[v]=1,h.splice(v,0,1)}),c=c.reshape(h);for(var f=0;f<c.rank;f++)t[f]=vu(o,t,n,c.shape,f),e[f]=mu(a,e,n,c.shape,f),n[f]=n[f]||1;var d=ya(u);d.forEach(function(v){e[v]=t[v]+1,n[v]=1});var p=oo(t,e,n),m=p.filter(function(v,g){return-1===d.indexOf(g)});return n.every(function(v){return 1===v})?At(c,t,p).reshape(m):D.runKernelFunc(function(v){return v.stridedSlice(c,t,e,n)},{$x:c}).reshape(m)}}),Bv=A({topk_:function(r,t,e){void 0===t&&(t=1),void 0===e&&(e=!0);var n=_(r,"x","topk");if(0===n.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var o=n.shape[n.shape.length-1];if(t>o)throw new Error("'k' passed to topk() must be <= the last dimension ("+o+") but got "+t);var a=D.runKernelFunc(function(i){return i.topk(n,t,e)},{$x:n});return{values:a[0],indices:a[1]}}}),Lv=A({scatterND_:function(r,t,e){var n=_(r,"indices","scatterND","int32"),o=_(t,"updates","scatterND");return du(o,n,e),D.runKernelFunc(function(a){return a.scatterND(n,o,e)},{indices:n,updates:o},null,"ScatterNd",{shape:e})}}),ja=A({fft_:function(r){E("complex64"===r.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+r.dtype+"."});var t=r.shape[r.shape.length-1],n=r.as2D(r.size/t,t);return D.runKernelFunc(function(o){return o.fft(n)},{input:r}).reshape(r.shape)}}),Co=A({ifft_:function(r){E("complex64"===r.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+r.dtype+"."});var t=r.shape[r.shape.length-1],n=r.as2D(r.size/t,t);return D.runKernelFunc(function(o){return o.ifft(n)},{input:r}).reshape(r.shape)}}),qa=A({rfft_:function(r,t){E("float32"===r.dtype,function(){return"The dtype for rfft() must be real value but got "+r.dtype});var e,n=r.shape[r.shape.length-1],o=r.size/n;if(null!=t&&t<n){var a=r.shape.map(function(g){return 0}),i=r.shape.map(function(g){return g});i[r.shape.length-1]=t,e=r.slice(a,i),n=t}else if(null!=t&&t>n){var s=r.shape.map(function(g){return g});s[r.shape.length-1]=t-n,e=r.concat(Ee(s),r.shape.length-1),n=t}else e=r;var u=e.zerosLike(),c=qe(e,u).as2D(o,n),l=ja(c),h=Math.floor(n/2)+1,f=ft(l),d=St(l),p=f.split([h,n-h],f.shape.length-1),m=d.split([h,n-h],d.shape.length-1),v=e.shape.slice();return v[e.shape.length-1]=h,qe(p[0],m[0]).reshape(v)}}),Kc=A({irfft_:function(r){var t=r.shape[r.shape.length-1],e=r.size/t;if(t<=2){var n=r.as2D(e,t),o=Co(n);return ft(o)}var a=[e,2*(t-1)],i=ft(r).as2D(e,t),s=St(r).as2D(e,t),u=i.slice([0,1],[e,t-2]).reverse(1),c=s.slice([0,1],[e,t-2]).reverse(1).mul(j(-1)),l=i.concat(u,1),h=s.concat(c,1);return n=qe(l,h).as2D(a[0],a[1]),o=Co(n),ft(o)}}),Wv=Object.freeze({fft:ja,ifft:Co,rfft:qa,irfft:Kc}),zv=A({sparseToDense_:function(r,t,e,n){void 0===n&&(n=0);var o=_(r,"sparseIndices","sparseToDense","int32"),a=_(t,"sparseValues","sparseToDense"),i=_(n,"defaultValue","sparseToDense",a.dtype);return function(s,u,c,l){if("int32"!==s.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+s.dtype+".");if(s.rank>2)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+s.shape+".");var h=s.rank>0?s.shape[0]:1,f=s.rank>1?s.shape[1]:1;if(c.length!==f)throw new Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+f+".");if(0!==u.rank&&(1!==u.rank||u.size!==h))throw new Error("sparseValues has incorrect shape "+u.shape+", should be [] or ["+h+"]");if(u.dtype!==l.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(o,a,e,i),D.runKernelFunc(function(s){return s.sparseToDense(o,a,e,i)},{$sparseIndices:o,$sparseValues:a,$defaultValue:i})}}),Vv=A({gatherND_:function(r,t){var e=_(t,"indices","gatherND","int32"),n=_(r,"x","gatherND");return D.runKernelFunc(function(o){return o.gatherND(n,e)},{x:n,indices:e},null,"GatherNd")}}),Uv=A({diag_:function(r){var t=_(r,"x","diag").flatten(),e=r.shape.concat(r.shape);return D.runKernelFunc(function(n){return n.diag(t)},{$x:t}).reshape(e)}}),Gv=A({dropout_:function(r,t,e,n){var o=_(r,"x","dropout");if(E("float32"===o.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+o.dtype+" tensor instead."}),E(t>=0&&t<1,function(){return"rate must be a float in the range [0, 1), but got "+t+"."}),0===t)return r instanceof _e?o.clone():o;var a=function(u,c){if(null==c)return u.shape.slice();if(Ne(u.shape,c))return c;if(u.shape.length===c.length){for(var l=[],h=0;h<u.shape.length;h++)l.push(null==c[h]&&null!=u.shape[h]?u.shape[h]:c[h]);return l}return c}(o,e),i=1-t,s=su(a,0,1,"float32",n).add(i).floor().div(i);return o.mul(s)}});function Xc(r,t,e){for(var n=1-r%2,o=new Float32Array(r),a=0;a<r;++a){var i=2*Math.PI*a/(r+n-1);o[a]=t-e*Math.cos(i)}return Me(o,"float32")}var $e,Ka=A({hannWindow_:function(r){return Xc(r,.5,.5)}}),Yc=A({hammingWindow_:function(r){return Xc(r,.54,.46)}}),Xa=A({frame_:function(r,t,e,n,o){void 0===n&&(n=!1),void 0===o&&(o=0);for(var a=0,i=[];a+t<=r.size;)i.push(At(r,a,t)),a+=e;if(n)for(;a<r.size;){var s=a+t-r.size,u=Be([At(r,a,t-s),Dt([s],o)]);i.push(u),a+=e}return 0===i.length?on([],[0,t]):Be(i).as2D(i.length,t)}}),$c=A({stft_:function(r,t,e,n,o){void 0===o&&(o=Ka),null==n&&(n=Math.floor(Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))));for(var i=Xa(r,t,e),s=Ye(i,o(t)),u=[],c=0;c<i.shape[0];c++)u.push(qa(s.slice([c,0],[1,t]),n));return Be(u)}}),Hv=Object.freeze({hannWindow:Ka,hammingWindow:Yc,frame:Xa,stft:$c});!function(r){r[r.NONE=0]="NONE",r[r.MEAN=1]="MEAN",r[r.SUM=2]="SUM",r[r.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}($e||($e={}));var qv=A({absoluteDifference_:function(r,t,e,n){void 0===n&&(n=$e.SUM_BY_NONZERO_WEIGHTS);var o=_(r,"labels","absoluteDifference"),a=_(t,"predictions","absoluteDifference"),i=null;null!=e&&(i=_(e,"weights","absoluteDifference")),pe(o.shape,a.shape,"Error in absoluteDifference: ");var s=o.sub(a).abs();return jt(s,i,n)}}),jt=A({computeWeightedLoss_:function(r,t,e){void 0===e&&(e=$e.SUM_BY_NONZERO_WEIGHTS);var n=_(r,"losses","computeWeightedLoss"),o=null;null!=t&&(o=_(t,"weights","computeWeightedLoss"));var a=null==o?n:n.mul(o);if(e===$e.NONE)return a;if(e===$e.SUM)return a.sum();if(e===$e.MEAN){if(null==o)return a.mean();var i=n.size/o.size,s=a.sum().div(o.sum());return i>1?s.div(j(i)):s}if(e===$e.SUM_BY_NONZERO_WEIGHTS){if(null==o)return a.sum().div(j(n.size));var u=o.mul(Ln(n.shape)).notEqual(j(0)).sum().toFloat();return a.sum().div(u)}throw Error("Unknown reduction: "+e)}}),Kv=A({cosineDistance_:function(r,t,e,n,o){void 0===o&&(o=$e.SUM_BY_NONZERO_WEIGHTS);var a=_(r,"labels","cosineDistance"),i=_(t,"predictions","cosineDistance"),s=null;null!=n&&(s=_(n,"weights","cosineDistance")),pe(a.shape,i.shape,"Error in cosineDistance: ");var u=j(1).sub(a.mul(i).sum(e,!0));return jt(u,s,o)}}),Xv=A({hingeLoss_:function(r,t,e,n){void 0===n&&(n=$e.SUM_BY_NONZERO_WEIGHTS);var o=_(r,"labels","hingeLoss"),a=_(t,"predictions","hingeLoss"),i=null;null!=e&&(i=_(e,"weights","hingeLoss")),pe(o.shape,a.shape,"Error in hingeLoss: ");var s=j(1);o=j(2).mul(o).sub(s);var u=s.sub(o.mul(a)).relu();return jt(u,i,n)}}),Yv=A({huberLoss_:function(r,t,e,n,o){void 0===n&&(n=1),void 0===o&&(o=$e.SUM_BY_NONZERO_WEIGHTS);var a=_(r,"labels","huberLoss"),i=_(t,"predictions","huberLoss"),s=null;null!=e&&(s=_(e,"weights","huberLoss")),pe(a.shape,i.shape,"Error in huberLoss: ");var u=j(n),c=i.sub(a).abs(),l=kc(c,u),h=c.sub(l),f=j(.5).mul(l.square()).add(u.mul(h));return jt(f,s,o)}}),$v=A({logLoss_:function(r,t,e,n,o){void 0===n&&(n=1e-7),void 0===o&&(o=$e.SUM_BY_NONZERO_WEIGHTS);var a=_(r,"labels","logLoss"),i=_(t,"predictions","logLoss"),s=null;null!=e&&(s=_(e,"weights","logLoss")),pe(a.shape,i.shape,"Error in logLoss: ");var u=j(1),c=j(n),l=a.mul(i.add(c).log()).neg().sub(u.sub(a).mul(u.sub(i).add(c).log()));return jt(l,s,o)}}),Qv=A({meanSquaredError_:function(r,t,e,n){void 0===n&&(n=$e.SUM_BY_NONZERO_WEIGHTS);var o=_(r,"labels","meanSquaredError"),a=_(t,"predictions","meanSquaredError"),i=null;null!=e&&(i=_(e,"weights","meanSquaredError")),pe(o.shape,a.shape,"Error in meanSquaredError: ");var s=o.squaredDifference(a);return jt(s,i,n)}}),Jv=A({sigmoidCrossEntropy_:function(r,t,e,n,o){void 0===n&&(n=0),void 0===o&&(o=$e.SUM_BY_NONZERO_WEIGHTS);var a=_(r,"multiClassLabels","sigmoidCrossEntropy"),i=_(t,"logits","sigmoidCrossEntropy"),s=null;if(null!=e&&(s=_(e,"weights","sigmoidCrossEntropy")),pe(a.shape,i.shape,"Error in sigmoidCrossEntropy: "),n>0){var u=j(n),c=j(1),l=j(.5);a=a.mul(c.sub(u)).add(l.mul(u))}var h=function(f,d){var p=_(f,"labels","sigmoidCrossEntropyWithLogits"),m=_(d,"logits","sigmoidCrossEntropyWithLogits");pe(p.shape,m.shape,"Error in sigmoidCrossEntropyWithLogits: ");var v=m.relu(),g=m.mul(p),x=m.abs().neg().exp().log1p();return v.sub(g).add(x)}(a,i);return jt(h,s,o)}}),Zv=A({softmaxCrossEntropy_:function(r,t,e,n,o){void 0===n&&(n=0),void 0===o&&(o=$e.SUM_BY_NONZERO_WEIGHTS);var a=_(r,"onehotLabels","softmaxCrossEntropy"),i=_(t,"logits","softmaxCrossEntropy"),s=null;if(null!=e&&(s=_(e,"weights","softmaxCrossEntropy")),pe(a.shape,i.shape,"Error in softmaxCrossEntropy: "),n>0){var u=j(n),c=j(1),l=j(a.shape[1]);a=a.mul(c.sub(u)).add(u.div(l))}var h=function(f,d,p){if(void 0===p&&(p=-1),-1===p&&(p=d.rank-1),p!==d.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+d.rank+" and dim was "+p);return ao(function(m,v,g){var x=v.logSumExp([p],!0),b=v.toFloat().sub(x);return g([m,b]),{value:b.mul(m).neg().sum([p]),gradFunc:function(y,w){var C=w[0],S=w[1],k=Ze(y.shape,[p]);return[y.reshape(k).mul(C.toFloat().sub(S.exp())),y.reshape(k).mul(S.exp().sub(C.toFloat()))]}}})(f,d)}(a,i);return jt(h,s,o)}}),em=Object.freeze({get Reduction(){return $e},absoluteDifference:qv,computeWeightedLoss:jt,cosineDistance:Kv,hingeLoss:Xv,huberLoss:Yv,logLoss:$v,meanSquaredError:Qv,sigmoidCrossEntropy:Jv,softmaxCrossEntropy:Zv});function Qc(r,t){return void 0===t&&(t=!1),D.tidy(function(){if(2!==r.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+r.shape.length+"D Tensor.");for(var e=r.shape[0],n=r.shape[1],o=iu(e),a=r.clone(),i=on([[1]],[1,1]),s=i.clone(),u=e>=n?n:e,c=function(h){var f,d=a,p=s,m=o;f=D.tidy(function(){var v=a.slice([h,h],[e-h,1]),g=v.norm(),x=a.slice([h,h],[1,1]),b=on([[-1]]).where(x.greater(0),on([[1]])),y=x.sub(b.mul(g)),w=v.div(y);s=1===w.shape[0]?i.clone():i.concat(w.slice([1,0],[w.shape[0]-1,w.shape[1]]),0);var C=b.matMul(y).div(g).neg(),S=a.slice([h,0],[e-h,n]),k=C.mul(s);if(0===h)a=S.sub(k.matMul(s.transpose().matMul(S)));else{var I=S.sub(k.matMul(s.transpose().matMul(S)));a=a.slice([0,0],[h,n]).concat(I,0)}var R=o.slice([0,h],[e,o.shape[1]-h]);if(0===h)o=R.sub(R.matMul(s).matMul(k.transpose()));else{var F=R.sub(R.matMul(s).matMul(k.transpose()));o=o.slice([0,0],[e,h]).concat(F,1)}return[s,a,o]}),s=f[0],a=f[1],o=f[2],tt([d,p,m])},l=0;l<u;++l)c(l);return!t&&e>n&&(o=o.slice([0,0],[e,n]),a=a.slice([0,0],[n,n])),[o,a]})}var tm=A({bandPart_:function(r,t,e){if(t%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+t+".");if(e%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+e+".");var n=_(r,"a","bandPart");if(n.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+n.rank+".");var o=n.shape,a=n.shape.slice(-2),i=a[0],s=a[1];if(!(t<=i))throw new Error("bandPart(): numLower ("+t+") must not be greater than the number of rows ("+i+").");if(!(e<=s))throw new Error("bandPart(): numUpper ("+e+") must not be greater than the number of columns ("+s+").");t<0&&(t=i),e<0&&(e=s);var u=Jr(0,i,1,"int32").reshape([-1,1]),c=Jr(0,s,1,"int32"),l=We(u,c),h=yo(l.lessEqual(j(+t,"int32")),l.greaterEqual(j(-e,"int32"))),f=Ee([i,s],n.dtype);return ut(Le(n.reshape([-1,i,s])).map(function(d){return Rn(h,d,f)})).reshape(o)}}),nm=A({gramSchmidt_:function(r){var t;if(Array.isArray(r)){t=!1,E(null!=r&&r.length>0,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var e=r[0].shape[0],n=function(u){E(r[u].shape[0]===e,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+r[u].shape[0]+" vs. "+e+")"})},o=1;o<r.length;++o)n(o)}else t=!0,r=da(r,r.shape[0],0).map(function(u){return cu(u,[0])});E(r.length<=r[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+r.length+") exceeds number of dimensions ("+r[0].shape[0]+")."});var a=[],i=r,s=function(u){a.push(D.tidy(function(){var c=i[u];if(u>0)for(var l=0;l<u;++l){var h=Uc(a[l].mulStrict(c)).mul(a[l]);c=c.sub(h)}return c.div(qc(c,"euclidean"))}))};for(o=0;o<r.length;++o)s(o);return t?ut(a,0):a}}),rm=A({qr_:function(r,t){if(void 0===t&&(t=!1),r.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+r.rank);if(2===r.rank)return Qc(r,t);var e=r.shape.slice(0,r.shape.length-2).reduce(function(i,s){return i*s}),n=Le(r.reshape([e,r.shape[r.shape.length-2],r.shape[r.shape.length-1]]),0),o=[],a=[];return n.forEach(function(i){var s=Qc(i,t),c=s[1];o.push(s[0]),a.push(c)}),[ut(o,0).reshape(r.shape),ut(a,0).reshape(r.shape)]}}),om=Object.freeze({bandPart:tm,gramSchmidt:nm,qr:rm});function Eo(r,t,e,n,o,a){null==n&&(n=.5),null==o&&(o=Number.NEGATIVE_INFINITY),null==a&&(a=0);var i=r.shape[0];return e=Math.min(e,i),E(0<=n&&n<=1,function(){return"iouThreshold must be in [0, 1], but was '"+n+"'"}),E(2===r.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+r.rank+"'"}),E(4===r.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+r.shape[1]}),E(1===t.rank,function(){return"scores must be a 1D tensor"}),E(t.shape[0]===i,function(){return"scores has incompatible shape with boxes. Expected "+i+", but was "+t.shape[0]}),E(0<=a&&a<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+a+"'"}),{maxOutputSize:e,iouThreshold:n,scoreThreshold:o,softNmsSigma:a}}var am=A({resizeBilinear_:function(r,t,e){void 0===e&&(e=!1);var n=_(r,"images","resizeBilinear");E(3===n.rank||4===n.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+n.rank+"."}),E(2===t.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+t+"."});var o=n,a=!1;3===n.rank&&(a=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var i=t[0],s=t[1],u=D.runKernelFunc(function(c,l){return l([o]),c.resizeBilinear(o,i,s,e)},{x:o},function(c,l){return{x:function(){return D.runKernelFunc(function(h){return h.resizeBilinearBackprop(c,l[0],e)},{})}}},"ResizeBilinear",{alignCorners:e,newHeight:i,newWidth:s});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),im=A({resizeNearestNeighbor_:function(r,t,e){void 0===e&&(e=!1);var n=_(r,"images","resizeNearestNeighbor");E(3===n.rank||4===n.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+n.rank+"."}),E(2===t.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+t+"."}),E("float32"===n.dtype||"int32"===n.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var o=n,a=!1;3===n.rank&&(a=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var i=t[0],s=t[1],u=D.runKernelFunc(function(c,l){return l([o]),c.resizeNearestNeighbor(o,i,s,e)},{batchImages:o},function(c,l){return{batchImages:function(){return D.runKernelFunc(function(h){return h.resizeNearestNeighborBackprop(c,l[0],e)},{})}}});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),sm=A({nonMaxSuppression_:function(r,t,e,n,o){void 0===n&&(n=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY);var a=_(r,"boxes","nonMaxSuppression"),i=_(t,"scores","nonMaxSuppression"),s=Eo(a,i,e,n,o);return D.runKernelFunc(function(c){return c.nonMaxSuppression(a,i,e,n,o)},{boxes:a,scores:i},null,"NonMaxSuppressionV3",{maxOutputSize:e=s.maxOutputSize,iouThreshold:n=s.iouThreshold,scoreThreshold:o=s.scoreThreshold})}}),cm=A({nonMaxSuppressionWithScore_:function(r,t,e,n,o,a){void 0===n&&(n=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0);var i=_(r,"boxes","nonMaxSuppression"),s=_(t,"scores","nonMaxSuppression"),u=Eo(i,s,e,n,o,a),c={maxOutputSize:e=u.maxOutputSize,iouThreshold:n=u.iouThreshold,scoreThreshold:o=u.scoreThreshold,softNmsSigma:a=u.softNmsSigma},l=D.runKernel("NonMaxSuppressionV5",{boxes:i,scores:s},c);return{selectedIndices:l[0],selectedScores:l[1]}}}),hm=A({cropAndResize_:function(r,t,e,n,o,a){var i=_(r,"image","cropAndResize"),s=_(t,"boxes","cropAndResize","float32"),u=_(e,"boxInd","cropAndResize","int32");o=o||"bilinear",a=a||0;var c=s.shape[0];return E(4===i.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+i.rank+"."}),E(2===s.rank&&4===s.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+c+",4] but had shape "+s.shape+"."}),E(1===u.rank&&u.shape[0]===c,function(){return"Error in cropAndResize: boxInd must be have size ["+c+"] but had shape "+s.shape+"."}),E(2===n.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+n.length+"."}),E(n[0]>=1&&n[1]>=1,function(){return"cropSize must be atleast [1,1], but was "+n}),E("bilinear"===o||"nearest"===o,function(){return"method must be bilinear or nearest, but was "+o}),D.runKernelFunc(function(l,h){return l.cropAndResize(i,s,u,n,o,a)},{images:i,boxes:s,boxInd:u},null,"CropAndResize",{method:o,extrapolationValue:a,cropSize:n})}}),Ya=Object.freeze({resizeBilinear:am,resizeNearestNeighbor:im,nonMaxSuppression:sm,nonMaxSuppressionAsync:function(r,t,e,n,o){return void 0===n&&(n=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),Y(this,void 0,void 0,function(){var a,i,s,u,h;return $(this,function(f){switch(f.label){case 0:return a=_(r,"boxes","nonMaxSuppressionAsync"),i=_(t,"scores","nonMaxSuppressionAsync"),s=Eo(a,i,e,n,o),e=s.maxOutputSize,n=s.iouThreshold,o=s.scoreThreshold,[4,Promise.all([a.data(),i.data()])];case 1:return u=f.sent(),h=Ra(u[0],u[1],e,n,o),a!==r&&a.dispose(),i!==t&&i.dispose(),[2,h]}})})},nonMaxSuppressionWithScore:cm,nonMaxSuppressionWithScoreAsync:function(r,t,e,n,o,a){return void 0===n&&(n=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0),Y(this,void 0,void 0,function(){var i,s,u,c,f;return $(this,function(d){switch(d.label){case 0:return i=_(r,"boxes","nonMaxSuppressionAsync"),s=_(t,"scores","nonMaxSuppressionAsync"),u=Eo(i,s,e,n,o,a),e=u.maxOutputSize,n=u.iouThreshold,o=u.scoreThreshold,a=u.softNmsSigma,[4,Promise.all([i.data(),s.data()])];case 1:return c=d.sent(),f=ka(c[0],c[1],e,n,o,a),i!==r&&i.dispose(),s!==t&&s.dispose(),[2,f]}})})},cropAndResize:hm}),$a=function(r,t){return!(r>0)||"linear"===t},Qa=function(r,t,e){if(null==e||"linear"===e)return r;if("relu"===e)return r.mul(t.step());throw new Error("Gradient for activation "+e+" has not been implemented yet.")},Ja=function(r,t){var e=t,n=Oe(r.shape,t.shape);return n.length>0&&(e=e.sum(n)),e.reshape(r.shape)},Za=function(r,t,e){if("linear"===t)return r;if("relu"===t)return ke(r);if("elu"===t)return Gc(r);if("relu6"===t)return jc(r);if("prelu"===t)return Hc(r,e);throw new Error("Unknown fused activation "+t+".")},fm=A({fusedMatMul_:function(r){var t,e=r.a,n=r.b,o=r.transposeA,a=void 0!==o&&o,i=r.transposeB,s=void 0!==i&&i,u=r.bias,c=r.activation,l=void 0===c?"linear":c,h=r.preluActivationWeights;if(!1===$a(D.state.gradientDepth,l)){var f=wo(e,n,a,s);return null!=u&&(f=le(f,u)),Za(f,l,h)}var d=_(e,"a","fused matMul"),p=_(n,"b","fused matMul");t=Ie(d,p),d=t[0],p=t[1];var m=a?d.shape[d.rank-2]:d.shape[d.rank-1],v=s?p.shape[p.rank-1]:p.shape[p.rank-2],g=a?d.shape[d.rank-1]:d.shape[d.rank-2],x=s?p.shape[p.rank-2]:p.shape[p.rank-1],b=d.shape.slice(0,-2),y=p.shape.slice(0,-2),w=Q(b),C=Q(y);E(d.rank>=2&&p.rank>=2&&d.rank===p.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+d.rank+" and "+p.rank+"."}),E(Ne(b,y),function(){return"Error in fused matMul: outer dimensions ("+b+") and ("+y+") of Tensors with shapes "+d.shape+" and "+p.shape+" must match."}),E(m===v,function(){return"Error in fused matMul: inner shapes ("+m+") and ("+v+") of Tensors with shapes "+d.shape+" and "+p.shape+" and transposeA="+a+" and transposeB="+s+" must match."});var S,k,I=d.shape.slice(0,-2).concat([g,x]),R=a?d.as3D(w,m,g):d.as3D(w,g,m),F=s?p.as3D(C,x,v):p.as3D(C,v,x);null!=u&&ce(I,(S=Ie(S=_(u,"bias","fused matMul"),d)[0]).shape),null!=h&&(k=_(h,"prelu weights","fused matMul"));var T={a:R,b:F};return null!=u&&(T.bias=S),null!=h&&(T.preluActivationWeights=k),D.runKernelFunc(function(O,B){var U=O.fusedBatchMatMul({a:R,b:F,transposeA:a,transposeB:s,bias:S,activation:l,preluActivationWeights:k});return B([R,F,U]),U},T,function(O,B){var U=B[0],z=B[1],G=Qa(O,B[2],l),H={};return null!=u&&(H={bias:function(){return Ja(S,G)}}),Object.assign(a||s?!a&&s?{a:function(){return G.matMul(z,!1,!1)},b:function(){return G.matMul(U,!0,!1)}}:a&&!s?{a:function(){return z.matMul(G,!1,!0)},b:function(){return U.matMul(G,!1,!1)}}:{a:function(){return z.matMul(G,!0,!0)},b:function(){return G.matMul(U,!0,!0)}}:{a:function(){return G.matMul(z,!1,!0)},b:function(){return U.matMul(G,!0,!1)}},H)},"_FusedMatMul",{transposeA:a,transposeB:s,activation:l},[R,F],[!0]).reshape(I)}}),dm=A({fusedConv2d_:function(r){var t=r.x,e=r.filter,n=r.strides,o=r.pad,a=r.dataFormat,i=void 0===a?"NHWC":a,s=r.dilations,u=void 0===s?[1,1]:s,c=r.dimRoundingMode,l=r.bias,h=r.activation,f=void 0===h?"linear":h,d=r.preluActivationWeights;if(!1===$a(D.state.gradientDepth,f=f||"linear")){var p=pt(t,e,n,o,i,u,c);return null!=l&&(p=le(p,l)),Za(p,f,d)}var m=_(t,"x","conv2d"),v=_(e,"filter","conv2d"),g=m,x=!1;3===m.rank&&(x=!0,g=m.as4D(1,m.shape[0],m.shape[1],m.shape[2])),E(4===g.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+g.rank+"."}),E(4===v.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+v.rank+"."}),null!=c&&E(Re(o),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+c+" but got pad "+o+"."}),E(g.shape[3]===v.shape[2],function(){return"Error in conv2d: depth of input ("+g.shape[3]+") must match input depth for filter "+v.shape[2]+"."}),E(et(n,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+u+"'"}),E("NHWC"===i,function(){return"Error in conv2d: got dataFormat of "+i+" but only NHWC is currently supported."});var b,y,w=an(g.shape,v.shape,n,u,o,c);null!=l&&(b=Ie(b=_(l,"bias","fused conv2d"),m)[0],ce(w.outShape,b.shape)),null!=d&&(y=_(d,"prelu weights","fused conv2d"));var C={x:g,filter:v};null!=l&&(C.bias=b),null!=d&&(C.preluActivationWeights=y);var k=D.runKernelFunc(function(I,R){var F=I.fusedConv2d({input:g,filter:v,convInfo:w,bias:b,activation:f,preluActivationWeights:y});return R([v,g,F]),F},C,function(I,R){var T=R[0],L=R[1],B=Qa(I,R[2],f);E(Cn(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});var U={};return null!=l&&(U={bias:function(){return Ja(b,B)}}),Object.assign({x:function(){return Mc(L.shape,B,T,n,o)},filter:function(){return Ga(L,B,T.shape,n,o)}},U)},"FusedConv2D",{convInfo:w,activation:f},[v,g],[!0]);return x?k.as3D(k.shape[1],k.shape[2],k.shape[3]):k}}),pm=A({fusedDepthwiseConv2d_:function(r){var t=r.x,e=r.filter,n=r.strides,o=r.pad,a=r.dataFormat,i=void 0===a?"NHWC":a,s=r.dilations,u=void 0===s?[1,1]:s,c=r.dimRoundingMode,l=r.bias,h=r.activation,f=void 0===h?"linear":h,d=r.preluActivationWeights;if(!1===$a(D.state.gradientDepth,f)){var p=bo(t,e,n,o,i,u,c);return null!=l&&(p=le(p,l)),Za(p,f,d)}var m=_(t,"x","depthwiseConv2d"),v=_(e,"filter","depthwiseConv2d"),g=m,x=!1;3===m.rank&&(x=!0,g=m.as4D(1,m.shape[0],m.shape[1],m.shape[2])),E(4===g.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+g.rank+"."}),E(4===v.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+v.rank+"."}),E(g.shape[3]===v.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+g.shape[3]+") must match the inChannels dimension in filter "+v.shape[2]+"."}),null==u&&(u=[1,1]),E(et(n,u),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+u+"'"}),null!=c&&E(Re(o),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+c+" but got pad "+o+"."});var b,y,w=an(g.shape,v.shape,n,u,o,c,!0);null!=l&&(b=Ie(b=_(l,"bias","fused conv2d"),m)[0],ce(w.outShape,b.shape)),null!=d&&(y=_(d,"prelu weights","fused depthwiseConv2d"));var C={x:g,filter:v};null!=l&&(C.bias=b),null!=d&&(C.preluActivationWeights=y);var k=D.runKernelFunc(function(I,R){var F=I.fusedDepthwiseConv2D({input:g,filter:v,convInfo:w,bias:b,activation:f,preluActivationWeights:y});return R([v,g,F]),F},C,function(I,R){E(Cn(u),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+u+"'"});var F=R[0],T=R[1],O=Qa(I,R[2],f),B={};return null!=l&&(B={bias:function(){return Ja(b,O)}}),Object.assign({x:function(){return Oc(T.shape,O,F,w)},filter:function(){return Bc(T,O,F.shape,w)}},B)},"FusedDepthwiseConv2D",{convInfo:w,activation:f},[v,g],[!0]);return x?k.as3D(k.shape[1],k.shape[2],k.shape[3]):k}}),vm=Object.freeze({matMul:fm,conv2d:dm,depthwiseConv2d:pm}),mm=Object.freeze({image:Ya,linalg:om,losses:em,spectral:Wv,fused:vm,signal:Hv,square:$d,squaredDifference:gc,conv1d:av,conv2d:pt,conv3d:iv,depthwiseConv2d:bo,separableConv2d:Ha,conv2dTranspose:sv,conv3dTranspose:uv,op:A,batchNormalization2d:Rp,batchNormalization3d:kp,batchNormalization4d:Sp,batchNormalization:Dp,batchNorm:Cc,batchNorm2d:Ap,batchNorm3d:Tp,batchNorm4d:Fp,booleanMaskAsync:function(r,t,e){return Y(this,void 0,void 0,function(){var n,o,a,i,s,u,c,l,h,f,d,p,m;return $(this,function(v){switch(v.label){case 0:for(n=_(r,"tensor","boolMask"),o=_(t,"mask","boolMask","bool"),a=e??0,s=n.shape,E((i=o.rank)>0,function(){return"mask cannot be scalar"}),pe(s.slice(a,a+i),o.shape,"mask's shape must match the first K dimensions of tensor's shape,"),u=1,c=a;c<a+i;c++)u*=s[c];return l=s.slice(0,a).concat([u],s.slice(a+i)),h=n.reshape(l),f=o.reshape([-1]),[4,Ic(f)];case 1:return d=v.sent(),p=d.squeeze([1]),m=Va(h,p,a),r!==n&&n.dispose(),t!==o&&o.dispose(),p.dispose(),h.dispose(),f.dispose(),d.dispose(),[2,m]}})})},complex:qe,real:ft,imag:St,concat:Be,concat1d:Oh,concat2d:Bh,concat3d:Lh,concat4d:Wh,split:da,matMul:wo,dot:cv,outerProduct:lv,reverse:Ar,reverse1d:hv,reverse2d:fv,reverse3d:dv,reverse4d:pv,maxPool:Ue,avgPool:Tr,pool:vv,maxPool3d:mv,avgPool3d:gv,slice:At,slice1d:yv,slice2d:xv,slice3d:zc,slice4d:bv,abs:Qd,acos:Jd,acosh:Zd,asin:ep,asinh:tp,atan:np,atanh:rp,ceil:op,clipByValue:La,cos:ap,cosh:ip,erf:sp,exp:Wa,expm1:up,floor:cp,log:lp,log1p:hp,logSigmoid:fp,neg:vo,reciprocal:dp,round:pp,rsqrt:yc,sigmoid:xc,sign:vp,isNaN:mp,isInf:gp,isFinite:yp,sin:xp,sinh:bp,softplus:wp,sqrt:_p,step:Cp,tan:Ep,tanh:Ip,all:wv,any:_v,argMax:Cv,argMin:Ev,logSumExp:Iv,max:_o,mean:Rv,min:kv,moments:Sv,sum:Uc,prod:Dv,equal:Sc,equalStrict:Xp,greater:Yp,greaterEqual:Dc,greaterEqualStrict:$p,greaterStrict:Qp,less:Jp,lessEqual:Zp,lessEqualStrict:ev,lessStrict:tv,notEqual:nv,notEqualStrict:rv,add:le,addN:Mp,addStrict:Op,atan2:Bp,div:Ct,divNoNan:Lp,divStrict:Wp,floorDiv:Rc,maximum:za,maximumStrict:zp,minimum:kc,minimumStrict:Vp,mod:Up,modStrict:Gp,mul:Ye,mulStrict:Hp,pow:xo,powStrict:jp,squaredDifferenceStrict:qp,sub:We,subStrict:Kp,elu:Gc,leakyRelu:Av,prelu:Hc,relu:ke,relu6:jc,selu:Tv,logicalAnd:yo,logicalNot:Np,logicalOr:Ec,logicalXor:Pp,where:Rn,whereAsync:Ic,buffer:ae,print:function Xh(r,t){void 0===t&&(t=!1),console.log(r.toString(t))},batchToSpaceND:au,broadcastTo:Yh,cast:$h,clone:Qh,cumsum:Jh,depthToSpace:Zh,expandDims:dt,eye:iu,multinomial:ef,oneHot:va,pad:_n,pad1d:tf,pad2d:nf,pad3d:rf,pad4d:of,rand:af,randomNormal:sf,randomGamma:uf,randomUniform:su,reshape:wt,spaceToBatchND:uu,squeeze:cu,stack:ut,tile:Wn,truncatedNormal:cf,unstack:Le,setdiff1dAsync:function(r,t){return Y(this,void 0,void 0,function(){var e,n,o,a,i,s,u,c,l,h;return $(this,function(f){switch(f.label){case 0:return e=_(r,"x","setdiff1d"),n=_(t,"y","setdiff1d"),E(e.dtype===n.dtype,function(){return"x and y should have the same dtype, but got x ("+e.dtype+") and y ("+n.dtype+")."}),E(1===e.rank,function(){return"x should be 1D tensor, but got x ("+e.shape+")."}),E(1===n.rank,function(){return"y should be 1D tensor, but got y ("+n.shape+")."}),[4,e.data()];case 1:return o=f.sent(),[4,n.data()];case 2:for(a=f.sent(),i=new Set(a),s=0,l=0;l<o.length;l++)i.has(o[l])||s++;for(u=new fr([s],e.dtype),c=new fr([s],"int32"),l=0,h=0;l<o.length;l++)i.has(o[l])||(u.values[h]=o[l],c.values[h]=l,h++);return[2,[u.toTensor(),c.toTensor()]]}})})},fill:Dt,linspace:function Mh(r,t,e){if(e<=0)throw new Error("The number of values should be positive.");return D.runKernelFunc(function(n){return n.linspace(r,t,e)},{})},ones:Ln,range:Jr,scalar:j,tensor:Ke,tensor1d:Me,tensor2d:on,tensor3d:fa,tensor4d:rt,tensor5d:function Fh(r,t,e){if(mn(r),null!=t&&5!==t.length)throw new Error("tensor5d() requires shape to have five numbers");var n=kt(r,e);if(5!==n.length&&1!==n.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===n.length&&null==t)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return rn(r,t,n,e)},tensor6d:function Nh(r,t,e){if(mn(r),null!=t&&6!==t.length)throw new Error("tensor6d() requires shape to have six numbers");var n=kt(r,e);if(6!==n.length&&1!==n.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===n.length&&null==t)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return rn(r,t=t||n,n,e)},variable:function Ph(r,t,e,n){return void 0===t&&(t=!0),D.makeVariable(r,t,e,n)},zeros:Ee,onesLike:ou,zerosLike:ve,transpose:sn,softmax:Ut,logSoftmax:ff,localResponseNormalization:Fv,norm:qc,gather:Va,unsortedSegmentSum:Fc,basicLSTMCell:Nv,multiRNNCell:Pv,movingAverage:Mv,stridedSlice:Ov,topk:Bv,scatterND:Lv,fft:ja,ifft:Co,rfft:qa,irfft:Kc,sparseToDense:zv,gatherND:Vv,diag:Uv,dropout:Gv,hannWindow:Ka,hammingWindow:Yc,frame:Xa,stft:$c,inTopKAsync:function(r,t,e){return void 0===e&&(e=1),Y(this,void 0,void 0,function(){var n,o,a,i,s,u,c,l,h,f,d,p,m,v;return $(this,function(g){switch(g.label){case 0:return n=_(r,"predictions","inTopK"),o=_(t,"targets","inTopK"),E(n.rank>1,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+n.rank}),E(n.rank-1===o.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+n.rank+" and targets rank "+o.rank}),pe(n.shape.slice(0,n.shape.length-1),o.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),a=n.shape[n.shape.length-1],E(e>0&&e<=a,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+a+"), but got "+e}),[4,n.data()];case 1:return i=g.sent(),[4,o.data()];case 2:for(s=g.sent(),l=(u=[i.length/a,a])[1],h=Pn("bool",c=u[0]),f=0;f<c;f++){for(p=i.subarray(d=f*l,d+l),m=[],v=0;v<p.length;v++)m.push({value:p[v],index:v});for(m.sort(function(x,b){return b.value-x.value}),h[f]=0,v=0;v<e;v++)if(m[v].index===s[f]){h[f]=1;break}}return r!==n&&n.dispose(),t!==o&&o.dispose(),[2,Ke(h,o.shape,"bool")]}})})}});function V(r,t){Array.isArray(r)||(r=[r]),r.forEach(function(e){null!=e&&E("complex64"!==e.dtype,function(){return t+" does not support complex64 tensors."})})}function ei(r,t,e,n){if("linear"===e)return r.linear(t);if("relu"===e)return r.relu(t);if("elu"===e)return r.elu(t);if("relu6"===e)return r.relu6(t);if("prelu"===e)return r.prelu(t,n);throw new Error("Activation "+e+" has not been implemented for the CPU backend.")}var gm=function(r){function t(){var e=r.call(this)||this;return e.blockSize=48,e.firstUse=!0,e.data=new gu(e,D),e}return mt(t,r),t.prototype.write=function(e,n,o){this.firstUse&&(this.firstUse=!1,M().get("IS_NODE")&&$r("\n============================\nHi there \u{1f44b}. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var a={};return this.data.set(a,{values:e,dtype:o}),a},t.prototype.move=function(e,n,o,a){this.data.set(e,{values:n,dtype:a})},t.prototype.numDataIds=function(){return this.data.numDataIds()},t.prototype.read=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){return[2,this.readSync(e)]})})},t.prototype.readSync=function(e){var n=this.data.get(e),a=n.complexTensors;return"complex64"===n.dtype?Ia(this.readSync(a.real.dataId),this.readSync(a.imag.dataId)):this.data.get(e).values},t.prototype.bufferSync=function(e){var n=this.readSync(e.dataId),o=n;if("string"===e.dtype)try{o=n.map(function(a){return ur(a)})}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return ae(e.shape,e.dtype,o)},t.prototype.makeOutput=function(e,n,o){var a=this.write(e,n,o);return D.makeTensorFromDataId(a,n,o,this)},t.prototype.disposeData=function(e){if(this.data.has(e)){var n=this.data.get(e).complexTensors;null!=n&&(n.real.dispose(),n.imag.dispose()),this.data.delete(e)}},t.prototype.time=function(e){return Y(this,void 0,void 0,function(){var n;return $(this,function(o){return n=yt(),e(),[2,{kernelMs:yt()-n}]})})},t.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},t.prototype.complex=function(e,n){var o=this.makeOutput(null,e.shape,"complex64");return this.data.get(o.dataId).complexTensors={real:D.keep(e.clone()),imag:D.keep(n.clone())},o},t.prototype.real=function(e){return this.data.get(e.dataId).complexTensors.real.clone()},t.prototype.imag=function(e){return this.data.get(e.dataId).complexTensors.imag.clone()},t.prototype.slice=function(e,n,o){if(V(e,"slice"),xa(e.shape,n,o)){var a=ba(n,e.strides),i=Q(o);return Ke(this.readSync(e.dataId).subarray(a,a+i),o,e.dtype)}for(var s=ae(o,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c).map(function(h,f){return h+n[f]});s.values[c]=u.get.apply(u,l)}return s.toTensor()},t.prototype.stridedSlice=function(e,n,o,a){V(e,"stridedSlice");var i=oo(n,o,a);if(i.some(function(d){return 0===d}))return Ke([],i);for(var s=ae(i,e.dtype),u=this.bufferSync(e),c=0;c<s.size;c++){for(var l=s.indexToLoc(c),h=new Array(l.length),f=0;f<h.length;f++)h[f]=l[f]*a[f]+n[f];s.set.apply(s,[u.get.apply(u,h)].concat(l))}return s.toTensor()},t.prototype.diag=function(e){for(var n=this.readSync(e.dataId),o=ae([e.size,e.size],e.dtype),a=o.values,i=0;i<n.length;i++)a[i*e.size+i]=n[i];return o.toTensor()},t.prototype.unstack=function(e,n){for(var o=e.shape[n],a=new Array(e.rank-1),i=0,s=0;s<e.rank;s++)s!==n&&(a[i++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[n]=1;var l=new Array(o);for(s=0;s<l.length;s++)u[n]=s,l[s]=this.slice(e,u,c).reshape(a);return l},t.prototype.reverse=function(e,n){V(e,"reverse");for(var o=ae(e.shape,e.dtype),a=this.bufferSync(e),i=function(u){var c=o.indexToLoc(u),l=c.slice();n.forEach(function(h){return l[h]=e.shape[h]-1-l[h]}),o.set.apply(o,[a.get.apply(a,l)].concat(c))},s=0;s<o.size;s++)i(s);return o.toTensor()},t.prototype.concat=function(e,n){var o=this;if("complex64"===e[0].dtype){var a=e.map(function(d){return ft(d)}),i=e.map(function(d){return St(d)});return qe(this.concat(a,n),this.concat(i,n))}var s=e.map(function(d){var p=Q(d.shape.slice(n));return d.as2D(-1,p)}),u=xn(s.map(function(d){return d.shape}),1),c=ae(u,e[0].dtype).values;if(1===s[0].shape[0]){var l=0;s.forEach(function(d){c.set(o.readSync(d.dataId),l),l+=d.size})}else{var h=0;s.forEach(function(d){for(var p=o.readSync(d.dataId),m=0,v=0;v<d.shape[0];++v)for(var g=v*u[1]+h,x=0;x<d.shape[1];++x)c[g+x]=p[m++];h+=d.shape[1]})}var f=xn(e.map(function(d){return d.shape}),n);return Ke(c,f,e[0].dtype)},t.prototype.neg=function(e){return V(e,"neg"),this.multiply(j(-1),e)},t.prototype.add=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(o,a,i,s){return{real:o+i,imag:a+s}}):this.broadcastedBinaryOp(e,n,Ve(e.dtype,n.dtype),function(o,a){return o+a})},t.prototype.addN=function(e){var n=this;V(e,"addN");for(var o=e.map(function(l){return n.readSync(l.dataId)}),a=ae(e[0].shape,e[0].dtype),i=a.values,s=0;s<e.length;s++)for(var u=o[s],c=0;c<i.length;c++)i[c]+=u[c];return a.toTensor()},t.prototype.softmax=function(e,n){var o=Pe([n],e.shape),a=this.max(e,o),i=Ze(a.shape,o),s=this.subtract(e,a.reshape(i)),u=this.exp(s),c=this.sum(u,o).reshape(i);return this.realDivide(u,c)},t.prototype.subtract=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(o,a,i,s){return{real:o-i,imag:a-s}}):this.broadcastedBinaryOp(e,n,Ve(e.dtype,n.dtype),function(o,a){return o-a})},t.prototype.pow=function(e,n){return V([e,n],"pow"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){return Math.pow(o,a)})},t.prototype.batchMatMul=function(e,n,o,a){V([e,n],"matMul");for(var i=o?e.shape[1]:e.shape[2],s=o?e.shape[2]:e.shape[1],u=a?n.shape[1]:n.shape[2],c=e.shape[0],l=this.readSync(e.dataId),h=this.readSync(n.dataId),f=o?[e.strides[0],1,e.strides[1]]:[e.strides[0],e.strides[1],1],d=f[0],p=f[1],m=f[2],v=a?[1,n.strides[1],n.strides[0]]:[n.strides[1],1,n.strides[0]],g=v[0],x=v[1],b=v[2],y=s*u,w=ae([c,s,u],e.dtype),C=w.values,S=this.blockSize,k=0;k<c;k++)for(var I=0;I<s;I+=S)for(var R=0;R<u;R+=S)for(var F=0;F<i;F+=S)for(var T=Math.min(I+S,s),L=Math.min(R+S,u),O=Math.min(F+S,i),B=I;B<T;B++)for(var U=R;U<L;U++){for(var z=0,W=F;W<O;W++)z+=l[k*d+B*p+W*m]*h[W*g+U*x+k*b];C[k*y+(B*u+U)]+=z}return w.toTensor()},t.prototype.fusedBatchMatMul=function(e){var s=e.bias,u=e.activation,c=e.preluActivationWeights,l=this.batchMatMul(e.a,e.b,e.transposeA,e.transposeB);return s&&(l=this.add(l,s)),u&&(l=ei(this,l,u,c)),l},t.prototype.multiply=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(o,a,i,s){return{real:o*i-a*s,imag:o*s+a*i}}):this.broadcastedBinaryOp(e,n,Ve(e.dtype,n.dtype),function(o,a){return o*a})},t.prototype.realDivide=function(e,n){return V([e,n],"realDivide"),this.broadcastedBinaryOp(e,n,"float32",function(o,a){return o/a})},t.prototype.floorDiv=function(e,n){return V([e,n],"floorDiv"),this.broadcastedBinaryOp(e,n,"int32",function(o,a){return Math.floor(o/a)})},t.prototype.sum=function(e,n){V(e,"sum"),nt("sum",n,e.rank);for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],Ve(e.dtype,"int32")),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=0,p=0;p<u;++p)d+=l[f+p];c[h]=d}return s},t.prototype.prod=function(e,n){V(e,"sum");for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],Ve(e.dtype,"int32")),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=1,p=0;p<u;++p)d*=l[f+p];c[h]=d}return s},t.prototype.unsortedSegmentSum=function(e,n,o){V(e,"unsortedSegmentSum");for(var a=[],i=e.rank-n.rank,s=0;s<i;++s)n=n.expandDims(s+1);for(s=0;s<o;++s){var u=j(s,"int32"),c=Sc(u,n).asType("float32").mul(e).sum(0);a.push(c)}return ut(a)},t.prototype.argMin=function(e,n){V(e,"argMin");var o=[n];nt("argMin",o,e.rank);for(var a=je(e.shape,o),s=a[1],u=Ee(a[0],"int32"),c=Q(s),l=this.readSync(u.dataId),h=this.readSync(e.dataId),f=0;f<l.length;++f){for(var d=f*c,p=h[d],m=0,v=0;v<c;++v){var g=h[d+v];g<p&&(p=g,m=v)}l[f]=m}return u},t.prototype.argMax=function(e,n){V(e,"argMax");var o=[n];nt("argMax",o,e.rank);for(var a=je(e.shape,o),s=a[1],u=Ee(a[0],"int32"),c=Q(s),l=this.readSync(u.dataId),h=this.readSync(e.dataId),f=0;f<l.length;++f){for(var d=f*c,p=h[d],m=0,v=0;v<c;++v){var g=h[d+v];g>p&&(p=g,m=v)}l[f]=m}return u},t.prototype.cumsum=function(e,n,o,a){if(V(e,"cumsum"),n!==e.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(e.rank-1)+" but got axis="+n);for(var i=Ve(e.dtype,"int32"),s=Ee(e.shape,i),u=this.readSync(s.dataId),c=this.readSync(e.dataId),l=e.shape[e.rank-1],h=a?function(v,g){return v+l-g-1}:function(v,g){return v+g},f=0;f<c.length;f+=l)for(var d=0;d<l;d++){var p=h(f,d);if(0===d)u[p]=o?0:c[p];else{var m=h(f,d-1);u[p]=o?c[m]+u[m]:c[p]+u[m]}}return s},t.prototype.equal=function(e,n){return V([e,n],"equal"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o===a?1:0})},t.prototype.notEqual=function(e,n){return V([e,n],"notEqual"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o!==a?1:0})},t.prototype.less=function(e,n){return V([e,n],"less"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o<a?1:0})},t.prototype.lessEqual=function(e,n){return V([e,n],"lessEqual"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o<=a?1:0})},t.prototype.greater=function(e,n){return V([e,n],"greater"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o>a?1:0})},t.prototype.greaterEqual=function(e,n){return V([e,n],"greaterEqual"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o>=a?1:0})},t.prototype.logicalNot=function(e){V(e,"logicalNot");for(var n=this.readSync(e.dataId),o=new Uint8Array(n.length),a=0;a<n.length;++a)o[a]=n[a]?0:1;return this.makeOutput(o,e.shape,"bool")},t.prototype.logicalAnd=function(e,n){return V([e,n],"logicalAnd"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o&&a})},t.prototype.logicalOr=function(e,n){return V([e,n],"logicalOr"),this.broadcastedBinaryOp(e,n,"bool",function(o,a){return o||a})},t.prototype.select=function(e,n,o){V([e,n,o],"select");for(var a=this.readSync(e.dataId),i=this.readSync(n.dataId),s=this.readSync(o.dataId),u=Ee(n.shape,Ve(n.dtype,o.dtype)),c=this.readSync(u.dataId),l=0,h=0===e.rank||e.rank>1||1===n.rank?1:Q(n.shape.slice(1)),f=0;f<a.length;f++)for(var d=0;d<h;d++)c[l++]=1===a[f]?i[f]:s[f];return u},t.prototype.where=function(e){V([e],"where");var n=this.readSync(e.dataId);return Sa(e.shape,n)},t.prototype.topk=function(e,n,o){return V(e,"topk"),Eu(this.readSync(e.dataId),e.shape,e.dtype,n)},t.prototype.min=function(e,n){V(e,"min"),nt("min",n,e.rank);for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],e.dtype),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p){var m=l[f+p];m<d&&(d=m)}c[h]=d}return s},t.prototype.minimum=function(e,n){return V([e,n],"minimum"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){return Math.min(o,a)})},t.prototype.mod=function(e,n){return V([e,n],"mod"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){var i=o%a;return o<0&&a<0||o>=0&&a>=0?i:(i+a)%a})},t.prototype.max=function(e,n){V(e,"max"),nt("max",n,e.rank);for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],e.dtype),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p){var m=l[f+p];m>d&&(d=m)}c[h]=d}return s},t.prototype.maximum=function(e,n){return V([e,n],"maximum"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){return Math.max(o,a)})},t.prototype.all=function(e,n){V(e,"all"),nt("all",n,e.rank);for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],e.dtype),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p)d=d&&l[f+p];c[h]=d}return s},t.prototype.any=function(e,n){V(e,"any"),nt("any",n,e.rank);for(var o=je(e.shape,n),i=o[1],s=Ee(o[0],e.dtype),u=Q(i),c=this.readSync(s.dataId),l=this.readSync(e.dataId),h=0;h<c.length;++h){for(var f=h*u,d=l[f],p=0;p<u;++p)d=d||l[f+p];c[h]=d}return s},t.prototype.squaredDifference=function(e,n){return V([e,n],"squaredDifference"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){var i=o-a;return i*i})},t.prototype.ceil=function(e){V(e,"ceil");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.ceil(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.floor=function(e){V(e,"floor");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.floor(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.sign=function(e){V(e,"x");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=n[a]<0?-1:n[a]>0?1:0;return this.makeOutput(o,e.shape,"float32")},t.prototype.isNaN=function(e){V(e,"x");for(var n=this.readSync(e.dataId),o=new Uint8Array(n.length),a=0;a<n.length;++a)Number.isNaN(n[a])&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},t.prototype.isInf=function(e){V(e,"x");for(var n=this.readSync(e.dataId),o=new Uint8Array(n.length),a=0;a<n.length;++a)Math.abs(n[a])===1/0&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},t.prototype.isFinite=function(e){V(e,"x");for(var n=this.readSync(e.dataId),o=new Uint8Array(n.length),a=0;a<n.length;++a)Number.isFinite(n[a])&&(o[a]=1);return this.makeOutput(o,e.shape,"bool")},t.prototype.round=function(e){V(e,"round");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a){var i=Math.floor(n[a]);o[a]=n[a]-i<.5?Math.floor(n[a]):n[a]-i>.5?Math.ceil(n[a]):i%2==0?i:i+1}return this.makeOutput(o,e.shape,"float32")},t.prototype.exp=function(e){V(e,"exp");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.exp(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.expm1=function(e){V(e,"expm1");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.expm1(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.log=function(e){V(e,"log");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.log(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.log1p=function(e){V(e,"log1p");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.log1p(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.sqrt=function(e){V(e,"sqrt");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=Math.sqrt(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.rsqrt=function(e){V(e,"rsqrt");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=1/Math.sqrt(n[a]);return this.makeOutput(o,e.shape,"float32")},t.prototype.reciprocal=function(e){V(e,"reciprocal");for(var n=this.readSync(e.dataId),o=new Float32Array(n.length),a=0;a<n.length;++a)o[a]=1/n[a];return this.makeOutput(o,e.shape,"float32")},t.prototype.linear=function(e){return e},t.prototype.relu=function(e){V(e,"relu");for(var n=Ee(e.shape,e.dtype),o=this.readSync(n.dataId),a=this.readSync(e.dataId),i=0;i<a.length;++i)o[i]=Math.max(0,a[i]);return n},t.prototype.relu6=function(e){V(e,"relu");for(var n=Ee(e.shape,e.dtype),o=this.readSync(n.dataId),a=this.readSync(e.dataId),i=0;i<a.length;++i)o[i]=Math.min(Math.max(0,a[i]),6);return n},t.prototype.prelu=function(e,n){return V([e,n],"prelu"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){return o<0?a*o:o})},t.prototype.elu=function(e){V(e,"elu");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var i=o[a];n[a]=i>=0?i:Math.exp(i)-1}return this.makeOutput(n,e.shape,"float32")},t.prototype.eluDer=function(e,n){V([e,n],"eluDer");for(var o=new Float32Array(n.size),a=this.readSync(n.dataId),i=this.readSync(e.dataId),s=0;s<a.length;++s){var u=a[s];o[s]=u>=1?i[s]:i[s]*(u+1)}return this.makeOutput(o,n.shape,"float32")},t.prototype.selu=function(e){V(e,"selu");for(var n=Oa,o=Ba,a=new Float32Array(e.size),i=this.readSync(e.dataId),s=0;s<i.length;++s){var u=i[s];a[s]=u>=0?o*u:n*(Math.exp(u)-1)}return this.makeOutput(a,e.shape,"float32")},t.prototype.clip=function(e,n,o){V(e,"clip");for(var a=new Float32Array(e.size),i=this.readSync(e.dataId),s=0;s<i.length;++s){var u=i[s];a[s]=u>o?o:u<n?n:u}return this.makeOutput(a,e.shape,"float32")},t.prototype.abs=function(e){for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.abs(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.complexAbs=function(e){for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<e.size;++a)n[a]=Math.hypot(o[2*a],o[2*a+1]);return this.makeOutput(n,e.shape,"float32")},t.prototype.int=function(e){V(e,"int");for(var n=new Int32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=o[a];return this.makeOutput(n,e.shape,"int32")},t.prototype.sigmoid=function(e){V(e,"sigmoid");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=1/(1+Math.exp(-o[a]));return this.makeOutput(n,e.shape,"float32")},t.prototype.softplus=function(e){V(e,"softplus");for(var n=Math.log(1.1920928955078125e-7)+2,o=new Float32Array(e.size),a=this.readSync(e.dataId),i=0;i<a.length;++i){var l,s=a[i]>-n,u=a[i]<n,c=Math.exp(a[i]);l=u?c:s?a[i]:Math.log(1+c),o[i]=l}return this.makeOutput(o,e.shape,"float32")},t.prototype.sin=function(e){V(e,"sin");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.sin(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.cos=function(e){V(e,"cos");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.cos(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.tan=function(e){V(e,"tan");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.tan(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.asin=function(e){V(e,"asin");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.asin(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.acos=function(e){V(e,"acos");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.acos(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atan=function(e){V(e,"atan");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.atan(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atan2=function(e,n){return V([e,n],"atan2"),this.broadcastedBinaryOp(e,n,e.dtype,function(o,a){return Math.atan2(o,a)})},t.prototype.sinh=function(e){V(e,"sinh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.sinh(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.cosh=function(e){V(e,"cosh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.cosh(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.tanh=function(e){V(e,"tanh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=fs(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.asinh=function(e){V(e,"asinh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.asinh(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.acosh=function(e){V(e,"acosh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.acosh(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atanh=function(e){V(e,"atanh");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a)n[a]=Math.atanh(o[a]);return this.makeOutput(n,e.shape,"float32")},t.prototype.erf=function(e){V(e,"erf");for(var n=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var i=Math.sign(o[a]),s=Math.abs(o[a]),u=1/(1+.3275911*s);n[a]=i*(1-((((1.061405429*u-1.453152027)*u+1.421413741)*u-.284496736)*u+.254829592)*u*Math.exp(-s*s))}return this.makeOutput(n,e.shape,"float32")},t.prototype.step=function(e,n){void 0===n&&(n=0),V(e,"step");for(var o=new Float32Array(e.size),a=this.readSync(e.dataId),i=0;i<a.length;++i){var s=a[i];o[i]=isNaN(s)?NaN:s>0?1:n}return this.makeOutput(o,e.shape,"float32")},t.prototype.fusedConv2d=function(e){var i=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.conv2d(e.input,e.filter,e.convInfo);return i&&(c=this.add(c,i)),s&&(c=ei(this,c,s,u)),c},t.prototype.conv2d=function(e,n,o){V([e,n],"conv2d");for(var a=o.filterHeight,i=o.filterWidth,s=o.dilationHeight,u=o.dilationWidth,c=o.padInfo.left,l=o.padInfo.top,h="channelsLast"===o.dataFormat,f=ae(o.outShape,e.dtype),d=e.strides[0],p=h?e.strides[1]:e.strides[2],m=h?e.strides[2]:1,v=h?1:e.strides[1],g=f.strides[0],x=h?f.strides[1]:f.strides[2],b=h?f.strides[2]:1,y=h?1:f.strides[1],w=this.readSync(e.dataId),C=this.readSync(n.dataId),S=f.values,k=0;k<o.batchSize;++k)for(var I=k*d,R=k*g,F=0;F<o.outHeight;++F)for(var T=R+F*x,L=F*o.strideHeight-l,O=0;O<a;O++){var B=L+O*s;if(!(B<0||B>=o.inHeight))for(var U=O*n.strides[0],z=I+B*p,W=0;W<o.outWidth;++W)for(var G=T+W*b,H=W*o.strideWidth-c,q=0;q<i;q++){var te=H+q*u;if(!(te<0||te>=o.inWidth))for(var ne=z+te*m,se=U+q*n.strides[1],ue=0;ue<o.inChannels;++ue){for(var he=w[ne+ue*v],me=0;me<o.outChannels;++me)S[G+me*y]+=he*C[se+me];se+=o.outChannels}}}return f.toTensor()},t.prototype.conv3d=function(e,n,o){for(var a=o.filterDepth,i=o.filterHeight,s=o.filterWidth,u=o.dilationDepth,c=o.dilationHeight,l=o.dilationWidth,h=o.padInfo.front,f=o.padInfo.left,d=o.padInfo.top,p=ae(o.outShape,e.dtype),m=this.readSync(e.dataId),v=this.readSync(n.dataId),g=p.values,x=0;x<o.batchSize;++x)for(var b=x*e.strides[0],y=x*p.strides[0],w=0;w<o.outDepth;++w)for(var C=y+w*p.strides[1],S=w*o.strideDepth-h,k=0;k<a;k++){var I=S+k*u;if(!(I<0||I>=o.inDepth))for(var R=k*n.strides[0],F=b+I*e.strides[1],T=0;T<o.outHeight;++T)for(var L=C+T*p.strides[2],O=T*o.strideHeight-d,B=0;B<i;B++){var U=O+B*c;if(!(U<0||U>=o.inHeight))for(var z=R+B*n.strides[1],W=F+U*e.strides[2],G=0;G<o.outWidth;++G)for(var H=L+G*o.outChannels,q=G*o.strideWidth-f,te=0;te<s;te++){var ne=q+te*l;if(!(ne<0||ne>=o.inWidth))for(var ue=W+ne*o.inChannels,he=z+te*n.strides[2],me=0;me<o.inChannels;++me){for(var fe=m[ue+me],ge=0;ge<o.outChannels;++ge)g[H+ge]+=fe*v[he+ge];he+=o.outChannels}}}}return p.toTensor()},t.prototype.conv2dDerInput=function(e,n,o){V([e,n],"conv2dDerInput");for(var a=ae(o.inShape,"float32"),i=a.values,s=this.readSync(e.dataId),u=this.readSync(n.dataId),c=n.strides,l=c[0],h=c[1],f=c[2],d=o.batchSize,p=o.filterHeight,m=o.filterWidth,v=o.inChannels,g=o.inHeight,x=o.inWidth,b=o.outChannels,y=o.outHeight,w=o.outWidth,C=o.strideHeight,S=o.strideWidth,I=p-1-o.padInfo.top,R=m-1-o.padInfo.left,F="channelsLast"===o.dataFormat,T=a.strides[0],L=F?a.strides[1]:a.strides[2],O=F?a.strides[2]:1,B=F?1:a.strides[1],U=e.strides[0],z=F?e.strides[1]:e.strides[2],W=F?e.strides[2]:1,G=F?1:e.strides[1],H=0;H<d;++H)for(var q=0;q<v;++q)for(var te=0;te<g;++te)for(var ne=te-I,se=Math.max(0,Math.ceil(ne/C)),ue=Math.min(y,(p+ne)/C),he=0;he<x;++he){for(var me=he-R,fe=Math.max(0,Math.ceil(me/S)),ge=Math.min(w,(m+me)/S),Fe=0,de=se;de<ue;++de)for(var we=de*C-ne,be=fe;be<ge;++be)for(var Te=U*H+z*de+W*be,Se=l*(p-1-we)+h*(m-1-(be*S-me))+f*q,De=0;De<b;++De)Fe+=s[Te+G*De]*u[Se+De];i[T*H+L*te+O*he+B*q]=Fe}return a.toTensor()},t.prototype.conv3dDerInput=function(e,n,o){for(var a=ae(o.inShape,"float32"),i=a.values,s=a.strides,u=s[0],c=s[1],l=s[2],h=s[3],f=this.readSync(e.dataId),d=e.strides,p=d[0],m=d[1],v=d[2],g=d[3],x=this.readSync(n.dataId),b=n.strides,y=b[0],w=b[1],C=b[2],S=b[3],k=o.batchSize,I=o.filterDepth,R=o.filterHeight,F=o.filterWidth,T=o.inChannels,L=o.inDepth,O=o.inHeight,B=o.inWidth,U=o.outChannels,z=o.outDepth,W=o.outHeight,G=o.outWidth,H=o.strideDepth,q=o.strideHeight,te=o.strideWidth,ne=I-1-o.padInfo.front,se=R-1-o.padInfo.top,ue=F-1-o.padInfo.left,he=0;he<k;++he)for(var me=0;me<T;++me)for(var fe=0;fe<L;++fe)for(var ge=fe-ne,Fe=Math.max(0,Math.ceil(ge/H)),de=Math.min(z,(I+ge)/H),we=0;we<O;++we)for(var be=we-se,Te=Math.max(0,Math.ceil(be/q)),Se=Math.min(W,(R+be)/q),De=0;De<B;++De){for(var Ot=De-ue,Bt=Math.max(0,Math.ceil(Ot/te)),ht=Math.min(G,(F+Ot)/te),tr=0,Qt=Fe;Qt<de;++Qt)for(var vn=Qt*H-ge,Jt=Te;Jt<Se;++Jt)for(var nr=Jt*q-be,Zt=Bt;Zt<ht;++Zt)for(var Zi=p*he+m*Qt+v*Jt+g*Zt,rr=y*(I-1-vn)+w*(R-1-nr)+C*(F-1-(Zt*te-Ot))+S*me,Lt=0;Lt<U;++Lt)tr+=f[Zi+Lt]*x[rr+Lt];i[u*he+c*fe+l*we+h*De+me]=tr}return a.toTensor()},t.prototype.conv2dDerFilter=function(e,n,o){V([e,n],"conv2dDerFilter");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c="channelsLast"===o.dataFormat,l=ae(o.filterShape,"float32"),h=o.padInfo.left,f=o.padInfo.top,d=this.bufferSync(e),p=this.bufferSync(n),m=0;m<s;++m)for(var v=Math.max(0,Math.ceil((f-m)/a)),g=Math.min(o.outHeight,(o.inHeight+f-m)/a),x=0;x<u;++x)for(var b=Math.max(0,Math.ceil((h-x)/i)),y=Math.min(o.outWidth,(o.inWidth+h-x)/i),w=0;w<o.inChannels;++w)for(var C=0;C<o.outChannels;++C){for(var S=0,k=0;k<o.batchSize;++k)for(var I=v;I<g;++I)for(var R=m+I*a-f,F=b;F<y;++F){var T=x+F*i-h;S+=c?d.get(k,R,T,w)*p.get(k,I,F,C):d.get(k,w,R,T)*p.get(k,C,I,F)}l.set(S,m,x,w,C)}return l.toTensor()},t.prototype.conv3dDerFilter=function(e,n,o){for(var a=o.strideDepth,i=o.strideHeight,s=o.strideWidth,u=o.filterDepth,c=o.filterHeight,l=o.filterWidth,h=ae(o.filterShape,"float32"),f=h.values,d=h.strides,p=d[0],m=d[1],v=d[2],g=d[3],x=this.readSync(n.dataId),b=n.strides,y=b[0],w=b[1],C=b[2],S=b[3],k=this.readSync(e.dataId),I=e.strides,R=I[0],F=I[1],T=I[2],L=I[3],O=o.padInfo.front,B=o.padInfo.left,U=o.padInfo.top,z=0;z<u;++z)for(var W=Math.max(0,Math.ceil((O-z)/a)),G=Math.min(o.outDepth,(o.inDepth+O-z)/a),H=z*p,q=0;q<c;++q)for(var te=Math.max(0,Math.ceil((U-q)/i)),ne=Math.min(o.outHeight,(o.inHeight+U-q)/i),se=q*m+H,ue=0;ue<l;++ue)for(var he=Math.max(0,Math.ceil((B-ue)/s)),me=Math.min(o.outWidth,(o.inWidth+B-ue)/s),fe=ue*v+se,ge=0;ge<o.inChannels;++ge)for(var Fe=ge*g+fe,de=0;de<o.outChannels;++de){for(var we=0,be=0;be<o.batchSize;++be)for(var Te=be*R,Se=be*y,De=W;De<G;++De)for(var Ot=(z+De*a-O)*F+Te,Bt=De*w+Se,ht=te;ht<ne;++ht)for(var tr=(q+ht*i-U)*T+Ot,Qt=ht*C+Bt,vn=he;vn<me;++vn)we+=k[(ue+vn*s-B)*L+tr+ge]*x[vn*S+Qt+de];f[Fe+de]=we}return h.toTensor()},t.prototype.fusedDepthwiseConv2D=function(e){var i=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.depthwiseConv2D(e.input,e.filter,e.convInfo);return i&&(c=this.add(c,i)),s&&(c=ei(this,c,s,u)),c},t.prototype.depthwiseConv2D=function(e,n,o){V([e,n],"depthwiseConv2D");for(var a=o.filterHeight,i=o.filterWidth,s=o.dilationHeight,u=o.dilationWidth,c=o.padInfo.left,l=o.padInfo.top,h=o.outChannels/o.inChannels,f=ae(o.outShape,e.dtype),d=this.readSync(e.dataId),p=this.readSync(n.dataId),m=f.values,v=0;v<o.batchSize;++v)for(var g=v*e.strides[0],x=v*f.strides[0],b=0;b<o.outHeight;++b)for(var y=x+b*f.strides[1],w=b*o.strideHeight-c,C=0;C<a;++C){var S=w+C*s;if(!(S<0||S>=o.inHeight))for(var k=C*n.strides[0],I=g+S*e.strides[1],R=0;R<o.outWidth;++R)for(var F=y+R*f.strides[2],T=R*o.strideWidth-l,L=0;L<i;++L){var O=T+L*u;if(!(O<0||O>=o.inWidth))for(var U=I+O*o.inChannels,z=F,W=k+L*n.strides[1],G=0;G<o.inChannels;++G){for(var H=d[U+G],q=0;q<h;++q)m[z+q]+=H*p[W+q];z+=h,W+=h}}}return f.toTensor()},t.prototype.depthwiseConv2DDerInput=function(e,n,o){V([e,n],"depthwiseConv2DDerInput");for(var a=ae(o.inShape,"float32"),i=a.values,s=a.strides,u=s[0],c=s[1],l=s[2],h=this.readSync(e.dataId),f=e.strides,d=f[0],p=f[1],m=f[2],v=this.readSync(n.dataId),g=n.strides,x=g[0],b=g[1],y=g[2],w=o.batchSize,C=o.filterHeight,S=o.filterWidth,k=o.inChannels,I=o.inHeight,R=o.inWidth,T=o.outHeight,L=o.outWidth,O=o.strideHeight,B=o.strideWidth,U=C-1-o.padInfo.top,z=S-1-o.padInfo.left,W=o.outChannels/k,G=0;G<w;++G)for(var H=0;H<k;++H)for(var q=0;q<I;++q)for(var te=q-U,ne=Math.max(0,Math.ceil(te/O)),se=Math.min(T,(C+te)/O),ue=0;ue<R;++ue){for(var he=ue-z,me=Math.max(0,Math.ceil(he/B)),fe=Math.min(L,(S+he)/B),ge=0,Fe=ne;Fe<se;++Fe)for(var de=Fe*O-te,we=me;we<fe;++we)for(var be=d*G+p*Fe+m*we,Te=x*(C-1-de)+b*(S-1-(we*B-he))+y*H,Se=0;Se<W;++Se)ge+=h[be+(H*W+Se)]*v[Te+Se];i[u*G+c*q+l*ue+H]=ge}return a.toTensor()},t.prototype.depthwiseConv2DDerFilter=function(e,n,o){V([e,n],"depthwiseConv2DDerFilter");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c=ae(o.filterShape,"float32"),l=o.padInfo.left,h=o.padInfo.top,f=o.outChannels/o.inChannels,d=this.bufferSync(e),p=this.bufferSync(n),m=0;m<s;++m)for(var v=Math.max(0,Math.ceil((h-m)/a)),g=Math.min(o.outHeight,(o.inHeight+h-m)/a),x=0;x<u;++x)for(var b=Math.max(0,Math.ceil((l-x)/i)),y=Math.min(o.outWidth,(o.inWidth+l-x)/i),w=0;w<o.outChannels;++w){for(var C=Math.trunc(w/f),S=w%f,k=0,I=0;I<o.batchSize;++I)for(var R=v;R<g;++R)for(var F=m+R*a-h,T=b;T<y;++T)k+=d.get(I,F,x+T*i-l,C)*p.get(I,R,T,w);c.set(k,m,x,C,S)}return c.toTensor()},t.prototype.tile=function(e,n){return V(e,"tile"),Cu(this.bufferSync(e),n)},t.prototype.pad=function(e,n,o){V(e,"pad");var a=n.map(function(f,d){return f[0]+e.shape[d]+f[1]}),i=n.map(function(f){return f[0]}),s=this.bufferSync(e),u=ae(a,e.dtype);0!==o&&u.values.fill(o);for(var c=0;c<e.size;c++){var l=s.indexToLoc(c),h=l.map(function(f,d){return f+i[d]});u.set.apply(u,[s.get.apply(s,l)].concat(h))}return u.toTensor()},t.prototype.transpose=function(e,n){V(e,"transpose");for(var o=new Array(e.rank),a=0;a<o.length;a++)o[a]=e.shape[n[a]];var i=this.readSync(e.dataId),s=ae(o,e.dtype),u=this.bufferSync(e);for(a=0;a<e.size;++a){for(var c=u.indexToLoc(a),l=new Array(c.length),h=0;h<l.length;h++)l[h]=c[n[h]];var f=s.locToIndex(l);s.values[f]=i[a]}return s.toTensor()},t.prototype.gather=function(e,n,o){V([e,n],"gather");var a=e.shape.slice(),i=this.readSync(n.dataId);a[o]=i.length;for(var s=ae(a,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c),h=l.slice();h[o]=i[l[o]];var f=u.locToIndex(h);s.values[c]=u.values[f]}return s.toTensor()},t.prototype.batchToSpaceND=function(e,n,o){V([e],"batchToSpaceND");var a=n.reduce(function(h,f){return h*f}),i=eo(e.shape,n,a),s=to(i.length,n.length),u=no(e.shape,n,a),c=lu(o,n.length),l=hu(u,o,n.length);return e.reshape(i).transpose(s).reshape(u).slice(c,l)},t.prototype.spaceToBatchND=function(e,n,o){V([e],"spaceToBatchND");var a=n.reduce(function(f,d){return f*d}),i=[[0,0]];i.push.apply(i,o);for(var s=1+n.length;s<e.shape.length;++s)i.push([0,0]);var u=e.pad(i),c=eo(u.shape,n,a,!1),l=to(c.length,n.length,!1),h=no(u.shape,n,a,!1);return u.reshape(c).transpose(l).reshape(h)},t.prototype.pool=function(e,n,o){V(e,"pool");for(var a=n.strideHeight,i=n.strideWidth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterHeight,l=n.effectiveFilterWidth,h=n.padInfo.top,f=n.padInfo.left,d="max"===o?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,p=this.readSync(e.dataId),m=ae(n.outShape,e.dtype),v=m.values,g=n.outShape[1]*n.outShape[2]*n.outShape[3],x=n.outShape[2]*n.outShape[3],b=n.outShape[3],y=0;y<n.batchSize;++y)for(var w=y*g,C=y*e.strides[0],S=0;S<n.inChannels;++S)for(var k=0;k<n.outHeight;++k)for(var I=k*a-h,R=Math.max(0,I),F=Math.min(n.inHeight,c+I),T=w+k*x,L=0;L<n.outWidth;++L){for(var O=L*i-f,B=Math.max(0,O),U=Math.min(n.inWidth,l+O),z=d,W=0,G=0,H=R;H<F;H+=s){for(var q=C+H*e.strides[1],te=B;te<U;te+=u){var ne=p[q+te*e.strides[2]+S];"max"===o&&ne>z?z=ne:"avg"===o&&(W+=ne,G++)}if(isNaN(z))break}v[T+L*b+S]="avg"===o?W/G:z}return m.toTensor()},t.prototype.maxPool=function(e,n){return this.pool(e,n,"max")},t.prototype.maxPoolPositions=function(e,n){for(var o=ae(n.outShape,"int32"),a=n.strideHeight,i=n.strideWidth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterHeight,l=n.effectiveFilterWidth,h=n.padInfo.top,f=n.padInfo.left,d=this.bufferSync(e),p=0;p<n.batchSize;++p)for(var m=0;m<n.inChannels;++m)for(var v=0;v<n.outHeight;++v){for(var g=v*a-h,x=g;x<0;)x+=s;for(var b=Math.min(n.inHeight,c+g),y=0;y<n.outWidth;++y){for(var w=y*i-f,C=w;C<0;)C+=u;for(var S=Math.min(n.inWidth,l+w),k=Number.NEGATIVE_INFINITY,I=-1,R=x;R<b;R+=s)for(var F=R-g,T=C;T<S;T+=u){var L=T-w,O=d.get(p,R,T,m);O>k&&(k=O,I=F*l+L)}o.set(I,p,v,y,m)}}return o.toTensor()},t.prototype.maxPoolBackprop=function(e,n,o,a){V([n,o],"maxPoolBackprop");for(var i=this.maxPoolPositions(n,a),s=a.strideHeight,u=a.strideWidth,c=a.dilationHeight,l=a.dilationWidth,h=a.effectiveFilterHeight,f=a.effectiveFilterWidth,d=f-1-a.padInfo.left,p=h-1-a.padInfo.top,m=ae(n.shape,"float32"),v=this.bufferSync(i),g=this.bufferSync(e),x=0;x<a.batchSize;++x)for(var b=0;b<a.inChannels;++b)for(var y=0;y<a.inHeight;++y)for(var w=0;w<a.inWidth;++w){for(var C=y-p,S=w-d,k=0,I=0;I<h;I+=c){var R=(C+I)/s;if(!(R<0||R>=a.outHeight||Math.floor(R)!==R))for(var F=0;F<f;F+=l){var T=(S+F)/u;if(!(T<0||T>=a.outWidth||Math.floor(T)!==T)){var L=h*f-1-v.get(x,R,T,b)===I*f+F?1:0;0!==L&&(k+=g.get(x,R,T,b)*L)}}}m.set(k,x,y,w,b)}return m.toTensor()},t.prototype.avgPoolBackprop=function(e,n,o){V([e,n],"avgPoolBackprop");for(var a=o.strideHeight,i=o.strideWidth,s=o.filterHeight,u=o.filterWidth,c=o.dilationHeight,l=o.dilationWidth,h=o.effectiveFilterHeight,f=o.effectiveFilterWidth,d=f-1-o.padInfo.left,p=h-1-o.padInfo.top,m=ae(n.shape,"float32"),v=1/(s*u),g=this.bufferSync(e),x=0;x<o.batchSize;++x)for(var b=0;b<o.inChannels;++b)for(var y=0;y<o.inHeight;++y)for(var w=0;w<o.inWidth;++w){for(var C=y-p,S=w-d,k=0,I=0;I<h;I+=c){var R=(C+I)/a;if(!(R<0||R>=o.outHeight||Math.floor(R)!==R))for(var F=0;F<f;F+=l){var T=(S+F)/i;T<0||T>=o.outWidth||Math.floor(T)!==T||(k+=g.get(x,R,T,b))}}m.set(k*v,x,y,w,b)}return m.toTensor()},t.prototype.pool3d=function(e,n,o){V(e,"pool3d");for(var a=n.strideDepth,i=n.strideHeight,s=n.strideWidth,u=n.dilationDepth,c=n.dilationHeight,l=n.dilationWidth,h=n.effectiveFilterDepth,f=n.effectiveFilterHeight,d=n.effectiveFilterWidth,p=n.padInfo.front,m=n.padInfo.top,v=n.padInfo.left,g="max"===o?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,x=this.readSync(e.dataId),b=ae(n.outShape,e.dtype),y=b.values,w=n.outShape[1]*n.outShape[2]*n.outShape[3]*n.outShape[4],C=n.outShape[2]*n.outShape[3]*n.outShape[4],S=n.outShape[3]*n.outShape[4],k=n.outShape[4],I=0;I<n.batchSize;++I)for(var R=I*w,F=I*e.strides[0],T=0;T<n.inChannels;++T)for(var L=0;L<n.outDepth;++L){for(var O=L*a-p,B=O;B<0;)B+=u;for(var U=Math.min(n.inDepth,h+O),z=R+L*C,W=0;W<n.outHeight;++W){for(var G=W*i-m,H=G;H<0;)H+=c;for(var q=Math.min(n.inHeight,f+G),te=z+W*S,ne=0;ne<n.outWidth;++ne){for(var se=ne*s-v,ue=se;ue<0;)ue+=l;for(var he=Math.min(n.inWidth,d+se),me=te+ne*k,fe=g,ge=0,Fe=0,de=B;de<U;de+=u){for(var we=F+de*e.strides[1],be=H;be<q;be+=c){for(var Te=we+be*e.strides[2],Se=ue;Se<he;Se+=l){var De=x[Te+Se*e.strides[3]+T];if("max"===o&&De>fe?fe=De:"avg"===o&&(ge+=De,Fe++),isNaN(fe))break}if(isNaN(fe))break}if(isNaN(fe))break}y[me+T]="avg"===o?ge/Fe:fe}}}return b.toTensor()},t.prototype.avgPool3d=function(e,n){return V(e,"avgPool3d"),this.pool3d(e,n,"avg").toFloat()},t.prototype.avgPool3dBackprop=function(e,n,o){V([e,n],"avgPool3dBackprop");for(var a=o.strideDepth,i=o.strideHeight,s=o.strideWidth,u=o.filterDepth,c=o.filterHeight,l=o.filterWidth,h=o.dilationDepth,f=o.dilationHeight,d=o.dilationWidth,p=o.effectiveFilterDepth,m=o.effectiveFilterHeight,v=o.effectiveFilterWidth,g=p-1-o.padInfo.front,x=v-1-o.padInfo.left,b=m-1-o.padInfo.top,y=ae(n.shape,"float32"),w=1/(u*c*l),C=this.bufferSync(e),S=0;S<o.batchSize;++S)for(var k=0;k<o.inChannels;++k)for(var I=0;I<o.inDepth;++I)for(var R=0;R<o.inHeight;++R)for(var F=0;F<o.inWidth;++F){for(var T=I-g,L=R-b,O=F-x,B=0,U=0;U<p;U+=h){var z=(T+U)/a;if(!(z<0||z>=o.outDepth||Math.floor(z)!==z))for(var W=0;W<m;W+=f){var G=(L+W)/i;if(!(G<0||G>=o.outHeight||Math.floor(G)!==G))for(var H=0;H<v;H+=d){var q=(O+H)/s;q<0||q>=o.outWidth||Math.floor(q)!==q||(B+=C.get(S,z,G,q,k))}}}y.set(B*w,S,I,R,F,k)}return y.toTensor()},t.prototype.maxPool3d=function(e,n){return V(e,"maxPool3d"),this.pool3d(e,n,"max").toFloat()},t.prototype.maxPool3dPositions=function(e,n){for(var o=ae(n.outShape,"int32"),a=n.strideDepth,i=n.strideHeight,s=n.strideWidth,u=n.dilationDepth,c=n.dilationHeight,l=n.dilationWidth,h=n.effectiveFilterDepth,f=n.effectiveFilterHeight,d=n.effectiveFilterWidth,p=n.padInfo.front,m=n.padInfo.top,v=n.padInfo.left,g=this.bufferSync(e),x=0;x<n.batchSize;++x)for(var b=0;b<n.inChannels;++b)for(var y=0;y<n.outDepth;++y){for(var w=y*a-p,C=w;C<0;)C+=u;for(var S=Math.min(n.inDepth,h+w),k=0;k<n.outHeight;++k){for(var I=k*i-m,R=I;R<0;)R+=c;for(var F=Math.min(n.inHeight,f+I),T=0;T<n.outWidth;++T){for(var L=T*s-v,O=L;O<0;)O+=l;for(var B=Math.min(n.inWidth,d+L),U=Number.NEGATIVE_INFINITY,z=-1,W=C;W<S;W+=u)for(var G=W-w,H=R;H<F;H+=c)for(var q=H-I,te=O;te<B;te+=l){var ne=te-L,se=g.get(x,W,H,te,b);se>=U&&(U=se,z=G*f*d+q*f+ne)}o.set(z,x,y,k,T,b)}}}return o.toTensor()},t.prototype.maxPool3dBackprop=function(e,n,o,a){V([n,o],"maxPool3dBackprop");for(var i=this.maxPool3dPositions(n,a),s=a.strideDepth,u=a.strideHeight,c=a.strideWidth,l=a.dilationDepth,h=a.dilationHeight,f=a.dilationWidth,d=a.effectiveFilterDepth,p=a.effectiveFilterHeight,m=a.effectiveFilterWidth,v=d-1-a.padInfo.front,g=m-1-a.padInfo.left,x=p-1-a.padInfo.top,b=ae(n.shape,"float32"),y=this.bufferSync(i),w=this.bufferSync(e),C=0;C<a.batchSize;++C)for(var S=0;S<a.inChannels;++S)for(var k=0;k<a.inDepth;++k)for(var I=0;I<a.inHeight;++I)for(var R=0;R<a.inWidth;++R){for(var F=k-v,T=I-x,L=R-g,O=0,B=0;B<d;B+=l){var U=(F+B)/s;if(!(U<0||U>=a.outDepth||Math.floor(U)!==U))for(var z=0;z<p;z+=h){var W=(T+z)/u;if(!(W<0||W>=a.outHeight||Math.floor(W)!==W))for(var G=0;G<m;G+=f){var H=(L+G)/c;if(!(H<0||H>=a.outWidth||Math.floor(H)!==H)){var q=d*p*m-1-y.get(C,U,W,H,S)===B*p*m+z*m+G?1:0;0!==q&&(O+=w.get(C,U,W,H,S)*q)}}}}b.set(O,C,k,I,R,S)}return b.toTensor()},t.prototype.cast=function(e,n){return Ca(e,n,this)},t.prototype.reshape=function(e,n){return co(e,n)},t.prototype.avgPool=function(e,n){return V(e,"avgPool"),this.pool(e,n,"avg").toFloat()},t.prototype.resizeBilinear=function(e,n,o,a){V(e,"resizeBilinear");for(var i=e.shape,s=i[0],u=i[1],c=i[2],l=i[3],h=this.readSync(e.dataId),f=new Float32Array(Q([s,n,o,l])),d=[a&&n>1?u-1:u,a&&o>1?c-1:c],p=[a&&n>1?n-1:n,a&&o>1?o-1:o],m=0,v=d[0]/p[0],g=d[1]/p[1],x=0;x<s;x++)for(var b=0;b<n;b++)for(var y=v*b,w=Math.floor(y),C=y-w,S=Math.min(u-1,Math.ceil(y)),k=x*e.strides[0]+w*e.strides[1],I=x*e.strides[0]+S*e.strides[1],R=0;R<o;R++)for(var F=g*R,T=Math.floor(F),L=F-T,O=Math.min(c-1,Math.ceil(F)),B=k+T*e.strides[2],U=I+T*e.strides[2],z=k+O*e.strides[2],W=I+O*e.strides[2],G=0;G<l;G++){var H=h[B+G],q=h[U+G],te=H+(h[z+G]-H)*L;f[m++]=te+(q+(h[W+G]-q)*L-te)*C}return Ke(f,[s,n,o,l])},t.prototype.resizeBilinearBackprop=function(e,n,o){V([e,n],"resizeBilinearBackprop");for(var a=n.shape,i=a[0],s=a[1],u=a[2],c=a[3],l=e.shape,h=l[1],f=l[2],d=new Float32Array(i*s*u*c),p=[o&&h>1?s-1:s,o&&f>1?u-1:u],m=[o&&h>1?h-1:h,o&&f>1?f-1:f],v=p[0]/m[0],g=p[1]/m[1],x=this.readSync(e.dataId),b=0,y=0;y<i;y++)for(var w=y*n.strides[0],C=0;C<h;C++)for(var S=C*v,k=Math.floor(S),I=Math.min(Math.ceil(S),s-1),R=w+k*n.strides[1],F=w+I*n.strides[1],T=S-k,L=1-T,O=0;O<f;O++)for(var B=O*g,U=Math.floor(B),z=Math.min(Math.ceil(B),u-1),W=B-U,G=1-W,H=R+U*n.strides[2],q=R+z*n.strides[2],te=F+U*n.strides[2],ne=F+z*n.strides[2],se=L*G,ue=L*W,he=T*G,me=T*W,fe=0;fe<c;fe++){var ge=x[b++];d[H+fe]+=ge*se,d[q+fe]+=ge*ue,d[te+fe]+=ge*he,d[ne+fe]+=ge*me}return rt(d,[i,u,s,c],n.dtype)},t.prototype.resizeNearestNeighbor=function(e,n,o,a){V(e,"resizeNearestNeighbor");for(var i=e.shape,s=i[0],u=i[1],c=i[2],l=i[3],h=this.readSync(e.dataId),f=new Float32Array(s*n*o*l),d=[a&&n>1?u-1:u,a&&o>1?c-1:c],p=[a&&n>1?n-1:n,a&&o>1?o-1:o],m=d[0]/p[0],v=d[1]/p[1],g=0,x=0;x<s;x++)for(var b=x*e.strides[0],y=0;y<n;y++)for(var w=m*y,C=b+Math.min(u-1,a?Math.round(w):Math.floor(w))*e.strides[1],S=0;S<o;S++)for(var k=v*S,I=C+Math.min(c-1,a?Math.round(k):Math.floor(k))*e.strides[2],R=0;R<l;R++)f[g++]=h[I+R];return Ke(f,[s,n,o,l],e.dtype)},t.prototype.resizeNearestNeighborBackprop=function(e,n,o){V([e,n],"resizeNearestNeighborBackprop");for(var a=n.shape,i=a[0],s=a[1],u=a[2],c=a[3],l=e.shape,h=l[1],f=l[2],d=new Float32Array(i*s*u*c),p=this.readSync(e.dataId),m=[o&&h>1?s-1:s,o&&f>1?u-1:u],v=[o&&h>1?h-1:h,o&&f>1?f-1:f],g=m[0]/v[0],x=m[1]/v[1],b=1/g,y=1/x,w=2*Math.ceil(b)+2,C=2*Math.ceil(y)+2,S=0;S<i;S++)for(var k=S*n.strides[0],I=0;I<s;I++)for(var R=k+I*n.strides[1],F=Math.floor(I*b),T=Math.floor(F-w/2),L=0;L<u;L++)for(var O=R+L*n.strides[2],B=Math.floor(L*y),U=Math.floor(B-C/2),z=0;z<c;z++){for(var W=0,G=0;G<w;G++){var H=G+T;if(!(H<0||H>=h)){var q=k+H*e.strides[1],te=H*g;if(I===Math.min(s-1,o?Math.round(te):Math.floor(te)))for(var ne=0;ne<C;ne++){var se=ne+U;if(!(se<0||se>=f)){var ue=q+se*e.strides[2],he=se*x;L===Math.min(u-1,o?Math.round(he):Math.floor(he))&&(W+=p[ue+z])}}}}d[O+z]=W}return rt(d,n.shape,n.dtype)},t.prototype.batchNormalization=function(e,n,o,a,i,s){V([e,n,o,i,s],"batchNorm");for(var u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=this.readSync(o.dataId),h=i?this.readSync(i.dataId):new Float32Array([1]),f=s?this.readSync(s.dataId):new Float32Array([0]),d=new Float32Array(u.length),p=f.length,m=h.length,v=l.length,g=c.length,x=0,b=0,y=0,w=0,C=0;C<u.length;++C)d[C]=f[x++]+(u[C]-c[b++])*h[y++]/Math.sqrt(l[w++]+a),x>=p&&(x=0),b>=g&&(b=0),y>=m&&(y=0),w>=v&&(w=0);return rt(d,e.shape)},t.prototype.localResponseNormalization4D=function(e,n,o,a,i){V(e,"localResponseNormalization4D");var s=e.shape[3],u=s-1,c=this.readSync(e.dataId),l=e.size,h=new Float32Array(l);function f(v){for(var g=v%s,x=v-g+Math.max(0,g-n),b=v-g+Math.min(g+n,u),y=0;x<=b;x++){var w=c[x];y+=w*w}return y}for(var d=0;d<l;d++){var p=f(d),m=c[d]*Math.pow(o+a*p,-i);h[d]=m}return rt(h,e.shape)},t.prototype.LRNGrad=function(e,n,o,a,i,s,u){V(e,"LRNGrad");for(var c=e.shape[3],l=this.readSync(e.dataId),h=this.readSync(n.dataId),f=this.readSync(o.dataId),d=new Float32Array(e.size),p=e.size,m=0;m<p;m++){for(var v=m%c,g=m-v+Math.max(0,v-a),x=m-v+Math.min(c,v+a+1),b=0,y=g;y<x;y++)b+=Math.pow(h[y],2);for(b=s*b+i,y=g;y<x;y++){var w=-2*s*u*h[y]*f[m]/b;m===y&&(w+=Math.pow(b,-u)),d[y]+=w*=l[m]}}return rt(d,e.shape)},t.prototype.multinomial=function(e,n,o,a){V(e,"multinomial");for(var i=n?e:Ut(e),s=i.shape[0],u=i.shape[1],c=Ee([s,o],"int32"),l=this.readSync(c.dataId),h=this.readSync(i.dataId),f=0;f<s;++f){var d=f*u,p=new Float32Array(u-1);p[0]=h[d];for(var m=1;m<p.length;++m)p[m]=p[m-1]+h[d+m];for(var v=Zr(a.toString()),g=f*o,x=0;x<o;++x){var b=v();l[g+x]=p.length;for(var y=0;y<p.length;y++)if(b<p[y]){l[g+x]=y;break}}}return c},t.prototype.oneHot=function(e,n,o,a){V(e,"oneHot");var i=new Float32Array(e.size*n);i.fill(a);for(var s=this.readSync(e.dataId),u=0;u<e.size;++u)s[u]>=0&&s[u]<n&&(i[u*n+s[u]]=o);return on(i,[e.size,n],"int32")},t.prototype.nonMaxSuppression=function(e,n,o,a,i){return V(e,"nonMaxSuppression"),Ra(this.readSync(e.dataId),this.readSync(n.dataId),o,a,i)},t.prototype.fft=function(e){return this.fftBatch(e,!1)},t.prototype.ifft=function(e){return this.fftBatch(e,!0)},t.prototype.fftBatch=function(e,n){for(var o=e.shape[0],a=e.shape[1],i=ae(e.shape,"float32"),s=ae(e.shape,"float32"),u=ft(e).as2D(o,a),c=St(e).as2D(o,a),l=0;l<o;l++)for(var h=u.slice([l,0],[1,a]),f=c.slice([l,0],[1,a]),d=qe(h,f),p=this.readSync(this.fftImpl(d,n).dataId),m=0;m<a;m++){var v=xu(p,m);i.values[l*a+m]=v.real,s.values[l*a+m]=v.imag}return qe(i.toTensor(),s.toTensor()).as2D(o,a)},t.prototype.fftImpl=function(e,n){var o=e.as1D(),a=o.size;if(this.isExponentOf2(a)){var i=this.fftRadix2(o,a,n).as2D(e.shape[0],e.shape[1]);return n&&(i=qe(ft(i).div(j(a)),St(i).div(j(a)))),i}var s=this.readSync(e.dataId),u=function(c){for(var l=new Float32Array(c.length/2),h=new Float32Array(c.length/2),f=0;f<c.length;f+=2)l[f/2]=c[f],h[f/2]=c[f+1];return{real:l,imag:h}}(this.fourierTransformByMatmul(s,a,n));return qe(u.real,u.imag).as2D(e.shape[0],e.shape[1])},t.prototype.isExponentOf2=function(e){return!(e&e-1)},t.prototype.fftRadix2=function(e,n,o){if(1===n)return e;var a=this.readSync(e.dataId),i=n/2,s=function(g){for(var x=Math.ceil(g.length/4),b=new Float32Array(x),y=new Float32Array(x),w=0;w<g.length;w+=4)b[Math.floor(w/4)]=g[w],y[Math.floor(w/4)]=g[w+1];return{real:b,imag:y}}(a),u=qe(s.real,s.imag).as1D(),c=function(g){for(var x=Math.floor(g.length/4),b=new Float32Array(x),y=new Float32Array(x),w=2;w<g.length;w+=4)b[Math.floor(w/4)]=g[w],y[Math.floor(w/4)]=g[w+1];return{real:b,imag:y}}(a),l=qe(c.real,c.imag).as1D();u=this.fftRadix2(u,i,o),l=this.fftRadix2(l,i,o);var h=function(g,x){for(var b=new Float32Array(g/2),y=new Float32Array(g/2),w=0;w<Math.ceil(g/2);w++){var C=(x?2:-2)*Math.PI*(w/g);b[w]=Math.cos(C),y[w]=Math.sin(C)}return{real:b,imag:y}}(n,o),f=qe(h.real,h.imag).mul(l),d=u.add(f),p=u.sub(f),m=ft(d).concat(ft(p)),v=St(d).concat(St(p));return qe(m,v).as1D()},t.prototype.fourierTransformByMatmul=function(e,n,o){for(var a=new Float32Array(2*n),i=0;i<n;i++){for(var s=0,u=0,c=0;c<n;c++){var l=pf(i*c,n,o),h=xu(e,c);s+=h.real*l.real-h.imag*l.imag,u+=h.real*l.imag+h.imag*l.real}o&&(s/=n,u/=n),df(a,s,u,i)}return a},t.prototype.depthToSpace=function(e,n,o){E("NHWC"===o,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+o}),E(n>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});for(var a=e.shape[0],i=e.shape[1],s=e.shape[2],u=e.shape[3],c=i*n,l=s*n,h=u/(n*n),f=this.readSync(e.dataId),d=new Float32Array(a*c*l*h),p=0,m=0;m<a;++m)for(var v=0;v<c;++v)for(var g=Math.floor(v/n),x=v%n,b=0;b<l;++b)for(var y=Math.floor(b/n),w=(x*n+b%n)*h,C=0;C<h;++C)d[p++]=f[C+w+u*(y+s*(g+i*m))];return rt(d,[a,c,l,h])},t.prototype.broadcastedBinaryOp=function(e,n,o,a){var i=ce(e.shape,n.shape),s=ae(i,o),u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=Gt(e.shape,i),h=Gt(n.shape,i),f=s.values;if(l.length+h.length===0)for(var d=0;d<f.length;++d)f[d]=a(u[d%u.length],c[d%c.length]);else{var p=this.bufferSync(e),m=this.bufferSync(n),v=function(g){var x=s.indexToLoc(g),b=x.slice(-e.rank);l.forEach(function(S){return b[S]=0});var y=p.locToIndex(b),w=x.slice(-n.rank);h.forEach(function(S){return w[S]=0});var C=m.locToIndex(w);f[g]=a(u[y],c[C])};for(d=0;d<f.length;++d)v(d)}return s.toTensor()},t.prototype.broadcastedBinaryComplexOp=function(e,n,o){var a=ce(e.shape,n.shape),i=ae(a,"float32"),s=ae(a,"float32"),u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=Gt(e.shape,a),h=Gt(n.shape,a),f=i.values,d=s.values;if(l.length+h.length===0)for(var p=0;p<f.length;p++){var m=p%u.length,v=p%c.length,g=o(u[2*m],u[2*m+1],c[2*v],c[2*v+1]);f[p]=g.real,d[p]=g.imag}else{var x=this.bufferSync(this.data.get(e.dataId).complexTensors.real),b=this.bufferSync(this.data.get(n.dataId).complexTensors.real),y=function(w){var C=i.indexToLoc(w),S=C.slice(-e.rank);l.forEach(function(T){return S[T]=0});var k=x.locToIndex(S),I=C.slice(-n.rank);h.forEach(function(T){return I[T]=0});var R=b.locToIndex(I),F=o(u[2*k],u[2*k+1],c[2*R],c[2*R+1]);f[w]=F.real,d[w]=F.imag};for(p=0;p<f.length;p++)y(p)}return this.complex(i.toTensor(),s.toTensor())},t.prototype.split=function(e,n,o){return _u(e,n,o)},t.prototype.dispose=function(){},t.prototype.floatPrecision=function(){return 32},t.prototype.epsilon=function(){return 1e-7},t.prototype.cropAndResize=function(e,n,o,a,i,s){for(var u=e.shape,c=u[0],l=u[1],h=u[2],f=u[3],d=n.shape[0],p=a[0],m=a[1],v=ae([d,p,m,f],"float32"),g=this.readSync(n.dataId),x=this.readSync(o.dataId),b=this.readSync(e.dataId),y=e.strides,w=v.strides,C=0;C<d;C++){var S=4*C,k=g[S],I=g[S+1],R=g[S+2],F=g[S+3],T=x[C];if(!(T>=c))for(var L=p>1?(R-k)*(l-1)/(p-1):0,O=m>1?(F-I)*(h-1)/(m-1):0,B=0;B<p;B++){var U=p>1?k*(l-1)+B*L:.5*(k+R)*(l-1);if(U<0||U>l-1)for(var z=0;z<m;z++)for(var W=0;W<f;W++){var G=W+z*w[2]+B*w[1]+C*w[0];v.values[G]=s}else if("bilinear"===i){var H=Math.floor(U),q=Math.ceil(U),te=U-H;for(z=0;z<m;z++)if((de=m>1?I*(h-1)+z*O:.5*(I+F)*(h-1))<0||de>h-1)for(W=0;W<f;W++)v.values[G=W+z*w[2]+B*w[1]+C*w[0]]=s;else{var ne=Math.floor(de),se=Math.ceil(de),ue=de-ne;for(W=0;W<f;W++){var he=b[G=W+ne*y[2]+H*y[1]+T*y[0]],me=b[G=W+se*y[2]+H*y[1]+T*y[0]],fe=b[G=W+ne*y[2]+q*y[1]+T*y[0]],ge=he+(me-he)*ue,Fe=fe+(b[G=W+se*y[2]+q*y[1]+T*y[0]]-fe)*ue;v.values[G=W+z*w[2]+B*w[1]+C*w[0]]=ge+(Fe-ge)*te}}}else for(z=0;z<m;++z){var de;if((de=m>1?I*(h-1)+z*O:.5*(I+F)*(h-1))<0||de>h-1)for(W=0;W<f;W++)v.values[G=W+z*w[2]+B*w[1]+C*w[0]]=s;else{var we=Math.round(de),be=Math.round(U);for(W=0;W<f;W++)v.values[W+z*w[2]+B*w[1]+C*w[0]]=b[W+we*y[2]+be*y[1]+T*y[0]]}}}}return v.toTensor()},t.prototype.sparseToDense=function(e,n,o,a){var i=_r(0,e,o);return this.scatter(e,n,o,i.outputSize,i.sliceSize,i.numUpdates,i.sliceRank,i.strides,a,!1)},t.prototype.gatherND=function(e,n){var o=n.shape,a=o[o.length-1],i=ma(e,n),s=i[0],u=i[1],c=i[2],l=i[3];if(0===u)return Ke([],s,e.dtype);for(var h=new fr([u,c],e.dtype),f=this.readSync(n.dataId),d=this.readSync(e.dataId),p=0;p<u;p++){for(var m=[],v=0,g=0;g<a;g++){var x=f[p*a+g];v+=x*l[g],m.push(x)}if(v<0||v>=e.size/c)throw new Error("Invalid indices: "+m+" does not index into "+e.shape);for(var b=0;b<c;b++)h.values[p*c+b]=d[v*c+b]}return h.toTensor().reshape(s)},t.prototype.scatterND=function(e,n,o){var a=_r(0,e,o),i=a.sliceRank,s=a.numUpdates,u=a.sliceSize,c=a.strides,l=a.outputSize,h=j(0);return this.scatter(e,n,o,l,u,s,i,c,h,!0)},t.prototype.fill=function(e,n,o){var a=sr(o=o||Mn(n),Q(e));return a.fill(n),D.makeTensor(a,e,o,this)},t.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(e.shape,1,e.dtype)},t.prototype.zerosLike=function(e){var n=sr(e.dtype,Q(e.shape));return this.makeOutput(n,e.shape,e.dtype)},t.prototype.linspace=function(e,n,o){return Ea(e,n,o)},t.prototype.scatter=function(e,n,o,a,i,s,u,c,l,h){var f=[a/i,i],d=this.readSync(e.dataId),p=this.readSync(n.dataId);if(0===a)return Ke([],o,n.dtype);var m=new fr(f,n.dtype);m.values.fill(this.readSync(l.dataId)[0]);for(var v=0;v<s;v++){for(var g=[],x=0,b=0;b<u;b++){var y=d[v*u+b];g.push(y),x+=y*c[b]}if(x<0||x>=a/i)throw new Error("Invalid indices: "+g+" does not index into "+o);for(var w=0;w<i;w++)h?m.values[x*i+w]+=p[v*i+w]:m.values[x*i+w]=0===n.rank?p[0]:p[v*i+w]}return m.toTensor().reshape(o)},t}(yu);D.registerBackend("cpu",function(){return new gm},1);for(var ti=0,Jc=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(r){var t=r.inputs,n=r.attrs,a=t.boxes,i=t.scores,u=n.maxOutputSize,c=n.iouThreshold,l=n.scoreThreshold,h=n.softNmsSigma,f=r.backend;V(a,"NonMaxSuppressionWithScore");var d=ka(f.data.get(a.dataId).values,f.data.get(i.dataId).values,u,c,l,h);return[d.selectedIndices,d.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(r){var n=r.inputs.x,o=r.backend;V(n,"square");for(var a=o.data.get(n.dataId).values,i=new Float32Array(a.length),s=0;s<a.length;++s){var u=a[s];i[s]=u*u}return{dataId:o.write(i,n.shape,n.dtype),shape:n.shape,dtype:n.dtype}}},{kernelName:Sr,backendName:"cpu",kernelFunc:function(r){var t=r.inputs,o=t.a,a=t.b,i=r.backend;V([o,a],Sr);var s=i.data.get(o.dataId).values,u=i.data.get(a.dataId).values,c=function(f,d,p,m,v,g){var x=ce(f,d),b=x.length,y=gt(x),w=Pn(v,Q(x)),C=f.length,S=d.length,k=gt(f),I=gt(d),R=Gt(f,x),F=Gt(d,x);if(R.length+F.length===0)for(var T=0;T<w.length;++T)w[T]=g(p[T%p.length],m[T%m.length]);else{var L=function(O){var B=ws(O,b,y),U=B.slice(-C);R.forEach(function(H){return U[H]=0});var z=$o(U,C,k),W=B.slice(-S);F.forEach(function(H){return W[H]=0});var G=$o(W,S,I);w[O]=g(p[z],m[G])};for(T=0;T<w.length;++T)L(T)}return[w,x]}(o.shape,a.shape,s,u,o.dtype,function(f,d){var p=f-d;return p*p}),h=c[1];return{dataId:i.write(c[0],h,o.dtype),shape:h,dtype:o.dtype}}}];ti<Jc.length;ti++)cs(Jc[ti]);for(var qn,ym=function(r){this.variableNames=["A"];var t=Xe(),e=r[0],n=r[1];this.outputShape=r,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+n+".0, "+e+".0);\n\n        vec4 values = "+t.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},xm=function(r){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var t=Xe(),e=r[0],n=r[1];this.outputShape=r,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+n+".0, "+e+".0);\n            vec4 values = "+t.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+t.output+" = result;\n      }\n    "},ni=0,Zc=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(r){var e=r.backend,o=r.inputs.pixels,i=typeof HTMLVideoElement<"u"&&o instanceof HTMLVideoElement,s=typeof HTMLImageElement<"u"&&o instanceof HTMLImageElement,u=i?[o.videoWidth,o.videoHeight]:[o.width,o.height],c=u[0],l=u[1],h=[l,c],f=[l,c,r.attrs.numChannels];(s||i)&&(null==qn&&(qn=document.createElement("canvas").getContext("2d")),qn.canvas.width=c,qn.canvas.height=l,qn.drawImage(o,0,0,c,l),o=qn.canvas);var d=e.makeTensorInfo(h,"int32");e.texData.get(d.dataId).usage=at.PIXELS,e.gpgpu.uploadPixelDataToTexture(e.getTexture(d.dataId),o);var p=M().getBool("WEBGL_PACK")?new xm(f):new ym(f),m=e.runWebGLProgram(p,[d],"int32");return e.disposeData(d.dataId),m}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(r){var t=r.inputs,e=r.backend,n=r.attrs;$r("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var i=t.scores,u=n.maxOutputSize,c=n.iouThreshold,l=n.scoreThreshold,h=n.softNmsSigma,f=e,d=ka(f.readSync(t.boxes.dataId),f.readSync(i.dataId),u,c,l,h);return[d.selectedIndices,d.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(r){var n=r.inputs.x,o=r.backend,a=new ie(n.shape,"return x * x;");return o.runWebGLProgram(a,[n],n.dtype)}},{kernelName:Sr,backendName:"webgl",kernelFunc:function(r){var t=r.inputs,o=t.a,a=t.b,i=r.backend,s=M().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Ht("return (a - b) * (a - b);",o.shape,a.shape):new Ae("return (a - b) * (a - b);",o.shape,a.shape);return i.compileAndRun(s,[o,a])}}];ni<Zc.length;ni++)cs(Zc[ni]);for(var ri=0,el=[{kernelName:"Square",gradFunc:function(r,t){var e=t[0];return{x:function(){return r.mul(e.toFloat().mul(2))}}}},{kernelName:Sr,gradFunc:function(r,t){var e=t[0],n=t[1],o=j(2);return{a:function(){return Ye(r,Ye(o,We(e,n)))},b:function(){return Ye(r,Ye(o,We(n,e)))}}}}];ri<el.length;ri++)wh(el[ri]);var bm=function(){function r(){}return r.prototype.fetch=function(t,e){return fetch(t,e)},r.prototype.now=function(){return performance.now()},r.prototype.encode=function(t,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Browser's encoder only supports utf-8, but got "+e);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(t)},r.prototype.decode=function(t,e){return new TextDecoder(e).decode(t)},r}();M().get("IS_BROWSER")&&M().setPlatform("browser",new bm);var oi,_m=function(){function r(){this.util=vt(745),this.textEncoder=new this.util.TextEncoder}return r.prototype.fetch=function(t,e){return null!=M().global.fetch?M().global.fetch(t,e):(null==oi&&(oi=vt(7318)),oi(t,e))},r.prototype.now=function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6},r.prototype.encode=function(t,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Node built-in encoder only supports utf-8, but got "+e);return this.textEncoder.encode(t)},r.prototype.decode=function(t,e){return 0===t.length?"":new this.util.TextDecoder(e).decode(t)},r}();M().get("IS_NODE")&&M().setPlatform("node",new _m);var ai={float32:4,int32:4,uint16:2,uint8:1,bool:1};function tl(r,t){for(var e={},n=0,o=function(s){var u=s.name,c=s.dtype,l=s.shape,h=Q(l),f=void 0;if("quantization"in s){var d=s.quantization;if("uint8"!==d.dtype&&"uint16"!==d.dtype)throw new Error("Weight "+s.name+" has unknown quantization dtype "+d.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var p=ai[d.dtype],m=r.slice(n,n+h*p),v="uint8"===d.dtype?new Uint8Array(m):new Uint16Array(m);if("float32"===c)f=Float32Array.from(v,function(C){return C*d.scale+d.min});else{if("int32"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=Int32Array.from(v,function(C){return Math.round(C*d.scale+d.min)})}n+=h*p}else if("string"===c){var g=Q(s.shape);f=[];for(var x=0;x<g;x++){var b=new Uint32Array(r.slice(n,n+4))[0];n+=4;var y=new Uint8Array(r.slice(n,n+b));f.push(y),n+=b}}else{var w=ai[c];if(m=r.slice(n,n+h*w),"float32"===c)f=new Float32Array(m);else if("int32"===c)f=new Int32Array(m);else{if("bool"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=new Uint8Array(m)}n+=h*w}e[u]=Ke(f,l,c)},a=0,i=t;a<i.length;a++)o(i[a]);return e}function Cm(r){if(null===r)throw new Error("Invalid input value: "+JSON.stringify(r));var t=0,e=[];r.forEach(function(a){if(t+=a.byteLength,e.push(a.byteLength===a.buffer.byteLength?a:new a.constructor(a)),!(a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+a.constructor.name)});var n=new Uint8Array(t),o=0;return e.forEach(function(a){n.set(new Uint8Array(a.buffer),o),o+=a.byteLength}),n.buffer}var ii=typeof Buffer<"u"&&(typeof Blob>"u"||typeof atob>"u"||typeof btoa>"u");function nl(r){return ii?Buffer.byteLength(r):new Blob([r]).size}function si(r){var t=0;r.forEach(function(o){t+=o.byteLength});var e=new Uint8Array(t),n=0;return r.forEach(function(o){e.set(new Uint8Array(o),n),n+=o.byteLength}),e.buffer}function rl(r){for(r=r.trim();r.endsWith("/");)r=r.slice(0,r.length-1);var t=r.split("/");return t[t.length-1]}function Fr(r){if(r.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==r.modelTopology?0:nl(JSON.stringify(r.modelTopology)),weightSpecsBytes:null==r.weightSpecs?0:nl(JSON.stringify(r.weightSpecs)),weightDataBytes:null==r.weightData?0:r.weightData.byteLength}}var ct=function(){function r(){this.saveRouters=[],this.loadRouters=[]}return r.getInstance=function(){return null==r.instance&&(r.instance=new r),r.instance},r.registerSaveRouter=function(t){r.getInstance().saveRouters.push(t)},r.registerLoadRouter=function(t){r.getInstance().loadRouters.push(t)},r.getSaveHandlers=function(t){return r.getHandlers(t,"save")},r.getLoadHandlers=function(t,e){return r.getHandlers(t,"load",e)},r.getHandlers=function(t,e,n){var o=[];return("load"===e?r.getInstance().loadRouters:r.getInstance().saveRouters).forEach(function(a){var i=a(t,n);null!==i&&o.push(i)}),o},r}(),Kn="://",un=function(){function r(){this.managers={}}return r.getInstance=function(){return null==r.instance&&(r.instance=new r),r.instance},r.registerManager=function(t,e){E(null!=t,function(){return"scheme must not be undefined or null."}),t.endsWith(Kn)&&(t=t.slice(0,t.indexOf(Kn))),E(t.length>0,function(){return"scheme must not be an empty string."});var n=r.getInstance();E(null==n.managers[t],function(){return"A model store manager is already registered for scheme '"+t+"'."}),n.managers[t]=e},r.getManager=function(t){var e=this.getInstance().managers[t];if(null==e)throw new Error("Cannot find model manager for scheme '"+t+"'");return e},r.getSchemes=function(){return Object.keys(this.getInstance().managers)},r}();function Ro(r){if(-1===r.indexOf(Kn))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+un.getSchemes().join(","));return{scheme:r.split(Kn)[0],path:r.split(Kn)[1]}}function ol(r,t,e){return void 0===e&&(e=!1),Y(this,void 0,void 0,function(){var n,o,a,i,s,u,c,l,h;return $(this,function(f){switch(f.label){case 0:return E(r!==t,function(){return"Old path and new path are the same: '"+r+"'"}),E((n=ct.getLoadHandlers(r)).length>0,function(){return"Copying failed because no load handler is found for source URL "+r+"."}),E(n.length<2,function(){return"Copying failed because more than one ("+n.length+") load handlers for source URL "+r+"."}),o=n[0],E((a=ct.getSaveHandlers(t)).length>0,function(){return"Copying failed because no save handler is found for destination URL "+t+"."}),E(a.length<2,function(){return"Copying failed because more than one ("+n.length+") save handlers for destination URL "+t+"."}),i=a[0],s=Ro(r).scheme,u=Ro(r).path,c=s===Ro(r).scheme,[4,o.load()];case 1:return l=f.sent(),e&&c?[4,un.getManager(s).removeModel(u)]:[3,3];case 2:f.sent(),f.label=3;case 3:return[4,i.save(l)];case 4:return h=f.sent(),!e||c?[3,6]:[4,un.getManager(s).removeModel(u)];case 5:f.sent(),f.label=6;case 6:return[2,h.modelArtifactsInfo]}})})}var kn="models_store",cn="model_info_store";function al(){if(!M().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var r=window||self,t=r.indexedDB||r.mozIndexedDB||r.webkitIndexedDB||r.msIndexedDB||r.shimIndexedDB;if(null==t)throw new Error("The current browser does not appear to support IndexedDB.");return t}function ui(r){var t=r.result;t.createObjectStore(kn,{keyPath:"modelPath"}),t.createObjectStore(cn,{keyPath:"modelPath"})}var Xn=function(){function r(t){if(this.indexedDB=al(),null==t||!t)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=t}return r.prototype.save=function(t){return Y(this,void 0,void 0,function(){return $(this,function(e){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,t)]})})},r.prototype.load=function(){return Y(this,void 0,void 0,function(){return $(this,function(t){return[2,this.databaseAction(this.modelPath)]})})},r.prototype.databaseAction=function(t,e){var n=this;return new Promise(function(o,a){var i=n.indexedDB.open("tensorflowjs",1);i.onupgradeneeded=function(){return ui(i)},i.onsuccess=function(){var s=i.result;if(null==e){var u=s.transaction(kn,"readonly"),c=u.objectStore(kn).get(n.modelPath);c.onsuccess=function(){if(null==c.result)return s.close(),a(new Error("Cannot find model with path '"+n.modelPath+"' in IndexedDB."));o(c.result.modelArtifacts)},c.onerror=function(m){return s.close(),a(c.error)},u.oncomplete=function(){return s.close()}}else{var l,h=Fr(e),f=s.transaction(cn,"readwrite"),d=f.objectStore(cn),p=d.put({modelPath:n.modelPath,modelArtifactsInfo:h});p.onsuccess=function(){var m=(l=s.transaction(kn,"readwrite")).objectStore(kn).put({modelPath:n.modelPath,modelArtifacts:e,modelArtifactsInfo:h});m.onsuccess=function(){return o({modelArtifactsInfo:h})},m.onerror=function(v){var g=(d=f.objectStore(cn)).delete(n.modelPath);g.onsuccess=function(){return s.close(),a(m.error)},g.onerror=function(x){return s.close(),a(m.error)}}},p.onerror=function(m){return s.close(),a(p.error)},f.oncomplete=function(){null==l?s.close():l.oncomplete=function(){return s.close()}}}},i.onerror=function(s){return a(i.error)}})},r.URL_SCHEME="indexeddb://",r}(),il=function(r){return M().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith(Xn.URL_SCHEME)?(t=r.slice(Xn.URL_SCHEME.length),new Xn(t)):null;var t};ct.registerSaveRouter(il),ct.registerLoadRouter(il);var Em=function(){function r(){this.indexedDB=al()}return r.prototype.listModels=function(){return Y(this,void 0,void 0,function(){var t=this;return $(this,function(e){return[2,new Promise(function(n,o){var a=t.indexedDB.open("tensorflowjs",1);a.onupgradeneeded=function(){return ui(a)},a.onsuccess=function(){var i=a.result,s=i.transaction(cn,"readonly"),u=s.objectStore(cn).getAll();u.onsuccess=function(){for(var c={},l=0,h=u.result;l<h.length;l++){var f=h[l];c[f.modelPath]=f.modelArtifactsInfo}n(c)},u.onerror=function(c){return i.close(),o(u.error)},s.oncomplete=function(){return i.close()}},a.onerror=function(i){return o(a.error)}})]})})},r.prototype.removeModel=function(t){return Y(this,void 0,void 0,function(){var e=this;return $(this,function(n){var o;return t=(o=t).startsWith(Xn.URL_SCHEME)?o.slice(Xn.URL_SCHEME.length):o,[2,new Promise(function(a,i){var s=e.indexedDB.open("tensorflowjs",1);s.onupgradeneeded=function(){return ui(s)},s.onsuccess=function(){var u,c=s.result,l=c.transaction(cn,"readwrite"),h=l.objectStore(cn),f=h.get(t);f.onsuccess=function(){if(null==f.result)return c.close(),i(new Error("Cannot find model with path '"+t+"' in IndexedDB."));var d=h.delete(t),p=function(){var m=(u=c.transaction(kn,"readwrite")).objectStore(kn).delete(t);m.onsuccess=function(){return a(f.result.modelArtifactsInfo)},m.onerror=function(v){return i(f.error)}};d.onsuccess=p,d.onerror=function(m){return p(),c.close(),i(f.error)}},f.onerror=function(d){return c.close(),i(f.error)},l.oncomplete=function(){null==u?c.close():u.oncomplete=function(){return c.close()}}},s.onerror=function(u){return i(s.error)}})]})})},r}();if(M().getBool("IS_BROWSER"))try{un.registerManager(Xn.URL_SCHEME,new Em)}catch{}var qt="/",Yn="tensorflowjs_models",sl="info",Im="model_topology",Rm="weight_specs",km="weight_data",Sm="model_metadata";function ul(r){return{info:[Yn,r,sl].join(qt),topology:[Yn,r,Im].join(qt),weightSpecs:[Yn,r,Rm].join(qt),weightData:[Yn,r,km].join(qt),modelMetadata:[Yn,r,Sm].join(qt)}}function Dm(r){var t=r.split(qt);if(t.length<3)throw new Error("Invalid key format: "+r);return t.slice(1,t.length-1).join(qt)}var $n=function(){function r(t){if(!M().getBool("IS_BROWSER")||typeof window>"u"||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==t||!t)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=t,this.keys=ul(this.modelPath)}return r.prototype.save=function(t){return Y(this,void 0,void 0,function(){var e,n,o;return $(this,function(a){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");e=JSON.stringify(t.modelTopology),n=JSON.stringify(t.weightSpecs),o=Fr(t);try{return this.LS.setItem(this.keys.info,JSON.stringify(o)),this.LS.setItem(this.keys.topology,e),this.LS.setItem(this.keys.weightSpecs,n),this.LS.setItem(this.keys.weightData,function(i){if(ii)return Buffer.from(i).toString("base64");for(var s=new Uint8Array(i),u="",c=0,l=s.length;c<l;c++)u+=String.fromCharCode(s[c]);return btoa(u)}(t.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,userDefinedMetadata:t.userDefinedMetadata})),[2,{modelArtifactsInfo:o}]}catch{throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+o.modelTopologyBytes+", weightSpecsBytes="+o.weightSpecsBytes+", weightDataBytes="+o.weightDataBytes+".")}return[2]})})},r.prototype.load=function(){return Y(this,void 0,void 0,function(){var t,e,n,o,a,i,s;return $(this,function(u){if(null==(t=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==t.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(e={},null==(n=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(e.modelTopology=n,null==(o=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(e.weightSpecs=o,null!=(a=this.LS.getItem(this.keys.modelMetadata))&&(i=JSON.parse(a),e.format=i.format,e.generatedBy=i.generatedBy,e.convertedBy=i.convertedBy,e.userDefinedMetadata=i.userDefinedMetadata),null==(s=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return e.weightData=function(c){if(ii){var l=Buffer.from(c,"base64");return l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)}for(var h=atob(c),f=new Uint8Array(h.length),d=0;d<h.length;++d)f.set([h.charCodeAt(d)],d);return f.buffer}(s),[2,e]})})},r.URL_SCHEME="localstorage://",r}(),cl=function(r){return M().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith($n.URL_SCHEME)?(t=r.slice($n.URL_SCHEME.length),new $n(t)):null;var t};ct.registerSaveRouter(cl),ct.registerLoadRouter(cl);var Am=function(){function r(){E(M().getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),E(typeof window>"u"||void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return r.prototype.listModels=function(){return Y(this,void 0,void 0,function(){var t,e,n,o,a,i;return $(this,function(s){for(t={},e=Yn+qt,n=qt+sl,o=0;o<this.LS.length;++o)(a=this.LS.key(o)).startsWith(e)&&a.endsWith(n)&&(i=Dm(a),t[i]=JSON.parse(this.LS.getItem(a)));return[2,t]})})},r.prototype.removeModel=function(t){return Y(this,void 0,void 0,function(){var e,n;return $(this,function(o){var a;if(t=(a=t).startsWith($n.URL_SCHEME)?a.slice($n.URL_SCHEME.length):a,e=ul(t),null==this.LS.getItem(e.info))throw new Error("Cannot find model at path '"+t+"'");return n=JSON.parse(this.LS.getItem(e.info)),this.LS.removeItem(e.info),this.LS.removeItem(e.topology),this.LS.removeItem(e.weightSpecs),this.LS.removeItem(e.weightData),[2,n]})})},r}();if(M().getBool("IS_BROWSER"))try{un.registerManager($n.URL_SCHEME,new Am)}catch{}function ll(r){return new Promise(function(t){return setTimeout(t)}).then(r)}var ci=function(){function r(t){if(!M().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");t.startsWith(r.URL_SCHEME)&&(t=t.slice(r.URL_SCHEME.length)),null!=t&&0!==t.length||(t="model"),this.modelTopologyFileName=t+".json",this.weightDataFileName=t+".weights.bin"}return r.prototype.save=function(t){return Y(this,void 0,void 0,function(){var e,a,i,s;return $(this,function(u){switch(u.label){case 0:if(typeof document>"u")throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(e=window.URL.createObjectURL(new Blob([t.weightData],{type:"application/octet-stream"})),!(t.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return a=window.URL.createObjectURL(new Blob([JSON.stringify({modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,weightsManifest:[{paths:["./"+this.weightDataFileName],weights:t.weightSpecs}]})],{type:"application/json"})),(i=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,i.href=a,[4,ll(function(){return i.dispatchEvent(new MouseEvent("click"))})];case 2:return u.sent(),null==t.weightData?[3,4]:((s=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,s.href=e,[4,ll(function(){return s.dispatchEvent(new MouseEvent("click"))})]);case 3:u.sent(),u.label=4;case 4:return[2,{modelArtifactsInfo:Fr(t)}]}})})},r.URL_SCHEME="downloads://",r}(),Pm=function(){function r(t){if(null==t||t.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+t);this.files=t}return r.prototype.load=function(){return Y(this,void 0,void 0,function(){var t,e,n=this;return $(this,function(o){return t=this.files[0],e=this.files.slice(1),[2,new Promise(function(a,i){var s=new FileReader;s.onload=function(u){var c=JSON.parse(u.target.result),l=c.modelTopology;if(null!=l){0===e.length&&a({modelTopology:l});var h=c.weightsManifest;if(null!=h){var f;try{f=n.checkManifestAndWeightFiles(h,e)}catch(v){return void i(v)}var d=[],p=[],m=[];h.forEach(function(v){v.paths.forEach(function(g){p.push(g),m.push(null)}),d.push.apply(d,v.weights)}),h.forEach(function(v){v.paths.forEach(function(g){var x=new FileReader;x.onload=function(b){var y=b.target.result,w=p.indexOf(g);m[w]=y,-1===m.indexOf(null)&&a({modelTopology:l,weightSpecs:d,weightData:si(m),format:c.format,generatedBy:c.generatedBy,convertedBy:c.convertedBy,userDefinedMetadata:c.userDefinedMetadata})},x.onerror=function(b){return i("Failed to weights data from file of path '"+g+"'.")},x.readAsArrayBuffer(f[g])})})}else i(new Error("weightManifest field is missing from file "+t.name))}else i(new Error("modelTopology field is missing from file "+t.name))},s.onerror=function(u){return i("Failed to read model topology and weights manifest JSON from file '"+t.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},s.readAsText(t)})]})})},r.prototype.checkManifestAndWeightFiles=function(t,e){for(var n=[],o=e.map(function(u){return rl(u.name)}),a={},i=0,s=t;i<s.length;i++)s[i].paths.forEach(function(u){var c=rl(u);if(-1!==n.indexOf(c))throw new Error("Duplicate file basename found in weights manifest: '"+c+"'");if(n.push(c),-1===o.indexOf(c))throw new Error("Weight file with basename '"+c+"' is not provided.");a[u]=e[o.indexOf(c)]});if(n.length!==e.length)throw new Error("Mismatch in the number of files in weights manifest ("+n.length+") and the number of weight files provided ("+e.length+").");return a},r}();function hl(r,t,e,n){var a;E(null!=(a=r)&&Array.isArray(a)&&a.length>0,function(){return"promises must be a none empty array"}),function(a,i){E(a>=0&&a<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+a}),E(i>=0&&i<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+i}),E(i>=a,function(){return"startFraction must be no more than endFraction, but got startFraction "+a+" and endFraction "+i})}(e=e??0,n=n??1);var o=0;return Promise.all(r.map(function(a){return a.then(function(i){var s=e+ ++o/r.length*(n-e);return t(s),i}),a}))}function fl(r,t){return Y(this,void 0,void 0,function(){var e,n,o,a,i,s,u,c,l;return $(this,function(h){switch(h.label){case 0:return null==t&&(t={}),e=null==t.fetchFunc?M().platform.fetch:t.fetchFunc,n=r.map(function(f){return e(f,t.requestInit,{isBinary:!0})}),o=0,a=.5,null!=t.onProgress?[3,2]:[4,Promise.all(n)];case 1:return i=h.sent(),[3,4];case 2:return[4,hl(n,t.onProgress,o,a)];case 3:i=h.sent(),h.label=4;case 4:return s=i.map(function(f){return f.arrayBuffer()}),u=.5,c=1,null!=t.onProgress?[3,6]:[4,Promise.all(s)];case 5:return l=h.sent(),[3,8];case 6:return[4,hl(s,t.onProgress,u,c)];case 7:l=h.sent(),h.label=8;case 8:return[2,l]}})})}function dl(r){var t=this;return function(e,n,o){return void 0===n&&(n=""),Y(t,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p;return $(this,function(m){switch(m.label){case 0:if(a=e.map(function(){return!1}),i={},s=null!=o?o.map(function(){return!1}):[],u=[],e.forEach(function(v,g){var x=0;v.weights.forEach(function(b){var w=ai["quantization"in b?b.quantization.dtype:b.dtype]*Q(b.shape),C=function(){a[g]=!0,null==i[g]&&(i[g]=[]),i[g].push({manifestEntry:b,groupOffset:x,sizeBytes:w})};null!=o?o.forEach(function(S,k){S===b.name&&(C(),s[k]=!0)}):C(),u.push(b.name),x+=w})}),!s.every(function(v){return v}))throw c=o.filter(function(v,g){return!s[g]}),new Error("Could not find weights in manifest with names: "+c.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return l=a.reduce(function(v,g,x){return g&&v.push(x),v},[]),h=[],l.forEach(function(v){e[v].paths.forEach(function(g){var x=n+(n.endsWith("/")?"":"/")+g;h.push(x)})}),[4,r(h)];case 1:return f=m.sent(),d={},p=0,l.forEach(function(v){for(var g=e[v].paths.length,x=0,b=0;b<g;b++)x+=f[p+b].byteLength;for(var y=new ArrayBuffer(x),w=new Uint8Array(y),C=0,S=0;S<g;S++){var k=new Uint8Array(f[p+S]);w.set(k,C),C+=k.byteLength}i[v].forEach(function(I){var R=tl(y.slice(I.groupOffset,I.groupOffset+I.sizeBytes),[I.manifestEntry]);for(var F in R)d[F]=R[F]}),p+=g}),[2,d]}})})}}ct.registerSaveRouter(function(r){return M().getBool("IS_BROWSER")&&!Array.isArray(r)&&r.startsWith(ci.URL_SCHEME)?(void 0===(t=r.slice(ci.URL_SCHEME.length))&&(t="model"),new ci(t)):null;var t});var pl=function(){function r(t,e){if(this.DEFAULT_METHOD="POST",null==e&&(e={}),this.weightPathPrefix=e.weightPathPrefix,this.onProgress=e.onProgress,null!=e.fetchFunc?(E("function"==typeof e.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=e.fetchFunc):this.fetch=M().platform.fetch,E(null!=t&&t.length>0,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(t)&&E(2===t.length,function(){return"URL paths for http must have a length of 2, (actual length is "+t.length+")."}),this.path=t,null!=e.requestInit&&null!=e.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=e.requestInit||{}}return r.prototype.save=function(t){return Y(this,void 0,void 0,function(){var e,a;return $(this,function(i){switch(i.label){case 0:if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(e=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,e.body.append("model.json",new Blob([JSON.stringify({modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,userDefinedMetadata:t.userDefinedMetadata,weightsManifest:[{paths:["./model.weights.bin"],weights:t.weightSpecs}]})],{type:"application/json"}),"model.json"),null!=t.weightData&&e.body.append("model.weights.bin",new Blob([t.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,e)];case 1:if((a=i.sent()).ok)return[2,{modelArtifactsInfo:Fr(t),responses:[a]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+a.status+".")}})})},r.prototype.load=function(){return Y(this,void 0,void 0,function(){var t,e,n,o,a,i,s,u,c,l,h,f;return $(this,function(d){switch(d.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(t=d.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+t.status+". Please verify this URL points to the model JSON of the model to load.");d.label=2;case 2:return d.trys.push([2,4,,5]),[4,t.json()];case 3:return e=d.sent(),[3,5];case 4:throw d.sent(),n="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?n+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":n+=" Please make sure the server is serving valid JSON for this request.",new Error(n);case 5:if(a=e.weightsManifest,i=e.generatedBy,s=e.convertedBy,u=e.format,c=e.userDefinedMetadata,null==(o=e.modelTopology)&&null==a)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==a?[3,7]:[4,this.loadWeights(a)];case 6:f=d.sent(),l=f[0],h=f[1],d.label=7;case 7:return[2,{modelTopology:o,weightSpecs:l,weightData:h,userDefinedMetadata:c,generatedBy:i,convertedBy:s,format:u}]}})})},r.prototype.loadWeights=function(t){return Y(this,void 0,void 0,function(){var n,o,a,i,s,u,c,h,f;return $(this,function(d){switch(d.label){case 0:for(void 0,void 0,m=(p=Array.isArray(this.path)?this.path[1]:this.path).lastIndexOf("/"),v=p.lastIndexOf("?"),n=[p.substring(0,m)+"/",v>m?p.substring(v):""],o=n[0],a=n[1],i=this.weightPathPrefix||o,s=[],u=0,c=t;u<c.length;u++)s.push.apply(s,c[u].weights);return h=[],t.forEach(function(p){p.paths.forEach(function(m){h.push(i+m+a)})}),[4,fl(h,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return f=d.sent(),[2,[s,si(f)]]}var p,m,v})})},r.URL_SCHEME_REGEX=/^https?:\/\//,r}();function li(r){return null!=r.match(pl.URL_SCHEME_REGEX)}var vl=function(r,t){return typeof fetch>"u"?null:(Array.isArray(r)?r.every(function(e){return li(e)}):li(r))?hi(r,{onProgress:t}):null};function hi(r,t){return new pl(r,t)}ct.registerSaveRouter(vl),ct.registerLoadRouter(vl);var Qn,fi=function(){function r(t){this.modelArtifacts=t}return r.prototype.load=function(){return Y(this,void 0,void 0,function(){return $(this,function(t){return[2,this.modelArtifacts]})})},r}(),Mm=function(){function r(t){this.saveHandler=t}return r.prototype.save=function(t){return Y(this,void 0,void 0,function(){return $(this,function(e){return[2,this.saveHandler(t)]})})},r}(),ml=Object.freeze({browserFiles:function(r){return new Pm(r)},browserHTTPRequest:function(r,t){return hi(r,t)},concatenateArrayBuffers:si,decodeWeights:tl,encodeWeights:function(r,t){return Y(this,void 0,void 0,function(){var e,n,o,a,i,s=this;return $(this,function(u){switch(u.label){case 0:for(e=[],n=[],o=Array.isArray(r)?r.map(function(c){return c.name}):Object.keys(r),a=function(c){var l=o[c],h=Array.isArray(r)?r[c].tensor:r[l];if("float32"!==h.dtype&&"int32"!==h.dtype&&"bool"!==h.dtype&&"string"!==h.dtype)throw new Error("Unsupported dtype in weight '"+l+"': "+h.dtype);var f={name:l,shape:h.shape,dtype:h.dtype};if("string"===h.dtype){var d=new Promise(function(p){return Y(s,void 0,void 0,function(){var m,v,g,x,b,y,w;return $(this,function(C){switch(C.label){case 0:return[4,h.bytes()];case 1:for(m=C.sent(),v=m.reduce(function(S,k){return S+k.length},0)+4*m.length,g=new Uint8Array(v),x=0,b=0;b<m.length;b++)y=m[b],w=new Uint8Array(new Uint32Array([y.length]).buffer),g.set(w,x),g.set(y,x+=4),x+=y.length;return p(g),[2]}})})});n.push(d)}else n.push(h.data());null!=t&&(f.group=t),e.push(f)},i=0;i<o.length;++i)a(i);return[4,Promise.all(n)];case 1:return[2,{data:Cm(u.sent()),specs:e}]}})})},fromMemory:function(r,t,e,n){return 1===arguments.length?null!=r.modelTopology||null!=r.weightSpecs?new fi(r):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new fi({modelTopology:r})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new fi({modelTopology:r,weightSpecs:t,weightData:e,trainingConfig:n}))},getLoadHandlers:function(r,t){return ct.getLoadHandlers(r,t)},getModelArtifactsInfoForJSON:Fr,getSaveHandlers:function(r){return ct.getSaveHandlers(r)},http:hi,isHTTPScheme:li,loadWeights:function(r,t,e,n){return void 0===t&&(t=""),Y(this,void 0,void 0,function(){return $(this,function(o){return[2,dl(function(a){return fl(a,{requestInit:n})})(r,t,e)]})})},registerLoadRouter:function(r){return ct.registerLoadRouter(r)},registerSaveRouter:function(r){return ct.registerSaveRouter(r)},weightsLoaderFactory:dl,withSaveHandler:function(r){return new Mm(r)},copyModel:function(r,t){return Y(this,void 0,void 0,function(){return $(this,function(e){return[2,ol(r,t,!1)]})})},listModels:function(){return Y(this,void 0,void 0,function(){var r,t,e,n,o,a,i;return $(this,function(s){switch(s.label){case 0:r=un.getSchemes(),t={},e=0,n=r,s.label=1;case 1:return e<n.length?[4,un.getManager(o=n[e]).listModels()]:[3,4];case 2:for(i in a=s.sent())t[o+Kn+i]=a[i];s.label=3;case 3:return e++,[3,1];case 4:return[2,t]}})})},moveModel:function(r,t){return Y(this,void 0,void 0,function(){return $(this,function(e){return[2,ol(r,t,!0)]})})},removeModel:function(r){return Y(this,void 0,void 0,function(){var t;return $(this,function(e){return t=Ro(r),[2,un.getManager(t.scheme).removeModel(t.path)]})})}}),Om=A({confusionMatrix_:function(r,t,e){var n=_(r,"labels","confusionMatrix"),o=_(t,"predictions","confusionMatrix");E(null==e||e>0&&Number.isInteger(e),function(){return"If provided, numClasses must be a positive integer, but got "+e}),E(1===n.rank,function(){return"Expected the rank of labels to be 1, but got "+n.rank}),E(1===o.rank,function(){return"Expected the rank of predictions to be 1, but got "+o.rank}),E(n.shape[0]===o.shape[0],function(){return"Mismatch in the number of examples: "+n.shape[0]+" vs. "+o.shape[0]+". Labels and predictions should have the same number of elements."}),E(e>0&&Number.isInteger(e),function(){return"numClasses is required to be a positive integer, but got "+e});var a=va(n.asType("int32"),e),i=va(o.asType("int32"),e);return a.transpose().matMul(i).asType("int32")}}),Bm=(Object.freeze({confusionMatrix:Om}),A({fromPixels_:function(r,t){if(void 0===t&&(t=3),t>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==r)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var e=!1,n=!1,o=!1,a=!1,i=!1;if(r.data instanceof Uint8Array)e=!0;else if(typeof ImageData<"u"&&r instanceof ImageData)n=!0;else if(typeof HTMLVideoElement<"u"&&r instanceof HTMLVideoElement)o=!0;else if(typeof HTMLImageElement<"u"&&r instanceof HTMLImageElement)a=!0;else{if(null==r.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+r.constructor.name);i=!0}if(o&&o&&r.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=ss("FromPixels",D.backendName))return D.runKernel("FromPixels",{pixels:r},{numChannels:t});var s,u,c=o?[r.videoWidth,r.videoHeight]:[r.width,r.height],l=c[0],h=c[1];if(i?s=r.getContext("2d").getImageData(0,0,l,h).data:n||e?s=r.data:(a||o)&&(null==Qn&&(Qn=document.createElement("canvas").getContext("2d")),Qn.canvas.width=l,Qn.canvas.height=h,Qn.drawImage(r,0,0,l,h),s=Qn.getImageData(0,0,l,h).data),4===t)u=new Int32Array(s);else{var f=l*h;u=new Int32Array(f*t);for(var d=0;d<f;d++)for(var p=0;p<t;++p)u[d*t+p]=s[4*d+p]}return fa(u,[h,l,t],"int32")}})),di=Object.freeze({toPixels:function(r,t){return Y(this,void 0,void 0,function(){var e,n,o,a,i,s,u,c,l,d,p,m,v,g,x,b,y,w,C,S,k;return $(this,function(I){switch(I.label){case 0:if(e=_(r,"img","toPixels"),r instanceof _e||(e=e.toInt()),2!==e.rank&&3!==e.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+e.rank+".");if(n=e.shape.slice(0,2),o=n[0],a=n[1],(i=2===e.rank?1:e.shape[2])>4||2===i)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+i);return[4,e.data()];case 1:return s=I.sent(),u=e.min(),c=e.max(),[4,Promise.all([u.data(),c.data()])];case 2:if(l=I.sent(),d=l[0][0],p=l[1][0],u.dispose(),c.dispose(),"float32"===e.dtype){if(d<0||p>1)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+d+" - "+p+"].")}else{if("int32"!==e.dtype)throw new Error("Unsupported type for toPixels: "+e.dtype+". Please use float32 or int32 tensors.");if(d<0||p>255)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+d+" - "+p+"].")}for(m="float32"===e.dtype?255:1,v=new Uint8ClampedArray(a*o*4),g=0;g<o*a;++g)x=void 0,b=void 0,y=void 0,w=void 0,1===i?(x=s[g]*m,b=s[g]*m,y=s[g]*m,w=255):3===i?(x=s[3*g]*m,b=s[3*g+1]*m,y=s[3*g+2]*m,w=255):4===i&&(x=s[4*g]*m,b=s[4*g+1]*m,y=s[4*g+2]*m,w=s[4*g+3]*m),v[0+(C=4*g)]=Math.round(x),v[C+1]=Math.round(b),v[C+2]=Math.round(y),v[C+3]=Math.round(w);return null!=t&&(t.width=a,t.height=o,S=t.getContext("2d"),k=new ImageData(v,a,o),S.putImageData(k,0,0)),e!==r&&e.dispose(),[2,v]}})})},fromPixels:Bm}),gl=function(){function r(){}return r.prototype.getClassName=function(){return this.constructor.className},r.fromConfig=function(t,e){return new t(e)},r}(),yl=function(){function r(){this.classNameMap={}}return r.getMap=function(){return null==r.instance&&(r.instance=new r),r.instance},r.register=function(t){r.getMap().classNameMap[t.className]=[t,t.fromConfig]},r}();function ln(r){E(null!=r.className,function(){return"Class being registered does not have the static className property defined."}),E("string"==typeof r.className,function(){return"className is required to be a string, but got type "+typeof r.className}),E(r.className.length>0,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),yl.register(r)}function pi(){return 32===D.backend.floatPrecision()?.001:.1}function vi(r,t,e){var n=!0;if((He(r)||He(t))&&(n=!1),He(r)&&He(t)&&(n=!0),n){var o=r.constructor.name,a=t.constructor.name;if(o!==a)throw new Error("Arrays are of different type. Actual: "+o+". Expected: "+a)}if(Array.isArray(r)&&Array.isArray(t)){var i=kt(r),s=kt(t);if(!Ne(i,s))throw new Error("Arrays have different shapes. Actual: ["+i+"]. Expected: ["+s+"]")}var u=He(r)?r:Wt(r),c=He(t)?t:Wt(t);if(u.length!==c.length)throw new Error("Arrays have different lengths actual: "+u.length+" vs expected: "+c.length+".\nActual:   "+u+".\nExpected: "+c+".");for(var l=0;l<c.length;++l){var h=u[l],f=c[l];if(!e(h,f))throw new Error("Arrays differ: actual["+l+"] = "+h+", expected["+l+"] = "+f+".\nActual:   "+u+".\nExpected: "+c+".")}}function mi(r,t,e){return!isFinite(r)&&!isFinite(t)||!(isNaN(r)||isNaN(t)||Math.abs(r-t)>e)}Object.freeze({Serializable:gl,SerializationMap:yl,registerClass:ln}),Object.freeze({TEST_EPSILON_FLOAT16:.1,expectArraysClose:function(r,t,e){return null==e&&(e=pi()),vi(r,t,function(n,o){return mi(n,o,e)})},testEpsilon:pi,expectPromiseToFail:function(r,t){r().then(function(){return t.fail()},function(){return t()})},expectArraysEqual:function(r,t){var e="string"==typeof t||"number"==typeof t||"boolean"==typeof t?[t]:t;return tn(r)||tn(r[0])||tn(t)||tn(t[0])?vi(r,e,function(n,o){return n==o}):vi(r,t,function(n,o){return mi(n,o,0)})},expectNumbersClose:function(r,t,e){if(null==e&&(e=pi()),!mi(r,t,e))throw new Error("Numbers differ: actual === "+r+", expected === "+t)},expectValuesInRange:function(r,t,e){for(var n=0;n<r.length;n++)if(r[n]<t||r[n]>e)throw new Error("Value out of range:"+r[n]+" low: "+t+", high: "+e)},expectArrayBuffersEqual:function(r,t){expect(new Float32Array(r)).toEqual(new Float32Array(t))}}),Object.freeze({gpgpu_util:sd,webgl_util:Ah,forceHalfFloat:function(){M().set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:mc,setWebGLContext:Ds,GPGPUContext:Zu});var Sn=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return mt(t,r),t.prototype.minimize=function(e,n,o){void 0===n&&(n=!1);var a=this.computeGradients(e,o),i=a.value,s=a.grads;if(null!=o){var u=o.map(function(c){return{name:c.name,tensor:s[c.name]}});this.applyGradients(u)}else this.applyGradients(s);return tt(s),n?i:(i.dispose(),null)},Object.defineProperty(t.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),t.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},t.prototype.computeGradients=function(e,n){return function hf(r,t){E(nn(r),function(){return"The f passed in variableGrads(f) must be a function"}),E(null==t||Array.isArray(t)&&t.every(function(l){return l instanceof Bn}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var e=null!=t;if(!e)for(var n in t=[],D.registeredVariables)t.push(D.registeredVariables[n]);var o=e?t.filter(function(l){return!l.trainable}):null,a=t.length;E((t=t.filter(function(l){return l.trainable})).length>0,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+a+" variables is trainable."});var i=D.gradients(r,t,null,!0),s=i.value,u=i.grads;E(u.some(function(l){return null!=l}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),E(0===s.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+s.rank+" tensor"});var c={};return t.forEach(function(l,h){null!=u[h]&&(c[l.name]=u[h])}),o?.forEach(function(l){return c[l.name]=null}),{value:s,grads:c}}(e,n)},t.prototype.dispose=function(){null!=this.iterations_&&tt(this.iterations_)},t.prototype.saveIterations=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:j(this.iterations_,"int32")}]})})},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},t.prototype.extractIterations=function(e){return Y(this,void 0,void 0,function(){var n;return $(this,function(o){switch(o.label){case 0:return n=this,[4,e[0].tensor.data()];case 1:return n.iterations_=o.sent()[0],[2,e.slice(1)]}})})},t}(gl);Object.defineProperty(Sn,Symbol.hasInstance,{value:function(r){return null!=r.minimize&&null!=r.computeGradients&&null!=r.applyGradients}});var bl=function(r){function t(e,n,o){void 0===o&&(o=null);var a=r.call(this)||this;return a.learningRate=e,a.rho=n,a.epsilon=o,a.accumulatedGrads=[],a.accumulatedUpdates=[],null==o&&(a.epsilon=D.backend.epsilon()),a}return mt(t,r),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=D.registeredVariables[o];null==n.accumulatedGrads[a]&&(n.accumulatedGrads[a]={originalName:o+"/accum_grad",variable:K(function(){return ve(i).variable(!1)})}),null==n.accumulatedUpdates[a]&&(n.accumulatedUpdates[a]={originalName:o+"/accum_var",variable:K(function(){return ve(i).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=n.accumulatedGrads[a].variable,c=n.accumulatedUpdates[a].variable;K(function(){var l=u.mul(n.rho).add(s.square().mul(1-n.rho)),h=c.add(n.epsilon).sqrt().div(u.add(n.epsilon).sqrt()).mul(s),f=c.mul(n.rho).add(h.square().mul(1-n.rho));u.assign(l),c.assign(f);var d=h.mul(-n.learningRate).add(i);i.assign(d)})}}),this.incrementIterations()},t.prototype.dispose=function(){null!=this.accumulatedUpdates&&(tt(this.accumulatedGrads.map(function(e){return e.variable})),tt(this.accumulatedUpdates.map(function(e){return e.variable})))},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){var e;return $(this,function(n){switch(n.label){case 0:return e=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){var n;return $(this,function(o){switch(o.label){case 0:return[4,this.extractIterations(e)];case 1:return e=o.sent(),this.accumulatedGrads=e.slice(0,n=e.length/2).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedUpdates=e.slice(n,2*n).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},t.fromConfig=function(e,n){return new e(n.learningRate,n.rho,n.epsilon)},t.className="Adadelta",t}(Sn);ln(bl);var wl=function(r){function t(e,n){void 0===n&&(n=.1);var o=r.call(this)||this;return o.learningRate=e,o.initialAccumulatorValue=n,o.accumulatedGrads=[],o}return mt(t,r),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=D.registeredVariables[o];null==n.accumulatedGrads[a]&&(n.accumulatedGrads[a]={originalName:o+"/accumulator",variable:K(function(){return Dt(i.shape,n.initialAccumulatorValue).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=n.accumulatedGrads[a].variable;K(function(){var c=u.add(s.square());u.assign(c);var l=s.div(c.add(D.backend.epsilon()).sqrt()).mul(-n.learningRate).add(i);i.assign(l)})}}),this.incrementIterations()},t.prototype.dispose=function(){null!=this.accumulatedGrads&&tt(this.accumulatedGrads.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulatedGrads.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulatedGrads=e.map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},t.fromConfig=function(e,n){return new e(n.learningRate,n.initialAccumulatorValue)},t.className="Adagrad",t}(Sn);ln(wl);var _l=function(r){function t(e,n,o,a){void 0===a&&(a=null);var i=r.call(this)||this;return i.learningRate=e,i.beta1=n,i.beta2=o,i.epsilon=a,i.accumulatedFirstMoment=[],i.accumulatedSecondMoment=[],K(function(){i.accBeta1=j(n).variable(),i.accBeta2=j(o).variable()}),null==a&&(i.epsilon=D.backend.epsilon()),i}return mt(t,r),t.prototype.applyGradients=function(e){var n=this,o=Array.isArray(e)?e.map(function(a){return a.name}):Object.keys(e);K(function(){var a=We(1,n.accBeta1),i=We(1,n.accBeta2);o.forEach(function(s,u){var c=D.registeredVariables[s];null==n.accumulatedFirstMoment[u]&&(n.accumulatedFirstMoment[u]={originalName:s+"/m",variable:K(function(){return ve(c).variable(!1)})}),null==n.accumulatedSecondMoment[u]&&(n.accumulatedSecondMoment[u]={originalName:s+"/v",variable:K(function(){return ve(c).variable(!1)})});var l=Array.isArray(e)?e[u].tensor:e[s];if(null!=l){var h=n.accumulatedFirstMoment[u].variable,f=n.accumulatedSecondMoment[u].variable,d=h.mul(n.beta1).add(l.mul(1-n.beta1)),p=f.mul(n.beta2).add(l.square().mul(1-n.beta2)),m=d.div(a),v=p.div(i);h.assign(d),f.assign(p);var g=m.div(v.sqrt().add(n.epsilon)).mul(-n.learningRate).add(c);c.assign(g)}}),n.accBeta1.assign(n.accBeta1.mul(n.beta1)),n.accBeta2.assign(n.accBeta2.mul(n.beta2))}),this.incrementIterations()},t.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&tt(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedSecondMoment&&tt(this.accumulatedSecondMoment.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){var e;return $(this,function(n){switch(n.label){case 0:return e=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){var n,o=this;return $(this,function(a){switch(a.label){case 0:return[4,this.extractIterations(e)];case 1:return e=a.sent(),K(function(){o.accBeta1.assign(xo(o.beta1,o.iterations_+1)),o.accBeta2.assign(xo(o.beta2,o.iterations_+1))}),this.accumulatedFirstMoment=e.slice(0,n=e.length/2).map(function(i){return{originalName:i.name,variable:i.tensor.variable(!1)}}),this.accumulatedSecondMoment=e.slice(n,2*n).map(function(i){return{originalName:i.name,variable:i.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},t.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon)},t.className="Adam",t}(Sn);ln(_l);var Cl=function(r){function t(e,n,o,a,i){void 0===a&&(a=null),void 0===i&&(i=0);var s=r.call(this)||this;return s.learningRate=e,s.beta1=n,s.beta2=o,s.epsilon=a,s.decay=i,s.accumulatedFirstMoment=[],s.accumulatedWeightedInfNorm=[],K(function(){s.iteration=j(0).variable(),s.accBeta1=j(n).variable()}),null==a&&(s.epsilon=D.backend.epsilon()),s}return mt(t,r),t.prototype.applyGradients=function(e){var n=this,o=Array.isArray(e)?e.map(function(a){return a.name}):Object.keys(e);K(function(){var a=We(1,n.accBeta1),i=Ct(-n.learningRate,n.iteration.mul(n.decay).add(1));o.forEach(function(s,u){var c=D.registeredVariables[s];null==n.accumulatedFirstMoment[u]&&(n.accumulatedFirstMoment[u]={originalName:s+"/m",variable:ve(c).variable(!1)}),null==n.accumulatedWeightedInfNorm[u]&&(n.accumulatedWeightedInfNorm[u]={originalName:s+"/v",variable:ve(c).variable(!1)});var l=Array.isArray(e)?e[u].tensor:e[s];if(null!=l){var h=n.accumulatedFirstMoment[u].variable,f=n.accumulatedWeightedInfNorm[u].variable,d=h.mul(n.beta1).add(l.mul(1-n.beta1)),p=f.mul(n.beta2),m=l.abs(),v=p.maximum(m);h.assign(d),f.assign(v);var g=i.div(a).mul(d.div(v.add(n.epsilon))).add(c);c.assign(g)}}),n.iteration.assign(n.iteration.add(1)),n.accBeta1.assign(n.accBeta1.mul(n.beta1))}),this.incrementIterations()},t.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&tt(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedWeightedInfNorm&&tt(this.accumulatedWeightedInfNorm.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){throw new Error("getWeights() is not implemented for Adamax yet.")})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){throw new Error("setWeights() is not implemented for Adamax yet.")})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},t.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon,n.decay)},t.className="Adamax",t}(Sn);ln(Cl);var gi=function(r){function t(e){var n=r.call(this)||this;return n.learningRate=e,n.setLearningRate(e),n}return mt(t,r),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=Array.isArray(e)?e[a].tensor:e[o];if(null!=i){var s=D.registeredVariables[o];K(function(){var u=n.c.mul(i).add(s);s.assign(u)})}}),this.incrementIterations()},t.prototype.setLearningRate=function(e){this.learningRate=e,null!=this.c&&this.c.dispose(),this.c=function Th(r){return D.keep(r)}(j(-e))},t.prototype.dispose=function(){this.c.dispose()},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()]]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:if(0!==(e=n.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate}},t.fromConfig=function(e,n){return new e(n.learningRate)},t.className="SGD",t}(Sn);ln(gi);var El=function(r){function t(e,n,o){void 0===o&&(o=!1);var a=r.call(this,e)||this;return a.learningRate=e,a.momentum=n,a.useNesterov=o,a.accumulations=[],a.m=j(a.momentum),a}return mt(t,r),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=D.registeredVariables[o];null==n.accumulations[a]&&(n.accumulations[a]={originalName:o+"/momentum",variable:K(function(){return ve(i).variable(!1)})});var s=n.accumulations[a].variable,u=Array.isArray(e)?e[a].tensor:e[o];null!=u&&K(function(){var c,l=n.m.mul(s).add(u);c=n.useNesterov?n.c.mul(u.add(l.mul(n.m))).add(i):n.c.mul(l).add(i),s.assign(l),i.assign(c)})}),this.incrementIterations()},t.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&tt(this.accumulations.map(function(e){return e.variable}))},t.prototype.setMomentum=function(e){this.momentum=e},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){return $(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulations.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){return $(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulations=e.map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},t.fromConfig=function(e,n){return new e(n.learningRate,n.momentum,n.useNesterov)},t.className="Momentum",t}(gi);ln(El);var Il=function(r){function t(e,n,o,a,i){void 0===n&&(n=.9),void 0===o&&(o=0),void 0===a&&(a=null),void 0===i&&(i=!1);var s=r.call(this)||this;if(s.learningRate=e,s.decay=n,s.momentum=o,s.epsilon=a,s.accumulatedMeanSquares=[],s.accumulatedMoments=[],s.accumulatedMeanGrads=[],s.centered=i,null==a&&(s.epsilon=D.backend.epsilon()),null==e)throw new Error("learningRate for RMSPropOptimizer must be defined.");return s}return mt(t,r),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e)).forEach(function(o,a){var i=D.registeredVariables[o];null==n.accumulatedMeanSquares[a]&&(n.accumulatedMeanSquares[a]={originalName:o+"/rms",variable:K(function(){return ve(i).variable(!1)})}),null==n.accumulatedMoments[a]&&(n.accumulatedMoments[a]={originalName:o+"/momentum",variable:K(function(){return ve(i).variable(!1)})}),null==n.accumulatedMeanGrads[a]&&n.centered&&(n.accumulatedMeanGrads[a]={originalName:o+"/mg",variable:K(function(){return ve(i).variable(!1)})});var s=Array.isArray(e)?e[a].tensor:e[o];if(null!=s){var u=n.accumulatedMeanSquares[a].variable,c=n.accumulatedMoments[a].variable;K(function(){var l=u.mul(n.decay).add(s.square().mul(1-n.decay));if(n.centered){var h=n.accumulatedMeanGrads[a].variable,f=h.mul(n.decay).add(s.mul(1-n.decay)),d=c.mul(n.momentum).add(s.mul(n.learningRate).div(l.sub(f.square().add(n.epsilon)).sqrt()));u.assign(l),h.assign(f),c.assign(d);var p=i.sub(d);i.assign(p)}else{var m=u.mul(n.decay).add(s.square().mul(1-n.decay));d=c.mul(n.momentum).add(s.mul(n.learningRate).div(m.add(n.epsilon).sqrt())),u.assign(m),c.assign(d),p=i.sub(d),i.assign(p)}})}}),this.incrementIterations()},t.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&tt(this.accumulatedMeanSquares.map(function(e){return e.variable})),null!=this.accumulatedMeanGrads&&this.centered&&tt(this.accumulatedMeanGrads.map(function(e){return e.variable})),null!=this.accumulatedMoments&&tt(this.accumulatedMoments.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return Y(this,void 0,void 0,function(){var e;return $(this,function(n){switch(n.label){case 0:return e=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&e.push.apply(e,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(o){return{name:o.originalName,tensor:o.variable}}))]}})})},t.prototype.setWeights=function(e){return Y(this,void 0,void 0,function(){var n;return $(this,function(o){switch(o.label){case 0:return[4,this.extractIterations(e)];case 1:return e=o.sent(),this.accumulatedMeanSquares=e.slice(0,n=this.centered?e.length/3:e.length/2).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedMoments=e.slice(n,2*n).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=e.slice(2*n,3*n).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}})),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},t.fromConfig=function(e,n){return new e(n.learningRate,n.decay,n.momentum,n.epsilon,n.centered)},t.className="RMSProp",t}(Sn);ln(Il),function(){function r(){}r.sgd=function(t){return new gi(t)},r.momentum=function(t,e,n){return void 0===n&&(n=!1),new El(t,e,n)},r.rmsprop=function(t,e,n,o,a){return void 0===e&&(e=.9),void 0===n&&(n=0),void 0===o&&(o=null),void 0===a&&(a=!1),new Il(t,e,n,o,a)},r.adam=function(t,e,n,o){return void 0===t&&(t=.001),void 0===e&&(e=.9),void 0===n&&(n=.999),void 0===o&&(o=null),new _l(t,e,n,o)},r.adadelta=function(t,e,n){return void 0===t&&(t=.001),void 0===e&&(e=.95),void 0===n&&(n=null),new bl(t,e,n)},r.adamax=function(t,e,n,o,a){return void 0===t&&(t=.002),void 0===e&&(e=.9),void 0===n&&(n=.999),void 0===o&&(o=null),void 0===a&&(a=0),new Cl(t,e,n,o,a)},r.adagrad=function(t,e){return void 0===e&&(e=.1),new wl(t,e)}}(),typeof requestAnimationFrame<"u"?requestAnimationFrame:typeof setImmediate<"u"&&setImmediate,_e.prototype.squaredDifference=function(r){return gc(this,r)},P=mm;var yi=function(r,t){return(yi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var o in n)n.hasOwnProperty(o)&&(e[o]=n[o])})(r,t)};function oe(r,t){function e(){this.constructor=r}yi(r,t),r.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}var Qe=function(){return Qe=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},Qe.apply(this,arguments)};function J(r,t,e,n){return new(e||(e=Promise))(function(a,i){function s(l){try{c(n.next(l))}catch(h){i(h)}}function u(l){try{c(n.throw(l))}catch(h){i(h)}}function c(l){l.done?a(l.value):function o(a){return a instanceof e?a:new e(function(i){i(a)})}(l.value).then(s,u)}c((n=n.apply(r,t||[])).next())})}function Z(r,t){var n,o,a,i,e={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(c){return function(l){return function u(c){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,o&&(a=2&c[0]?o.return:c[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,c[1])).done)return a;switch(o=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,o=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(!(a=(a=e.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){e=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){e.label=c[1];break}if(6===c[0]&&e.label<a[1]){e.label=a[1],a=c;break}if(a&&e.label<a[2]){e.label=a[2],e.ops.push(c);break}a[2]&&e.ops.pop(),e.trys.pop();continue}c=t.call(r,e)}catch(l){c=[6,l],o=0}finally{n=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}function Nr(){for(var r=0,t=0,e=arguments.length;t<e;t++)r+=arguments[t].length;var n=Array(r),o=0;for(t=0;t<e;t++)for(var a=arguments[t],i=0,s=a.length;i<s;i++,o++)n[o]=a[i];return n}var Jn=function(){function r(t,e){if(!An(t)||!An(e))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:t,height:e}));this._width=t,this._height=e}return Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),r.prototype.reverse=function(){return new r(1/this.width,1/this.height)},r}();function Pr(r,t){return r instanceof _e&&r.shape.length===t}function So(r){return Pr(r,3)}function hn(r){return Pr(r,4)}function kl(r){return r%2==0}function Sl(r){return r&&r.width&&r.height}function xi(r){return r.reduce(function(t,e){return t.add(e)},new xe(0,0)).div(new xe(r.length,r.length))}function Mr(r,t,e){return Array(r).fill(0).map(function(n,o){return t+o*e})}function An(r){return!!r&&r!==1/0&&r!==-1/0&&!isNaN(r)||0===r}function Dl(r){return An(r)&&0<=r&&r<=1}var xe=function(){function r(t,e){this._x=t,this._y=e}return Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),r.prototype.add=function(t){return new r(this.x+t.x,this.y+t.y)},r.prototype.sub=function(t){return new r(this.x-t.x,this.y-t.y)},r.prototype.mul=function(t){return new r(this.x*t.x,this.y*t.y)},r.prototype.div=function(t){return new r(this.x/t.x,this.y/t.y)},r.prototype.abs=function(){return new r(Math.abs(this.x),Math.abs(this.y))},r.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},r.prototype.floor=function(){return new r(Math.floor(this.x),Math.floor(this.y))},r}(),Kt=function(){function r(t,e){void 0===e&&(e=!0);var n=t||{},o=[n.left,n.top,n.right,n.bottom].every(An),a=[n.x,n.y,n.width,n.height].every(An);if(!a&&!o)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(n));var i=a?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top],s=i[0],u=i[1],c=i[2],l=i[3];r.assertIsValidBox({x:s,y:u,width:c,height:l},"Box.constructor",e),this._x=s,this._y=u,this._width=c,this._height=l}return r.isRect=function(t){return!!t&&[t.x,t.y,t.width,t.height].every(An)},r.assertIsValidBox=function(t,e,n){if(void 0===n&&(n=!1),!r.isRect(t))throw new Error(e+" - invalid box: "+JSON.stringify(t)+", expected object with properties x, y, width, height");if(!n&&(t.width<0||t.height<0))throw new Error(e+" - width ("+t.width+") and height ("+t.height+") must be positive numbers")},Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topLeft",{get:function(){return new xe(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topRight",{get:function(){return new xe(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomLeft",{get:function(){return new xe(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomRight",{get:function(){return new xe(this.right,this.bottom)},enumerable:!0,configurable:!0}),r.prototype.round=function(){var t=[this.x,this.y,this.width,this.height].map(function(i){return Math.round(i)});return new r({x:t[0],y:t[1],width:t[2],height:t[3]})},r.prototype.floor=function(){var t=[this.x,this.y,this.width,this.height].map(function(i){return Math.floor(i)});return new r({x:t[0],y:t[1],width:t[2],height:t[3]})},r.prototype.toSquare=function(){var t=this,e=t.x,n=t.y,o=t.width,a=t.height,i=Math.abs(o-a);return o<a&&(e-=i/2,o+=i),a<o&&(n-=i/2,a+=i),new r({x:e,y:n,width:o,height:a})},r.prototype.rescale=function(t){var e=Sl(t)?t.width:t,n=Sl(t)?t.height:t;return new r({x:this.x*e,y:this.y*n,width:this.width*e,height:this.height*n})},r.prototype.pad=function(t,e){var n=[this.x-t/2,this.y-e/2,this.width+t,this.height+e];return new r({x:n[0],y:n[1],width:n[2],height:n[3]})},r.prototype.clipAtImageBorders=function(t,e){var n=this,a=n.y,i=n.right,s=n.bottom,u=Math.max(n.x,0),c=Math.max(a,0),h=s-c;return new r({x:u,y:c,width:Math.min(i-u,t-u),height:Math.min(h,e-c)}).floor()},r.prototype.shift=function(t,e){return new r({x:this.x+t,y:this.y+e,width:this.width,height:this.height})},r.prototype.padAtBorders=function(t,e){var n=this.width+1,o=this.height+1,s=n,u=o,c=this.left,l=this.top,h=this.right,f=this.bottom;return h>e&&(s=-h+e+n,h=e),f>t&&(u=-f+t+o,f=t),c<1&&(u=2-c,c=1),l<1&&(u=2-l,l=1),{dy:1,edy:u,dx:1,edx:s,y:l,ey:f,x:c,ex:h,w:n,h:o}},r.prototype.calibrate=function(t){return new r({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()},r}(),Do=function(r){function t(e,n,o,a,i){return void 0===i&&(i=!1),r.call(this,{left:e,top:n,right:o,bottom:a},i)||this}return oe(t,r),t}(Kt),Al=function(){function r(t,e,n,o,a){this._imageDims=new Jn(a.width,a.height),this._score=t,this._classScore=e,this._className=n,this._box=new Kt(o).rescale(this._imageDims)}return Object.defineProperty(r.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativeBox",{get:function(){return new Kt(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),r.prototype.forSize=function(t,e){return new r(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:e})},r}(),Tt=function(r){function t(e,n,o){return r.call(this,e,e,"",n,o)||this}return oe(t,r),t.prototype.forSize=function(e,n){var o=r.prototype.forSize.call(this,e,n);return new t(o.score,o.relativeBox,o.imageDims)},t}(Al);function qm(r,t,e){void 0===e&&(e=!0);var a=Math.max(0,Math.min(r.right,t.right)-Math.max(r.left,t.left))*Math.max(0,Math.min(r.bottom,t.bottom)-Math.max(r.top,t.top));return e?a/(r.area+t.area-a):a/Math.min(r.area,t.area)}function Or(r,t,e,n){void 0===n&&(n=!0);for(var o=t.map(function(s,u){return{score:s,boxIndex:u}}).sort(function(s,u){return s.score-u.score}).map(function(s){return s.boxIndex}),a=[],i=function(){var s=o.pop();a.push(s);for(var u=o,c=[],l=0;l<u.length;l++)c.push(qm(r[s],r[u[l]],n));o=o.filter(function(p,m){return c[m]<=e})};o.length>0;)i();return a}function Br(r,t){return K(function(){var e=t[0],n=t[1],o=t[2],a=Dt(Nr(r.shape.slice(0,3),[1]),e),i=Dt(Nr(r.shape.slice(0,3),[1]),n),s=Dt(Nr(r.shape.slice(0,3),[1]),o),u=Be([a,i,s],3);return We(r,u)})}function bi(r){return 1/(1+Math.exp(-r))}var ze,wi=function(r){function t(e,n,o,a,i){return void 0===i&&(i=!1),r.call(this,{x:e,y:n,width:o,height:a},i)||this}return oe(t,r),t}(Kt),Ao=function(){function r(t,e,n){void 0===n&&(n=new xe(0,0));var o=e.width,a=e.height;this._imgDims=new Jn(o,a),this._shift=n,this._positions=t.map(function(i){return i.mul(new xe(o,a)).add(n)})}return Object.defineProperty(r.prototype,"shift",{get:function(){return new xe(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativePositions",{get:function(){var t=this;return this._positions.map(function(e){return e.sub(t._shift).div(new xe(t.imageWidth,t.imageHeight))})},enumerable:!0,configurable:!0}),r.prototype.forSize=function(t,e){return new this.constructor(this.relativePositions,{width:t,height:e})},r.prototype.shiftBy=function(t,e){return new this.constructor(this.relativePositions,this._imgDims,new xe(t,e))},r.prototype.shiftByPoint=function(t){return this.shiftBy(t.x,t.y)},r.prototype.align=function(t,e){if(void 0===e&&(e={}),t){var n=t instanceof Tt?t.box.floor():new Kt(t);return this.shiftBy(n.x,n.y).align(null,e)}var o=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},e),i=o.minBoxPadding;return o.useDlibAlignment?this.alignDlib():this.alignMinBbox(i)},r.prototype.alignDlib=function(){var t=this.getRefPointsForAlignment(),n=t[1],o=t[2],a=function(h){return o.sub(h).magnitude()},i=(a(t[0])+a(n))/2,s=Math.floor(i/.45),u=xi(t),c=Math.floor(Math.max(0,u.x-.5*s)),l=Math.floor(Math.max(0,u.y-.43*s));return new wi(c,l,Math.min(s,this.imageWidth+c),Math.min(s,this.imageHeight+l))},r.prototype.alignMinBbox=function(t){var e=function jm(r){var t=r.map(function(s){return s.x}),e=r.map(function(s){return s.y}),n=t.reduce(function(s,u){return u<s?u:s},1/0),o=e.reduce(function(s,u){return u<s?u:s},1/0),a=t.reduce(function(s,u){return s<u?u:s},0),i=e.reduce(function(s,u){return s<u?u:s},0);return new Do(n,o,a,i)}(this.positions);return e.pad(e.width*t,e.height*t)},r.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},r}(),Qm=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],xi([e[3],e[4]])]},t}(Ao),Tl=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.getJawOutline=function(){return this.positions.slice(0,17)},t.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},t.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},t.prototype.getNose=function(){return this.positions.slice(27,36)},t.prototype.getLeftEye=function(){return this.positions.slice(36,42)},t.prototype.getRightEye=function(){return this.positions.slice(42,48)},t.prototype.getMouth=function(){return this.positions.slice(48,68)},t.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(xi)},t}(Ao),Fl=function(){function r(t,e){this._label=t,this._distance=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),r.prototype.toString=function(t){return void 0===t&&(t=!0),this.label+(t?" ("+function Gm(r,t){void 0===t&&(t=2);var e=Math.pow(10,t);return Math.floor(r*e)/e}(this.distance)+")":"")},r}(),Nl=function(r){function t(e,n){var o=r.call(this,e)||this;return o._label=n,o}return oe(t,r),t.assertIsValidLabeledBox=function(e,n){if(Kt.assertIsValidBox(e,n),!An(e.label))throw new Error(n+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),t}(Kt),To=function(){function r(t,e){if("string"!=typeof t)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(function(n){return!(n instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=t,this._descriptors=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),r.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(t){return Array.from(t)})}},r.fromJSON=function(t){var e=t.descriptors.map(function(n){return new Float32Array(n)});return new r(t.label,e)},r}();function _i(r,t){return Object.assign({},r,{detection:t})}function Pl(){var r=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:r,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function Ml(r){var t="";if(!r)try{r=vt(Object(function(){var o=new Error("Cannot find module 'fs'");throw o.code="MODULE_NOT_FOUND",o}()))}catch(n){t=n.toString()}return{readFile:r?function(n){return new Promise(function(o,a){r.readFile(n,function(i,s){return i?a(i):o(s)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+t)}}}function Ol(){var r=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,o=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},a=Ml();return Qe({Canvas:r||function(){return function i(){}}(),CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){return function i(){}}(),Image:t||function(){return function i(){}}(),ImageData:global.ImageData||function(){return function i(){}}(),Video:global.HTMLVideoElement||function(){return function i(){}}(),createCanvasElement:function(){if(r)return new r;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:o},a)}function Bl(){return"object"==typeof window&&typeof document<"u"&&typeof HTMLImageElement<"u"&&typeof HTMLCanvasElement<"u"&&typeof HTMLVideoElement<"u"&&typeof ImageData<"u"&&typeof CanvasRenderingContext2D<"u"}function Ll(){return"object"==typeof global&&typeof process<"u"&&!!process.version}function Ci(r){ze=r}function Ei(){Bl()&&Ci(Pl()),Ll()&&Ci(Ol())}!function(r){function t(e,n,o,a){var i=r.call(this,e,n)||this;return i._score=o,i._classScore=a,i}oe(t,r),t.assertIsValidPredictedBox=function(e,n){if(Nl.assertIsValidLabeledBox(e,n),!Dl(e.score)||!Dl(e.classScore))throw new Error(n+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(t.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0})}(Nl);var Je={getEnv:function Zm(){if(!ze)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return ze},setEnv:Ci,initialize:Ei,createBrowserEnv:Pl,createFileSystem:Ml,createNodejsEnv:Ol,monkeyPatch:function eg(r){if(ze||Ei(),!ze)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var t=r.Canvas,e=void 0===t?ze.Canvas:t,n=r.Image,o=void 0===n?ze.Image:n;ze.Canvas=e,ze.Image=o,ze.createCanvasElement=r.createCanvasElement||function(){return new e},ze.createImageElement=r.createImageElement||function(){return new o},ze.ImageData=r.ImageData||ze.ImageData,ze.Video=r.Video||ze.Video,ze.fetch=r.fetch||ze.fetch,ze.readFile=r.readFile||ze.readFile},isBrowser:Bl,isNodejs:Ll};function Ii(r){return Je.isNodejs()||"string"!=typeof r?r:document.getElementById(r)}function Ft(r){var t=Je.getEnv(),e=t.Canvas;if(r instanceof t.CanvasRenderingContext2D)return r;var o=Ii(r);if(!(o instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var a=o.getContext("2d");if(!a)throw new Error("resolveContext2d - canvas 2d context is null");return a}Ei();var Tn=function(r){return r.TOP_LEFT="TOP_LEFT",r.TOP_RIGHT="TOP_RIGHT",r.BOTTOM_LEFT="BOTTOM_LEFT",r.BOTTOM_RIGHT="BOTTOM_RIGHT",r}(Tn||{}),Wl=function(){return function r(t){void 0===t&&(t={});var n=t.backgroundColor,o=t.fontColor,a=t.fontSize,i=t.fontStyle,s=t.padding;this.anchorPosition=t.anchorPosition||Tn.TOP_LEFT,this.backgroundColor=n||"rgba(0, 0, 0, 0.5)",this.fontColor=o||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=i||"Georgia",this.padding=s||4}}();!function(){function r(t,e,n){void 0===n&&(n={}),this.text="string"==typeof t?[t]:t instanceof r?t.text:t,this.anchor=e,this.options=new Wl(n)}r.prototype.measureWidth=function(t){var e=this.options.padding;return this.text.map(function(n){return t.measureText(n).width}).reduce(function(n,o){return n<o?o:n},0)+2*e},r.prototype.measureHeight=function(){var t=this.options;return this.text.length*t.fontSize+2*t.padding},r.prototype.getUpperLeft=function(t,e){var n=this.options.anchorPosition,o=n===Tn.BOTTOM_RIGHT||n===Tn.TOP_RIGHT,a=n===Tn.BOTTOM_LEFT||n===Tn.BOTTOM_RIGHT,i=this.measureWidth(t),s=this.measureHeight(),u=o?this.anchor.x-i:this.anchor.x,c=a?this.anchor.y-s:this.anchor.y;if(e){var h=e.height;return{x:Math.max(Math.min(u,e.width-i),0),y:Math.max(Math.min(c,h-s),0)}}return{x:u,y:c}},r.prototype.draw=function(t){var e=Ii(t),n=Ft(e),o=this.options,a=o.backgroundColor,i=o.fontColor,s=o.fontSize,c=o.padding;n.font=s+"px "+o.fontStyle;var l=this.measureWidth(n),h=this.measureHeight();n.fillStyle=a;var f=this.getUpperLeft(n,e);n.fillRect(f.x,f.y,l,h),n.fillStyle=i,this.text.forEach(function(d,p){n.fillText(d,c+f.x,c+f.y+(p+1)*s)})}}();function zl(r){var t=Je.getEnv();return r instanceof t.Image&&r.complete||r instanceof t.Video&&r.readyState>=3}function Vl(r){var t=Je.getEnv(),n=t.Video;return r instanceof t.Image?new Jn(r.naturalWidth,r.naturalHeight):r instanceof n?new Jn(r.videoWidth,r.videoHeight):new Jn(r.width,r.height)}function Fo(r){var t=r.width,e=r.height,o=(0,Je.getEnv().createCanvasElement)();return o.width=t,o.height=e,o}function Ri(r,t){var e=Je.getEnv().ImageData;if(!(r instanceof e||zl(r)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var n=t||Vl(r),o=n.width,a=n.height,i=Fo({width:o,height:a});return r instanceof e?Ft(i).putImageData(r,0,0):Ft(i).drawImage(r,0,0,o,a),i}function og(r,t){return J(this,void 0,void 0,function(){var e,n,o,a,i,s;return Z(this,function(u){switch(u.label){case 0:return e=t||Je.getEnv().createCanvasElement(),n=r.shape.slice(hn(r)?1:0),o=n[0],a=n[1],i=n[2],s=K(function(){return r.as3D(o,a,i).toInt()}),[4,di.toPixels(s,e)];case 1:return u.sent(),s.dispose(),[2,e]}})})}function Ul(r){var t=Je.getEnv();return r instanceof t.Image||r instanceof t.Canvas||r instanceof t.Video}var No=function(){function r(t,e){var n=this;if(void 0===e&&(e=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(t))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+t);this._treatAsBatchInput=e,this._batchSize=t.length,t.forEach(function(o,a){if(So(o))return n._imageTensors[a]=o,void(n._inputDimensions[a]=o.shape);if(hn(o)){var i=o.shape[0];if(1!==i)throw new Error("NetInput - tf.Tensor4D with batchSize "+i+" passed, but not supported in input array");return n._imageTensors[a]=o,void(n._inputDimensions[a]=o.shape.slice(1))}var s=o instanceof Je.getEnv().Canvas?o:Ri(o);n._canvases[a]=s,n._inputDimensions[a]=[s.height,s.width,3]})}return Object.defineProperty(r.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"reshapedInputDimensions",{get:function(){var t=this;return Mr(this.batchSize,0,1).map(function(e,n){return t.getReshapedInputDimensions(n)})},enumerable:!0,configurable:!0}),r.prototype.getInput=function(t){return this.canvases[t]||this.imageTensors[t]},r.prototype.getInputDimensions=function(t){return this._inputDimensions[t]},r.prototype.getInputHeight=function(t){return this._inputDimensions[t][0]},r.prototype.getInputWidth=function(t){return this._inputDimensions[t][1]},r.prototype.getReshapedInputDimensions=function(t){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return function Hm(r,t){var e=r.width,n=r.height,o=t/Math.max(n,e);return new Jn(Math.round(e*o),Math.round(n*o))}({width:this.getInputWidth(t),height:this.getInputHeight(t)},this.inputSize)},r.prototype.toBatchTensor=function(t,e){var n=this;return void 0===e&&(e=!0),this._inputSize=t,K(function(){var o=Mr(n.batchSize,0,1).map(function(i){var s=n.getInput(i);if(s instanceof _e){var u=hn(s)?s:s.expandDims();return u=function Km(r,t){return void 0===t&&(t=!1),K(function(){var e=r.shape.slice(1),n=e[0],o=e[1];if(n===o)return r;var a=Math.abs(n-o),i=Math.round(a*(t?.5:1)),s=n>o?2:1,u=function(d){var p=r.shape.slice();return p[s]=d,Dt(p,0)},c=u(i),l=a-c.shape[s],f=[t&&l?u(l):null,r,c].filter(function(d){return!!d}).map(function(d){return d.toFloat()});return Be(f,s)})}(u,e),(u.shape[1]!==t||u.shape[2]!==t)&&(u=Ya.resizeBilinear(u,[t,t])),u.as3D(t,t,3)}if(s instanceof Je.getEnv().Canvas)return di.fromPixels(function ag(r,t,e){void 0===e&&(e=!1);var n=Je.getEnv(),a=n.Canvas;if(!(r instanceof n.Image||r instanceof a))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var i=Vl(r),s=t/Math.max(i.height,i.width),u=s*i.width,c=s*i.height,l=Fo({width:t,height:t}),h=r instanceof a?r:Ri(r),f=Math.abs(u-c)/2,d=e&&u<c?f:0,p=e&&c<u?f:0;return Ft(l).drawImage(h,d,p,u,c),l}(s,t,e));throw new Error("toBatchTensor - at batchIdx "+i+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+s)});return ut(o.map(function(i){return i.toFloat()})).as4D(n.batchSize,t,t,3)})},r}();function Ge(r){return J(this,void 0,void 0,function(){var t,e,n;return Z(this,function(o){switch(o.label){case 0:if(r instanceof No)return[2,r];if(!(t=Array.isArray(r)?r:[r]).length)throw new Error("toNetInput - empty array passed as input");return e=function(a){return Array.isArray(r)?" at input index "+a+":":""},(n=t.map(Ii)).forEach(function(a,i){if(!Ul(a)&&!So(a)&&!hn(a))throw"string"==typeof t[i]?new Error("toNetInput -"+e(i)+" string passed, but could not resolve HTMLElement for element id "+t[i]):new Error("toNetInput -"+e(i)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id");if(hn(a)){var s=a.shape[0];if(1!==s)throw new Error("toNetInput -"+e(i)+" tf.Tensor4D with batchSize "+s+" passed, but not supported in input array")}}),[4,Promise.all(n.map(function(a){return Ul(a)&&function rg(r){return new Promise(function(t,e){if(r instanceof Je.getEnv().Canvas||zl(r))return t();function n(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",o),t(a))}function o(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",n),a.currentTarget.removeEventListener("error",o),e(a))}r.addEventListener("load",n),r.addEventListener("error",o)})}(a)}))];case 1:return o.sent(),[2,new No(n,Array.isArray(r))]}})})}function ki(r,t){return J(this,void 0,void 0,function(){var e,n,o,a,i,s;return Z(this,function(c){switch(c.label){case 0:return e=Je.getEnv().Canvas,n=r,r instanceof e?[3,5]:[4,Ge(r)];case 1:if((o=c.sent()).batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");return(a=o.getInput(0))instanceof e?(i=a,[3,4]):[3,2];case 2:return[4,og(a)];case 3:i=c.sent(),c.label=4;case 4:n=i,c.label=5;case 5:return s=Ft(n),[2,t.map(function(l){return l instanceof Tt?l.forSize(n.width,n.height).box.floor():l}).map(function(l){return l.clipAtImageBorders(n.width,n.height)}).map(function(l){var h=l.x,f=l.y,d=l.width,p=l.height,m=Fo({width:d,height:p});return Ft(m).putImageData(s.getImageData(h,f,d,p),0,0),m})]}})})}function Si(r,t){return J(this,void 0,void 0,function(){return Z(this,function(e){if(!So(r)&&!hn(r))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(hn(r)&&r.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,K(function(){var n=r.shape.slice(hn(r)?1:0),o=n[0],a=n[1],i=n[2];return t.map(function(c){return c instanceof Tt?c.forSize(a,o).box:c}).map(function(c){return c.clipAtImageBorders(a,o)}).map(function(c){var l=c.x,h=c.y,f=c.width,d=c.height;return zc(r.as3D(o,a,i),[h,l,0],[d,f,i])})})]})})}function ig(r,t){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return[4,(0,Je.getEnv().fetch)(r,t)];case 1:if(!((n=o.sent()).status<400))throw new Error("failed to fetch: ("+n.status+") "+n.statusText+", from url: "+n.url);return[2,n]}})})}function sg(r){return J(this,void 0,void 0,function(){return Z(this,function(t){switch(t.label){case 0:return[4,ig(r)];case 1:return[2,t.sent().json()]}})})}function Gl(r,t){var e=t+"-weights_manifest.json";if(!r)return{modelBaseUri:"",manifestUri:e};if("/"===r)return{modelBaseUri:"/",manifestUri:"/"+e};var n=r.startsWith("http://")?"http://":r.startsWith("https://")?"https://":"",o=(r=r.replace(n,"")).split("/").filter(function(s){return s}),a=r.endsWith(".json")?o[o.length-1]:e,i=n+(r.endsWith(".json")?o.slice(0,o.length-1):o).join("/");return{modelBaseUri:i=r.startsWith("/")?"/"+i:i,manifestUri:"/"===i?"/"+a:i+"/"+a}}function ug(r,t){return J(this,void 0,void 0,function(){var e,o,a;return Z(this,function(i){switch(i.label){case 0:return e=Gl(r,t),o=e.modelBaseUri,[4,sg(e.manifestUri)];case 1:return a=i.sent(),[2,ml.loadWeights(a,o)]}})})}var Xt=function(){function r(t){this._name=t,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(r.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),r.prototype.getParamFromPath=function(t){var e=this.traversePropertyPath(t);return e.obj[e.objProp]},r.prototype.reassignParamFromPath=function(t,e){var n=this.traversePropertyPath(t),o=n.obj,a=n.objProp;o[a].dispose(),o[a]=e},r.prototype.getParamList=function(){var t=this;return this._paramMappings.map(function(e){var n=e.paramPath;return{path:n,tensor:t.getParamFromPath(n)}})},r.prototype.getTrainableParams=function(){return this.getParamList().filter(function(t){return t.tensor instanceof Bn})},r.prototype.getFrozenParams=function(){return this.getParamList().filter(function(t){return!(t.tensor instanceof Bn)})},r.prototype.variable=function(){var t=this;this.getFrozenParams().forEach(function(e){t.reassignParamFromPath(e.path,e.tensor.variable())})},r.prototype.freeze=function(){var t=this;this.getTrainableParams().forEach(function(e){var n=e.path,o=e.tensor,a=Ke(o.dataSync());o.dispose(),t.reassignParamFromPath(n,a)})},r.prototype.dispose=function(t){void 0===t&&(t=!0),this.getParamList().forEach(function(e){if(t&&e.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+e.path);e.tensor.dispose()}),this._params=void 0},r.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(t){return Array.from(t.tensor.dataSync())}).reduce(function(t,e){return t.concat(e)}))},r.prototype.load=function(t){return J(this,void 0,void 0,function(){return Z(this,function(e){switch(e.label){case 0:return t instanceof Float32Array?(this.extractWeights(t),[2]):[4,this.loadFromUri(t)];case 1:return e.sent(),[2]}})})},r.prototype.loadFromUri=function(t){return J(this,void 0,void 0,function(){var e;return Z(this,function(n){switch(n.label){case 0:if(t&&"string"!=typeof t)throw new Error(this._name+".loadFromUri - expected model uri");return[4,ug(t,this.getDefaultModelName())];case 1:return e=n.sent(),this.loadFromWeightMap(e),[2]}})})},r.prototype.loadFromDisk=function(t){return J(this,void 0,void 0,function(){var e,n,o,a,s,u,c,l,h;return Z(this,function(f){switch(f.label){case 0:if(t&&"string"!=typeof t)throw new Error(this._name+".loadFromDisk - expected model file path");return e=Je.getEnv().readFile,n=Gl(t,this.getDefaultModelName()),o=n.manifestUri,a=n.modelBaseUri,s=ml.weightsLoaderFactory(function(d){return Promise.all(d.map(function(p){return e(p).then(function(m){return m.buffer})}))}),l=(c=JSON).parse,[4,e(o)];case 1:return u=l.apply(c,[f.sent().toString()]),[4,s(u,a)];case 2:return h=f.sent(),this.loadFromWeightMap(h),[2]}})})},r.prototype.loadFromWeightMap=function(t){var e=this.extractParamsFromWeigthMap(t),o=e.params;this._paramMappings=e.paramMappings,this._params=o},r.prototype.extractWeights=function(t){var e=this.extractParams(t),o=e.params;this._paramMappings=e.paramMappings,this._params=o},r.prototype.traversePropertyPath=function(t){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var e=t.split("/").reduce(function(a,i){if(!a.nextObj.hasOwnProperty(i))throw new Error("traversePropertyPath - object does not have property "+i+", for path "+t);return{obj:a.nextObj,objProp:i,nextObj:a.nextObj[i]}},{nextObj:this.params}),n=e.obj,o=e.objProp;if(!(n&&o&&n[o]instanceof _e))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+t);return{obj:n,objProp:o}},r}();function lt(r,t,e){return K(function(){var n=Ha(r,t.depthwise_filter,t.pointwise_filter,e,"same");return le(n,t.bias)})}function Di(r,t,e){return void 0===e&&(e=!1),K(function(){var n=ke(e?le(pt(r,t.conv0.filters,[2,2],"same"),t.conv0.bias):lt(r,t.conv0,[2,2])),o=lt(n,t.conv1,[1,1]),i=lt(ke(le(n,o)),t.conv2,[1,1]);return ke(le(n,le(o,i)))})}function Po(r,t,e,n){return void 0===e&&(e=!1),void 0===n&&(n=!0),K(function(){var o=ke(e?le(pt(r,t.conv0.filters,n?[2,2]:[1,1],"same"),t.conv0.bias):lt(r,t.conv0,n?[2,2]:[1,1])),a=lt(o,t.conv1,[1,1]),s=lt(ke(le(o,a)),t.conv2,[1,1]),c=lt(ke(le(o,le(a,s))),t.conv3,[1,1]);return ke(le(o,le(a,le(s,c))))})}function Et(r,t,e,n){return void 0===e&&(e="same"),void 0===n&&(n=!1),K(function(){var o=le(pt(r,t.filters,[1,1],e),t.bias);return n?ke(o):o})}function Yt(r,t){Object.keys(r).forEach(function(e){t.some(function(n){return n.originalPath===e})||r[e].dispose()})}function Mo(r,t){return function(e,n,o,a){var i=rt(r(e*n*o*o),[o,o,e,n]),s=Me(r(n));return t.push({paramPath:a+"/filters"},{paramPath:a+"/bias"}),{filters:i,bias:s}}}function Ai(r,t){return function(e,n,o){var a=on(r(e*n),[e,n]),i=Me(r(n));return t.push({paramPath:o+"/weights"},{paramPath:o+"/bias"}),{weights:a,bias:i}}}var Hl=function(){return function r(t,e,n){this.depthwise_filter=t,this.pointwise_filter=e,this.bias=n}}();function Ti(r,t){return function(e,n,o){var a=rt(r(9*e),[3,3,e,1]),i=rt(r(e*n),[1,1,e,n]),s=Me(r(n));return t.push({paramPath:o+"/depthwise_filter"},{paramPath:o+"/pointwise_filter"},{paramPath:o+"/bias"}),new Hl(a,i,s)}}function Fi(r){return function(t){var e=r(t+"/depthwise_filter",4),n=r(t+"/pointwise_filter",4),o=r(t+"/bias",1);return new Hl(e,n,o)}}function fn(r,t){return function(e,n,o){var a=r[e];if(!Pr(a,n))throw new Error("expected weightMap["+e+"] to be a Tensor"+n+"D, instead have "+a);return t.push({originalPath:e,paramPath:o||e}),a}}function $t(r){var t=r;return{extractWeights:function e(o){var a=t.slice(0,o);return t=t.slice(o),a},getRemainingWeights:function n(){return t}}}function jl(r,t){var e=Mo(r,t),n=Ti(r,t);function o(i,s,u,c){return void 0===c&&(c=!1),{conv0:c?e(i,s,3,u+"/conv0"):n(i,s,u+"/conv0"),conv1:n(s,s,u+"/conv1"),conv2:n(s,s,u+"/conv2")}}return{extractDenseBlock3Params:o,extractDenseBlock4Params:function a(i,s,u,c){void 0===c&&(c=!1);var l=o(i,s,u,c);return{conv0:l.conv0,conv1:l.conv1,conv2:l.conv2,conv3:n(s,s,u+"/conv3")}}}}function ql(r){return function(t){return{filters:r(t+"/filters",4),bias:r(t+"/bias",1)}}}function Kl(r,t){var e=fn(r,t),n=ql(e),o=Fi(e);return{extractDenseBlock3Params:function a(s,u){return void 0===u&&(u=!1),{conv0:u?n(s+"/conv0"):o(s+"/conv0"),conv1:o(s+"/conv1"),conv2:o(s+"/conv2")}},extractDenseBlock4Params:function i(s,u){return void 0===u&&(u=!1),{conv0:u?n(s+"/conv0"):o(s+"/conv0"),conv1:o(s+"/conv1"),conv2:o(s+"/conv2"),conv3:o(s+"/conv3")}}}}var Xl=function(r){function t(){return r.call(this,"FaceFeatureExtractor")||this}return oe(t,r),t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return K(function(){var s=Po(Br(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(j(255)),n.dense0,!0);return s=Po(s,n.dense1),s=Po(s,n.dense2),s=Po(s,n.dense3),Tr(s,[7,7],[2,2],"valid")})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},t.prototype.extractParamsFromWeigthMap=function(e){return function lg(r){var t=[],e=Kl(r,t).extractDenseBlock4Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2"),dense3:e("dense3")};return Yt(r,t),{params:n,paramMappings:t}}(e)},t.prototype.extractParams=function(e){return function cg(r){var t=[],e=$t(r),o=e.getRemainingWeights,a=jl(e.extractWeights,t).extractDenseBlock4Params,i=a(3,32,"dense0",!0),s=a(32,64,"dense1"),u=a(64,128,"dense2"),c=a(128,256,"dense3");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:t,params:{dense0:i,dense1:s,dense2:u,dense3:c}}}(e)},t}(Xt);function Nt(r,t){return K(function(){return le(wo(r,t.weights),t.bias)})}function Yl(r){var t={},e={};return Object.keys(r).forEach(function(n){(n.startsWith("fc")?e:t)[n]=r[n]}),{featureExtractorMap:t,classifierMap:e}}var $l=function(r){function t(e,n){var o=r.call(this,e)||this;return o._faceFeatureExtractor=n,o}return oe(t,r),Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,o=this.params;if(!o)throw new Error(this._name+" - load model before inference");return K(function(){var a=e instanceof No?n.faceFeatureExtractor.forwardInput(e):e;return Nt(a.as2D(a.shape[0],-1),o.fc)})},t.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),a=n.paramMappings;this._params=n.params,this._paramMappings=a},t.prototype.extractClassifierParams=function(e){return function hg(r,t,e){var n=[],o=$t(r),i=o.getRemainingWeights,u=Ai(o.extractWeights,n)(t,e,"fc");if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{paramMappings:n,params:{fc:u}}}(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},t.prototype.extractParamsFromWeigthMap=function(e){var n=Yl(e),a=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(n.featureExtractorMap),function fg(r){var t=[],e=fn(r,t),o={fc:function n(a){return{weights:e(a+"/weights",2),bias:e(a+"/bias",1)}}("fc")};return Yt(r,t),{params:o,paramMappings:t}}(a)},t.prototype.extractParams=function(e){var n=this.getClassifierChannelsIn(),o=this.getClassifierChannelsOut(),a=o*n+o,i=e.slice(0,e.length-a),s=e.slice(e.length-a);return this.faceFeatureExtractor.extractWeights(i),this.extractClassifierParams(s)},t}(Xt),Ql=["neutral","happy","sad","angry","fearful","disgusted","surprised"],dg=function(){function r(t){var e=this;if(7!==t.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+t.length);Ql.forEach(function(n,o){e[n]=t[o]})}return r.prototype.asSortedArray=function(){var t=this;return Ql.map(function(e){return{expression:e,probability:t[e]}}).sort(function(e,n){return n.probability-e.probability})},r}(),pg=function(r){function t(e){return void 0===e&&(e=new Xl),r.call(this,"FaceExpressionNet",e)||this}return oe(t,r),t.prototype.forwardInput=function(e){var n=this;return K(function(){return Ut(n.runNet(e))})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.predictExpressions=function(e){return J(this,void 0,void 0,function(){var n,o,a,i,s=this;return Z(this,function(u){switch(u.label){case 0:return[4,Ge(e)];case 1:return n=u.sent(),[4,this.forwardInput(n)];case 2:return o=u.sent(),[4,Promise.all(Le(o).map(function(c){return J(s,void 0,void 0,function(){var l;return Z(this,function(h){switch(h.label){case 0:return[4,c.data()];case 1:return l=h.sent(),c.dispose(),[2,l]}})})}))];case 3:return a=u.sent(),o.dispose(),i=a.map(function(c){return new dg(c)}),[2,n.isBatchInput?i:i[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_expression_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t.prototype.getClassifierChannelsOut=function(){return 7},t}($l);function Jl(r,t){return Object.assign({},r,{expressions:t})}function Ni(r,t){var e=r.detection.box,n=t.shiftBy(e.x,e.y),o=n.align(),a=r.detection.imageDims,i=new Tt(r.detection.score,o.rescale(a.reverse()),a);return Object.assign({},r,{landmarks:n,unshiftedLandmarks:t,alignedRect:i})}function Zl(r,t,e){return le(pt(r,t.filters,e,"same"),t.bias)}function Pi(r,t,e){void 0===e&&(e=!0);var n=e?ke(r):r;return n=lt(n,t.separable_conv0,[1,1]),n=lt(ke(n),t.separable_conv1,[1,1]),n=Ue(n,[3,3],[2,2],"same"),le(n,Zl(r,t.expansion_conv,[2,2]))}var Cg=function(r){function t(e){var n=r.call(this,"TinyXception")||this;return n._numMainBlocks=e,n}return oe(t,r),t.prototype.forwardInput=function(e){var n=this,o=this.params;if(!o)throw new Error("TinyXception - load model before inference");return K(function(){var s=Br(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(j(256)),u=ke(Zl(s,o.entry_flow.conv_in,[2,2]));return u=Pi(u,o.entry_flow.reduction_block_0,!1),u=Pi(u,o.entry_flow.reduction_block_1),Mr(n._numMainBlocks,0,1).forEach(function(c){u=function _g(r,t){var e=lt(ke(r),t.separable_conv0,[1,1]);return e=lt(ke(e),t.separable_conv1,[1,1]),e=lt(ke(e),t.separable_conv2,[1,1]),le(e,r)}(u,o.middle_flow["main_block_"+c])}),u=Pi(u,o.exit_flow.reduction_block),u=ke(lt(u,o.exit_flow.separable_conv,[1,1]))})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"tiny_xception_model"},t.prototype.extractParamsFromWeigthMap=function(e){return function wg(r,t){var e=[],n=function bg(r,t){var e=fn(r,t),n=ql(e),o=Fi(e);return{extractConvParams:n,extractSeparableConvParams:o,extractReductionBlockParams:function a(s){return{separable_conv0:o(s+"/separable_conv0"),separable_conv1:o(s+"/separable_conv1"),expansion_conv:n(s+"/expansion_conv")}},extractMainBlockParams:function i(s){return{separable_conv0:o(s+"/separable_conv0"),separable_conv1:o(s+"/separable_conv1"),separable_conv2:o(s+"/separable_conv2")}}}}(r,e),a=n.extractSeparableConvParams,i=n.extractReductionBlockParams,s=n.extractMainBlockParams,h={conv_in:(0,n.extractConvParams)("entry_flow/conv_in"),reduction_block_0:i("entry_flow/reduction_block_0"),reduction_block_1:i("entry_flow/reduction_block_1")},f={};Mr(t,0,1).forEach(function(v){f["main_block_"+v]=s("middle_flow/main_block_"+v)});var m={reduction_block:i("exit_flow/reduction_block"),separable_conv:a("exit_flow/separable_conv")};return Yt(r,e),{params:{entry_flow:h,middle_flow:f,exit_flow:m},paramMappings:e}}(e,this._numMainBlocks)},t.prototype.extractParams=function(e){return function xg(r,t){var e=[],n=$t(r),a=n.getRemainingWeights,i=function yg(r,t){var e=Mo(r,t),n=Ti(r,t);return{extractConvParams:e,extractSeparableConvParams:n,extractReductionBlockParams:function o(i,s,u){return{separable_conv0:n(i,s,u+"/separable_conv0"),separable_conv1:n(s,s,u+"/separable_conv1"),expansion_conv:e(i,s,1,u+"/expansion_conv")}},extractMainBlockParams:function a(i,s){return{separable_conv0:n(i,i,s+"/separable_conv0"),separable_conv1:n(i,i,s+"/separable_conv1"),separable_conv2:n(i,i,s+"/separable_conv2")}}}}(n.extractWeights,e),u=i.extractSeparableConvParams,c=i.extractReductionBlockParams,l=i.extractMainBlockParams,p={conv_in:(0,i.extractConvParams)(3,32,3,"entry_flow/conv_in"),reduction_block_0:c(32,64,"entry_flow/reduction_block_0"),reduction_block_1:c(64,128,"entry_flow/reduction_block_1")},m={};Mr(t,0,1).forEach(function(b){m["main_block_"+b]=l(128,"middle_flow/main_block_"+b)});var x={reduction_block:c(128,256,"exit_flow/reduction_block"),separable_conv:u(256,512,"exit_flow/separable_conv")};if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:e,params:{entry_flow:p,middle_flow:m,exit_flow:x}}}(e,this._numMainBlocks)},t}(Xt),Mi=function(r){return r.FEMALE="female",r.MALE="male",r}(Mi||{}),Rg=function(r){function t(e){void 0===e&&(e=new Cg(2));var n=r.call(this,"AgeGenderNet")||this;return n._faceFeatureExtractor=e,n}return oe(t,r),Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,o=this.params;if(!o)throw new Error(this._name+" - load model before inference");return K(function(){var a=e instanceof No?n.faceFeatureExtractor.forwardInput(e):e,i=Tr(a,[7,7],[2,2],"valid").as2D(a.shape[0],-1);return{age:Nt(i,o.fc.age).as1D(),gender:Nt(i,o.fc.gender)}})},t.prototype.forwardInput=function(e){var n=this;return K(function(){var o=n.runNet(e);return{age:o.age,gender:Ut(o.gender)}})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.predictAgeAndGender=function(e){return J(this,void 0,void 0,function(){var n,o,a,i,s,u,c=this;return Z(this,function(l){switch(l.label){case 0:return[4,Ge(e)];case 1:return n=l.sent(),[4,this.forwardInput(n)];case 2:return o=l.sent(),a=Le(o.age),i=Le(o.gender),s=a.map(function(h,f){return{ageTensor:h,genderTensor:i[f]}}),[4,Promise.all(s.map(function(h){var f=h.ageTensor,d=h.genderTensor;return J(c,void 0,void 0,function(){var p,m,v,g,x;return Z(this,function(b){switch(b.label){case 0:return[4,f.data()];case 1:return p=b.sent()[0],[4,d.data()];case 2:return m=b.sent()[0],g=(v=m>.5)?Mi.MALE:Mi.FEMALE,x=v?m:1-m,f.dispose(),d.dispose(),[2,{age:p,gender:g,genderProbability:x}]}})})}))];case 3:return u=l.sent(),o.age.dispose(),o.gender.dispose(),[2,n.isBatchInput?u:u[0]]}})})},t.prototype.getDefaultModelName=function(){return"age_gender_model"},t.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),a=n.paramMappings;this._params=n.params,this._paramMappings=a},t.prototype.extractClassifierParams=function(e){return function Eg(r){var t=[],e=$t(r),o=e.getRemainingWeights,a=Ai(e.extractWeights,t),i=a(512,1,"fc/age"),s=a(512,2,"fc/gender");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:t,params:{fc:{age:i,gender:s}}}}(e)},t.prototype.extractParamsFromWeigthMap=function(e){var n=Yl(e),a=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(n.featureExtractorMap),function Ig(r){var t=[],e=fn(r,t);function n(a){return{weights:e(a+"/weights",2),bias:e(a+"/bias",1)}}var o={fc:{age:n("fc/age"),gender:n("fc/gender")}};return Yt(r,t),{params:o,paramMappings:t}}(a)},t.prototype.extractParams=function(e){var o=e.slice(0,e.length-1539),a=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(o),this.extractClassifierParams(a)},t}(Xt),eh=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.postProcess=function(e,n,o){var a=o.map(function(s){var u=s.width,c=s.height,l=n/Math.max(c,u);return{width:u*l,height:c*l}}),i=a.length;return K(function(){var s=function(f,d){return ut([Dt([68],f),Dt([68],d)],1).as2D(1,136).as1D()},u=function(f,d){var p=a[f],m=p.width,v=p.height;return d(m,v)?Math.abs(m-v)/2:0};return e.mul(Dt([i,136],n)).sub(ut(Array.from(Array(i),function(f,d){return s(function(f){return u(f,function(d,p){return d<p})}(d),function(f){return u(f,function(d,p){return p<d})}(d))}))).div(ut(Array.from(Array(i),function(f,d){return s(a[d].width,a[d].height)})))})},t.prototype.forwardInput=function(e){var n=this;return K(function(){var o=n.runNet(e);return n.postProcess(o,e.inputSize,e.inputDimensions.map(function(a){return{height:a[0],width:a[1]}}))})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.detectLandmarks=function(e){return J(this,void 0,void 0,function(){var n,o,a,i=this;return Z(this,function(s){switch(s.label){case 0:return[4,Ge(e)];case 1:return n=s.sent(),o=K(function(){return Le(i.forwardInput(n))}),[4,Promise.all(o.map(function(u,c){return J(i,void 0,void 0,function(){var l,h,f,d,p;return Z(this,function(m){switch(m.label){case 0:return f=(h=Array).from,[4,u.data()];case 1:return l=f.apply(h,[m.sent()]),d=l.filter(function(v,g){return kl(g)}),p=l.filter(function(v,g){return!kl(g)}),[2,new Tl(Array(68).fill(0).map(function(v,g){return new xe(d[g],p[g])}),{height:n.getInputHeight(c),width:n.getInputWidth(c)})]}})})}))];case 2:return a=s.sent(),o.forEach(function(u){return u.dispose()}),[2,n.isBatchInput?a:a[0]]}})})},t.prototype.getClassifierChannelsOut=function(){return 136},t}($l),th=function(r){function t(e){return void 0===e&&(e=new Xl),r.call(this,"FaceLandmark68Net",e)||this}return oe(t,r),t.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t}(eh),Dg=function(r){function t(){return r.call(this,"TinyFaceFeatureExtractor")||this}return oe(t,r),t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return K(function(){var s=Di(Br(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(j(255)),n.dense0,!0);return s=Di(s,n.dense1),s=Di(s,n.dense2),Tr(s,[14,14],[2,2],"valid")})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},t.prototype.extractParamsFromWeigthMap=function(e){return function kg(r){var t=[],e=Kl(r,t).extractDenseBlock3Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2")};return Yt(r,t),{params:n,paramMappings:t}}(e)},t.prototype.extractParams=function(e){return function Sg(r){var t=[],e=$t(r),o=e.getRemainingWeights,a=jl(e.extractWeights,t).extractDenseBlock3Params,i=a(3,32,"dense0",!0),s=a(32,64,"dense1"),u=a(64,128,"dense2");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:t,params:{dense0:i,dense1:s,dense2:u}}}(e)},t}(Xt),Ag=function(r){function t(e){return void 0===e&&(e=new Dg),r.call(this,"FaceLandmark68TinyNet",e)||this}return oe(t,r),t.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},t.prototype.getClassifierChannelsIn=function(){return 128},t}(eh);function Oi(r,t,e,n,o){void 0===o&&(o="same");var a=t.conv,s=a.bias,u=pt(r,a.filters,e,o);return u=function Tg(r,t){return le(Ye(r,t.weights),t.biases)}(u=le(u,s),t.scale),n?ke(u):u}function nh(r,t){return Oi(r,t,[1,1],!1)}function rh(r,t){return Oi(r,t,[2,2],!0,"valid")}function Ng(r,t){function a(s,u,c,l){var h=function n(s,u,c,l){var h=function e(s,u,c){var l=r(s),h=l.length/(u*c*c);if(function Um(r){return r%1!=0}(h))throw new Error("depth has to be an integer: "+h+", weights.length: "+l.length+", numFilters: "+u+", filterSize: "+c);return K(function(){return sn(rt(l,[u,h,c,c]),[2,3,1,0])})}(s,u,c),f=Me(r(u));return t.push({paramPath:l+"/filters"},{paramPath:l+"/bias"}),{filters:h,bias:f}}(s,u,c,l+"/conv"),f=function o(s,u){var c=Me(r(s)),l=Me(r(s));return t.push({paramPath:u+"/weights"},{paramPath:u+"/biases"}),{weights:c,biases:l}}(u,l+"/scale");return{conv:h,scale:f}}return{extractConvLayerParams:a,extractResidualLayerParams:function i(s,u,c,l,h){return void 0===h&&(h=!1),{conv1:a((h?.5:1)*s,u,c,l+"/conv1"),conv2:a(s,u,c,l+"/conv2")}}}}function Og(r){var t=[],e=function Mg(r,t){var e=fn(r,t);function o(i){var s=e(i+"/conv/filters",4),u=e(i+"/conv/bias",1),c=function n(i){return{weights:e(i+"/scale/weights",1),biases:e(i+"/scale/biases",1)}}(i);return{conv:{filters:s,bias:u},scale:c}}return{extractConvLayerParams:o,extractResidualLayerParams:function a(i){return{conv1:o(i+"/conv1"),conv2:o(i+"/conv2")}}}}(r,t),o=e.extractResidualLayerParams,a=(0,e.extractConvLayerParams)("conv32_down"),i=o("conv32_1"),s=o("conv32_2"),u=o("conv32_3"),c=o("conv64_down"),l=o("conv64_1"),h=o("conv64_2"),f=o("conv64_3"),d=o("conv128_down"),p=o("conv128_1"),m=o("conv128_2"),v=o("conv256_down"),g=o("conv256_1"),x=o("conv256_2"),b=o("conv256_down_out"),y=r.fc;if(t.push({originalPath:"fc",paramPath:"fc"}),!function Vm(r){return Pr(r,2)}(y))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+y);var w={conv32_down:a,conv32_1:i,conv32_2:s,conv32_3:u,conv64_down:c,conv64_1:l,conv64_2:h,conv64_3:f,conv128_down:d,conv128_1:p,conv128_2:m,conv256_down:v,conv256_1:g,conv256_2:x,conv256_down_out:b,fc:y};return Yt(r,t),{params:w,paramMappings:t}}function Pt(r,t){var e=function Fg(r,t){return Oi(r,t,[1,1],!0)}(r,t.conv1);return e=nh(e,t.conv2),e=le(e,r),ke(e)}function Oo(r,t){var e=rh(r,t.conv1);e=nh(e,t.conv2);var n=Tr(r,2,2,"valid"),o=Ee(n.shape),a=n.shape[3]!==e.shape[3];if(n.shape[1]!==e.shape[1]||n.shape[2]!==e.shape[2]){var s=Nr(e.shape);s[1]=1;var u=Ee(s),c=Nr((e=Be([e,u],1)).shape);c[2]=1;var l=Ee(c);e=Be([e,l],2)}return n=a?Be([n,o],3):n,e=le(n,e),ke(e)}!function(r){oe(function t(){return null!==r&&r.apply(this,arguments)||this},r)}(th);var Bg=function(r){function t(){return r.call(this,"FaceRecognitionNet")||this}return oe(t,r),t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceRecognitionNet - load model before inference");return K(function(){var s=rh(Br(e.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div(j(256)),n.conv32_down);s=Pt(s=Ue(s,3,2,"valid"),n.conv32_1),s=Pt(s,n.conv32_2),s=Pt(s,n.conv32_3),s=Pt(s=Oo(s,n.conv64_down),n.conv64_1),s=Pt(s,n.conv64_2),s=Pt(s,n.conv64_3),s=Pt(s=Oo(s,n.conv128_down),n.conv128_1),s=Pt(s,n.conv128_2),s=Pt(s=Oo(s,n.conv256_down),n.conv256_1);var u=(s=Oo(s=Pt(s,n.conv256_2),n.conv256_down_out)).mean([1,2]);return wo(u,n.fc)})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.computeFaceDescriptor=function(e){return J(this,void 0,void 0,function(){var n,o,a,i=this;return Z(this,function(s){switch(s.label){case 0:return[4,Ge(e)];case 1:return n=s.sent(),o=K(function(){return Le(i.forwardInput(n))}),[4,Promise.all(o.map(function(u){return u.data()}))];case 2:return a=s.sent(),o.forEach(function(u){return u.dispose()}),[2,n.isBatchInput?a:a[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_recognition_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Og(e)},t.prototype.extractParams=function(e){return function Pg(r){var t=$t(r),e=t.extractWeights,n=t.getRemainingWeights,o=[],a=Ng(e,o),s=a.extractResidualLayerParams,u=(0,a.extractConvLayerParams)(4704,32,7,"conv32_down"),c=s(9216,32,3,"conv32_1"),l=s(9216,32,3,"conv32_2"),h=s(9216,32,3,"conv32_3"),f=s(36864,64,3,"conv64_down",!0),d=s(36864,64,3,"conv64_1"),p=s(36864,64,3,"conv64_2"),m=s(36864,64,3,"conv64_3"),v=s(147456,128,3,"conv128_down",!0),g=s(147456,128,3,"conv128_1"),x=s(147456,128,3,"conv128_2"),b=s(589824,256,3,"conv256_down",!0),y=s(589824,256,3,"conv256_1"),w=s(589824,256,3,"conv256_2"),C=s(589824,256,3,"conv256_down_out"),S=K(function(){return sn(on(e(32768),[128,256]),[1,0])});if(o.push({paramPath:"fc"}),0!==n().length)throw new Error("weights remaing after extract: "+n().length);return{params:{conv32_down:u,conv32_1:c,conv32_2:l,conv32_3:h,conv64_down:f,conv64_1:d,conv64_2:p,conv64_3:m,conv128_down:v,conv128_1:g,conv128_2:x,conv256_down:b,conv256_1:y,conv256_2:w,conv256_down_out:C,fc:S},paramMappings:o}}(e)},t}(Xt);function oh(r,t,e){return Object.assign({},r,{gender:t,genderProbability:e})}var ah=function(){function r(t){var e=void 0===t?{}:t,n=e.minFaceSize,o=e.scaleFactor,a=e.maxNumScales,i=e.scoreThresholds,s=e.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=n||20,this._scaleFactor=o||.709,this._maxNumScales=a||10,this._scoreThresholds=i||[.6,.7,.7],this._scaleSteps=s,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(u){return"number"!=typeof u}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(u){return"number"!=typeof u})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(r.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),r}();function Mt(r,t,e){return K(function(){var n=pt(r,t.filters,e,"same");return n=le(n,t.batch_norm_offset),La(n,0,6)})}function Kg(r,t,e){var n=r.arraySync(),o=Math.min(n[t][0],n[t][2]),a=Math.min(n[t][1],n[t][3]),i=Math.max(n[t][0],n[t][2]),s=Math.max(n[t][1],n[t][3]),u=Math.min(n[e][0],n[e][2]),c=Math.min(n[e][1],n[e][3]),l=Math.max(n[e][0],n[e][2]),h=Math.max(n[e][1],n[e][3]),f=(i-o)*(s-a),d=(l-u)*(h-c);if(f<=0||d<=0)return 0;var p=Math.max(o,u),m=Math.max(a,c),v=Math.min(i,l),g=Math.min(s,h),x=Math.max(v-p,0)*Math.max(g-m,0);return x/(f+d-x)}function Zn(r,t){return K(function(){var e=r.shape[0];return{boxPredictionEncoding:wt(Et(r,t.box_encoding_predictor),[e,-1,1,4]),classPrediction:wt(Et(r,t.class_predictor),[e,-1,3])}})}var Lr=function(){function r(t){var e=void 0===t?{}:t,n=e.minConfidence,o=e.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=n||.5,this._maxResults=o||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(r.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),r}(),ih=function(r){function t(){return r.call(this,"SsdMobilenetv1")||this}return oe(t,r),t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("SsdMobilenetv1 - load model before inference");return K(function(){var o=e.toBatchTensor(512,!1).toFloat(),i=function jg(r,t){return K(function(){var e=null,n=Mt(r,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach(function(a,i){var s=i+1,u=function Hg(r){return[2,4,6,12].some(function(t){return t===r})?[2,2]:[1,1]}(s);n=function Gg(r,t,e){return K(function(){var n=bo(r,t.filters,e,"same");return n=Cc(n,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,.0010000000474974513),La(n,0,6)})}(n,a.depthwise_conv,u),n=Mt(n,a.pointwise_conv,[1,1]),11===s&&(e=n)}),null===e)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:n,conv11:e}})}(We(Ye(o,j(.007843137718737125)),j(1)),n.mobilenetv1),s=function Qg(r,t,e){return K(function(){var n=Mt(r,e.conv_0,[1,1]),o=Mt(n,e.conv_1,[2,2]),a=Mt(o,e.conv_2,[1,1]),i=Mt(a,e.conv_3,[2,2]),s=Mt(i,e.conv_4,[1,1]),u=Mt(s,e.conv_5,[2,2]),c=Mt(u,e.conv_6,[1,1]),l=Mt(c,e.conv_7,[2,2]),h=Zn(t,e.box_predictor_0),f=Zn(r,e.box_predictor_1),d=Zn(o,e.box_predictor_2),p=Zn(i,e.box_predictor_3),m=Zn(u,e.box_predictor_4),v=Zn(l,e.box_predictor_5);return{boxPredictions:Be([h.boxPredictionEncoding,f.boxPredictionEncoding,d.boxPredictionEncoding,p.boxPredictionEncoding,m.boxPredictionEncoding,v.boxPredictionEncoding],1),classPredictions:Be([h.classPrediction,f.classPrediction,d.classPrediction,p.classPrediction,m.classPrediction,v.classPrediction],1)}})}(i.out,i.conv11,n.prediction_layer);return function $g(r,t,e){return K(function(){var n=r.shape[0],o=function Yg(r,t){var e=function Xg(r){var t=Le(sn(r,[1,0])),e=[We(t[2],t[0]),We(t[3],t[1])];return{sizes:e,centers:[le(t[0],Ct(e[0],j(2))),le(t[1],Ct(e[1],j(2)))]}}(r),n=e.sizes,o=e.centers,a=Le(sn(t,[1,0])),i=Ct(Ye(Wa(Ct(a[2],j(5))),n[0]),j(2)),s=le(Ye(Ct(a[0],j(10)),n[0]),o[0]),u=Ct(Ye(Wa(Ct(a[3],j(5))),n[1]),j(2)),c=le(Ye(Ct(a[1],j(10)),n[1]),o[1]);return sn(ut([We(s,i),We(c,u),le(s,i),le(c,u)]),[1,0])}(wt(Wn(e.extra_dim,[n,1,1]),[-1,4]),wt(r,[-1,4]));o=wt(o,[n,o.shape[0]/n,4]);var a=xc(At(t,[0,0,1],[-1,-1,-1])),i=At(a,[0,0,0],[-1,-1,1]);return i=wt(i,[n,i.shape[1]]),{boxes:Le(o),scores:Le(i)}})}(s.boxPredictions,s.classPredictions,n.output_layer)})},t.prototype.forward=function(e){return J(this,void 0,void 0,function(){var n;return Z(this,function(o){switch(o.label){case 0:return n=this.forwardInput,[4,Ge(e)];case 1:return[2,n.apply(this,[o.sent()])]}})})},t.prototype.locateFaces=function(e,n){return void 0===n&&(n={}),J(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,m,v,x,b,y,w,C,S,k;return Z(this,function(I){switch(I.label){case 0:return o=new Lr(n),a=o.maxResults,i=o.minConfidence,[4,Ge(e)];case 1:for(s=I.sent(),u=this.forwardInput(s),h=(c=u.boxes)[0],f=(l=u.scores)[0],d=1;d<c.length;d++)c[d].dispose(),l[d].dispose();return v=(m=Array).from,[4,f.data()];case 2:return p=v.apply(m,[I.sent()]),x=function qg(r,t,e,n,o){var i=Math.min(e,r.shape[0]),s=t.map(function(l,h){return{score:l,boxIndex:h}}).filter(function(l){return l.score>o}).sort(function(l,h){return h.score-l.score}),u=function(l){return l<=n?1:0},c=[];return s.forEach(function(l){if(!(c.length>=i)){for(var h=l.score,f=c.length-1;f>=0;--f){var d=Kg(r,l.boxIndex,c[f]);if(0!==d&&(l.score*=u(d),l.score<=o))break}h===l.score&&c.push(l.boxIndex)}}),c}(h,p,a,.5,i),b=s.getReshapedInputDimensions(0),w=(y=s.inputSize)/b.width,C=y/b.height,S=h.arraySync(),k=x.map(function(R){var F=[Math.max(0,S[R][0]),Math.min(1,S[R][2])].map(function(z){return z*C}),T=F[0],L=F[1],O=[Math.max(0,S[R][1]),Math.min(1,S[R][3])].map(function(z){return z*w}),B=O[0];return new Tt(p[R],new wi(B,T,O[1]-B,L-T),{height:s.getInputHeight(0),width:s.getInputWidth(0)})}),h.dispose(),f.dispose(),[2,k]}})})},t.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},t.prototype.extractParamsFromWeigthMap=function(e){return function Vg(r){var t=[],e=function zg(r,t){var e=fn(r,t);function n(c,l,h){return{filters:e(c+"/Conv2d_"+l+"_pointwise/weights",4,h+"/filters"),batch_norm_offset:e(c+"/Conv2d_"+l+"_pointwise/convolution_bn_offset",1,h+"/batch_norm_offset")}}function o(c){var l="mobilenetv1/conv_"+c,h="MobilenetV1/Conv2d_"+c+"_depthwise",f=l+"/depthwise_conv",d=l+"/pointwise_conv";return{depthwise_conv:{filters:e(h+"/depthwise_weights",4,f+"/filters"),batch_norm_scale:e(h+"/BatchNorm/gamma",1,f+"/batch_norm_scale"),batch_norm_offset:e(h+"/BatchNorm/beta",1,f+"/batch_norm_offset"),batch_norm_mean:e(h+"/BatchNorm/moving_mean",1,f+"/batch_norm_mean"),batch_norm_variance:e(h+"/BatchNorm/moving_variance",1,f+"/batch_norm_variance")},pointwise_conv:n("MobilenetV1",c,d)}}function i(c,l){return{filters:e(c+"/weights",4,l+"/filters"),bias:e(c+"/biases",1,l+"/bias")}}function s(c){return{box_encoding_predictor:i("Prediction/BoxPredictor_"+c+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+c+"/box_encoding_predictor"),class_predictor:i("Prediction/BoxPredictor_"+c+"/ClassPredictor","prediction_layer/box_predictor_"+c+"/class_predictor")}}return{extractMobilenetV1Params:function a(){return{conv_0:n("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:o(1),conv_2:o(2),conv_3:o(3),conv_4:o(4),conv_5:o(5),conv_6:o(6),conv_7:o(7),conv_8:o(8),conv_9:o(9),conv_10:o(10),conv_11:o(11),conv_12:o(12),conv_13:o(13)}},extractPredictionLayerParams:function u(){return{conv_0:n("Prediction",0,"prediction_layer/conv_0"),conv_1:n("Prediction",1,"prediction_layer/conv_1"),conv_2:n("Prediction",2,"prediction_layer/conv_2"),conv_3:n("Prediction",3,"prediction_layer/conv_3"),conv_4:n("Prediction",4,"prediction_layer/conv_4"),conv_5:n("Prediction",5,"prediction_layer/conv_5"),conv_6:n("Prediction",6,"prediction_layer/conv_6"),conv_7:n("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:s(0),box_predictor_1:s(1),box_predictor_2:s(2),box_predictor_3:s(3),box_predictor_4:s(4),box_predictor_5:s(5)}}}}(r,t),n=e.extractMobilenetV1Params,o=e.extractPredictionLayerParams,a=r["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!So(a))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+a);var i={mobilenetv1:n(),prediction_layer:o(),output_layer:{extra_dim:a}};return Yt(r,t),{params:i,paramMappings:t}}(e)},t.prototype.extractParams=function(e){return function Wg(r){var t=[],e=$t(r),n=e.extractWeights,o=e.getRemainingWeights,a=function Lg(r,t){function n(u,c,l,h,f){var d=rt(r(u*c*l*l),[l,l,u,c]),p=Me(r(c));return t.push({paramPath:h+"/filters"},{paramPath:h+"/"+(f?"batch_norm_offset":"bias")}),{filters:d,bias:p}}function o(u,c,l,h){var f=n(u,c,l,h,!0);return{filters:f.filters,batch_norm_offset:f.bias}}function a(u,c,l){var h=function e(u,c){var l=rt(r(9*u),[3,3,u,1]),h=Me(r(u)),f=Me(r(u)),d=Me(r(u)),p=Me(r(u));return t.push({paramPath:c+"/filters"},{paramPath:c+"/batch_norm_scale"},{paramPath:c+"/batch_norm_offset"},{paramPath:c+"/batch_norm_mean"},{paramPath:c+"/batch_norm_variance"}),{filters:l,batch_norm_scale:h,batch_norm_offset:f,batch_norm_mean:d,batch_norm_variance:p}}(u,l+"/depthwise_conv");return{depthwise_conv:h,pointwise_conv:o(u,c,1,l+"/pointwise_conv")}}return{extractMobilenetV1Params:function i(){return{conv_0:o(3,32,3,"mobilenetv1/conv_0"),conv_1:a(32,64,"mobilenetv1/conv_1"),conv_2:a(64,128,"mobilenetv1/conv_2"),conv_3:a(128,128,"mobilenetv1/conv_3"),conv_4:a(128,256,"mobilenetv1/conv_4"),conv_5:a(256,256,"mobilenetv1/conv_5"),conv_6:a(256,512,"mobilenetv1/conv_6"),conv_7:a(512,512,"mobilenetv1/conv_7"),conv_8:a(512,512,"mobilenetv1/conv_8"),conv_9:a(512,512,"mobilenetv1/conv_9"),conv_10:a(512,512,"mobilenetv1/conv_10"),conv_11:a(512,512,"mobilenetv1/conv_11"),conv_12:a(512,1024,"mobilenetv1/conv_12"),conv_13:a(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function s(){return{conv_0:o(1024,256,1,"prediction_layer/conv_0"),conv_1:o(256,512,3,"prediction_layer/conv_1"),conv_2:o(512,128,1,"prediction_layer/conv_2"),conv_3:o(128,256,3,"prediction_layer/conv_3"),conv_4:o(256,128,1,"prediction_layer/conv_4"),conv_5:o(128,256,3,"prediction_layer/conv_5"),conv_6:o(256,64,1,"prediction_layer/conv_6"),conv_7:o(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:n(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:n(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:n(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:n(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:n(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:n(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:n(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:n(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:n(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:n(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:n(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:n(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(n,t),s=a.extractPredictionLayerParams,u=(0,a.extractMobilenetV1Params)(),c=s(),h={extra_dim:fa(n(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{mobilenetv1:u,prediction_layer:c,output_layer:h},paramMappings:t}}(e)},t}(Xt);!function(r){oe(function t(){return null!==r&&r.apply(this,arguments)||this},r)}(ih);var e0=[new xe(.738768,.874946),new xe(2.42204,2.65704),new xe(4.30971,7.04493),new xe(10.246,4.59428),new xe(12.6868,11.8741)],t0=[new xe(1.603231,2.094468),new xe(6.041143,7.080126),new xe(2.882459,3.518061),new xe(4.266906,5.178857),new xe(9.041765,10.66308)],n0=[117.001,114.697,97.404],Bo=function(r){return"number"==typeof r};function Bi(r){return K(function(){var t=Ye(r,j(.10000000149011612));return le(ke(We(r,t)),t)})}function dn(r,t){return K(function(){var e=_n(r,[[0,0],[1,1],[1,1],[0,0]]);return e=pt(e,t.conv.filters,[1,1],"valid"),e=We(e,t.bn.sub),e=Ye(e,t.bn.truediv),Bi(e=le(e,t.conv.bias))})}function pn(r,t){return K(function(){var e=_n(r,[[0,0],[1,1],[1,1],[0,0]]);return e=Ha(e,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),Bi(e=le(e,t.bias))})}var Li=function(){function r(t){var e=void 0===t?{}:t,n=e.inputSize,o=e.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=n||416,this._scoreThreshold=o||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),r}(),sh=function(r){function t(e){var n=r.call(this,"TinyYolov2")||this;return function a0(r){if(!r)throw new Error("invalid config: "+r);if("boolean"!=typeof r.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+r.withSeparableConvs);if(!Bo(r.iouThreshold)||r.iouThreshold<0||r.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+r.iouThreshold);if(!Array.isArray(r.classes)||!r.classes.length||!r.classes.every(function(t){return"string"==typeof t}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(r.classes));if(!Array.isArray(r.anchors)||!r.anchors.length||!r.anchors.map(function(t){return t||{}}).every(function(t){return Bo(t.x)&&Bo(t.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(r.anchors));if(r.meanRgb&&(!Array.isArray(r.meanRgb)||3!==r.meanRgb.length||!r.meanRgb.every(Bo)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(r.meanRgb))}(e),n._config=e,n}return oe(t,r),Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),t.prototype.runTinyYolov2=function(e,n){var o=dn(e,n.conv0);return o=dn(o=Ue(o,[2,2],[2,2],"same"),n.conv1),o=dn(o=Ue(o,[2,2],[2,2],"same"),n.conv2),o=dn(o=Ue(o,[2,2],[2,2],"same"),n.conv3),o=dn(o=Ue(o,[2,2],[2,2],"same"),n.conv4),o=dn(o=Ue(o,[2,2],[2,2],"same"),n.conv5),o=dn(o=Ue(o,[2,2],[1,1],"same"),n.conv6),Et(o=dn(o,n.conv7),n.conv8,"valid",!1)},t.prototype.runMobilenet=function(e,n){var o=this.config.isFirstLayerConv2d?Bi(Et(e,n.conv0,"valid",!1)):pn(e,n.conv0);return o=pn(o=Ue(o,[2,2],[2,2],"same"),n.conv1),o=pn(o=Ue(o,[2,2],[2,2],"same"),n.conv2),o=pn(o=Ue(o,[2,2],[2,2],"same"),n.conv3),o=pn(o=Ue(o,[2,2],[2,2],"same"),n.conv4),o=pn(o=Ue(o,[2,2],[2,2],"same"),n.conv5),o=Ue(o,[2,2],[1,1],"same"),o=n.conv6?pn(o,n.conv6):o,Et(o=n.conv7?pn(o,n.conv7):o,n.conv8,"valid",!1)},t.prototype.forwardInput=function(e,n){var o=this,a=this.params;if(!a)throw new Error("TinyYolov2 - load model before inference");return K(function(){var i=e.toBatchTensor(n,!1).toFloat();return i=(i=o.config.meanRgb?Br(i,o.config.meanRgb):i).div(j(256)),o.config.withSeparableConvs?o.runMobilenet(i,a):o.runTinyYolov2(i,a)})},t.prototype.forward=function(e,n){return J(this,void 0,void 0,function(){var o;return Z(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,Ge(e)];case 1:return[4,o.apply(this,[a.sent(),n])];case 2:return[2,a.sent()]}})})},t.prototype.detect=function(e,n){return void 0===n&&(n={}),J(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,m,x=this;return Z(this,function(b){switch(b.label){case 0:return o=new Li(n),a=o.inputSize,i=o.scoreThreshold,[4,Ge(e)];case 1:return s=b.sent(),[4,this.forwardInput(s,a)];case 2:return u=b.sent(),c=K(function(){return Le(u)[0].expandDims()}),l={width:s.getInputWidth(0),height:s.getInputHeight(0)},[4,this.extractBoxes(c,s.getReshapedInputDimensions(0),i)];case 3:return h=b.sent(),u.dispose(),c.dispose(),f=h.map(function(y){return y.box}),d=h.map(function(y){return y.score}),p=h.map(function(y){return y.classScore}),m=h.map(function(y){return x.config.classes[y.label]}),[2,Or(f.map(function(y){return y.rescale(a)}),d,this.config.iouThreshold,!0).map(function(y){return new Al(d[y],p[y],m[y],f[y],l)})]}})})},t.prototype.getDefaultModelName=function(){return""},t.prototype.extractParamsFromWeigthMap=function(e){return function c0(r,t){var s,e=[],n=function u0(r,t){var e=fn(r,t);function o(s){return{filters:e(s+"/filters",4),bias:e(s+"/bias",1)}}return{extractConvParams:o,extractConvWithBatchNormParams:function a(s){var u=o(s+"/conv"),c=function n(s){return{sub:e(s+"/sub",1),truediv:e(s+"/truediv",1)}}(s+"/bn");return{conv:u,bn:c}},extractSeparableConvParams:Fi(e)}}(r,e),o=n.extractConvParams,a=n.extractConvWithBatchNormParams,i=n.extractSeparableConvParams;if(t.withSeparableConvs){var u=t.filterSizes&&t.filterSizes.length||9;s={conv0:t.isFirstLayerConv2d?o("conv0"):i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:u>7?i("conv6"):void 0,conv7:u>8?i("conv7"):void 0,conv8:o("conv8")}}else s={conv0:a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:a("conv6"),conv7:a("conv7"),conv8:o("conv8")};return Yt(r,e),{params:s,paramMappings:e}}(e,this.config)},t.prototype.extractParams=function(e){var n=this.config.filterSizes||t.DEFAULT_FILTER_SIZES,o=n?n.length:void 0;if(7!==o&&8!==o&&9!==o)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+o+" filterSizes in config");return function s0(r,t,e,n){var f,o=$t(r),i=o.getRemainingWeights,s=[],u=function i0(r,t){var e=Mo(r,t),a=Ti(r,t);return{extractConvParams:e,extractConvWithBatchNormParams:function o(i,s,u){var c=e(i,s,3,u+"/conv"),l=function n(i,s){var u=Me(r(i)),c=Me(r(i));return t.push({paramPath:s+"/sub"},{paramPath:s+"/truediv"}),{sub:u,truediv:c}}(s,u+"/bn");return{conv:c,bn:l}},extractSeparableConvParams:a}}(o.extractWeights,s),c=u.extractConvParams,l=u.extractConvWithBatchNormParams,h=u.extractSeparableConvParams;if(t.withSeparableConvs){var d=n[0],p=n[1],m=n[2],v=n[3],g=n[4],x=n[5],b=n[6],y=n[7],w=n[8];f={conv0:t.isFirstLayerConv2d?c(d,p,3,"conv0"):h(d,p,"conv0"),conv1:h(p,m,"conv1"),conv2:h(m,v,"conv2"),conv3:h(v,g,"conv3"),conv4:h(g,x,"conv4"),conv5:h(x,b,"conv5"),conv6:y?h(b,y,"conv6"):void 0,conv7:w?h(y,w,"conv7"):void 0,conv8:c(w||y||b,5*e,1,"conv8")}}else m=n[2],v=n[3],g=n[4],x=n[5],b=n[6],y=n[7],w=n[8],f={conv0:l(d=n[0],p=n[1],"conv0"),conv1:l(p,m,"conv1"),conv2:l(m,v,"conv2"),conv3:l(v,g,"conv3"),conv4:l(g,x,"conv4"),conv5:l(x,b,"conv5"),conv6:l(b,y,"conv6"),conv7:l(y,w,"conv7"),conv8:c(w,5*e,1,"conv8")};if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{params:f,paramMappings:s}}(e,this.config,this.boxEncodingSize,n)},t.prototype.extractBoxes=function(e,n,o){return J(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,m,v,g,x,b,y,w,C,S,k,I,R,F,T,L,O,B,U,z,W=this;return Z(this,function(G){switch(G.label){case 0:return a=n.width,i=n.height,s=Math.max(a,i),u=s/a,c=s/i,l=e.shape[1],h=this.config.anchors.length,f=K(function(){var H=e.reshape([l,l,h,W.boxEncodingSize]);return[H.slice([0,0,0,0],[l,l,h,4]),H.slice([0,0,0,4],[l,l,h,1]),W.withClassScores?Ut(H.slice([0,0,0,5],[l,l,h,W.config.classes.length]),3):j(0)]}),d=f[0],m=f[2],v=[],[4,(p=f[1]).array()];case 1:return g=G.sent(),[4,d.array()];case 2:x=G.sent(),b=0,G.label=3;case 3:if(!(b<l))return[3,12];y=0,G.label=4;case 4:if(!(y<l))return[3,11];w=0,G.label=5;case 5:return w<h?(C=bi(g[b][y][w][0]),!o||C>o?(S=(y+bi(x[b][y][w][0]))/l*u,k=(b+bi(x[b][y][w][1]))/l*c,I=Math.exp(x[b][y][w][2])*this.config.anchors[w].x/l*u,R=Math.exp(x[b][y][w][3])*this.config.anchors[w].y/l*c,F=S-I/2,T=k-R/2,L={row:b,col:y,anchor:w},this.withClassScores?[4,this.extractPredictedClass(m,L)]:[3,7]):[3,9]):[3,10];case 6:return z=G.sent(),[3,8];case 7:z={classScore:1,label:0},G.label=8;case 8:B=(O=z).classScore,U=O.label,v.push(Qe({box:new Do(F,T,F+I,T+R),score:C,classScore:C*B,label:U},L)),G.label=9;case 9:return w++,[3,5];case 10:return y++,[3,4];case 11:return b++,[3,3];case 12:return d.dispose(),p.dispose(),m.dispose(),[2,v]}})})},t.prototype.extractPredictedClass=function(e,n){return J(this,void 0,void 0,function(){var o,a,i,s;return Z(this,function(u){switch(u.label){case 0:return o=n.row,a=n.col,i=n.anchor,[4,e.array()];case 1:return s=u.sent(),[2,Array(this.config.classes.length).fill(0).map(function(c,l){return s[o][a][i][l]}).map(function(c,l){return{classScore:c,label:l}}).reduce(function(c,l){return c.classScore>l.classScore?c:l})]}})})},t.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],t}(Xt),h0=function(r){function t(e){void 0===e&&(e=!0);var o=Object.assign({},{withSeparableConvs:e,iouThreshold:.4,classes:["face"]},e?{anchors:t0,meanRgb:n0}:{anchors:e0,withClassScores:!0});return r.call(this,o)||this}return oe(t,r),Object.defineProperty(t.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return J(this,void 0,void 0,function(){return Z(this,function(a){switch(a.label){case 0:return[4,this.detect(e,n)];case 1:return[2,a.sent().map(function(i){return new Tt(i.score,i.relativeBox,{width:i.imageWidth,height:i.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},t.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},t}(sh),f0=function(r){function t(){var e=null!==r&&r.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}return oe(t,r),t}(Li),Wr=function(){function r(){}return r.prototype.then=function(t){return J(this,void 0,void 0,function(){var e;return Z(this,function(n){switch(n.label){case 0:return e=t,[4,this.run()];case 1:return[2,e.apply(void 0,[n.sent()])]}})})},r.prototype.run=function(){return J(this,void 0,void 0,function(){return Z(this,function(t){throw new Error("ComposableTask - run is not implemented")})})},r}();function uh(r,t){return Object.assign({},r,{descriptor:t})}function Lo(r,t,e,n,o){return void 0===o&&(o=function(a){return a.alignedRect}),J(this,void 0,void 0,function(){var a,i,s,u,c;return Z(this,function(l){switch(l.label){case 0:return a=r.map(function(h){return function vg(r){return function Jm(r){return r.detection instanceof Tt}(r)&&r.landmarks instanceof Ao&&r.unshiftedLandmarks instanceof Ao&&r.alignedRect instanceof Tt}(h)?o(h):h.detection}),(s=n)?[3,5]:t instanceof _e?[4,Si(t,a)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,ki(t,a)];case 3:u=l.sent(),l.label=4;case 4:s=u,l.label=5;case 5:return[4,e(i=s)];case 6:return c=l.sent(),i.forEach(function(h){return h instanceof _e&&h.dispose()}),[2,c]}})})}function Wi(r,t,e,n,o){return J(this,void 0,void 0,function(){var a=this;return Z(this,function(i){return[2,Lo([r],t,function(s){return J(a,void 0,void 0,function(){return Z(this,function(u){return[2,e(s[0])]})})},n,o)]})})}function zi(r,t){var n=t[1];return{height:Math.floor(t[0]*r),width:Math.floor(n*r)}}var Vi=function(r){function t(e,n,o,a){return r.call(this,{left:e,top:n,right:o,bottom:a},!0)||this}return oe(t,r),t}(Kt);function ch(r){return K(function(){return Ye(We(r,j(127.5)),j(.0078125))})}function er(r,t){return K(function(){return le(ke(r),Ye(t,vo(ke(vo(r)))))})}function Ui(r,t,e){return void 0===e&&(e=!1),K(function(){var n=Et(r,t.conv1,"valid");return n=er(n,t.prelu1_alpha),n=er(n=Et(n=Ue(n,e?[2,2]:[3,3],[2,2],"same"),t.conv2,"valid"),t.prelu2_alpha),er(n=Et(n=e?n:Ue(n,[3,3],[2,2],"valid"),t.conv3,"valid"),t.prelu3_alpha)})}function _0(r,t,e,n,o){o.stage1=[];var a=t.map(function(f){return K(function(){var d={scale:f},p=function b0(r,t){return K(function(){var e=zi(t,r.shape.slice(1)),i=ch(Ya.resizeBilinear(r,[e.height,e.width]));return sn(i,[0,2,1,3])})}(r,f),m=Date.now(),v=function x0(r,t){return K(function(){var e=Ui(r,t,!0),n=Et(e,t.conv4_1,"valid"),o=dt(_o(n,3),3);return{prob:Ut(We(n,o),3),regions:Et(e,t.conv4_2,"valid")}})}(p,n),g=v.prob,x=v.regions;return d.pnet=Date.now()-m,{scoresTensor:Le(Le(g,3)[1])[0],regionsTensor:Le(x)[0],scale:f,statsForScale:d}})}),i=a.map(function(f){var d=f.scoresTensor,p=f.regionsTensor,v=f.statsForScale,g=function w0(r,t,e,n){for(var o=[],a=r.arraySync(),i=0;i<r.shape[0];i++)for(var s=0;s<r.shape[1];s++)a[i][s]>=n&&o.push(new xe(s,i));return o.map(function(c){var l=new Do(Math.round((2*c.y+1)/e),Math.round((2*c.x+1)/e),Math.round((2*c.y+12)/e),Math.round((2*c.x+12)/e)),h=a[c.y][c.x],f=t.arraySync();return{cell:l,score:h,region:new Vi(f[c.y][c.x][0],f[c.y][c.x][1],f[c.y][c.x][2],f[c.y][c.x][3])}})}(d,p,f.scale,e);if(d.dispose(),p.dispose(),!g.length)return o.stage1.push(v),[];var x=Date.now(),b=Or(g.map(function(y){return y.cell}),g.map(function(y){return y.score}),.5);return v.nms=Date.now()-x,v.numBoxes=b.length,o.stage1.push(v),b.map(function(y){return g[y]})}),s=i.reduce(function(f,d){return f.concat(d)},[]),u=[],c=[];if(s.length>0){var l=Date.now(),h=Or(s.map(function(f){return f.cell}),s.map(function(f){return f.score}),.7);o.stage1_nms=Date.now()-l,c=h.map(function(f){return s[f].score}),u=h.map(function(f){return s[f]}).map(function(f){var d=f.cell,p=f.region;return new Do(d.left+p.left*d.width,d.top+p.top*d.height,d.right+p.right*d.width,d.bottom+p.bottom*d.height).toSquare().round()})}return{boxes:u,scores:c}}function lh(r,t,e){var n=e.width,o=e.height;return J(this,void 0,void 0,function(){var a,i,s,u=this;return Z(this,function(c){switch(c.label){case 0:return a=Ft(r),[4,Promise.all(t.map(function(l){return J(u,void 0,void 0,function(){var h,v,g,x;return Z(this,function(b){return h=l.padAtBorders(r.height,r.width),x=a.getImageData(v=h.x-1,g=h.y-1,h.ex-v,h.ey-g),[2,Je.isNodejs()?Ri(x):createImageBitmap(x)]})})}))];case 1:return i=c.sent(),s=[],i.forEach(function(l){var f=Ft(Fo({width:n,height:o}));f.drawImage(l,0,0,n,o);for(var d=f.getImageData(0,0,n,o).data,p=[],m=0;m<d.length;m+=4)p.push(d[m+2]),p.push(d[m+1]),p.push(d[m]);s.push(p)}),[2,s.map(function(l){return K(function(){return ch(sn(rt(l,[1,n,o,3]),[0,2,1,3]).toFloat())})})]}})})}function E0(r,t,e,n,o){return J(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,m,v,g,x;return Z(this,function(b){switch(b.label){case 0:return a=Date.now(),[4,lh(r,t,{width:24,height:24})];case 1:return i=b.sent(),o.stage2_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(y){var w=function C0(r,t){return K(function(){var e=Ui(r,t),a=er(Nt(wt(e,[e.shape[0],t.fc1.weights.shape[0]]),t.fc1),t.prelu4_alpha),i=Nt(a,t.fc2_1),s=dt(_o(i,1),1),u=Ut(We(i,s),1),c=Nt(a,t.fc2_2);return{scores:Le(u,1)[1],regions:c}})}(y,n);return y.dispose(),w}),o.stage2_rnet=Date.now()-a,u=s.length>1?Be(s.map(function(y){return y.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[b.sent()]),u.dispose(),f=c.map(function(y,w){return{score:y,idx:w}}).filter(function(y){return y.score>e}).map(function(y){return y.idx}),d=f.map(function(y){return t[y]}),p=f.map(function(y){return c[y]}),m=[],v=[],d.length>0&&(a=Date.now(),g=Or(d,p,.7),o.stage2_nms=Date.now()-a,x=g.map(function(y){var w=s[f[y]].regions.arraySync();return new Vi(w[0][0],w[0][1],w[0][2],w[0][3])}),v=g.map(function(y){return p[y]}),m=g.map(function(y,w){return d[y].calibrate(x[w])})),s.forEach(function(y){y.regions.dispose(),y.scores.dispose()}),[2,{boxes:m,scores:v}]}})})}function R0(r,t,e,n,o){return J(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,d,p,m,v,g,x,b;return Z(this,function(y){switch(y.label){case 0:return a=Date.now(),[4,lh(r,t,{width:48,height:48})];case 1:return i=y.sent(),o.stage3_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(w){var C=function I0(r,t){return K(function(){var e=Ui(r,t);e=er(e=Et(e=Ue(e,[2,2],[2,2],"same"),t.conv4,"valid"),t.prelu4_alpha);var a=er(Nt(wt(e,[e.shape[0],t.fc1.weights.shape[0]]),t.fc1),t.prelu5_alpha),i=Nt(a,t.fc2_1),s=dt(_o(i,1),1),u=Ut(We(i,s),1),c=Nt(a,t.fc2_2),l=Nt(a,t.fc2_3);return{scores:Le(u,1)[1],regions:c,points:l}})}(w,n);return w.dispose(),C}),o.stage3_onet=Date.now()-a,u=s.length>1?Be(s.map(function(w){return w.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[y.sent()]),u.dispose(),f=c.map(function(w,C){return{score:w,idx:C}}).filter(function(w){return w.score>e}).map(function(w){return w.idx}),d=f.map(function(w){var C=s[w].regions.arraySync();return new Vi(C[0][0],C[0][1],C[0][2],C[0][3])}),p=f.map(function(w,C){return t[w].calibrate(d[C])}),m=f.map(function(w){return c[w]}),v=[],g=[],x=[],p.length>0&&(a=Date.now(),b=Or(p,m,.7,!1),o.stage3_nms=Date.now()-a,v=b.map(function(w){return p[w]}),g=b.map(function(w){return m[w]}),x=b.map(function(w,C){return Array(5).fill(0).map(function(S,k){var I=s[w].points.arraySync();return new xe(I[0][k]*(v[C].width+1)+v[C].left,I[0][k+5]*(v[C].height+1)+v[C].top)})})),s.forEach(function(w){w.regions.dispose(),w.scores.dispose(),w.points.dispose()}),[2,{boxes:v,scores:g,points:x}]}})})}var k0=function(r){function t(){return r.call(this,"Mtcnn")||this}return oe(t,r),t.prototype.load=function(e){return J(this,void 0,void 0,function(){return Z(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.load.call(this,e)]})})},t.prototype.loadFromDisk=function(e){return J(this,void 0,void 0,function(){return Z(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.loadFromDisk.call(this,e)]})})},t.prototype.forwardInput=function(e,n){return void 0===n&&(n={}),J(this,void 0,void 0,function(){var o,a,i,s,u,c,l,h,f,d,p,m,v,g,b,y,w,C,S,k;return Z(this,function(I){switch(I.label){case 0:if(!(o=this.params))throw new Error("Mtcnn - load model before inference");if(!(a=e.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return i={},s=Date.now(),u=K(function(){return function d0(r){return K(function(){return ut(Le(r,3).reverse(),3)})}(dt(di.fromPixels(a)).toFloat())}),c=function(R){return u.dispose(),i.total=Date.now()-s,R},l=u.shape.slice(1),h=l[0],f=l[1],d=new ah(n),p=d.minFaceSize,m=d.scaleFactor,v=d.maxNumScales,g=d.scoreThresholds,b=(d.scaleSteps||function y0(r,t,e){for(var a=12/r,i=[],s=Math.min(e[0],e[1])*a,u=0;s>=12;)i.push(a*Math.pow(t,u)),s*=t,u+=1;return i}(p,m,[h,f])).filter(function(R){var F=zi(R,[h,f]);return Math.min(F.width,F.height)>12}).slice(0,v),i.scales=b,i.pyramid=b.map(function(R){return zi(R,[h,f])}),y=Date.now(),[4,_0(u,b,g[0],o.pnet,i)];case 1:return w=I.sent(),i.total_stage1=Date.now()-y,w.boxes.length?(i.stage2_numInputBoxes=w.boxes.length,y=Date.now(),[4,E0(a,w.boxes,g[1],o.rnet,i)]):[2,c({results:[],stats:i})];case 2:return C=I.sent(),i.total_stage2=Date.now()-y,C.boxes.length?(i.stage3_numInputBoxes=C.boxes.length,y=Date.now(),[4,R0(a,C.boxes,g[2],o.onet,i)]):[2,c({results:[],stats:i})];case 3:return S=I.sent(),i.total_stage3=Date.now()-y,k=S.boxes.map(function(R,F){return Ni(_i({},new Tt(S.scores[F],new wi(R.left/f,R.top/h,R.width/f,R.height/h),{height:h,width:f})),new Qm(S.points[F].map(function(T){return T.sub(new xe(R.left,R.top)).div(new xe(R.width,R.height))}),{width:R.width,height:R.height}))}),[2,c({results:k,stats:i})]}})})},t.prototype.forward=function(e,n){return void 0===n&&(n={}),J(this,void 0,void 0,function(){var o;return Z(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,Ge(e)];case 1:return[4,o.apply(this,[a.sent(),n])];case 2:return[2,a.sent().results]}})})},t.prototype.forwardWithStats=function(e,n){return void 0===n&&(n={}),J(this,void 0,void 0,function(){var o;return Z(this,function(a){switch(a.label){case 0:return o=this.forwardInput,[4,Ge(e)];case 1:return[2,o.apply(this,[a.sent(),n])]}})})},t.prototype.getDefaultModelName=function(){return"mtcnn_model"},t.prototype.extractParamsFromWeigthMap=function(e){return function g0(r){var t=[],e=function m0(r,t){var e=fn(r,t);function n(l){return{filters:e(l+"/weights",4,l+"/filters"),bias:e(l+"/bias",1)}}function o(l){return{weights:e(l+"/weights",2),bias:e(l+"/bias",1)}}function a(l){return e(l,1)}function i(l){return{conv1:n(l+"/conv1"),prelu1_alpha:a(l+"/prelu1_alpha"),conv2:n(l+"/conv2"),prelu2_alpha:a(l+"/prelu2_alpha"),conv3:n(l+"/conv3"),prelu3_alpha:a(l+"/prelu3_alpha")}}return{extractPNetParams:function s(){var l=i("pnet"),h=n("pnet/conv4_1"),f=n("pnet/conv4_2");return Qe(Qe({},l),{conv4_1:h,conv4_2:f})},extractRNetParams:function u(){var l=i("rnet"),h=o("rnet/fc1"),f=a("rnet/prelu4_alpha"),d=o("rnet/fc2_1"),p=o("rnet/fc2_2");return Qe(Qe({},l),{fc1:h,prelu4_alpha:f,fc2_1:d,fc2_2:p})},extractONetParams:function c(){var l=i("onet"),h=n("onet/conv4"),f=a("onet/prelu4_alpha"),d=o("onet/fc1"),p=a("onet/prelu5_alpha"),m=o("onet/fc2_1"),v=o("onet/fc2_2"),g=o("onet/fc2_3");return Qe(Qe({},l),{conv4:h,prelu4_alpha:f,fc1:d,prelu5_alpha:p,fc2_1:m,fc2_2:v,fc2_3:g})}}}(r,t),o=e.extractRNetParams,a=e.extractONetParams,i=(0,e.extractPNetParams)(),s=o(),u=a();return Yt(r,t),{params:{pnet:i,rnet:s,onet:u},paramMappings:t}}(e)},t.prototype.extractParams=function(e){return function v0(r){var t=$t(r),n=t.getRemainingWeights,o=[],a=function p0(r,t){var e=Mo(r,t),n=Ai(r,t);function o(c,l){var h=Me(r(c));return t.push({paramPath:l}),h}function a(c,l,h){return void 0===h&&(h=!1),{conv1:e(c[0],c[1],3,l+"/conv1"),prelu1_alpha:o(c[1],l+"/prelu1_alpha"),conv2:e(c[1],c[2],3,l+"/conv2"),prelu2_alpha:o(c[2],l+"/prelu2_alpha"),conv3:e(c[2],c[3],h?2:3,l+"/conv3"),prelu3_alpha:o(c[3],l+"/prelu3_alpha")}}return{extractPNetParams:function i(){var c=a([3,10,16,32],"pnet"),l=e(32,2,1,"pnet/conv4_1"),h=e(32,4,1,"pnet/conv4_2");return Qe(Qe({},c),{conv4_1:l,conv4_2:h})},extractRNetParams:function s(){var c=a([3,28,48,64],"rnet",!0),l=n(576,128,"rnet/fc1"),h=o(128,"rnet/prelu4_alpha"),f=n(128,2,"rnet/fc2_1"),d=n(128,4,"rnet/fc2_2");return Qe(Qe({},c),{fc1:l,prelu4_alpha:h,fc2_1:f,fc2_2:d})},extractONetParams:function u(){var c=a([3,32,64,64],"onet"),l=e(64,128,2,"onet/conv4"),h=o(128,"onet/prelu4_alpha"),f=n(1152,256,"onet/fc1"),d=o(256,"onet/prelu5_alpha"),p=n(256,2,"onet/fc2_1"),m=n(256,4,"onet/fc2_2"),v=n(256,10,"onet/fc2_3");return Qe(Qe({},c),{conv4:l,prelu4_alpha:h,fc1:f,prelu5_alpha:d,fc2_1:p,fc2_2:m,fc2_3:v})}}}(t.extractWeights,o),s=a.extractRNetParams,u=a.extractONetParams,c=(0,a.extractPNetParams)(),l=s(),h=u();if(0!==n().length)throw new Error("weights remaing after extract: "+n().length);return{params:{pnet:c,rnet:l,onet:h},paramMappings:o}}(e)},t}(Xt),D0=[new xe(1.603231,2.094468),new xe(6.041143,7.080126),new xe(2.882459,3.518061),new xe(4.266906,5.178857),new xe(9.041765,10.66308)],A0=[117.001,114.697,97.404],T0=function(r){function t(){return r.call(this,{withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:D0,meanRgb:A0,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}return oe(t,r),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return J(this,void 0,void 0,function(){return Z(this,function(a){switch(a.label){case 0:return[4,this.detect(e,n)];case 1:return[2,a.sent().map(function(i){return new Tt(i.score,i.relativeBox,{width:i.imageWidth,height:i.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},t.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},t}(sh),ye={ssdMobilenetv1:new ih,tinyFaceDetector:new T0,tinyYolov2:new h0,mtcnn:new k0,faceLandmark68Net:new th,faceLandmark68TinyNet:new Ag,faceRecognitionNet:new Bg,faceExpressionNet:new pg,ageGenderNet:new Rg};function hh(r,t){return Object.assign({},r,{age:t})}var fh=function(r){function t(e,n,o){var a=r.call(this)||this;return a.parentTask=e,a.input=n,a.extractedFaces=o,a}return oe(t,r),t}(Wr),Gi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o=this;return Z(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return[4,Lo(e=a.sent(),this.input,function(i){return J(o,void 0,void 0,function(){return Z(this,function(s){switch(s.label){case 0:return[4,Promise.all(i.map(function(u){return ye.faceExpressionNet.predictExpressions(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return n=a.sent(),[2,e.map(function(i,s){return Jl(i,n[s])})]}})})},t.prototype.withAgeAndGender=function(){return new Ki(this,this.input)},t}(fh),Hi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n;return Z(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return(e=o.sent())?[4,Wi(e,this.input,function(a){return ye.faceExpressionNet.predictExpressions(a)},this.extractedFaces)]:[2];case 2:return n=o.sent(),[2,Jl(e,n)]}})})},t.prototype.withAgeAndGender=function(){return new Xi(this,this.input)},t}(fh),ji=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.withAgeAndGender=function(){return new Yi(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Qi(this,this.input)},t}(Gi),qi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.withAgeAndGender=function(){return new $i(this,this.input)},t.prototype.withFaceDescriptor=function(){return new Ji(this,this.input)},t}(Hi),dh=function(r){function t(e,n,o){var a=r.call(this)||this;return a.parentTask=e,a.input=n,a.extractedFaces=o,a}return oe(t,r),t}(Wr),Ki=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o=this;return Z(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return[4,Lo(e=a.sent(),this.input,function(i){return J(o,void 0,void 0,function(){return Z(this,function(s){switch(s.label){case 0:return[4,Promise.all(i.map(function(u){return ye.ageGenderNet.predictAgeAndGender(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return n=a.sent(),[2,e.map(function(i,s){var u=n[s],c=u.age;return hh(oh(i,u.gender,u.genderProbability),c)})]}})})},t.prototype.withFaceExpressions=function(){return new Gi(this,this.input)},t}(dh),Xi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o;return Z(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return(e=s.sent())?[4,Wi(e,this.input,function(u){return ye.ageGenderNet.predictAgeAndGender(u)},this.extractedFaces)]:[2];case 2:return n=s.sent(),o=n.age,[2,hh(oh(e,n.gender,n.genderProbability),o)]}})})},t.prototype.withFaceExpressions=function(){return new Hi(this,this.input)},t}(dh),Yi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.withFaceExpressions=function(){return new ji(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Qi(this,this.input)},t}(Ki),$i=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.withFaceExpressions=function(){return new qi(this,this.input)},t.prototype.withFaceDescriptor=function(){return new Ji(this,this.input)},t}(Xi),ph=function(r){function t(e,n){var o=r.call(this)||this;return o.parentTask=e,o.input=n,o}return oe(t,r),t}(Wr),Qi=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e;return Z(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return[4,Lo(e=o.sent(),this.input,function(a){return Promise.all(a.map(function(i){return ye.faceRecognitionNet.computeFaceDescriptor(i)}))},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,o.sent().map(function(a,i){return uh(e[i],a)})]}})})},t.prototype.withFaceExpressions=function(){return new ji(this,this.input)},t.prototype.withAgeAndGender=function(){return new Yi(this,this.input)},t}(ph),Ji=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n;return Z(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return(e=o.sent())?[4,Wi(e,this.input,function(a){return ye.faceRecognitionNet.computeFaceDescriptor(a)},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return n=o.sent(),[2,uh(e,n)]}})})},t.prototype.withFaceExpressions=function(){return new qi(this,this.input)},t.prototype.withAgeAndGender=function(){return new $i(this,this.input)},t}(ph),vh=function(r){function t(e,n,o){var a=r.call(this)||this;return a.parentTask=e,a.input=n,a.useTinyLandmarkNet=o,a}return oe(t,r),Object.defineProperty(t.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?ye.faceLandmark68TinyNet:ye.faceLandmark68Net},enumerable:!0,configurable:!0}),t}(Wr),F0=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o,a,i,s=this;return Z(this,function(u){switch(u.label){case 0:return[4,this.parentTask];case 1:return e=u.sent(),n=e.map(function(c){return c.detection}),this.input instanceof _e?[4,Si(this.input,n)]:[3,3];case 2:return a=u.sent(),[3,5];case 3:return[4,ki(this.input,n)];case 4:a=u.sent(),u.label=5;case 5:return o=a,[4,Promise.all(o.map(function(c){return s.landmarkNet.detectLandmarks(c)}))];case 6:return i=u.sent(),o.forEach(function(c){return c instanceof _e&&c.dispose()}),[2,e.map(function(c,l){return Ni(c,i[l])})]}})})},t.prototype.withFaceExpressions=function(){return new ji(this,this.input)},t.prototype.withAgeAndGender=function(){return new Yi(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Qi(this,this.input)},t}(vh),N0=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o,a,i;return Z(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return(e=s.sent())?(n=e.detection,this.input instanceof _e?[4,Si(this.input,[n])]:[3,3]):[2];case 2:return a=s.sent(),[3,5];case 3:return[4,ki(this.input,[n])];case 4:a=s.sent(),s.label=5;case 5:return[4,this.landmarkNet.detectLandmarks((o=a)[0])];case 6:return i=s.sent(),o.forEach(function(u){return u instanceof _e&&u.dispose()}),[2,Ni(e,i)]}})})},t.prototype.withFaceExpressions=function(){return new qi(this,this.input)},t.prototype.withAgeAndGender=function(){return new $i(this,this.input)},t.prototype.withFaceDescriptor=function(){return new Ji(this,this.input)},t}(vh),mh=function(r){function t(e,n){void 0===n&&(n=new Lr);var o=r.call(this)||this;return o.input=e,o.options=n,o}return oe(t,r),t}(Wr),P0=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n,o,a;return Z(this,function(i){switch(i.label){case 0:return n=(e=this).input,(o=e.options)instanceof ah?[4,ye.mtcnn.forward(n,o)]:[3,2];case 1:return[2,i.sent().map(function(s){return s.detection})];case 2:if(!(a=o instanceof f0?function(s){return ye.tinyFaceDetector.locateFaces(s,o)}:o instanceof Lr?function(s){return ye.ssdMobilenetv1.locateFaces(s,o)}:o instanceof Li?function(s){return ye.tinyYolov2.locateFaces(s,o)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,a(n)]}})})},t.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(n){return J(e,void 0,void 0,function(){var o;return Z(this,function(a){switch(a.label){case 0:return[4,this.run()];case 1:return o=a.sent(),[2,n(o.map(function(i){return _i({},i)}))]}})})})},t.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new F0(this.runAndExtendWithFaceDetections(),this.input,e)},t.prototype.withFaceExpressions=function(){return new Gi(this.runAndExtendWithFaceDetections(),this.input)},t.prototype.withAgeAndGender=function(){return new Ki(this.runAndExtendWithFaceDetections(),this.input)},t}(mh),M0=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return oe(t,r),t.prototype.run=function(){return J(this,void 0,void 0,function(){var e,n;return Z(this,function(o){switch(o.label){case 0:return[4,new P0(this.input,this.options)];case 1:return e=o.sent(),n=e[0],e.forEach(function(a){a.score>n.score&&(n=a)}),[2,n]}})})},t.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(n){return J(e,void 0,void 0,function(){var o;return Z(this,function(a){switch(a.label){case 0:return[4,this.run()];case 1:return o=a.sent(),[2,n(o?_i({},o):void 0)]}})})})},t.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new N0(this.runAndExtendWithFaceDetection(),this.input,e)},t.prototype.withFaceExpressions=function(){return new Hi(this.runAndExtendWithFaceDetection(),this.input)},t.prototype.withAgeAndGender=function(){return new Xi(this.runAndExtendWithFaceDetection(),this.input)},t}(mh);!function(){function r(t,e){void 0===e&&(e=.6),this._distanceThreshold=e;var n=Array.isArray(t)?t:[t];if(!n.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var o=1,a=function(){return"person "+o++};this._labeledDescriptors=n.map(function(i){if(i instanceof To)return i;if(i instanceof Float32Array)return new To(a(),[i]);if(i.descriptor&&i.descriptor instanceof Float32Array)return new To(a(),[i.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}Object.defineProperty(r.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),r.prototype.computeMeanDistance=function(t,e){return e.map(function(n){return function B0(r,t){if(r.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var e=Array.from(r),n=Array.from(t);return Math.sqrt(e.map(function(o,a){return o-n[a]}).reduce(function(o,a){return o+Math.pow(a,2)},0))}(n,t)}).reduce(function(n,o){return n+o},0)/(e.length||1)},r.prototype.matchDescriptor=function(t){var e=this;return this.labeledDescriptors.map(function(n){return new Fl(n.label,e.computeMeanDistance(t,n.descriptors))}).reduce(function(n,o){return n.distance<o.distance?n:o})},r.prototype.findBestMatch=function(t){var e=this.matchDescriptor(t);return e.distance<this.distanceThreshold?e:new Fl("unknown",e.distance)},r.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(t){return t.toJSON()})}},r.fromJSON=function(t){return new r(t.labeledDescriptors.map(function(n){return To.fromJSON(n)}),t.distanceThreshold)}}();const W0=["video"];function z0(r,t){if(1&r&&(ee.j41(0,"div",8),ee.EFF(1),ee.k0s()),2&r){const e=ee.XpG();ee.R7$(),ee.SpI(" ",e.message," ")}}let V0=(()=>{class r{videoRef;faceVerified=new ee.bkB;message="Chargement...";hasReference=!1;modelsLoaded=!1;isScanning=!1;ngOnInit(){this.loadModels()}loadModels(){var e=this;return(0,or.A)(function*(){e.message="\u{1f4e6} Chargement des mod\xe8les...";try{yield Promise.all([ye.ssdMobilenetv1.loadFromUri("/assets/models/ssd_mobilenetv1"),ye.faceLandmark68Net.loadFromUri("/assets/models/face_landmark_68"),ye.faceRecognitionNet.loadFromUri("/assets/models/face_recognition")]),e.modelsLoaded=!0,e.message="\u{1f4f8} Mod\xe8les charg\xe9s. Initialisation cam\xe9ra...",console.log("\u2705 Tous les mod\xe8les ont bien \xe9t\xe9 charg\xe9s !")}catch(n){e.message="\u274c Erreur lors du chargement des mod\xe8les",console.error("\u274c Erreur face-api model:",n)}})()}ngAfterViewInit(){this.initCamera()}initCamera(){var e=this;return(0,or.A)(function*(){console.log("\u{1f3a5} Initialisation de la cam\xe9ra...");try{const n=yield navigator.mediaDevices.getUserMedia({video:!0});e.videoRef.nativeElement.srcObject=n,e.message="\u{1f3a5} Cam\xe9ra active. Vous pouvez rescanner.",console.log("\u2705 Cam\xe9ra initialis\xe9e avec succ\xe8s")}catch(n){e.message="\u274c Impossible d\u2019acc\xe9der \xe0 la cam\xe9ra",console.error("\u274c Erreur acc\xe8s cam\xe9ra :",n)}})()}captureAndEmit(){var e=this;return(0,or.A)(function*(){if(!e.modelsLoaded||e.isScanning)return;e.isScanning=!0,e.message="\u{1f50d} Analyse du visage en cours...";const n=e.videoRef.nativeElement;try{const o=yield function O0(r,t){return void 0===t&&(t=new Lr),new M0(r,t)}(n,new Lr).withFaceLandmarks().withFaceDescriptor();if(!o||!o.descriptor)return e.message="\u{1f615} Visage non d\xe9tect\xe9. V\xe9rifiez l\u2019\xe9clairage ou ajustez votre position.",void console.warn("\u{1f615} Aucun visage d\xe9tect\xe9.");const a=Array.from(o.descriptor);e.message="\u2705 Visage captur\xe9. V\xe9rification en cours...",e.faceVerified.emit(a),setTimeout(()=>{e.message="\u{1f3a5} Cam\xe9ra active. Vous pouvez rescanner."},4e3)}catch(o){e.message="\u274c Erreur pendant la capture.",console.error(o)}finally{e.isScanning=!1}})()}static \u0275fac=function(n){return new(n||r)};static \u0275cmp=ee.VBU({type:r,selectors:[["app-face-scan"]],viewQuery:function(n,o){if(1&n&&ee.GBs(W0,5),2&n){let a;ee.mGM(a=ee.lsd())&&(o.videoRef=a.first)}},outputs:{faceVerified:"faceVerified"},decls:9,vars:2,consts:[["video",""],[1,"scan-page"],["class","status-message",4,"ngIf"],[1,"video-container"],[1,"video-frame"],["autoplay","","muted","","playsinline",""],[1,"oval-mask"],[1,"capture-btn",3,"click","disabled"],[1,"status-message"]],template:function(n,o){if(1&n){const a=ee.RV6();ee.j41(0,"div",1),ee.DNE(1,z0,2,1,"div",2),ee.j41(2,"div",3)(3,"div",4),ee.nrm(4,"video",5,0)(6,"div",6),ee.k0s(),ee.j41(7,"button",7),ee.bIt("click",function(){return ee.eBV(a),ee.Njj(o.captureAndEmit())}),ee.EFF(8," \u{1f4f8} Scanner visage "),ee.k0s()()()}2&n&&(ee.R7$(),ee.Y8G("ngIf",o.message),ee.R7$(6),ee.Y8G("disabled",!o.modelsLoaded||o.isScanning))},dependencies:[ar.MD,ar.bT],styles:[".scan-page[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;font-family:Inter,Helvetica,sans-serif;padding:1.5rem 1rem;min-height:100vh;background-color:#f9f9f9;max-width:480px;margin:auto}.reference-status[_ngcontent-%COMP%]{width:100%;margin-bottom:1rem;padding:.75rem 1rem;background-color:#e9f5ff;border-left:4px solid #2196f3;border-radius:.5rem;font-size:.95rem;color:#0c4a6e;box-sizing:border-box}.video-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.75rem;width:100%}.video-frame[_ngcontent-%COMP%]{position:relative;width:100%;max-width:320px;height:400px;border-radius:1rem;overflow:hidden;background:#000;box-shadow:0 4px 20px #00000026}video[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.oval-mask[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;width:60%;height:70%;transform:translate(-50%,-50%);border:3px solid rgba(0,132,255,.5);border-radius:50%/60%;pointer-events:none;box-sizing:border-box}.instruction-message[_ngcontent-%COMP%], .status-message[_ngcontent-%COMP%]{margin-top:1rem;text-align:center;font-weight:500;font-size:.95rem;transition:color .3s ease;padding:0 1rem}.instruction-message.success[_ngcontent-%COMP%]{color:#28a745}.instruction-message.error[_ngcontent-%COMP%]{color:#dc3545}.instruction-message.info[_ngcontent-%COMP%]{color:#444}.capture-btn[_ngcontent-%COMP%]{margin-top:.5rem;background-color:#2196f3;color:#fff;padding:.6rem 1.2rem;border:none;border-radius:9999px;font-size:1rem;cursor:pointer;transition:background-color .3s ease;width:100%;max-width:220px}.capture-btn[_ngcontent-%COMP%]:hover{background-color:#1976d2}.capture-btn[_ngcontent-%COMP%]:disabled{background-color:#9e9e9e;cursor:not-allowed}.return-btn[_ngcontent-%COMP%]{margin-top:1rem;background:transparent;color:#444;font-size:.95rem;border:none;cursor:pointer;text-decoration:underline}"]})}return r})();var gh=vt(3242);function U0(r,t){1&r&&(ee.j41(0,"p"),ee.EFF(1," \u{1f9e0} Une photo de r\xe9f\xe9rence est d\xe9j\xe0 enregistr\xe9e. Vous allez \xeatre compar\xe9 \xe0 celle-ci. "),ee.k0s())}function G0(r,t){1&r&&(ee.j41(0,"p"),ee.EFF(1,"\u{1f4f8} Aucune photo de r\xe9f\xe9rence trouv\xe9e. La premi\xe8re capture sera enregistr\xe9e comme r\xe9f\xe9rence."),ee.k0s())}function H0(r,t){if(1&r&&(ee.j41(0,"div",5),ee.DNE(1,U0,2,0,"p",6)(2,G0,2,0,"ng-template",null,0,ee.C5r),ee.k0s()),2&r){const e=ee.sdS(3),n=ee.XpG();ee.R7$(),ee.Y8G("ngIf",n.hasReference)("ngIfElse",e)}}let j0=(()=>{class r{route;http;router;tokenQr="";message="\u{1f4f7} Scan facial en cours...";messageType="info";hasReference=null;BASE_URL="https://emargementonline-production.up.railway.app/api";constructor(e,n,o){this.route=e,this.http=n,this.router=o,this.tokenQr=this.route.snapshot.paramMap.get("token")||""}ngOnInit(){var e=this;return(0,or.A)(function*(){const n=localStorage.getItem("_TOKEN_UTILISATEUR");if(!n)return;const o=JSON.parse(n).token,a=(new Vo.Lr).set("Authorization",`Bearer ${o}`);try{const i=yield e.http.get(`${e.BASE_URL}/etudiants/photo-reference`,{headers:a}).toPromise();e.hasReference=i?.exists??!1}catch(i){console.warn("Erreur r\xe9cup\xe9ration photo de r\xe9f\xe9rence :",i),e.hasReference=null}})()}onFaceVerified(e){var n=this;return(0,or.A)(function*(){n.message="\u{1f9e0} Visage captur\xe9, v\xe9rification en cours...",n.messageType="info";const o=localStorage.getItem("_TOKEN_UTILISATEUR");if(!o)return n.message="\u274c Non connect\xe9",void(n.messageType="error");const a=JSON.parse(o).token,i=(new Vo.Lr).set("Authorization",`Bearer ${a}`);try{if(n.hasReference){if(!(yield n.http.post(`${n.BASE_URL}/etudiants/face-verify`,{descriptor:e},{headers:i}).toPromise())?.match)return n.message="\u274c Reconnaissance faciale \xe9chou\xe9e. Veuillez r\xe9essayer.",void(n.messageType="error");n.message="\u2705 Visage reconnu. Validation de pr\xe9sence...",n.messageType="success"}else n.message="\u{1f4f8} Enregistrement photo de r\xe9f\xe9rence...",n.messageType="info",yield n.http.post(`${n.BASE_URL}/etudiants/face-reference`,{descriptor:e},{headers:i}).toPromise(),n.message="\u2705 R\xe9f\xe9rence enregistr\xe9e. Validation de pr\xe9sence...",n.messageType="success";const s=yield n.http.post(`${n.BASE_URL}/qrcode/${n.tokenQr}/scan`,{empreinte_device:"fallback-device",descriptor:e},{headers:i}).toPromise();n.message=s.message||"\u2705 Pr\xe9sence valid\xe9e avec succ\xe8s !",n.messageType="success",setTimeout(()=>{n.router.navigate(["/dashboard-etudiant"])},2e3)}catch(s){console.error(s),n.message=s?.error?.message||"\u274c Erreur pendant le processus",n.messageType="error"}})()}goBack(){this.router.navigate(["/dashboard-etudiant"])}static \u0275fac=function(n){return new(n||r)(ee.rXU(gh.nX),ee.rXU(Vo.Qq),ee.rXU(gh.Ix))};static \u0275cmp=ee.VBU({type:r,selectors:[["app-scan-qr"]],decls:5,vars:3,consts:[["noRef",""],[1,"scan-qr-wrapper"],["class","reference-status",4,"ngIf"],[3,"faceVerified"],[1,"instruction-message",3,"ngClass"],[1,"reference-status"],[4,"ngIf","ngIfElse"]],template:function(n,o){1&n&&(ee.j41(0,"div",1),ee.DNE(1,H0,4,2,"div",2),ee.j41(2,"app-face-scan",3),ee.bIt("faceVerified",function(i){return o.onFaceVerified(i)}),ee.k0s(),ee.j41(3,"p",4),ee.EFF(4),ee.k0s()()),2&n&&(ee.R7$(),ee.Y8G("ngIf",null!==o.hasReference),ee.R7$(2),ee.Y8G("ngClass",o.messageType),ee.R7$(),ee.SpI(" ",o.message," "))},dependencies:[ar.MD,ar.YU,ar.bT,V0],styles:[".scan-qr-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:1rem;min-height:100vh;background-color:#f9f9f9;font-family:Inter,Helvetica,sans-serif;text-align:center}.reference-status[_ngcontent-%COMP%]{width:100%;max-width:450px;margin-bottom:1rem;padding:.6rem 1rem;background-color:#e9f5ff;border-left:4px solid #2196f3;border-radius:.5rem;font-size:.95rem;color:#0c4a6e}.instruction-message[_ngcontent-%COMP%]{margin-top:1.5rem;font-size:1rem;font-weight:500;text-align:center;transition:color .3s ease;word-wrap:break-word;padding:0 1rem}.instruction-message.success[_ngcontent-%COMP%]{color:#28a745}.instruction-message.error[_ngcontent-%COMP%]{color:#dc3545}.instruction-message.info[_ngcontent-%COMP%]{color:#444}@media (max-width: 480px){.reference-status[_ngcontent-%COMP%]{font-size:.9rem;padding:.5rem .75rem}.instruction-message[_ngcontent-%COMP%]{font-size:.95rem;margin-top:1rem}.scan-qr-wrapper[_ngcontent-%COMP%]{padding:1rem .5rem}}"]})}return r})()},7318:()=>{},8082:()=>{}}]);